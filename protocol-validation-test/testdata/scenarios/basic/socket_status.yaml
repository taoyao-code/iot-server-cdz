# 插座状态上报测试
# 严格按照《设备对接指引-组网设备2024(1).txt》第2.2.3节构建

name: "插座状态上报测试"
description: "验证插座状态主动上报机制，包含BKV协议解析"
category: "basic"
version: "1.0"
author: "Protocol Validation System"
created_at: "2024-12-25T00:00:00Z"

scenarios:
  - id: "socket_status_report_001"
    name: "插座状态集群上报"
    description: "组网版插座状态集群上报，包含双插孔状态"
    type: "uplink"
    
    input:
      hex_frame: "fcfe0091100000000000018223121400270004010110170a01020000000000000000090103822312140027006501940301040104013effff030107250301961e28015b030108000301098004010a000004019508e304010b000004010c000104010d000004010e000028015b030108010301098004010a000004019508e304010b000004010c000104010d000004010e000030fcee"
      scenario: "socket_status_report"
      context:
        socket_count: 1
        port_count: 2
        
    expected:
      command: 0x1000
      direction: 0x01
      gateway_id: "82231214002700"
      frame_type: "bkv_status_report"
      valid: true
      
    assertions:
      - field: "header"
        type: "equals"
        value: 0xfcfe
        message: "上行帧头必须为0xfcfe"
        required: true
        
      - field: "command"
        type: "equals"
        value: 0x1000
        message: "BKV命令必须为0x1000"
        required: true
        
      - field: "direction"
        type: "equals"
        value: 0x01
        message: "上行帧方向必须为0x01"
        required: true
        
      - field: "gateway_id"
        type: "equals"
        value: "82231214002700"
        message: "网关ID必须正确"
        required: true
        
      - field: "checksum_valid"
        type: "equals"
        value: true
        message: "校验和必须正确"
        required: true

    bkv_assertions:
      - field: "bkv_command"
        type: "equals"
        value: 0x1017
        message: "BKV状态上报命令必须为0x1017"
        
      - field: "socket_no"
        type: "equals"
        value: 1
        message: "插座序号必须正确"

    metadata:
      protocol_version: "1.7"
      bkv_protocol: true
      socket_type: "dual_port"
      
  - id: "socket_status_response_001"
    name: "平台状态上报应答"
    description: "平台对插座状态上报的应答"
    type: "downlink"
    
    input:
      hex_frame: "fcff002f100000000000008223121400270004010110170a01020000000000000000090103822312140027000301017efcee"
      scenario: "status_ack"
      
    expected:
      command: 0x1000
      direction: 0x00
      gateway_id: "82231214002700"
      frame_type: "bkv_status_response"
      valid: true
      
    assertions:
      - field: "header"
        type: "equals"
        value: 0xfcff
        message: "下行帧头必须为0xfcff"
        required: true
        
      - field: "direction"
        type: "equals"
        value: 0x00
        message: "下行帧方向必须为0x00"
        required: true

    bkv_assertions:
      - field: "ack_status"
        type: "equals"
        value: 1
        message: "应答状态必须为OK(1)"

    metadata:
      protocol_version: "1.7"
      bkv_protocol: true
      response_type: "ack"