# IoT协议验证测试体系

严格按照《设备对接指引-组网设备2024(1).txt》构建的独立协议验证测试体系。

## 项目特性

- **100% 协议覆盖**：涵盖所有31个协议场景（心跳、状态上报、查询、组网、充电全生命周期、刷卡、参数设置、异常事件、OTA、校验和、序列号、错误边界值等）
- **分模块数据驱动测试**：用例数据以YAML/JSON格式管理，帧以Hex格式存储
- **最小行为模拟器**：仅当需要验证真实时间/并发/连接行为时使用
- **完全解耦设计**：独立项目，可随时删除，不依赖服务端代码
- **全面验证能力**：断言帧结构、字段语义、业务号一致性、金额/功率计算、ACK行为、错误容错

## 输出产物

1. **测试源码**：完整的Go测试框架
2. **场景脚本**：31个协议场景的测试脚本
3. **覆盖矩阵**：HTML格式的覆盖度报告
4. **失败帧解析报告**：详细的错误分析和修复建议

## 项目结构

```
protocol-validation-test/
├── README.md
├── go.mod
├── go.sum
├── cmd/                     # 命令行工具
│   ├── test-runner/         # 测试运行器
│   ├── coverage-reporter/   # 覆盖度报告生成器
│   └── frame-analyzer/      # 失败帧解析器
├── internal/                # 核心实现
│   ├── parser/             # 协议解析器
│   ├── validator/          # 验证引擎
│   ├── simulator/          # 最小行为模拟器
│   └── coverage/           # 覆盖度追踪
├── testdata/               # 测试数据
│   ├── scenarios/          # 31个场景的测试数据
│   │   ├── basic/         # 基础场景YAML
│   │   ├── advanced/      # 进阶场景YAML
│   │   └── edge-cases/    # 边界和错误测试
│   └── frames/            # 协议帧Hex数据
├── reports/               # 输出报告
│   ├── coverage-matrix.html
│   ├── failed-frames.json
│   └── test-results.xml
└── scripts/              # 辅助脚本
    ├── generate-testdata.sh
    └── run-all-tests.sh
```

## 31个协议场景覆盖清单

### 基础场景 (9个)
1. 心跳上报/回复
2. 服务器下发数据/模块上报数据  
3. 插座状态上报
4. 查询插座状态
5. 下发网络节点列表-刷新列表
6. 下发网络节点列表-添加单个插座
7. 下发网络节点列表-删除单个插座
8. 控制设备按时/按电量充电
9. 充电结束上报按时/按电量

### 进阶场景 (10个)
10. 按功率下发充电命令
11. 按功率充电结束上报
12. 刷卡充电(在线卡)
13. 刷卡查询余额
14. 设置设备允许语音播报的时间
15. 插座系统参数设置
16. 插座系统参数查询
17. 异常事件上报
18. OTA升级
19. 按电费+服务费充电

### 验证场景 (12个)
20. 校验和正确验证
21. 校验和错误验证
22. 序列号一致性验证
23. 帧长度验证
24. 包头包尾验证
25. 网关ID验证
26. 业务号一致性验证
27. ACK行为验证
28. 错误帧测试 (坏帧1)
29. 错误帧测试 (坏帧2)
30. 未知命令测试
31. 边界值测试

## 快速开始

```bash
# 运行所有测试
./scripts/run-all-tests.sh

# 生成覆盖矩阵报告
go run ./cmd/coverage-reporter

# 分析失败帧
go run ./cmd/frame-analyzer --frame "fcfe002e..."

# 运行特定场景
go run ./cmd/test-runner --scenario heartbeat
```

## 开发阶段

- [x] 阶段1：创建独立项目结构 
- [ ] 阶段2：实现核心协议解析和验证框架
- [ ] 阶段3：构建数据驱动测试用例  
- [ ] 阶段4：实现31个协议场景完整覆盖
- [ ] 阶段5：添加最小行为模拟器
- [ ] 阶段6：生成覆盖矩阵和失败帧解析报告

## 技术栈

- **Go 1.25+**：核心开发语言
- **YAML/JSON**：测试数据格式
- **HTML/CSS**：报告生成
- **标准库**：最小化外部依赖

## 许可证

本项目独立于IoT服务端，可随时删除或迁移。