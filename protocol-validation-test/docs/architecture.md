# IoT协议验证测试体系架构设计

## 项目概述

严格按照《设备对接指引-组网设备2024(1).txt》构建的独立协议验证测试体系，实现100%协议场景覆盖，完全与服务端解耦。

## 设计原则

1. **完全独立**：独立项目，可随时删除，不依赖服务端代码
2. **数据驱动**：优先采用分模块数据驱动测试，用例数据以YAML/JSON格式管理
3. **最小模拟**：仅当需要验证真实时间/并发/连接行为时，使用最小行为模拟器
4. **全面覆盖**：100%覆盖31个协议场景，包含所有指令与场景
5. **严格验证**：断言帧结构、字段语义、业务号一致性、金额/功率计算、ACK行为、错误容错

## 架构组件

### 1. 协议解析层 (`internal/parser/`)

#### 接口设计
- `FrameParser`: 协议帧解析器接口
- `TLVParser`: TLV结构解析器接口  
- `BKVParser`: BKV协议解析器接口

#### 核心功能
- 帧格式解析和验证
- 校验和计算和验证
- TLV结构解析
- BKV协议载荷解析
- 错误处理和诊断

### 2. 验证引擎 (`internal/validator/`)

#### 组件结构
```
validator/
├── engine.go      # 验证引擎核心
├── loader.go      # 测试用例加载器
├── assertions.go  # 断言处理器
└── errors.go      # 错误处理器
```

#### 功能特性
- 数据驱动的测试用例加载
- 灵活的断言系统
- 详细的错误报告
- 性能监控

### 3. 覆盖度追踪 (`internal/coverage/`)

#### 追踪维度
- **场景覆盖**: 31个协议场景的覆盖情况
- **命令覆盖**: 各种协议命令的测试覆盖
- **帧类型覆盖**: 不同帧类型的验证覆盖
- **字段覆盖**: 协议字段的验证覆盖

#### 报告格式
- JSON格式的机器可读报告
- HTML格式的人类友好报告
- 实时覆盖度统计

### 4. 最小行为模拟器 (`internal/simulator/`)

#### 模拟能力
- 时间模拟（支持时间加速）
- 并发连接模拟
- 网络异常模拟
- 错误注入

#### 设计约束
- 仅包含最小连接/调度/错误注入能力
- 不做真实物理仿真
- 重点在协议层面的行为验证

### 5. 命令行工具 (`cmd/`)

#### 工具集合
- `test-runner`: 测试运行器
- `coverage-reporter`: 覆盖度报告生成器
- `frame-analyzer`: 失败帧解析器

## 31个协议场景覆盖

### 基础场景 (9个)
1. **心跳上报/回复**: 验证设备与平台的心跳机制
2. **服务器下发数据/模块上报数据**: 验证数据双向通信
3. **插座状态上报**: 验证状态主动上报机制
4. **查询插座状态**: 验证状态查询响应
5. **下发网络节点列表-刷新列表**: 验证组网列表刷新
6. **下发网络节点列表-添加单个插座**: 验证单插座添加
7. **下发网络节点列表-删除单个插座**: 验证单插座删除
8. **控制设备按时/按电量充电**: 验证基础充电控制
9. **充电结束上报按时/按电量**: 验证基础充电结束

### 进阶场景 (10个)
10. **按功率下发充电命令**: 验证分功率计费模式
11. **按功率充电结束上报**: 验证功率充电结算
12. **刷卡充电(在线卡)**: 验证刷卡充电流程
13. **刷卡查询余额**: 验证余额查询机制
14. **设置设备允许语音播报的时间**: 验证语音控制
15. **插座系统参数设置**: 验证参数配置
16. **插座系统参数查询**: 验证参数查询
17. **异常事件上报**: 验证异常处理
18. **OTA升级**: 验证固件升级流程
19. **按电费+服务费充电**: 验证复合计费模式

### 验证场景 (12个)
20. **校验和正确验证**: 验证正确校验和处理
21. **校验和错误验证**: 验证错误校验和容错
22. **序列号一致性验证**: 验证序列号规则
23. **帧长度验证**: 验证帧长度规则
24. **包头包尾验证**: 验证帧边界标识
25. **网关ID验证**: 验证网关ID格式和一致性
26. **业务号一致性验证**: 验证业务号匹配
27. **ACK行为验证**: 验证应答机制
28. **错误帧测试(坏帧1)**: 测试错误帧处理能力
29. **错误帧测试(坏帧2)**: 测试另一种错误帧
30. **未知命令测试**: 测试未知命令处理
31. **边界值测试**: 测试数值边界处理

## 数据格式规范

### 测试用例格式 (YAML)
```yaml
name: "场景名称"
category: "basic|advanced|validation" 
scenarios:
  - id: "unique_id"
    input:
      hex_frame: "协议帧十六进制数据"
    expected:
      command: 0x0000
      direction: 0x01
      valid: true
    assertions:
      - field: "字段名"
        type: "equals|range|pattern|valid"
        value: "期望值"
```

### 覆盖矩阵格式 (JSON)
```json
{
  "version": "1.0",
  "scenarios": {...},
  "commands": {...},
  "frame_types": {...},
  "summary": {
    "scenario_coverage": 1.0,
    "test_pass_rate": 0.95
  }
}
```

## 开发阶段

### 阶段1: 项目结构创建 ✅
- [x] 独立项目目录结构
- [x] Go模块初始化
- [x] 基础接口定义
- [x] 命令行工具框架
- [x] 文档和脚本

### 阶段2: 核心框架实现
- [ ] 协议帧解析器
- [ ] TLV解析器
- [ ] 校验和验证
- [ ] 验证引擎核心

### 阶段3: 数据驱动测试
- [ ] YAML测试用例格式
- [ ] 测试用例加载器
- [ ] 断言引擎
- [ ] 基础场景测试数据

### 阶段4: 完整场景覆盖
- [ ] 31个场景的完整测试数据
- [ ] 复杂场景解析
- [ ] 边界值和错误测试
- [ ] 负例测试(2个坏帧+1个未知命令)

### 阶段5: 最小行为模拟器
- [ ] 时间/并发/连接模拟
- [ ] 事件调度器
- [ ] 错误注入机制
- [ ] 超时重试测试

### 阶段6: 报告系统
- [ ] 覆盖矩阵HTML报告
- [ ] 失败帧解析报告
- [ ] 测试运行器完善
- [ ] 完整文档

## 质量保证

### 测试策略
- 单元测试覆盖核心组件
- 集成测试验证端到端流程
- 性能测试确保解析效率
- 压力测试验证并发能力

### 错误处理
- 详细的错误分类和定位
- 可读的错误消息和修复建议
- 失败帧的自动分析和报告
- 容错机制确保测试继续

### 性能指标
- 帧解析时间 < 1ms
- 内存使用 < 1MB
- 支持100并发测试
- 报告生成时间 < 5s

## 部署和使用

### 快速开始
```bash
# 克隆项目
git clone protocol-validation-test
cd protocol-validation-test

# 运行所有测试
./scripts/run-all-tests.sh

# 生成报告
go run ./cmd/coverage-reporter
```

### 持续集成
- 支持CI/CD流水线集成
- 自动化测试执行
- 覆盖度趋势跟踪
- 回归测试检测

## 项目维护

### 版本管理
- 语义化版本号
- 变更日志维护
- 向后兼容性保证
- 迁移指南提供

### 文档维护
- API文档自动生成
- 示例代码更新
- 最佳实践指导
- 故障排除指南