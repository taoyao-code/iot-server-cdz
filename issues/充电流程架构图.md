# 充电流程架构图与协议交互图

## 🏗️ 整体系统架构

```mermaid
graph TB
    subgraph "用户层"
        A[用户APP] --> B[扫码充电]
        A --> C[刷卡充电]
    end
    
    subgraph "平台层"
        D[API网关] --> E[充电服务]
        E --> F[订单管理]
        E --> G[设备管理]
        F --> H[计费系统]
    end
    
    subgraph "协议层"
        I[TCP服务器] --> J[协议解析器]
        J --> K[BKV协议处理器]
        K --> L[命令路由器]
    end
    
    subgraph "数据层"
        M[PostgreSQL] --> N[订单表]
        M --> O[设备表]
        M --> P[端口表]
        Q[Redis] --> R[会话缓存]
        Q --> S[状态缓存]
    end
    
    subgraph "设备层"
        T[网关设备] --> U[插座设备]
        U --> V[计量模块]
        U --> W[控制模块]
    end
    
    A --> D
    E --> I
    L --> M
    L --> Q
    I --> T
    T --> U
```

## ⚡ 完整充电流程时序图

### 正常充电流程
```mermaid
sequenceDiagram
    participant User
    participant Platform
    participant Protocol
    participant Device
    participant Database
    
    User->>Platform: 发起充电请求
    Platform->>Database: 创建预订单
    Platform->>Protocol: 构建充电命令
    Protocol->>Device: 下发cmd 0x0015(控制设备)
    Device-->>Protocol: 返回ACK确认
    Protocol->>Database: 更新订单为充电中
    Protocol->>Platform: 返回充电开始成功
    
    loop 每5分钟
        Device->>Protocol: 上报cmd 0x1000(状态)
        Protocol->>Database: 更新端口状态
        Protocol->>Platform: 推送进度事件
    end
    
    Device->>Device: 检测到充电完成
    Device->>Protocol: 上报cmd 0x0015(结束)
    Protocol->>Database: 查询对应订单
    Protocol->>Database: 更新订单完成
    Protocol->>Database: 重置端口状态
    Protocol-->>Device: 发送确认回复
    Protocol->>Platform: 推送充电结束
    Platform->>Platform: 进行计费结算
    Platform->>User: 通知充电完成
```

### 异常处理流程
```mermaid
sequenceDiagram
    participant Device
    participant Protocol
    participant Platform
    participant Database
    
    Device->>Device: 检测到异常
    Device->>Protocol: 上报cmd 0x1010(异常事件)
    Protocol->>Database: 记录异常事件
    Protocol->>Platform: 推送异常告警
    Platform->>Database: 查询活跃订单
    
    alt 存在活跃订单
        Platform->>Database: 强制完成订单
        Platform->>Database: 更新异常原因
        Platform->>Platform: 触发退款流程
    else 无活跃订单
        Platform->>Platform: 记录设备异常
    end
    
    Platform-->>Device: 发送异常确认
    Platform->>Platform: 通知运维处理
```

## 🔧 协议数据流图

### BKV协议帧处理流程
```mermaid
graph LR
    A[原始TCP数据] --> B[帧解析器]
    B --> C{验证帧格式}
    C -->|有效| D[命令路由器]
    C -->|无效| E[错误日志]
    
    D --> F{命令类型}
    F -->|0x0000| G[心跳处理器]
    F -->|0x0015| H[控制命令处理器]
    F -->|0x1000| I[状态上报处理器]
    F -->|0x1010| J[异常事件处理器]
    
    G --> K[更新设备在线状态]
    H --> L[处理充电控制]
    I --> M[更新端口状态]
    J --> N[处理异常事件]
    
    K --> O[数据库更新]
    L --> O
    M --> O
    N --> O
    O --> P[事件推送]
```

### 充电命令详细流程
```mermaid
sequenceDiagram
    participant API
    participant Service
    participant Protocol
    participant Device
    participant DB
    
    API->>Service: StartCharging(request)
    Service->>DB: GetDeviceInfo(device_id)
    Service->>Service: ValidateParameters()
    Service->>DB: CreatePreOrder()
    Service->>Protocol: BuildControlCommand()
    
    Protocol->>Protocol: EncodeBKVFrame()
    Protocol->>Device: Send cmd 0x0015
    
    alt 设备响应成功
        Device-->>Protocol: ACK with result=1
        Protocol->>Protocol: ParseACK()
        Protocol->>DB: UpdateOrderStatus(charging)
        Protocol->>Service: Return success
    else 设备响应失败
        Device-->>Protocol: ACK with result=0
        Protocol->>DB: DeletePreOrder()
        Protocol->>Service: Return failure
    end
    
    Service->>API: Return result
```

## 📊 数据状态转换图

### 订单状态机
```mermaid
stateDiagram-v2
    [*] --> Pending: 创建预订单
    Pending --> Charging: 设备ACK成功
    Pending --> Failed: 设备ACK失败/参数错误
    
    Charging --> Stopping: 用户停止/异常停止
    Charging --> Completed: 正常充电结束
    Charging --> Interrupted: 设备离线/异常
    
    Stopping --> Completed: 停止成功
    Stopping --> Failed: 停止失败
    
    Interrupted --> Charging: 设备恢复
    Interrupted --> Failed: 超时/无法恢复
    
    Completed --> [*]
    Failed --> [*]
```

### 端口状态转换
```mermaid
stateDiagram-v2
    [*] --> Idle: 初始化
    Idle --> Charging: 开始充电命令
    Charging --> Idle: 充电结束/异常停止
    
    Idle --> Fault: 设备异常
    Fault --> Idle: 异常恢复
    
    Charging --> Fault: 充电异常
    Fault --> Charging: 故障恢复后重新开始
```

## 🔍 协议字段详细解析图

### 控制命令帧结构 (cmd 0x0015)
```mermaid
graph TD
    A[fcff001c0015001c9a5100860044594530050008070200010100f00000c8fcee]
    
    A --> B[fcff: 包头]
    A --> C[001c: 长度 28]
    A --> D[0015: 命令]
    A --> E[001c9a51: 帧流水号]
    A --> F[00: 包类型]
    A --> G[86004459453005: 网关ID]
    A --> H[0008070200010100f00000: 数据段]
    A --> I[c8: 校验和]
    A --> J[fcee: 包尾]
    
    H --> K[0008: 数据长度 8]
    H --> L[07: 子命令]
    H --> M[02: 插座号]
    H --> N[00: 插孔号]
    H --> O[01: 开关状态]
    H --> P[01: 充电模式]
    H --> Q[00f0: 充电时长]
    H --> R[0000: 充电电量]
```

### 状态上报帧结构 (cmd 0x1000 BKV)
```mermaid
graph TD
    A[fcfe00911000000000000182231214002700...]
    
    A --> B[fcfe: 包头]
    A --> C[0091: 长度 145]
    A --> D[1000: 命令]
    A --> E[00000000: 帧流水号]
    A --> F[01: 包类型]
    A --> G[82231214002700: 网关ID]
    A --> H[BKV数据段]
    A --> I[30: 校验和]
    A --> J[fcee: 包尾]
    
    H --> K[0401011017...: BKV编码数据]
    K --> L[0x04: Tag=设备类型]
    K --> M[0x01: Length=1]
    K --> N[0x01: Value=插座]
    K --> O[0x10: Tag=命令]
    K --> P[0x17: Value=状态上报]
    K --> Q[0x0A: Tag=帧序列号]
    K --> R[0x20...: Value=序列号]
```

## ⚠️ 错误处理流程图

### 协议错误处理
```mermaid
graph TD
    A[接收协议帧] --> B{帧格式验证}
    B -->|无效| C[记录错误日志]
    B -->|有效| D{命令字验证}
    
    D -->|未知命令| E[记录未知命令]
    D -->|已知命令| F{数据长度验证}
    
    F -->|长度错误| G[记录长度错误]
    F -->|长度正确| H{校验和验证}
    
    H -->|校验失败| I[记录校验错误]
    H -->|校验成功| J[处理命令]
    
    J --> K{处理结果}
    K -->|成功| L[正常响应]
    K -->|失败| M[错误响应]
    
    C --> N[发送错误统计]
    E --> N
    G --> N
    I --> N
    M --> N
```

### 业务错误处理
```mermaid
graph TD
    A[充电请求] --> B{参数验证}
    B -->|失败| C[返回参数错误]
    
    B -->|成功| D{设备状态检查}
    D -->|离线| E[返回设备离线]
    D -->|在线| F{端口状态检查}
    
    F -->|占用| G[返回端口占用]
    F -->|空闲| H{创建订单}
    
    H -->|失败| I[返回系统错误]
    H -->|成功| J{下发命令}
    
    J -->|超时| K[返回超时错误]
    J -->|失败| L[返回设备错误]
    J -->|成功| M{ACK验证}
    
    M -->|失败| N[取消订单]
    M -->|成功| O[更新订单状态]
    
    C --> P[记录用户错误]
    E --> P
    G --> P
    I --> P
    K --> P
    L --> P
    N --> P
```

## 📈 性能监控指标图

### 关键性能指标
```mermaid
graph LR
    A[协议性能] --> B[帧处理延迟 <100ms]
    A --> C[命令成功率 >99%]
    A --> D[状态上报完整率 >95%]
    
    E[业务性能] --> F[订单完成率 >98%]
    E --> G[平均充电时长 30-240min]
    E --> H[异常订单比例 <2%]
    
    I[系统性能] --> J[数据库响应 <50ms]
    I --> K[Redis缓存命中率 >90%]
    I --> L[TCP连接稳定性 >99.9%]
    
    M[设备性能] --> N[设备在线率 >95%]
    M --> O[心跳丢失率 <1%]
    M --> P[协议合规率 >98%]
```

## 🔐 安全验证流程

### 数据完整性验证
```mermaid
sequenceDiagram
    participant Sender
    participant Protocol
    participant Receiver
    
    Sender->>Protocol: 构建协议帧
    Protocol->>Protocol: 计算校验和
    Protocol->>Protocol: 添加校验字节
    Sender->>Receiver: 发送完整帧
    
    Receiver->>Protocol: 接收帧数据
    Protocol->>Protocol: 提取校验和
    Protocol->>Protocol: 重新计算校验
    Protocol->>Protocol: 对比校验结果
    
    alt 校验通过
        Protocol->>Receiver: 处理有效帧
    else 校验失败
        Protocol->>Receiver: 丢弃错误帧
        Receiver->>Receiver: 记录校验错误
    end
```

### 业务数据验证
```mermaid
graph TD
    A[接收业务数据] --> B{数据类型验证}
    B -->|无效| C[返回类型错误]
    
    B -->|有效| D{数据范围验证}
    D -->|超出范围| E[返回范围错误]
    
    D -->|范围内| F{业务逻辑验证}
    F -->|逻辑错误| G[返回逻辑错误]
    
    F -->|逻辑正确| H{一致性验证}
    H -->|不一致| I[返回一致性错误]
    
    H -->|一致| J[验证通过]
    
    C --> K[记录验证失败]
    E --> K
    G --> K
    I --> K
    J --> L[处理业务数据]
```

这些架构图和流程图提供了充电流程的全方位可视化展示，包括：
- 系统整体架构和组件关系
- 详细的协议交互时序
- 数据状态转换逻辑
- 协议字段结构解析
- 错误处理流程
- 性能监控指标
- 安全验证机制

这些图表可以直接用于技术文档、培训材料和系统监控dashboard中。