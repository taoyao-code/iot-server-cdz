# é˜¶æ®µ1è¯¦ç»†å®æ–½è®¡åˆ’ - æ ¸å¿ƒä¸šåŠ¡å±‚

**æ—¶é—´èŒƒå›´**: 6-8å‘¨  
**ä¼˜å…ˆçº§**: P0 (å¿…é¡»å®Œæˆ)  
**ç›®æ ‡**: æ„å»ºå®Œæ•´çš„ç”¨æˆ·ç®¡ç†å’Œå……ç”µä¸šåŠ¡æµç¨‹

## ğŸ¯ é˜¶æ®µç›®æ ‡

å®Œæˆæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œä½¿ç³»ç»Ÿæ”¯æŒï¼š
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç†
- å®Œæ•´çš„å……ç”µä¸šåŠ¡æµç¨‹(ä¸‹å•â†’å……ç”µâ†’è®¡è´¹â†’æ”¯ä»˜)
- åŸºç¡€çš„ç«™ç‚¹å’Œè®¾å¤‡ç®¡ç†
- ä¸ºåç»­é˜¶æ®µå¥ å®šåšå®åŸºç¡€

## ğŸ“‹ è¯¦ç»†ä»»åŠ¡æ¸…å•

### Week 1-2: ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

#### ğŸ” è®¤è¯æˆæƒç³»ç»Ÿ
- [ ] **æ•°æ®åº“è®¾è®¡**
  ```sql
  -- åœ¨ db/migrations/ æ–°å¢è¿ç§»æ–‡ä»¶
  users(id, username, phone, email, password_hash, status, created_at, updated_at)
  roles(id, name, description, permissions, created_at)
  user_roles(user_id, role_id, created_at)
  organizations(id, name, parent_id, type, address, created_at)
  user_orgs(user_id, org_id, role, created_at)
  ```

- [ ] **JWTè®¤è¯ä¸­é—´ä»¶**
  ```go
  // internal/auth/jwt.go
  - JWT tokenç”Ÿæˆå’ŒéªŒè¯
  - åˆ·æ–°tokenæœºåˆ¶
  - é»‘åå•ç®¡ç†
  ```

- [ ] **RBACæƒé™ç³»ç»Ÿ**
  ```go
  // internal/auth/rbac.go
  - åŸºäºCasbinçš„æƒé™æ¨¡å‹
  - åŠ¨æ€æƒé™æ£€æŸ¥ä¸­é—´ä»¶
  - æƒé™ç¼“å­˜ç­–ç•¥
  ```

#### ğŸ“± ç”¨æˆ·ç®¡ç†API
- [ ] **ç”¨æˆ·æ³¨å†Œç™»å½•**
  ```go
  POST /api/v1/auth/register
  POST /api/v1/auth/login
  POST /api/v1/auth/refresh
  POST /api/v1/auth/logout
  ```

- [ ] **ç”¨æˆ·ä¿¡æ¯ç®¡ç†**
  ```go
  GET /api/v1/users/profile
  PUT /api/v1/users/profile
  GET /api/v1/users (ç®¡ç†å‘˜)
  POST /api/v1/users (ç®¡ç†å‘˜)
  ```

- [ ] **ç»„ç»‡æ¶æ„ç®¡ç†**
  ```go
  GET /api/v1/organizations
  POST /api/v1/organizations
  PUT /api/v1/organizations/{id}
  DELETE /api/v1/organizations/{id}
  ```

**Week 1-2 äº¤ä»˜ç‰©**:
- å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç³»ç»Ÿ
- ç”¨æˆ·ç®¡ç†ç›¸å…³API
- ç»„ç»‡æ¶æ„ç®¡ç†åŠŸèƒ½
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

### Week 3-4: å……ç”µä¸šåŠ¡ç®¡ç†

#### ğŸ’³ å……ç”µè®¢å•ç³»ç»Ÿ
- [ ] **æ‰©å±•è®¢å•æ•°æ®æ¨¡å‹**
  ```sql
  -- æ‰©å±•ç°æœ‰ orders è¡¨
  ALTER TABLE orders ADD COLUMN user_id BIGINT;
  ALTER TABLE orders ADD COLUMN pricing_strategy_id BIGINT;
  ALTER TABLE orders ADD COLUMN estimated_amount_cent BIGINT;
  ALTER TABLE orders ADD COLUMN actual_amount_cent BIGINT;
  
  -- æ–°å¢è¡¨
  pricing_strategies(id, org_id, name, rules_json, effective_from, effective_to)
  charging_sessions(id, order_id, start_time, end_time, total_kwh, total_cost_cent)
  ```

- [ ] **è®¡è´¹å¼•æ“**
  ```go
  // internal/billing/engine.go
  - æŒ‰æ—¶é—´è®¡è´¹
  - æŒ‰ç”µé‡è®¡è´¹  
  - é˜¶æ¢¯è®¡è´¹
  - å³°è°·ç”µä»·
  ```

#### ğŸ”Œ å……ç”µæ§åˆ¶API
- [ ] **å……ç”µæµç¨‹API**
  ```go
  POST /api/v1/charging/sessions    // åˆ›å»ºå……ç”µè®¢å•
  POST /api/v1/charging/start       // å¯åŠ¨å……ç”µ
  POST /api/v1/charging/stop        // åœæ­¢å……ç”µ  
  GET /api/v1/charging/status/{sessionId} // æŸ¥è¯¢çŠ¶æ€
  ```

- [ ] **é›†æˆç°æœ‰è®¾å¤‡æ§åˆ¶**
  ```go
  // æ‰©å±• internal/protocol/ çš„å¤„ç†å™¨
  - å¢åŠ ä¸šåŠ¡å±‚è°ƒç”¨æ¥å£
  - è®¢å•çŠ¶æ€ä¸è®¾å¤‡çŠ¶æ€åŒæ­¥
  - å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
  ```

#### ğŸ’° æ”¯ä»˜é›†æˆ
- [ ] **æ”¯ä»˜æŠ½è±¡å±‚**
  ```go
  // internal/payment/interface.go
  type PaymentProvider interface {
      CreateOrder(amount, orderNo) (*PaymentOrder, error)
      QueryStatus(orderNo) (*PaymentStatus, error)
      Refund(orderNo, amount) (*RefundResult, error)
  }
  ```

- [ ] **å¾®ä¿¡æ”¯ä»˜é›†æˆ**
  ```go
  // internal/payment/wechat.go
  - ç»Ÿä¸€ä¸‹å•
  - æ”¯ä»˜å›è°ƒå¤„ç†
  - è®¢å•æŸ¥è¯¢å’Œé€€æ¬¾
  ```

- [ ] **æ”¯ä»˜API**
  ```go
  POST /api/v1/payments/create      // åˆ›å»ºæ”¯ä»˜è®¢å•
  POST /api/v1/payments/callback    // æ”¯ä»˜å›è°ƒ
  GET /api/v1/payments/status/{orderNo} // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
  ```

**Week 3-4 äº¤ä»˜ç‰©**:
- å®Œæ•´çš„å……ç”µè®¢å•å’Œè®¡è´¹ç³»ç»Ÿ
- å……ç”µæ§åˆ¶API
- å¾®ä¿¡æ”¯ä»˜é›†æˆ
- ç«¯åˆ°ç«¯å……ç”µæµç¨‹æµ‹è¯•é€šè¿‡

### Week 5-6: ç«™ç‚¹è®¾å¤‡ç®¡ç†

#### ğŸ¢ ç«™ç‚¹ç®¡ç†ç³»ç»Ÿ
- [ ] **ç«™ç‚¹æ•°æ®æ¨¡å‹**
  ```sql
  stations(id, org_id, name, address, location_lat, location_lng, status, created_at)
  station_devices(id, station_id, device_id, position, status, created_at)
  ```

- [ ] **ç«™ç‚¹ç®¡ç†API**
  ```go
  GET /api/v1/stations
  POST /api/v1/stations
  PUT /api/v1/stations/{id}
  DELETE /api/v1/stations/{id}
  GET /api/v1/stations/{id}/devices
  ```

#### âš™ï¸ è®¾å¤‡é…ç½®ç®¡ç†
- [ ] **æ‰©å±•ç°æœ‰è®¾å¤‡API**
  ```go
  // æ‰©å±• internal/api/routes.go
  PUT /api/v1/devices/{phyId}/config    // è®¾å¤‡å‚æ•°é…ç½®
  POST /api/v1/devices/{phyId}/reboot   // è¿œç¨‹é‡å¯
  POST /api/v1/devices/{phyId}/upgrade  // è§¦å‘å‡çº§
  GET /api/v1/devices/{phyId}/logs      // è®¾å¤‡æ—¥å¿—æŸ¥è¯¢
  ```

- [ ] **æ‰¹é‡æ“ä½œæ”¯æŒ**
  ```go
  POST /api/v1/devices/batch/config     // æ‰¹é‡é…ç½®
  POST /api/v1/devices/batch/reboot     // æ‰¹é‡é‡å¯
  GET /api/v1/devices/batch/status      // æ‰¹é‡çŠ¶æ€æŸ¥è¯¢
  ```

#### ğŸ“Š åŸºç¡€ç›‘æ§ç•Œé¢
- [ ] **è®¾å¤‡çŠ¶æ€èšåˆAPI**
  ```go
  GET /api/v1/dashboard/overview        // æ€»è§ˆæ•°æ®
  GET /api/v1/dashboard/devices/status  // è®¾å¤‡çŠ¶æ€ç»Ÿè®¡
  GET /api/v1/dashboard/stations/status // ç«™ç‚¹çŠ¶æ€ç»Ÿè®¡
  ```

**Week 5-6 äº¤ä»˜ç‰©**:
- ç«™ç‚¹ç®¡ç†åŠŸèƒ½
- è®¾å¤‡é…ç½®å’Œæ‰¹é‡æ“ä½œ
- åŸºç¡€ç›‘æ§API
- ç®¡ç†ç•Œé¢æ•°æ®æ”¯æŒ

### Week 7-8: é›†æˆæµ‹è¯•ä¸ä¼˜åŒ–

#### ğŸ§ª ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] **ä¸šåŠ¡æµç¨‹æµ‹è¯•**
  ```go
  // å®Œæ•´å……ç”µæµç¨‹æµ‹è¯•
  ç”¨æˆ·æ³¨å†Œ â†’ æ‰«ç ä¸‹å• â†’ å¯åŠ¨å……ç”µ â†’ è®¡è´¹ â†’ æ”¯ä»˜ â†’ ç»“æŸ
  ```

- [ ] **å‹åŠ›æµ‹è¯•**
  ```bash
  # å¹¶å‘å……ç”µè®¢å•æµ‹è¯•
  # è®¾å¤‡çŠ¶æ€æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
  # æ”¯ä»˜å›è°ƒå¤„ç†æµ‹è¯•
  ```

#### ğŸ”§ æ€§èƒ½ä¼˜åŒ–
- [ ] **æ•°æ®åº“ä¼˜åŒ–**
  ```sql
  -- æ·»åŠ å¿…è¦ç´¢å¼•
  CREATE INDEX idx_orders_user_status ON orders(user_id, status);
  CREATE INDEX idx_sessions_device_time ON charging_sessions(device_id, start_time);
  ```

- [ ] **ç¼“å­˜ç­–ç•¥**
  ```go
  // Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
  - ç”¨æˆ·æƒé™ä¿¡æ¯
  - è®¾å¤‡çŠ¶æ€
  - è®¡è´¹ç­–ç•¥
  ```

#### ğŸ“š æ–‡æ¡£å®Œå–„
- [ ] **APIæ–‡æ¡£æ›´æ–°**
  ```yaml
  # æ›´æ–° api/openapi/openapi.yaml
  # æ–°å¢æ‰€æœ‰ä¸šåŠ¡APIå®šä¹‰
  ```

- [ ] **éƒ¨ç½²æ–‡æ¡£**
  ```markdown
  # æ›´æ–° README.md
  # æ–°å¢ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜
  # æ•°æ®åº“è¿ç§»æŒ‡å—
  ```

**Week 7-8 äº¤ä»˜ç‰©**:
- å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶
- æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
- å®Œå–„çš„APIæ–‡æ¡£
- éƒ¨ç½²å’Œè¿ç»´æŒ‡å—

## ğŸ› ï¸ æŠ€æœ¯å®æ–½æŒ‡å¯¼

### é¡¹ç›®ç»“æ„æ‰©å±•
```
internal/
â”œâ”€â”€ auth/           # è®¤è¯æˆæƒ
â”‚   â”œâ”€â”€ jwt.go
â”‚   â”œâ”€â”€ rbac.go
â”‚   â””â”€â”€ middleware.go
â”œâ”€â”€ billing/        # è®¡è´¹å¼•æ“
â”‚   â”œâ”€â”€ engine.go
â”‚   â”œâ”€â”€ strategies.go
â”‚   â””â”€â”€ calculator.go
â”œâ”€â”€ payment/        # æ”¯ä»˜ç³»ç»Ÿ
â”‚   â”œâ”€â”€ interface.go
â”‚   â”œâ”€â”€ wechat.go
â”‚   â””â”€â”€ alipay.go
â”œâ”€â”€ business/       # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ charging.go
â”‚   â””â”€â”€ station.go
â””â”€â”€ api/
    â””â”€â”€ v1/         # æ–°ç‰ˆæœ¬API
        â”œâ”€â”€ auth.go
        â”œâ”€â”€ charging.go
        â””â”€â”€ station.go
```

### é…ç½®æ–‡ä»¶æ‰©å±•
```yaml
# configs/config.yaml æ–°å¢
auth:
  jwt_secret: "your-secret-key"
  jwt_expire: 24h
  refresh_expire: 720h

payment:
  wechat:
    app_id: "your-app-id"
    merchant_id: "your-merchant-id"
    api_key: "your-api-key"
  
billing:
  default_strategy_id: 1
  currency: "CNY"
  
cache:
  redis:
    addr: "localhost:6379"
    db: 1
    expire: 3600
```

### æ•°æ®åº“è¿ç§»
```sql
-- db/migrations/002_add_business_tables.up.sql
-- æŒ‰å‘¨æ¬¡åˆ›å»ºè¿ç§»æ–‡ä»¶
-- ä¿æŒå‘åå…¼å®¹æ€§
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ç”¨æˆ·å¯ä»¥æ³¨å†Œã€ç™»å½•å¹¶ç®¡ç†ä¸ªäººä¿¡æ¯
- [ ] æ”¯æŒå®Œæ•´çš„å……ç”µä¸‹å•â†’å¯åŠ¨â†’è®¡è´¹â†’æ”¯ä»˜æµç¨‹
- [ ] ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç«™ç‚¹ã€è®¾å¤‡å’Œç”¨æˆ·æƒé™
- [ ] é›†æˆå¾®ä¿¡æ”¯ä»˜ï¼Œæ”¯æŒæ”¯ä»˜å’Œé€€æ¬¾
- [ ] å…·å¤‡åŸºç¡€çš„ç›‘æ§å’ŒçŠ¶æ€æŸ¥è¯¢åŠŸèƒ½

### æŠ€æœ¯éªŒæ”¶
- [ ] APIå“åº”æ—¶é—´ P95 < 100ms
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼Œå¤æ‚æŸ¥è¯¢ < 50ms
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–ä¸»è¦ä¸šåŠ¡æµç¨‹
- [ ] æ”¯æŒå¹¶å‘100ä¸ªå……ç”µè®¢å•

### ä»£ç è´¨é‡
- [ ] ä»£ç reviewé€šè¿‡ç‡ 100%
- [ ] éµå¾ªé¡¹ç›®ç°æœ‰çš„ç¼–ç è§„èŒƒ
- [ ] å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] APIæ–‡æ¡£å®Œæ•´å¹¶ä¸å®ç°ä¸€è‡´

## ğŸš€ åç»­é˜¶æ®µé¢„è§ˆ

**é˜¶æ®µ2é¢„å‘Š**: æ•°æ®åˆ†æä¸è¿è¥
- å……ç”µæ•°æ®ç»Ÿè®¡å’Œå¯è§†åŒ–
- è®¾å¤‡å¥åº·ç›‘æ§å’Œå‘Šè­¦
- æ”¶ç›Šåˆ†æå’Œè¿è¥æŠ¥è¡¨

**é˜¶æ®µ3é¢„å‘Š**: ç”¨æˆ·ç•Œé¢
- Webç®¡ç†åå°å¼€å‘
- ç§»åŠ¨ç«¯ç”¨æˆ·APIä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒå®Œå–„

---

**å‡†å¤‡å¼€å§‹**: ç¡®è®¤è®¡åˆ’åå³å¯å¯åŠ¨ç”¨æˆ·ç®¡ç†ç³»ç»Ÿå¼€å‘