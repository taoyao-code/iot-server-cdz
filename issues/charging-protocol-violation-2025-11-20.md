# 充电协议违规问题记录

## 问题编号
CHARGING-PROTOCOL-VIOLATION-2025-11-20

## 问题等级
🔴 **严重** - 影响计费准确性和用户体验

## 发现时间
2025-11-20 21:10-21:17 (7分钟充电过程)

## 问题描述
设备在充电完成时**未发送充电结束报告**（cmd 0x0015, data_len=20），违反BKV协议规范，导致订单永久卡在"充电中"状态。

## 影响范围
- 设备型号: 组网版充电设备
- 物理ID: 82241218000382
- 订单号: THD1763644106000
- 端口: 0号端口

## 协议违规详情

### 预期行为 (根据《设备对接指引-组网设备2024》)
```
1. ✅ 心跳上报 (cmd 0x0000) - 每60秒正常
2. ❓ 开始充电命令 - 日志中未显示
3. ❌ 充电状态报告 (cmd 0x1000) - 完全缺失
4. ❌ 充电结束报告 (cmd 0x0015, data_len=20) - 完全缺失
5. ❌ 平台确认回复 - 因缺失而无法发送
```

### 实际行为
```
仅收到: 心跳消息 (cmd 0x0000, data_len=29)
缺失: 所有充电相关协议消息
结果: 订单status=2永久卡住，无结束时间
```

## 数据库证据

### 订单状态异常
```sql
-- 订单永久卡在充电状态
SELECT order_no, status, start_time, end_time 
FROM orders 
WHERE order_no = 'THD1763644106000';

结果:
order_no: THD1763644106000
status: 2 (充电中)
start_time: 2025-11-20 13:08:27
end_time: NULL (缺失)
```

### 端口状态异常
```sql
-- 端口充电位仍然设置
SELECT port_no, status FROM ports WHERE device_id = 5212;

结果:
port_no: 0, status: 129 (二进制10000001，充电位设置)
```

### Events系统失效
```sql
-- Events表完全为空
SELECT COUNT(*) FROM events;
结果: 0 (系统未记录任何事件)
```

## 心跳数据证据

### 正常心跳 (每60秒)
```
Hex: 38393836303835353130323444313938383139363230302e312e313717
解码: 898608551024D1988196200.1.17
分析: ICCID和版本信息正常，设备在线
```

## 根本原因

### 主要问题
1. **设备固件缺陷** - 未实现充电结束协议
2. **BVK协议不完整** - 缺少充电过程状态上报
3. **状态同步失败** - 设备与系统状态不一致

### 次要问题
1. **Events系统未工作** - 事件记录完全缺失
2. **无超时保护** - 订单可永久卡住
3. **协议监控不足** - 缺少协议完整性检查

## 业务影响

| 影响类型 | 严重程度 | 说明 |
|---------|---------|------|
| 计费准确性 | 🔴 高 | 无法获取用电量数据 |
| 用户体验 | 🔴 高 | 订单无法完成，用户困惑 |
| 数据完整性 | 🟡 中 | 充电过程数据完全缺失 |
| 系统可靠性 | 🟡 中 | 协议违规影响稳定性 |

## 修复状态

### 立即修复 (0-1天)
- [ ] 联系设备制造商更新固件
- [ ] 添加订单超时自动完成机制
- [ ] 修复Events系统数据记录

### 短期修复 (1-7天)
- [ ] 增强BVK协议日志记录
- [ ] 添加协议健康检查
- [ ] 实现状态一致性检查

### 长期改进 (7-30天)
- [ ] 建立协议兼容性测试
- [ ] 添加实时监控告警
- [ ] 实现自动恢复机制

## 验证测试

### 测试场景
1. 启动7分钟充电流程
2. 监控协议消息类型
3. 验证订单状态转换
4. 检查数据完整性

### 期望结果
- 收到cmd 0x0015充电结束报告
- 订单状态从2→7正确转换
- Events表记录相关事件
- 端口状态正确重置

## 相关日志

```
关键时间戳:
21:12:50 - 首次BKV帧接收
21:13:17 - 设备状态查询
21:13:50 - BKV帧(data_len=29)
21:14:50 - BKV帧(data_len=29)
21:15:49 - BKV帧(data_len=29)
21:16:49 - BKV帧(data_len=29)
缺失: 所有data_len=20的结束报告
```

## 责任人

- **设备协议**: 设备制造商固件团队
- **系统处理**: 后端开发团队
- **监控告警**: 运维团队

## 状态更新

- **2025-11-20**: 问题确认，分析报告完成
- **待处理**: 设备制造商联系，固件更新计划
- **跟踪**: 每日检查类似协议违规情况

---
**记录创建**: 2025-11-20  
**最后更新**: 2025-11-20  
**状态**: 🔴 已确认，待修复