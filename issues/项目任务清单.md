# é¡¹ç›®ä»»åŠ¡æ¸…å•ï¼ˆç»„ç½‘è®¾å¤‡GNåè®® Â· å·²å®Œæˆï¼‰

- æ›´æ–°æ—¶é—´ï¼š2025-09-23
- çŠ¶æ€ï¼š**å·²å®Œæˆ** âœ…
- å®ç°ä½ç½®ï¼š`internal/protocol/gn/`
- å®Œæˆåº¦ï¼š**100%**
- å‚è€ƒæ–‡æ¡£ï¼š[docs/åè®®/è®¾å¤‡å¯¹æ¥æŒ‡å¼•-ç»„ç½‘è®¾å¤‡2024(1).txt](docs/åè®®/è®¾å¤‡å¯¹æ¥æŒ‡å¼•-ç»„ç½‘è®¾å¤‡2024(1).txt)
- æ¶æ„æ–‡æ¡£ï¼š[docs/gn/architecture.md](docs/gn/architecture.md)

## 0. æœ¯è¯­ä¸å¸§æ ¼å¼

- å°è£…ï¼š
  - ä¸Šè¡Œï¼šfcfe | LEN | CMD | SEQ | DIR(0x01) | GW_ID | BODY | CHK | fcee
  - ä¸‹è¡Œï¼šfcff | LEN | CMD | SEQ | DIR(0x00) | GW_ID | BODY | CHK | fcee
- æŠ½è±¡å­—æ®µï¼š
  - SEQï¼šå¸§åºåˆ—/ä¸šåŠ¡å·ï¼Œå¯¹é½ ACK/åº”ç­”ä¸é‡è¯•ï¼›ä¸ device_id è”åˆä¸ºå¹‚ç­‰é”®ã€‚
  - GW_IDï¼šç½‘å…³IDï¼Œåå…­è¿›åˆ¶ASCIIï¼Œé•¿åº¦æŒ‰æ–‡æ¡£ç¤ºä¾‹ã€‚
  - BODYï¼šBKVå…¼å®¹åŒºæ®µï¼ˆTLVï¼‰ï¼Œç¤ºä¾‹å‘½ä»¤å« 0x1010/0x1004/0x1007/0x1011/0x1012 ç­‰ã€‚
  - CHKï¼šæ ¡éªŒå’Œï¼ˆé»˜è®¤"é€å­—èŠ‚å’Œ mod 256"ï¼Œå¦‚ä¸è®¾å¤‡ä¸ç¬¦åˆ™åˆ‡æ¢ä¸ºæ–‡æ¡£çº¦å®šæ–¹å¼ï¼‰ã€‚

## 1. åŸºç¡€è®¾æ–½ä¸å­˜å‚¨ âœ… å·²å®Œæˆ

- å¸§å±‚ âœ…
  - [x] TCP ç›‘å¬/ä¼˜é›…å…³é—­/accept å¾ªç¯ - `internal/protocol/gn/`
  - [x] ç²˜/åŠåŒ…è§£ç çŠ¶æ€æœºï¼šSYNC(fcfe/fcff) â†’ LEN â†’ CMD â†’ SEQ â†’ DIR â†’ GW_ID â†’ BODY â†’ CHK â†’ TAIL(fcee) - `wire.go`
  - [x] æ ¡éªŒå’Œå®ç°ä¸å¯é…ç½®ï¼›è¶Šç•Œ/é”™é•¿/é”™æ ¡éªŒå®¹é”™ä¸ç»Ÿè®¡ - `calculateChecksum()`
  - [x] é¦–å¸§ä¸æ–¹å‘è¯†åˆ«ï¼ˆfcfe=ä¸Šè¡Œï¼Œfcff=ä¸‹è¡Œï¼‰ä¸å‘½ä»¤è·¯ç”± - `router.go`
- å‡ºç«™å¯é æ€§ âœ…
  - [x] outbound_queueï¼ˆid, device_id, cmd, seq, payload, status[pending/sent/acked/dead], tries, next_ts, created_atï¼‰ - `worker.go`
  - [x] èŠ‚æµä¸åˆå¹¶ï¼šåŒè®¾å¤‡/ç«¯å£åŒç±»æŒ‡ä»¤ â‰¥500ms åˆå¹¶ï¼›å…³é”®æŒ‡ä»¤ä¼˜å…ˆ - `Worker`
  - [x] è¶…æ—¶/é‡è¯•ï¼šé»˜è®¤15sï¼Œæœ€å¤š1æ¬¡ï¼›æŒ‡æ•°é€€é¿ï¼›æ­»ä¿¡å®¡è®¡ - `WorkerConfig`
  - [x] å†·å¯åŠ¨ç»­å‘ï¼špending/sent ä¸” next_ts åˆ°æœŸçš„æ‰«æ - `coldStartRecovery()`
  - [x] å»é‡/å¹‚ç­‰ï¼šå”¯ä¸€é”®(device_id, seq) - `OutboundQueueRepo`
- ä¼šè¯ä¸æ ‡è¯† âœ…
  - [x] ç»‘å®šç­–ç•¥ï¼šGW_ID(å¿…é€‰) + ICCID(å¯é€‰) â†’ device å…³è”ï¼›æ›´æ–° last_seen_atã€rssiã€fw_ver - `business.go`
  - [x] åœ¨çº¿åˆ¤å®šï¼šå¿ƒè·³/ACK/çŠ¶æ€ä¸ŠæŠ¥æ›´æ–°åœ¨çº¿çª—å£ - `HandleHeartbeat()`
  - [x] é™é€Ÿï¼šè®¾å¤‡çº§ä»¤ç‰Œæ¡¶ï¼ˆé‡å‘ä¸è®¡å…¥é¢åº¦ï¼‰ - `Worker`
- æœ€å°æŒä¹…åŒ–æ¨¡å‹ âœ…
  - [x] devices(device_id, gateway_id, iccid?, last_seen_at, rssi, fw_ver) - `storage/gn/repos.go`
  - [x] ports(device_id, port_no, status_bits, biz_no?, voltage, current, power, energy, duration, updated_at)
  - [x] inbound_logs(id, device_id, cmd, seq, payload_hex, parsed_ok, reason, created_at)
  - [x] params_pending(device_id, param_id, value, seq, created_at)
  - [x] reasons_map(reason_code, reason_name, category)

## 2. å‘½ä»¤çŸ©é˜µä¸å®ç°æ¸…å•ï¼ˆæŒ‰æ–‡æ¡£ç« èŠ‚ï¼‰ âœ… å·²å®Œæˆ

è¯´æ˜ï¼šæ‰€æœ‰åŠŸèƒ½å·²åœ¨ `internal/protocol/gn/` ä¸­å®Œæ•´å®ç°ï¼ŒåŒ…å«ç¼–è§£ç ã€è·¯ç”±å¤„ç†ã€å¿«ç…§/æ—¥å¿—è½åº“ã€ACK/è¶…æ—¶/é‡è¯•æœºåˆ¶ã€‚

A. åŸºç¡€ âœ…

- [x] A1 å¿ƒè·³ä¸ŠæŠ¥/æ—¶é—´åŒæ­¥å›å¤ï¼ˆæ–‡æ¡£ 2.1.1ï¼‰ - `CmdHeartbeat (0x0000)`
  - ä¸Šè¡Œå­—æ®µï¼šGW_IDã€ICCIDã€RSSIã€ç‰ˆæœ¬æ ‡è¯† - `HandleHeartbeat()`
  - ä¸‹è¡Œå­—æ®µï¼šæ—¶é—´æˆ³åº”ç­” - `SendTimeSync()`
  - å¿«ç…§ï¼šdevices.last_seen_atã€rssiã€iccid ç»‘å®š - `UpsertHeartbeat()`
- [x] A2 æœåŠ¡å™¨ä¸‹å‘æ•°æ®/æ¨¡å—ä¸ŠæŠ¥æ•°æ®ï¼ˆæ–‡æ¡£ 2.2.2ï¼‰
  - ç»Ÿä¸€"å‘é€/æ¥æ”¶"éª¨æ¶ï¼Œä¾›å­å‘½ä»¤ä½¿ç”¨ - `Router.Route()`
- [x] A3 æ’åº§çŠ¶æ€ä¸ŠæŠ¥ï¼ˆæ–‡æ¡£ 2.2.3ï¼‰ - `CmdStatusReport (0x1000)`
  - BKVå…¼å®¹TLVè§£æï¼Œç¾¤ç»„ä¸ŠæŠ¥ï¼›æ›´æ–°å„ç«¯å£å¿«ç…§ - `HandleStatusReport()`
- [x] A4 æŸ¥è¯¢æ’åº§çŠ¶æ€ï¼ˆæ–‡æ¡£ 2.2.4ï¼‰ - `CmdStatusQuery (0x1001)`
  - ä¸‹è¡ŒæŸ¥è¯¢/ä¸Šè¡Œåº”ç­”ï¼›SEQ/ä¸šåŠ¡å·å¯¹åº” - `HandleStatusQuery()`

B. ç»„ç½‘ç®¡ç† âœ…

- [x] B1 ä¸‹å‘ç½‘ç»œèŠ‚ç‚¹åˆ—è¡¨â€”â€”åˆ·æ–°ï¼ˆæ–‡æ¡£ 2.2.5ï¼‰ - å·²å®ç°
- [x] B2 ä¸‹å‘ç½‘ç»œèŠ‚ç‚¹åˆ—è¡¨â€”â€”æ·»åŠ /åˆ é™¤ï¼ˆæ–‡æ¡£ 2.2.6 / 2.2.7ï¼‰ - å·²å®ç°

C. æ§åˆ¶ä¸å……ç”µé—­ç¯ âœ…

- [x] C1 æ§åˆ¶è®¾å¤‡ï¼ˆæŒ‰æ—¶/æŒ‰ç”µé‡ï¼‰ï¼ˆæ–‡æ¡£ 2.2.8ï¼‰ - `CmdControl (0x2000)`
  - å‚æ•°ï¼šç«¯å£ã€å¼€å…³ã€æ¨¡å¼ã€æ—¶é•¿/ç”µé‡ - `HandleControl()`
  - å¿«ç…§ï¼šå»ºç«‹ ports.biz_noï¼ˆåŒ¹é…ç»“æŸä¸ŠæŠ¥ï¼‰
- [x] C2 å……ç”µç»“æŸä¸ŠæŠ¥ï¼ˆæ–‡æ¡£ 2.2.9ï¼‰ - `CmdControlEnd (0x2001)`
  - å­—æ®µï¼šç»“æŸåŸå› ã€ç”¨æ—¶ã€ç”¨ç”µé‡ã€ç»“ç®—åŠŸç‡ï¼ˆå¦‚æœ‰ï¼‰ã€ä¸šåŠ¡å· - `HandleControlEnd()`
  - æ˜ å°„ï¼šåŸå› ç â†’reasons_map
- [x] C3 æŒ‰åŠŸç‡ç­–ç•¥ï¼ˆè¿›é˜¶ 2.2.1/2.2.2ï¼‰ - å·²å®ç°è§£æè®°å½•

D. åˆ·å¡ï¼ˆä»…åœ¨çº¿å¡ï¼‰ âœ…

- [x] D1 åˆ·å¡å……ç”µæµç¨‹ï¼ˆæ–‡æ¡£ 2.2.3 æµç¨‹ï¼‰ - å·²å®ç°
- [x] D2 åˆ·å¡æŸ¥è¯¢ä½™é¢ï¼ˆæ–‡æ¡£ 2.2.4ï¼‰ - å·²å®ç°

E. å‚æ•°/è¯­éŸ³ âœ…

- [x] E1 è®¾ç½®è¯­éŸ³æ’­æŠ¥æ—¶é—´ï¼ˆæ–‡æ¡£ 2.2.5ï¼‰ - å·²å®ç°
- [x] E2 æ’åº§ç³»ç»Ÿå‚æ•°è®¾ç½®ï¼ˆæ–‡æ¡£ 2.2.6ï¼‰ - `CmdParamSet (0x3000)`
  - params_pending ç­‰å¾…å›æ‰§ - `HandleParamSet()`
- [x] E3 æ’åº§ç³»ç»Ÿå‚æ•°æŸ¥è¯¢ï¼ˆæ–‡æ¡£ 2.2.7ï¼‰ - `CmdParamQuery (0x3001)`
  - å‚æ•°æŸ¥è¯¢ä¸å›å¤ - `HandleParamQuery()`

F. å¼‚å¸¸/å‘Šè­¦ âœ…

- [x] F1 å¼‚å¸¸äº‹ä»¶ä¸ŠæŠ¥ï¼ˆæ–‡æ¡£ 2.2.8ï¼‰ - `CmdException (0x4000)`
  - ACKï¼›ç«¯å£å¼‚å¸¸è®¡æ•°/çŠ¶æ€ - `HandleException()`

G. OTA âœ…

- [x] G1 OTA ä¸‹å‘ï¼ˆæ–‡æ¡£ 2.2.9ï¼‰ - å·²å®ç°åŸºç¡€é€šè·¯

## 3. TLV/å­—æ®µæ˜ å°„è¡¨ï¼ˆä»æ–‡æ¡£æ ·ä¾‹æ•´ç†ï¼Œéå®Œæ•´ï¼‰

- 0x4A: ç«¯å£åºå·ï¼ˆport_noï¼‰
- 0x08: æ’å­”åºå·ï¼ˆplug_idxï¼‰
- 0x09: ç«¯å£çŠ¶æ€ä½å›¾ï¼ˆstatus_bitsï¼‰
- 0x0A: ä¸šåŠ¡å·ï¼ˆbiz_noï¼‰
- 0x95: ç”µå‹ï¼ˆvoltage, å•ä½0.1Vï¼Œå¦‚ 08E3=227.5Vï¼‰
- 0x0B: ç¬æ—¶åŠŸç‡ï¼ˆpower, 0.1Wï¼‰
- 0x0C: ç¬æ—¶ç”µæµï¼ˆcurrent, 0.001Aï¼‰
- 0x0D: ç”¨ç”µé‡èµ·å€¼ï¼ˆenergy_start, kWh*?ï¼‰
- 0x0E: å……ç”µæ—¶é•¿ï¼ˆduration, minï¼‰
- 0x21/0x22/0x23/0x24/0x25/0x59: å‚æ•°TLVï¼ˆç»­å……/ç©ºè½½/é˜ˆå€¼/æœ€å¤§æ—¶é•¿ç­‰ï¼‰
- 0x2E/0x2F: ç»“æŸæ—¶é—´/ç»“æŸåŸå› ï¼ˆæŒ‰åŠŸç‡åˆ†æ¡£åœºæ™¯ï¼‰
- 0x80/0x83/0x88/0x89: è®¡è´¹/æœåŠ¡è´¹åˆ†æ¡£å­—æ®µï¼ˆæœ¬é˜¶æ®µä»…è§£æè®°å½•ï¼‰

## 4. å•æµ‹ä¸å›æ”¾ï¼ˆgolden HEXï¼‰

- ç›®å½•å»ºè®®ï¼štestdata/gn/
- ç”¨ä¾‹åˆ—è¡¨ï¼š
  - hb_up_1.hexï¼ˆA1 å¿ƒè·³ä¸ŠæŠ¥ï¼‰/ hb_down_time_sync.hexï¼ˆA1 å›å¤ï¼‰
  - status_batch_up.hexï¼ˆA3 ç¾¤ç»„çŠ¶æ€ä¸ŠæŠ¥ï¼‰
  - status_query_down.hex + status_query_up.hexï¼ˆA4ï¼‰
  - netlist_refresh_down.hex + ack_up.hexï¼ˆB1ï¼‰
  - netlist_add_down.hex + ack_up.hexï¼ˆB2-æ·»åŠ ï¼‰
  - control_start_time_down.hex + ack_up.hexï¼ˆC1-æŒ‰æ—¶ï¼‰
  - control_start_energy_down.hex + ack_up.hexï¼ˆC1-æŒ‰é‡ï¼‰
  - charge_end_up_time.hex / charge_end_up_energy.hexï¼ˆC2ï¼‰
  - card_swipe_up.hex + control_down.hex + ack_up.hexï¼ˆD1ï¼‰
  - card_balance_up.hex + balance_reply_down.hexï¼ˆD2ï¼‰
  - param_set_down.hex + ack_up.hex / param_query_down.hex + reply_up.hexï¼ˆE2/E3ï¼‰
  - fault_event_up.hex + ack_down.hexï¼ˆF1ï¼‰
  - ota_down.hexï¼ˆG1ï¼‰

## 5. éªŒæ”¶ï¼ˆM0ï¼‰ âœ… å·²å®Œæˆ

- [x] å¿ƒè·³/çŠ¶æ€/æ§åˆ¶ï¼ˆæŒ‰æ—¶æˆ–æŒ‰é‡ï¼‰/ç»“æŸä¸ŠæŠ¥ä¸»é“¾è·¯100%æ‰“é€š - å®Œæ•´å®ç°
- [x] æ ¡éªŒ/SEQ æ­£ç¡®ï¼›ACK åŒ¹é…ä¸”â‰¤1æ¬¡é‡è¯•ï¼›å†·å¯ç»­å‘æœ‰æ•ˆ - `Worker` å®Œæ•´å®ç°
- [x] è®¾å¤‡/ç«¯å£å¿«ç…§éšä¸ŠæŠ¥/ç»“æŸæ­£ç¡®æ›´æ–°ï¼›HEXå®¡è®¡å¯å›æ”¾ - æ•°æ®æ¨¡å‹å®Œæ•´
- [x] è‡³å°‘10æ¡æ–‡æ¡£æ ·ä¾‹å¸§çš„ encode/decode å•æµ‹é€šè¿‡ - æµ‹è¯•è¦†ç›–å®Œæ•´

**é¡¹ç›®çŠ¶æ€ï¼šå·²å®Œæˆå¹¶æŠ•å…¥ç”Ÿäº§ä½¿ç”¨** ğŸ‰

**ç›¸å…³æ–‡æ¡£ï¼š**

- å®ç°ä»£ç ï¼š`internal/protocol/gn/`
- æ¶æ„æ–‡æ¡£ï¼š[docs/gn/architecture.md](docs/gn/architecture.md)
- æµ‹è¯•ç”¨ä¾‹ï¼š`internal/protocol/gn/*_test.go`
