# 项目任务清单（仅"组网设备"协议 · docs/协议/设备对接指引-组网设备2024(1).txt）

- 生成时间：2025-09-18 11:32:49 UTC
- 默认分支：main
- 范围：仅实现"组网设备"协议文档中的功能流转，覆盖封装帧解析/编解码、指令路由、可靠出站（SEQ/msg_id/ACK/重试/冷启续发）、设备/端口快照、必要的参数读写；不实现其他协议与域功能。
- 参考文档：[docs/协议/设备对接指引-组网设备2024(1).txt](docs/协议/设备对接指引-组网设备2024(1).txt)

## 0. 术语与帧格式

- 封装：
  - 上行：fcfe | LEN | CMD | SEQ | DIR(0x01) | GW_ID | BODY | CHK | fcee
  - 下行：fcff | LEN | CMD | SEQ | DIR(0x00) | GW_ID | BODY | CHK | fcee
- 抽象字段：
  - SEQ：帧序列/业务号，对齐 ACK/应答与重试；与 device_id 联合为幂等键。
  - GW_ID：网关ID，十六进制ASCII，长度按文档示例。
  - BODY：BKV兼容区段（TLV），示例命令含 0x1010/0x1004/0x1007/0x1011/0x1012 等。
  - CHK：校验和（默认"逐字节和 mod 256"，如与设备不符则切换为文档约定方式）。

## 1. 基础设施与存储

- 帧层
  - [ ] TCP 监听/优雅关闭/accept 循环
  - [ ] 粘/半包解码状态机：SYNC(fcfe/fcff) → LEN → CMD → SEQ → DIR → GW_ID → BODY → CHK → TAIL(fcee)
  - [ ] 校验和实现与可配置；越界/错长/错校验容错与统计
  - [ ] 首帧与方向识别（fcfe=上行，fcff=下行）与命令路由
- 出站可靠性
  - [ ] outbound_queue（id, device_id, cmd, seq, payload, status[pending/sent/acked/dead], tries, next_ts, created_at）
  - [ ] 节流与合并：同设备/端口同类指令 ≥500ms 合并；关键指令优先
  - [ ] 超时/重试：默认15s，最多1次；指数退避；死信审计
  - [ ] 冷启动续发：pending/sent 且 next_ts 到期的扫描
  - [ ] 去重/幂等：唯一键(device_id, seq)
- 会话与标识
  - [ ] 绑定策略：GW_ID(必选) + ICCID(可选) → device 关联；更新 last_seen_at、rssi、fw_ver
  - [ ] 在线判定：心跳/ACK/状态上报更新在线窗口
  - [ ] 限速：设备级令牌桶（重发不计入额度）
- 最小持久化模型
  - [ ] devices(device_id, gateway_id, iccid?, last_seen_at, rssi, fw_ver)
  - [ ] ports(device_id, port_no, status_bits, biz_no?, voltage, current, power, energy, duration, updated_at)
  - [ ] inbound_logs(id, device_id, cmd, seq, payload_hex, parsed_ok, reason, created_at)
  - [ ] params_pending(device_id, param_id, value, seq, created_at)
  - [ ] reasons_map(reason_code, reason_name, category)

## 2. 命令矩阵与实现清单（按文档章节）

说明：每项需包含编解码、路由处理、快照/日志落库、（若为下行）ACK/超时/重试，以及基于文档HEX样例的单测。

A. 基础

- [ ] A1 心跳上报/时间同步回复（文档 2.1.1）
  - 上行字段：GW_ID、ICCID、RSSI、版本标识
  - 下行字段：时间戳应答
  - 快照：devices.last_seen_at、rssi、iccid 绑定
- [ ] A2 服务器下发数据/模块上报数据（文档 2.2.2）
  - 统一"发送/接收"骨架，供子命令使用
- [ ] A3 插座状态上报（文档 2.2.3）
  - BKV兼容TLV解析，群组上报；更新各端口快照
- [ ] A4 查询插座状态（文档 2.2.4）
  - 下行查询/上行应答；SEQ/业务号对应

B. 组网管理

- [ ] B1 下发网络节点列表——刷新（文档 2.2.5）
- [ ] B2 下发网络节点列表——添加/删除（文档 2.2.6 / 2.2.7）

C. 控制与充电闭环

- [ ] C1 控制设备（按时/按电量）（文档 2.2.8）
  - 参数：端口、开关、模式、时长/电量
  - 快照：建立 ports.biz_no（匹配结束上报）
- [ ] C2 充电结束上报（文档 2.2.9）
  - 字段：结束原因、用时、用电量、结算功率（如有）、业务号
  - 映射：原因码→reasons_map
- [ ] C3 按功率策略（进阶 2.2.1/2.2.2）——如本阶段不需要，可仅解析记录

D. 刷卡（仅在线卡）

- [ ] D1 刷卡充电流程（文档 2.2.3 流程）
- [ ] D2 刷卡查询余额（文档 2.2.4）——余额由上层提供或临时配置

E. 参数/语音

- [ ] E1 设置语音播报时间（文档 2.2.5）
- [ ] E2 插座系统参数设置（文档 2.2.6）→ params_pending 等待回执
- [ ] E3 插座系统参数查询（文档 2.2.7）

F. 异常/告警

- [ ] F1 异常事件上报（文档 2.2.8）→ ACK；端口异常计数/状态

G. OTA

- [ ] G1 OTA 下发（文档 2.2.9）→ 仅通路（灰度/回滚后续）

## 3. TLV/字段映射表（从文档样例整理，非完整）

- 0x4A: 端口序号（port_no）
- 0x08: 插孔序号（plug_idx）
- 0x09: 端口状态位图（status_bits）
- 0x0A: 业务号（biz_no）
- 0x95: 电压（voltage, 单位0.1V，如 08E3=227.5V）
- 0x0B: 瞬时功率（power, 0.1W）
- 0x0C: 瞬时电流（current, 0.001A）
- 0x0D: 用电量起值（energy_start, kWh*?）
- 0x0E: 充电时长（duration, min）
- 0x21/0x22/0x23/0x24/0x25/0x59: 参数TLV（续充/空载/阈值/最大时长等）
- 0x2E/0x2F: 结束时间/结束原因（按功率分档场景）
- 0x80/0x83/0x88/0x89: 计费/服务费分档字段（本阶段仅解析记录）

## 4. 单测与回放（golden HEX）

- 目录建议：testdata/gn/
- 用例列表：
  - hb_up_1.hex（A1 心跳上报）/ hb_down_time_sync.hex（A1 回复）
  - status_batch_up.hex（A3 群组状态上报）
  - status_query_down.hex + status_query_up.hex（A4）
  - netlist_refresh_down.hex + ack_up.hex（B1）
  - netlist_add_down.hex + ack_up.hex（B2-添加）
  - control_start_time_down.hex + ack_up.hex（C1-按时）
  - control_start_energy_down.hex + ack_up.hex（C1-按量）
  - charge_end_up_time.hex / charge_end_up_energy.hex（C2）
  - card_swipe_up.hex + control_down.hex + ack_up.hex（D1）
  - card_balance_up.hex + balance_reply_down.hex（D2）
  - param_set_down.hex + ack_up.hex / param_query_down.hex + reply_up.hex（E2/E3）
  - fault_event_up.hex + ack_down.hex（F1）
  - ota_down.hex（G1）

## 5. 验收（M0）

- 心跳/状态/控制（按时或按量）/结束上报主链路100%打通
- 校验/SEQ 正确；ACK 匹配且≤1次重试；冷启续发有效
- 设备/端口快照随上报/结束正确更新；HEX审计可回放
- 至少10条文档样例帧的 encode/decode 单测通过
