# BKV 协议待实现功能清单

> 基于 `BKV协议完整性分析报告.md` 提炼的执行清单  
> 优先级: 🔴 高 | 🟡 中 | 🟢 低  
> **最后更新**: 2025-10-05

---

## ✅ 已完成功能

### ✅ 1. 参数存储持久化 (已完成 - Week 3)

**状态**: ✅ 完成

**完成内容**:

- ✅ 创建数据库迁移脚本 `db/migrations/0005_device_params_up.sql`
- ✅ 实现 `Repository.StoreParamWrite()` 数据库版本
- ✅ 实现 `Repository.GetParamWritePending()` 数据库版本
- ✅ 实现 `Repository.ConfirmParamWrite()` 确认方法
- ✅ 实现 `Repository.FailParamWrite()` 失败标记方法
- ✅ 移除 `wire.go` 中的内存 `paramStore`

### ✅ 2. 刷卡充电流程 (已完成 - Week 4 + Week 5)

**状态**: ✅ 完成（核心流程100%）

**完成内容**:

#### 2.1 数据库准备 ✅

- ✅ 创建 `cards` 表 (卡号、余额、状态)
- ✅ 创建 `card_transactions` 表 (交易记录，支持4种充电模式)
- ✅ 创建 `card_balance_logs` 表 (余额变更日志)

#### 2.2 协议编解码 ✅

- ✅ 实现 `ParseCardSwipeRequest()` - 解析设备上报卡号（cmd=0x0B上行）
- ✅ 实现 `EncodeChargeCommand()` - 编码充电指令（cmd=0x0B下行，支持4种模式）
- ✅ 实现 `ParseOrderConfirmation()` - 解析设备回应订单（cmd=0x0F上行）⭐
- ✅ 实现 `ParseChargeEndReport()` - 解析充电结束（cmd=0x0C上行）
- ✅ 实现 `ParseBalanceQuery()` - 解析余额查询（cmd=0x1A上行）
- ✅ 实现 `EncodeBalanceResponse()` - 编码余额响应（cmd=0x1A下行）

#### 2.3 业务处理 ✅

- ✅ 实现 `CardService.HandleCardSwipe()` - 刷卡充电处理器
  - ✅ 卡片验证逻辑
  - ✅ 余额检查
  - ✅ 创建充电订单（支持4种模式）
- ✅ 实现 `CardService.HandleOrderConfirmation()` - 处理设备订单确认（cmd=0x0F）⭐
  - ✅ 更新订单状态为"设备已确认"
  - ✅ 失败时触发订单回滚
- ✅ 实现 `CardService.HandleChargeEnd()` - 充电结束处理
  - ✅ 订单结算
  - ✅ 余额扣减（原子操作+事务锁）
  - ✅ 生成交易记录
- ✅ 实现 `PricingEngine` - 计费引擎（支持4种充电模式）

#### 2.4 下行消息发送 ✅ (Week 5新增)

- ✅ 实现 `sendChargeCommand()` - 发送充电指令（0x0B下行）
- ✅ 实现 `sendOrderConfirmReply()` - 发送订单确认回复（0x0F下行）
- ✅ 实现 `sendChargeEndReply()` - 发送充电结束确认（0x0C下行）
- ✅ 实现 `sendBalanceResponse()` - 发送余额响应（0x1A下行）
- ✅ 实现 `OutboundAdapter` - Outbound适配器

#### 2.5 测试 ✅

- ✅ 创建 `card_integration_test.go` - 4个E2E集成测试
- ✅ 测试完整流程：上报 → 验证 → 充电 → 结束 → 余额查询
- ✅ 测试异常场景（余额不足、卡片无效等）

**Week 6完成日期**: 2025-10-05  

- ✅ 实现 `internal/protocol/bkv/network.go` - 组网管理协议编解码
- ✅ 实现 `internal/api/network_routes.go` - 组网管理HTTP API
- ✅ 创建 `internal/protocol/bkv/network_test.go` - 8个测试用例+E2E测试
- ✅ 测试完整流程：刷新列表、添加插座、删除插座

**Week 7完成日期**: 2025-10-05  

- ✅ 实现 `internal/protocol/bkv/ota.go` - OTA升级协议编解码
- ✅ 实现 `internal/api/ota_routes.go` - OTA升级HTTP API
- ✅ 创建 `internal/protocol/bkv/ota_test.go` - 6个测试用例+E2E测试
- ✅ 测试完整流程：DTU升级、插座升级、进度上报

---

## 🔴 Phase 1: 高优先级功能 (剩余任务)

**SQL**:

```sql
CREATE TABLE device_param_writes (
    id SERIAL PRIMARY KEY,
    device_id BIGINT REFERENCES devices(id),
    param_id SMALLINT NOT NULL,
    param_value BYTEA NOT NULL,
    msg_id INTEGER NOT NULL,
    status SMALLINT DEFAULT 0,
    verified_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(device_id, param_id, msg_id)
);
```

---

### ~~1. 组网管理功能~~ ✅ 已完成 (Week 6)

**协议要求**: 支持远程管理网关下的插座设备列表

**任务清单**: (全部完成)

#### 3.1 数据库准备

- [x] 创建 `gateway_sockets` 表

```sql
CREATE TABLE gateway_sockets (
    id SERIAL PRIMARY KEY,
    gateway_id VARCHAR(50) NOT NULL,
    socket_no SMALLINT NOT NULL,
    socket_mac VARCHAR(20) NOT NULL,
    socket_uid VARCHAR(20),
    channel SMALLINT,
    status SMALLINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(gateway_id, socket_no)
);
```

#### 3.2 协议编解码

- [x] 实现 `EncodeNetworkRefreshCommand()` - 刷新列表（cmd=0x08）
- [x] 实现 `EncodeNetworkAddNodeCommand()` - 添加插座（cmd=0x09）
- [x] 实现 `EncodeNetworkDeleteNodeCommand()` - 删除插座（cmd=0x0A）
- [x] 实现 `ParseNetworkResponse()` - 解析设备响应

#### 3.3 业务处理

- [x] 实现 `HandleNetworkRefresh()` - 刷新列表处理器
- [x] 实现 `HandleNetworkAddNode()` - 添加节点处理器
- [x] 实现 `HandleNetworkDeleteNode()` - 删除节点处理器
- [x] 在 `router_handlers.go` 注册命令处理器

#### 3.4 API接口

- [x] 添加 HTTP API: `GET /api/gateway/{id}/sockets` - 查询所有插座
- [x] 添加 HTTP API: `GET /api/gateway/{id}/sockets/{socket_no}` - 查询单个插座
- [x] 添加 HTTP API: `DELETE /api/gateway/{id}/sockets/{socket_no}` - 删除插座

#### 3.5 测试

- [x] 创建 `network_test.go`
- [x] 测试批量刷新列表
- [x] 测试添加单个插座
- [x] 测试删除单个插座

**协议文档参考**: 2.2.5-2.2.7 (183-248行)

---

### ~~2. OTA 升级功能~~ ✅ 已完成 (Week 7)

**协议要求**: 支持远程升级设备固件

**任务清单**: (全部完成)

#### 4.1 数据库准备

- [x] 创建 `ota_tasks` 表

```sql
CREATE TABLE ota_tasks (
    id SERIAL PRIMARY KEY,
    device_id BIGINT REFERENCES devices(id),
    target_type SMALLINT,
    firmware_version VARCHAR(20),
    ftp_server VARCHAR(50),
    ftp_port INTEGER,
    file_name VARCHAR(50),
    status SMALLINT DEFAULT 0,
    progress SMALLINT,
    error_msg TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 4.2 协议编解码

- [x] 实现 `EncodeOTACommand()` - 编码OTA升级指令（cmd=0x07）
- [x] 实现 `ParseOTAResponse()` - 解析设备响应
- [x] 实现 `ParseOTAProgress()` - 解析升级进度上报

#### 4.3 业务处理

- [x] 实现 `HandleOTAResponse()` - OTA升级响应处理器
- [x] 实现 `HandleOTAProgress()` - 升级进度处理
- [x] 在 `router_handlers.go` 更新 0x0007 注册

#### 4.4 API接口

- [x] 添加 HTTP API: `POST /api/devices/{id}/ota` - 创建OTA任务
- [x] 添加 HTTP API: `GET /api/devices/{id}/ota/{task_id}` - 查询任务详情
- [x] 添加 HTTP API: `GET /api/devices/{id}/ota` - 查询任务列表

#### 4.5 测试

- [x] 创建 `ota_test.go`
- [x] 测试DTU升级流程
- [x] 测试插座升级流程
- [x] 测试升级失败处理

**协议文档参考**: OTA升级 (798-812行)

---

## 🟡 Phase 2: 中优先级功能 (增强功能)

### 5. 按功率充电完善 ⏱️ 2天

**当前问题**: `handlers.go:269-281` 有 `ChargingModeByLevel` 但多档位逻辑不完整

**任务清单**:

- [ ] 扩展 `BKVControlCommand` 结构体支持多档位

  ```go
  type PowerLevel struct {
      PowerW     uint16 // 功率(W)
      PriceCents uint16 // 价格(分)
      Duration   uint16 // 时长(分钟)
  }
  ```

- [ ] 实现 `EncodePowerLevelCommand()` - 编码分功率充电命令（cmd=0x17）
- [ ] 实现 `ParsePowerLevelEnd()` - 解析分功率结束上报（cmd=0x18）
- [ ] 完善 `HandleControl()` 中的多档位处理逻辑
- [ ] 添加 `power_level_charging_test.go` 测试

**协议文档参考**: 2.2.1-2.2.2 (319-378行)

---

### 6. 按电费+服务费计费 ⏱️ 3天

**协议要求**: 支持电费和服务费分开计费

**任务清单**:

#### 6.1 数据库扩展

- [ ] 扩展 `orders` 表

```sql
ALTER TABLE orders ADD COLUMN electric_fee_cents INTEGER;
ALTER TABLE orders ADD COLUMN service_fee_cents INTEGER;
ALTER TABLE orders ADD COLUMN fee_level_usage JSONB;
```

#### 6.2 协议编解码

- [ ] 实现 `ServiceFeeConfig` 结构体

  ```go
  type ServiceFeeConfig struct {
      Mode       uint8  // 0=按时, 1=按电量
      LevelCount uint8
      Levels     []FeeLevel
  }
  
  type FeeLevel struct {
      StartTime   uint16 // HHMM
      EndTime     uint16 // HHMM
      ElectricFee uint16 // 分/度
      ServiceFee  uint16 // 分/度
  }
  ```

- [ ] 实现 `EncodeServiceFeeCommand()` - 编码服务费充电命令
- [ ] 实现 `ParseServiceFeeEnd()` - 解析服务费充电结束

#### 6.3 业务处理

- [ ] 扩展 `HandleBKVControlCommand()` 支持服务费模式
- [ ] 扩展 `HandleBKVChargingEnd()` 支持服务费结算
- [ ] 添加 `service_fee_test.go` 测试

**协议文档参考**: 按电费+服务费 (379-453行)

---

### 7. 设置语音播报时间 ⏱️ 1天

**协议要求**: 支持设置设备静音时段

**任务清单**:

- [ ] 创建 `device_voice_configs` 表
- [ ] 实现 `EncodeVoiceConfigCommand()` - 编码语音配置（cmd=0x1B）
- [ ] 实现 `ParseVoiceConfigResponse()` - 解析设备响应
- [ ] 实现 `HandleVoiceConfig()` - 语音配置处理器
- [ ] 注册 0x1B 命令处理器
- [ ] 添加 HTTP API: `PUT /api/devices/{id}/voice-config`
- [ ] 添加 `voice_config_test.go` 测试

**协议文档参考**: 2.2.5 (633-667行)

---

### 8. 查询插座状态 ⏱️ 1天

**协议要求**: 支持主动查询插座当前状态

**任务清单**:

- [ ] 实现 `EncodeQuerySocketCommand()` - 编码查询命令（cmd=0x1D）
- [ ] 实现 `ParseSocketStateResponse()` - 解析插座状态响应
- [ ] 实现 `HandleQuerySocketState()` - 查询状态处理器
- [ ] 注册 0x1D 命令处理器
- [ ] 添加 HTTP API: `GET /api/sockets/{id}/state`
- [ ] 添加 `query_socket_test.go` 测试

**协议文档参考**: 2.2.4 (156-182行)

---

## 🟢 Phase 3: 低优先级优化

### 9. 实现协议约束验证 ⏱️ 1天

**任务清单**:

- [ ] 插座编号验证（1-250，同网关不重复）
- [ ] 充电时长验证（1-900分钟）
- [ ] 信道范围验证（1-15）
- [ ] 语音时段数量验证（最多2段）
- [ ] 添加业务规则校验中间件

---

### 10. 异常事件专表 ⏱️ 1天

**当前问题**: 异常事件仅记录到通用日志，不便于统计分析

**任务清单**:

- [ ] 创建 `device_exceptions` 表
- [ ] 修改 `handleExceptionEvent()` 写入专表
- [ ] 添加 HTTP API: `GET /api/devices/{id}/exceptions`
- [ ] 添加异常统计报表接口

---

### 10. 完善协议命令注册 ⏱️ 0.5天

**任务清单**:

- [ ] 在 `router_handlers.go` 中补全所有命令注册
- [ ] 添加 `makeHandler()` 辅助方法统一包装
- [ ] 更新 `BKVCommands` 映射表
- [ ] 添加命令注册完整性测试

**需要注册的命令**:

```go
0x0008, 0x0009, 0x000A  // 组网管理
0x000B, 0x000C, 0x001A  // 刷卡充电
0x001B                  // 语音配置
0x001D                  // 查询状态
0x0017, 0x0018          // 按功率充电
```

---

### 11. 错误处理和日志规范化 ⏱️ 1天

**任务清单**:

- [ ] 统一错误类型定义 `internal/protocol/bkv/errors.go`

  ```go
  var (
      ErrInvalidFrame = errors.New("invalid frame")
      ErrInvalidBKV   = errors.New("invalid BKV payload")
      ErrCardNotFound = errors.New("card not found")
      // ...
  )
  ```

- [ ] 统一日志格式
- [ ] 添加关键操作日志：
  - 刷卡充电开始/结束
  - OTA升级启动/完成
  - 组网操作成功/失败
  - 参数设置成功/失败

---

### 12. 指标监控 ⏱️ 1天

**任务清单**:

- [ ] 在 `internal/metrics/metrics.go` 添加 BKV 专用指标

  ```go
  CardChargingTotal     prometheus.Counter  // 刷卡充电次数
  CardChargingFailures  prometheus.Counter  // 刷卡充电失败
  OTAUpgradesTotal      prometheus.Counter  // OTA升级次数
  OTAUpgradesDuration   prometheus.Histogram // OTA升级耗时
  NetworkOpsTotal       prometheus.Counter  // 组网操作次数
  ParamWritesTotal      prometheus.Counter  // 参数写入次数
  ```

- [ ] 在各处理器中埋点
- [ ] 更新 Grafana 仪表板

---

## Phase 4: 测试与文档 ⏱️ 5-7天

### 13. 单元测试补充

**任务清单**:

- [ ] `card_charging_test.go` - 刷卡充电完整流程
- [ ] `ota_test.go` - OTA升级流程
- [ ] `network_management_test.go` - 组网管理
- [ ] `service_fee_test.go` - 服务费计费
- [ ] `param_persistence_test.go` - 参数持久化
- [ ] 目标: 覆盖率达到 80%+

---

### 14. 集成测试

**任务清单**:

- [ ] 搭建 BKV 协议模拟器
- [ ] 测试完整充电流程（扫码 + 刷卡）
- [ ] 测试异常场景（断线重连、超时、重复消息）
- [ ] 压力测试（1000+ 并发连接）

---

### 15. 文档更新

**任务清单**:

- [ ] 更新 `docs/协议/README.md` - BKV 协议实现说明
- [ ] 创建 `docs/api/bkv_commands.md` - 命令参考手册
- [ ] 创建 `docs/运维/ota_upgrade_guide.md` - OTA 升级指南
- [ ] 创建 `docs/对接/card_charging_integration.md` - 刷卡充电对接文档
- [ ] 更新 OpenAPI 规范 `api/openapi/openapi.yaml`

---

## 总工作量估算

| Phase | 工作量 | 已完成 | 剩余 | 说明 |
|-------|--------|-------|------|------|
| **已完成** | **7天** | **✅ 7天** | **0天** | **参数持久化(1天) + 刷卡充电(6天)** |
| Phase 1 | 6天 | 0天 | 6天 | 高优先级（组网+OTA） |
| Phase 2 | 7天 | 0天 | 7天 | 增强功能，建议完成 |
| Phase 3 | 4.5天 | 0天 | 4.5天 | 优化项 |
| Phase 4 | 5-7天 | 0天 | 5-7天 | 测试与文档 |
| **总计** | **29.5-31.5天** | **✅ 7天 (22%)** | **22.5-24.5天** | 约 **4-5周剩余** |

**进度**: ✅ 22% 完成（核心业务功能已就绪）

**注意**: 开发前需与设备厂商确认3处"略"标注的命令格式

---

## 快速自检清单

开发完成后，使用此清单验证功能完整性：

### 基础功能

- [ ] 心跳上报/回复正常
- [ ] 插座状态周期性上报
- [ ] 按时/按量充电功能正常
- [ ] 充电结束上报和订单结算正常

### 刷卡充电 ✅ 已完成

- ✅ 设备刷卡后能上报卡号（cmd=0x0B上行）
- ✅ 平台能验证卡片并下发充电指令（cmd=0x0B下行，支持4种模式）
- ✅ ⭐ 设备能回应订单确认（cmd=0x0F）
- ✅ 充电过程中能查询余额（cmd=0x1A）
- ✅ 充电结束能正确扣减余额并结算（cmd=0x0C）

### 组网管理

- [ ] 能批量刷新网关插座列表
- [ ] 能动态添加单个插座
- [ ] 能删除单个插座
- [ ] 组网状态能查询和监控

### OTA 升级

- [ ] 能远程下发OTA升级命令
- [ ] 设备能上报升级进度
- [ ] 升级成功/失败能正确处理

### 参数管理 ✅ 已完成

- ✅ 参数设置后能持久化
- ✅ 参数回读校验功能正常
- ✅ 参数查询能返回正确值

### 计费功能

- [ ] 按功率充电支持多档位
- [ ] 电费+服务费能分别计费
- [ ] 分时段计费功能正常

### 运维功能

- [ ] 语音播报时段能配置
- [ ] 异常事件能上报并记录
- [ ] 插座状态能主动查询

---

**下一步行动**:

1. 召开技术评审会，确认实施计划
2. 分配任务和责任人
3. 创建开发分支 `feature/bkv-complete`
4. 每周回顾进度，更新此清单
5. Phase 1 完成后进行阶段性测试验收

---

*此清单由 `BKV协议完整性分析报告.md` 提炼，定期同步更新。*
