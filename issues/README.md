# IOT Server - BKV 协议问题与改进跟踪

> 📅 最后更新: 2025-10-05  
> 📊 整体完成度: **约 50%**  
> 🎯 目标: 完整实现 BKV 协议 V1.7 规范

---

## 📋 文档导航

| 文档 | 说明 | 状态 |
|-----|------|------|
| [项目架构设计.md](../docs/架构/项目架构设计.md) | 完整系统架构：分层设计、数据流、部署架构、技术栈 | ✅ 已完成 |
| [架构优缺点分析.md](../docs/架构/架构优缺点分析.md) | 深度架构评估：9大优点、10大缺点、改进路线图 | ✅ 已完成 |
| [BKV协议完整性分析报告.md](./BKV协议完整性分析报告.md) | 详细分析报告，包含问题详解、数据库设计、风险评估 | ✅ 已完成 |
| [待实现功能清单.md](./待实现功能清单.md) | 执行清单，包含具体任务、工作量估算、验收标准 | ✅ 已完成 |

---

## 🎯 核心问题概览

### 🔴 高优先级缺陷 (必须修复)

| # | 问题 | 影响 | 工作量 | 状态 |
|---|-----|------|--------|------|
| 1 | **参数存储使用内存，重启丢失** | 参数设置功能不可用 | 1天 | ⏳ 待处理 |
| 2 | **刷卡充电流程完全缺失（含cmd 0x0F）** | 无法支持刷卡支付 | 5-6天 | ⏳ 待处理 |
| 3 | **组网管理功能缺失** | 无法远程管理插座设备 | 3天 | ⏳ 待处理 |
| 4 | **OTA升级功能缺失** | 无法远程升级固件 | 3天 | ⏳ 待处理 |

### 🟡 中优先级功能 (增强功能)

| # | 问题 | 影响 | 工作量 | 状态 |
|---|-----|------|--------|------|
| 5 | 按功率充电多档位逻辑不完整 | 分功率计费不准确 | 2天 | ⏳ 待处理 |
| 6 | 电费+服务费计费缺失 | 计费模式不灵活 | 3天 | ⏳ 待处理 |
| 7 | 语音播报时间设置缺失 | 无法远程静音控制 | 1天 | ⏳ 待处理 |
| 8 | 查询插座状态功能缺失 | 无法主动查询状态 | 1天 | ⏳ 待处理 |

---

## 📊 功能实现统计

### 命令实现情况

```
已完整实现: 5/21  (23.8%)  ███████░░░░░░░░░░░░░░░░░░░░░
部分实现:   4/21  (19.0%)  █████░░░░░░░░░░░░░░░░░░░░░░░
完全缺失:  12/21  (57.2%)  ████████████████░░░░░░░░░░░░
```

### 协议章节覆盖度

| 章节 | 功能 | 完成度 |
|------|------|--------|
| 2.1 基础功能 | 心跳、状态上报、控制 | 70% ███████░░░ |
| 2.2 进阶功能 | 分功率、刷卡、OTA | 30% ███░░░░░░░ |

---

## 🚀 实施路线图

### Phase 1: 高优先级缺陷修复 (2周)

```
Week 1: 参数持久化 + 组网管理
Week 2: 刷卡充电（7步流程，含cmd 0x0F）+ OTA升级
```

### Phase 2: 计费功能完善 (1周)

```
- 按功率充电完善
- 电费+服务费计费
- 余额查询功能
```

### Phase 3: 辅助功能补充 (4.5天)

```
- 插座状态位解析 (0.5天)
- 协议约束验证 (1天)
- 语音播报配置 (1天)
- 查询插座状态 (1天)
- 异常事件专表 (1天)
```

### Phase 4: 测试与文档 (1周)

```
- 单元测试补充 (覆盖率 80%+)
- 集成测试
- 协议对接文档
```

**总预估**: 6 周 (28.5-31.5 工作日)

⚠️ **开发前置条件**: 需与设备厂商确认3处"略"标注的命令格式（删除插座、充电结束回复、按功率充电回复）

---

## 🔍 快速问题定位

### 从入口开始的问题链

```
cmd/server/main.go
  └─> internal/app/bootstrap/app.go
      ├─> TCP服务 (internal/tcpserver)
      │   └─> 连接处理 (internal/gateway/conn_handler.go)
      │       └─> 协议适配器 (internal/protocol/bkv)
      │           ├─> adapter.go          ✅ 基础适配正常
      │           ├─> parser.go           ✅ 帧解析正常
      │           ├─> router_handlers.go  ⚠️ 命令注册不完整
      │           ├─> handlers.go         ⚠️ 部分处理器为空实现
      │           └─> wire.go             🔴 参数存储使用内存
      │
      ├─> 数据库 (internal/storage/pg)
      │   └─> repo.go                     ⚠️ 缺少表：cards, ota_tasks, gateway_sockets
      │
      └─> Outbound队列 (internal/outbound)
          └─> worker.go                   ✅ 下行队列正常
```

### 关键文件状态

| 文件 | 状态 | 问题 |
|-----|------|------|
| `internal/protocol/bkv/router_handlers.go` | 🟡 部分实现 | 仅注册 5 个命令，缺失 16 个命令（含0x0F） |
| `internal/protocol/bkv/handlers.go` | 🟡 部分实现 | 多个处理器仅有空骨架，缺少状态位解析 |
| `internal/protocol/bkv/wire.go` | 🔴 有缺陷 | 参数存储使用内存 map (line:14) |
| `internal/storage/pg/repo.go` | 🟡 需扩展 | 缺少刷卡、OTA、组网相关表 |
| `db/migrations/` | 🟡 需补充 | 需要新增 6+ 个迁移脚本 |

### 协议文档缺失部分

| 命令/功能 | 缺失内容 | 文档位置 | 影响 |
|---------|---------|---------|------|
| 删除单个插座 (0x0A) | 完整命令格式 | 248行 | 🔴 高 - 无法实现 |
| 充电结束上报回复 | 平台响应格式 | 316-317行 | 🟡 中 - 可能仅需ACK |
| 按功率充电回复 | 设备响应详细格式 | 345行 | 🟡 中 - 仅注明业务号 |

---

## 📦 数据库变更需求

### 需要新增的表

1. **cards** - 卡片管理
2. **card_transactions** - 卡片交易记录
3. **ota_tasks** - OTA升级任务
4. **gateway_sockets** - 网关插座组网关系
5. **device_param_writes** - 设备参数写入记录
6. **device_exceptions** - 设备异常事件
7. **device_voice_configs** - 语音播报配置

### 需要扩展的表

```sql
-- orders 表扩展
ALTER TABLE orders ADD COLUMN card_no VARCHAR(20);
ALTER TABLE orders ADD COLUMN charging_mode SMALLINT;
ALTER TABLE orders ADD COLUMN spent_cents INTEGER;
ALTER TABLE orders ADD COLUMN settlement_power INTEGER;
ALTER TABLE orders ADD COLUMN electric_fee_cents INTEGER;
ALTER TABLE orders ADD COLUMN service_fee_cents INTEGER;
ALTER TABLE orders ADD COLUMN fee_level_usage JSONB;
```

---

## 🧪 测试覆盖度

### 现有测试文件

- ✅ `adapter_test.go` - 适配器测试
- ✅ `parser_test.go` - 解析器测试
- ✅ `handlers_test.go` - 处理器基础测试
- ✅ `tlv_test.go` - TLV解析测试

### 缺失的测试

- ❌ `card_charging_test.go` - 刷卡充电流程
- ❌ `ota_test.go` - OTA升级流程
- ❌ `network_management_test.go` - 组网管理
- ❌ `service_fee_test.go` - 服务费计费
- ❌ `param_persistence_test.go` - 参数持久化

---

## 🛠️ 开发指南

### 快速开始

1. **阅读分析报告**: [BKV协议完整性分析报告.md](./BKV协议完整性分析报告.md)
2. **查看任务清单**: [待实现功能清单.md](./待实现功能清单.md)
3. **选择任务**: 从 Phase 1 的高优先级任务开始
4. **创建分支**: `git checkout -b feature/bkv-{功能名}`
5. **参考协议文档**: `docs/协议/设备对接指引-组网设备2024(1).txt`

### 代码规范

```go
// 处理器命名规范
func (h *Handlers) Handle{功能名}(ctx context.Context, f *Frame) error

// 编码器命名规范
func Encode{功能名}Command(params) ([]byte, error)

// 解析器命名规范
func Parse{功能名}Response(data []byte) (*Result, error)

// 测试文件命名规范
{功能名}_test.go
```

### 提交规范

```bash
# 功能实现
git commit -m "feat(bkv): 实现刷卡充电流程"

# Bug修复
git commit -m "fix(bkv): 修复参数存储重启丢失问题"

# 测试补充
git commit -m "test(bkv): 添加刷卡充电集成测试"

# 文档更新
git commit -m "docs(bkv): 更新刷卡充电对接文档"
```

---

## 📞 联系方式

- **技术讨论**: 见团队 Wiki
- **问题反馈**: 提交 Issue 或 PR
- **文档维护**: 发现问题请及时更新

---

## 🔄 更新记录

| 日期 | 版本 | 更新内容 | 作者 |
|------|------|---------|------|
| 2025-10-05 | v1.0 | 初始版本，完成协议完整性分析 | AI Assistant |
| 2025-10-05 | v1.1 | 发现命令0x0F遗漏，补充协议约束和状态位解析 | AI Assistant |
| 2025-10-05 | v1.2 | 补充数据单位转换、协议格式、代码示例（3轮检查完成） | AI Assistant |

## 📝 重要发现总结

### 🔴 关键遗漏

1. **命令 0x0F（设备回应订单）** - 刷卡充电流程第3步，完全遗漏
2. **插座状态位解析** - 8位状态位影响业务判断，需要正确解析

### ⚠️ 协议文档问题

1. 删除插座命令（0x0A）- 文档仅写"略"
2. 充电结束回复 - 文档标注"略"
3. 按功率充电回复 - 文档标注"略"

### 📊 协议约束

1. 插座编号：1-250（同网关不重复）
2. 充电时长：1-900分钟
3. 信道：1-15
4. 心跳周期：1分钟
5. 状态上报：5分钟（状态变化立即上报）

---

**下一步行动**:

1. ✅ 完成协议完整性分析（含遗漏检查）
2. ✅ 生成待实现功能清单
3. ⏳ **与设备厂商确认3处"略"标注** ← 优先，阻塞开发
4. ⏳ 召开技术评审会
5. ⏳ 分配任务和责任人
6. ⏳ 开始 Phase 1 开发

---

*此文档由自动化工具生成，定期同步更新。如有问题，请查看详细分析报告。*
