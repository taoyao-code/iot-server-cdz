# IoTå……ç”µæ¡©æœåŠ¡å™¨ - å®Œæ•´é¡¹ç›®åˆ†ææŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-11-11  
> **åˆ†æèŒƒå›´**: æ¶æ„è®¾è®¡ | æ•°æ®æµå›¾ | ä¸‰å±‚ç³»ç»Ÿ | æ ¸å¿ƒç»„ä»¶  
> **é¡¹ç›®è·¯å¾„**: `/Users/zhanghai/code/å……ç”µæ¡©/iot-server`

---

## ğŸ“Š ä¸€ã€é¡¹ç›®æ¦‚è§ˆ

### 1.1 åŸºæœ¬ä¿¡æ¯

| é¡¹ç›®å±æ€§ | ä¿¡æ¯ |
|---------|------|
| **é¡¹ç›®åç§°** | IoTå……ç”µæ¡©ç‰©è”ç½‘æœåŠ¡å™¨ |
| **æŠ€æœ¯æ ˆ** | Go 1.25.4 + PostgreSQL + Redis |
| **æ¶æ„æ¨¡å¼** | äº‹ä»¶é©±åŠ¨ + å¾®æœåŠ¡åŒ– + å¤šåè®®é€‚é… |
| **éƒ¨ç½²æ–¹å¼** | Docker Compose (ç”Ÿäº§ç¯å¢ƒæ”¯æŒK8s) |
| **æ ¸å¿ƒèƒ½åŠ›** | 50,000+ å¹¶å‘è¿æ¥ã€å¤šåè®®æ”¯æŒã€å¼‚æ­¥å‘½ä»¤é˜Ÿåˆ— |
| **å­˜å‚¨ç­–ç•¥** | PostgreSQL(æŒä¹…åŒ–) + Redis(ä¼šè¯/é˜Ÿåˆ—) |

### 1.2 ç³»ç»Ÿå®šä½

**æœ¬ç³»ç»Ÿæ˜¯å……ç”µè®¾å¤‡ä¸ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ä¸­é—´ä»¶**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿ   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ IoTä¸­é—´ä»¶    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ å……ç”µè®¾å¤‡    â”‚
â”‚ (ç”¨æˆ·/æ”¯ä»˜/è´¦æˆ·) â”‚  HTTP    â”‚ (æœ¬ç³»ç»Ÿ)     â”‚  TCP    â”‚ (BKV/AP3000)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŒè´£åˆ’åˆ†**:
- âœ… **æœ¬ç³»ç»Ÿ**: è®¾å¤‡è¿æ¥ã€åè®®é€‚é…ã€çŠ¶æ€åŒæ­¥ã€æŒ‡ä»¤è½¬å‘ã€äº‹ä»¶æ¨é€
- âŒ **ä¸è´Ÿè´£**: ç”¨æˆ·è®¤è¯ã€æ”¯ä»˜æ‰£æ¬¾ã€è´¦æˆ·ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™åˆ¶å®š

---

## ğŸ—ï¸ äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IoT å……ç”µæ¡©æœåŠ¡å™¨ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  TCP ç½‘å…³        â”‚              â”‚  HTTP API        â”‚        â”‚
â”‚  â”‚  (ç«¯å£ 6000)     â”‚              â”‚  (ç«¯å£ 7055)     â”‚        â”‚
â”‚  â”‚                  â”‚              â”‚                  â”‚        â”‚
â”‚  â”‚  â€¢ è¿æ¥é™æµ      â”‚              â”‚  â€¢ ç¬¬ä¸‰æ–¹API     â”‚        â”‚
â”‚  â”‚  â€¢ é€Ÿç‡é™åˆ¶      â”‚              â”‚  â€¢ å¥åº·æ£€æŸ¥      â”‚        â”‚
â”‚  â”‚  â€¢ ç†”æ–­å™¨        â”‚              â”‚  â€¢ Metrics       â”‚        â”‚
â”‚  â”‚  â€¢ åè®®æ£€æµ‹      â”‚              â”‚  â€¢ OTAç®¡ç†       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                                 â”‚                  â”‚
â”‚           â”œâ”€â–º Mux (åè®®å¤šè·¯å¤ç”¨)            â”‚                  â”‚
â”‚           â”‚   â€¢ é­”æœ¯å­—èŠ‚æ£€æµ‹                â”‚                  â”‚
â”‚           â”‚   â€¢ åŠ¨æ€åè®®åˆ†å‘                â”‚                  â”‚
â”‚           â”‚                                 â”‚                  â”‚
â”‚           â”œâ”€â–º åè®®é€‚é…å™¨å±‚                  â”‚                  â”‚
â”‚           â”‚   â”œâ”€ AP3000 Adapter            â”‚                  â”‚
â”‚           â”‚   â”œâ”€ BKV Adapter               â”‚                  â”‚
â”‚           â”‚   â””â”€ GN Adapter                â”‚                  â”‚
â”‚           â”‚                                 â”‚                  â”‚
â”‚           â””â”€â–º ä¼šè¯ç®¡ç†å™¨ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚               (Redis æ”¯æŒåˆ†å¸ƒå¼)                               â”‚
â”‚               â€¢ Bind/Unbind                                    â”‚
â”‚               â€¢ IsOnline (åŠ æƒè¯„åˆ†)                            â”‚
â”‚               â€¢ GetConn                                        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              æ•°æ®æŒä¹…åŒ–å±‚                                 â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚                                                           â”‚â”‚
â”‚  â”‚  PostgreSQL                    Redis                     â”‚â”‚
â”‚  â”‚  â”œâ”€ devices (è®¾å¤‡åŸºç¡€ä¿¡æ¯)      â”œâ”€ session:device:{id}   â”‚â”‚
â”‚  â”‚  â”œâ”€ ports (ç«¯å£çŠ¶æ€å¿«ç…§)        â”œâ”€ outbound:queue        â”‚â”‚
â”‚  â”‚  â”œâ”€ orders (è®¢å•ç”Ÿå‘½å‘¨æœŸ)       â”œâ”€ outbound:processing   â”‚â”‚
â”‚  â”‚  â”œâ”€ cmd_log (æŒ‡ä»¤æ—¥å¿—)          â”œâ”€ outbound:dead         â”‚â”‚
â”‚  â”‚  â”œâ”€ outbound_queue (ä¸‹è¡Œé˜Ÿåˆ—)   â””â”€ event:queue           â”‚â”‚
â”‚  â”‚  â”œâ”€ events (äº‹ä»¶æ¨é€Outbox)                              â”‚â”‚
â”‚  â”‚  â”œâ”€ cards (å……ç”µå¡ç®¡ç†)                                   â”‚â”‚
â”‚  â”‚  â”œâ”€ card_transactions (åˆ·å¡äº¤æ˜“)                         â”‚â”‚
â”‚  â”‚  â”œâ”€ gateway_sockets (ç»„ç½‘æ’åº§)                           â”‚â”‚
â”‚  â”‚  â””â”€ ota_tasks (OTAå‡çº§ä»»åŠ¡)                              â”‚â”‚
â”‚  â”‚                                                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              åå°å·¥ä½œçº¿ç¨‹ (Goroutines)                    â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  â€¢ RedisWorker (ä¸‹è¡Œé˜Ÿåˆ—è½®è¯¢ - 100ms)                    â”‚â”‚
â”‚  â”‚  â€¢ EventQueueWorkers (Webhookæ¨é€ - å¹¶å‘5)              â”‚â”‚
â”‚  â”‚  â€¢ EventPusher (Outboxæ¨¡å¼æ¨é€ - 10s)                    â”‚â”‚
â”‚  â”‚  â€¢ OrderMonitor (è®¢å•è¶…æ—¶ç›‘æ§ - 1min)                    â”‚â”‚
â”‚  â”‚  â€¢ PortStatusSyncer (ç«¯å£çŠ¶æ€åŒæ­¥ - 5min)                â”‚â”‚
â”‚  â”‚  â€¢ DeadLetterCleaner (æ­»ä¿¡é˜Ÿåˆ—æ¸…ç† - 1h)                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¶æ„æ¨¡å¼

#### æ¨¡å¼1: åè®®é€‚é…å™¨æ¨¡å¼ (å¯æ’æ‹”åè®®)

```go
type Adapter interface {
    Sniff(prefix []byte) bool          // åè®®å—…æ¢
    Process(ctx ConnContext, data []byte) // æ•°æ®å¤„ç†
}

// å®ç°å±‚
- AP3000Adapter: é­”æœ¯å­—èŠ‚ [0x44, 0x22, 0x4E]
- BKVAdapter: é­”æœ¯å­—èŠ‚ [0xFC, 0xFE/0xFF]
- GNAdapter: ç»„ç½‘åè®®
```

**å·¥ä½œæµç¨‹**:
```
TCPæµ â†’ Mux.onRead(å‰8å­—èŠ‚)
      â†’ for adapter in [AP3000, BKV, GN]:
          if adapter.Sniff(prefix):
              ç»‘å®šæ­¤adapter
              åç»­æ•°æ®ä»…å‘å¾€æ­¤adapter
```

#### æ¨¡å¼2: å¼‚æ­¥å‘½ä»¤ä¼ é€’æ¨¡å¼ (è§£è€¦éé˜»å¡)

```
HTTP APIè¯·æ±‚
    â†“
å…¥é˜ŸRedis (202 Accepted)
    â†“
RedisWorkerè½®è¯¢(100ms)
    â†“
æ£€æŸ¥è®¾å¤‡åœ¨çº¿
    â†“
å†™å…¥TCP Socket
    â†“
ç­‰å¾…ACKç¡®è®¤
```

**ä¼˜åŠ¿**:
- âœ… APIå¿«é€Ÿå“åº” (ä¸é˜»å¡ç­‰å¾…è®¾å¤‡)
- âœ… å‘½ä»¤æŒä¹…åŒ– (è¿›ç¨‹é‡å¯ä¸ä¸¢å¤±)
- âœ… è‡ªåŠ¨é‡è¯• (å¤±è´¥æœ€å¤š3æ¬¡)
- âœ… æ­»ä¿¡é˜Ÿåˆ— (äººå·¥ä»‹å…¥)

#### æ¨¡å¼3: åŠ æƒåœ¨çº¿æ£€æµ‹ (å¤šä¿¡å·è¯„åˆ†)

```go
åœ¨çº¿åˆ†æ•° = 
    + å¿ƒè·³æ–°é²œåº¦å¾—åˆ† (0-1.0, 60ç§’è¶…æ—¶)
    - TCPæ–­å¼€æƒ©ç½š (-0.2, æœ€è¿‘5åˆ†é’Ÿ)
    - ACKè¶…æ—¶æƒ©ç½š (-0.3, æœ€è¿‘5åˆ†é’Ÿ)

åœ¨çº¿åˆ¤å®š: score >= 0.5
```

**åœºæ™¯å¤„ç†**:
- è®¾å¤‡åˆšæ–­å¼€: å¿ƒè·³0.8 - æ–­å¼€0.2 = 0.6 (åœ¨çº¿)
- è®¾å¤‡é•¿æœŸç¦»çº¿: å¿ƒè·³0.0 - æ–­å¼€0.2 = -0.2 (ç¦»çº¿)
- ç½‘ç»œæŠ–åŠ¨: å¿ƒè·³1.0 - ACKè¶…æ—¶0.3 = 0.7 (åœ¨çº¿)

#### æ¨¡å¼4: ä¼˜å…ˆçº§é˜Ÿåˆ— + é™çº§ç­–ç•¥ (èƒŒå‹æ§åˆ¶)

```
é˜Ÿåˆ—é•¿åº¦    | ç­–ç•¥
-----------|-----------------------
0-200      | æ¥å—æ‰€æœ‰å‘½ä»¤
200-500    | æ‹’ç»ä½ä¼˜å…ˆçº§ (priority>5)
500-1000   | ä»…æ¥å—æ­£å¸¸/é«˜ä¼˜å…ˆçº§ (priorityâ‰¤2)
>1000      | ä»…æ¥å—ç´§æ€¥å‘½ä»¤ (priority=0)

åˆ†æ•°è®¡ç®—: priority Ã— 10Â¹Â² + unixnano
```

---

## ğŸ“Š ä¸‰ã€æ•°æ®æµå›¾

### 3.1 å…¥ç«™æ¶ˆæ¯æµ (è®¾å¤‡ â†’ æœåŠ¡å™¨)

```
                    å……ç”µè®¾å¤‡
                       â†“
              TCPè¿æ¥ (ç«¯å£6000)
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  TCPServer.Accept()      â”‚
        â”‚  åˆ›å»º ConnContext        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Mux.BindToConn()        â”‚
        â”‚  è¯»å–å‰8å­—èŠ‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  åè®®æ£€æµ‹ (Sniff)        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  AP3000? â†’ AP3000Adapter â”‚
        â”‚  BKV?    â†’ BKVAdapter    â”‚
        â”‚  GN?     â†’ GNAdapter     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  StreamDecoder.Feed()    â”‚
        â”‚  å¤„ç†åˆ†å¸§/åŠåŒ…           â”‚
        â”‚  â†’ [Frame1, Frame2, ...] â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  RouterTable.Route()     â”‚
        â”‚  handlers[frame.Cmd]     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ä¸šåŠ¡å¤„ç†å™¨              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  â€¢ HandleRegister()      â”‚
        â”‚  â€¢ HandleHeartbeat()     â”‚
        â”‚  â€¢ HandleControl()       â”‚
        â”‚  â€¢ HandleChargeReport()  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ•°æ®æŒä¹…åŒ–              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  â€¢ EnsureDevice(phyID)   â”‚
        â”‚  â€¢ UpsertPortState()     â”‚
        â”‚  â€¢ UpsertOrderProgress() â”‚
        â”‚  â€¢ InsertCmdLog()        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ­¥éª¤**:
1. **TCPè¿æ¥å»ºç«‹**: é™æµæ£€æŸ¥ â†’ é€Ÿç‡é™åˆ¶ â†’ ç†”æ–­å™¨
2. **åè®®æ£€æµ‹**: ä¸€æ¬¡æ€§æ£€æµ‹,æ°¸ä¹…ç»‘å®š
3. **æµå¼è§£ç **: å¤„ç†TCPç²˜åŒ…/åŠåŒ…
4. **è·¯ç”±åˆ†å‘**: å‘½ä»¤ç  â†’ å¤„ç†å™¨æ˜ å°„
5. **ä¸šåŠ¡å¤„ç†**: çŠ¶æ€æ›´æ–° + äº‹ä»¶æ¨é€
6. **æ•°æ®æŒä¹…åŒ–**: UPSERTç¡®ä¿å¹‚ç­‰æ€§

### 3.2 å‡ºç«™æ¶ˆæ¯æµ (æœåŠ¡å™¨ â†’ è®¾å¤‡)

```
    ç¬¬ä¸‰æ–¹ç³»ç»Ÿ
        â†“
    POST /api/v1/third/devices/{id}/charge
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ThirdPartyHandler          â”‚
â”‚ 1. æ£€æŸ¥è®¾å¤‡åœ¨çº¿            â”‚
â”‚ 2. æ£€æŸ¥ç«¯å£å ç”¨(è¡Œé”)      â”‚
â”‚ 3. åˆ›å»ºè®¢å•(DB)            â”‚
â”‚ 4. æ„å»ºåè®®å‘½ä»¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OutboundAdapter            â”‚
â”‚ 1. ç¼–ç å¸§ (bkv.Build)      â”‚
â”‚ 2. è®¡ç®—ä¼˜å…ˆçº§              â”‚
â”‚ 3. åˆ›å»ºOutboundMessage     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RedisQueue.Enqueue()       â”‚
â”‚ 1. æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦(é™çº§)      â”‚
â”‚ 2. ZADD outbound:queue     â”‚
â”‚ 3. è¿”å› 202 Accepted       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ RedisWorker (æŒç»­è½®è¯¢)       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 1. ZPOPMIN (åŸå­å‡ºé˜Ÿ)        â•‘
â•‘ 2. sess.GetConn(phyID)       â•‘
â•‘ 3. connContext.Write(frame)  â•‘
â•‘ 4. ç­‰å¾…ACK (10ç§’è¶…æ—¶)        â•‘
â•‘ 5. æˆåŠŸ â†’ MarkSuccess        â•‘
â•‘ 6. å¤±è´¥ â†’ é‡è¯•(æœ€å¤š3æ¬¡)      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â†“
       è®¾å¤‡æ¥æ”¶
           â†“
       è¿”å›ACK
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HandleACK                  â”‚
â”‚ 1. repo.AckOutbound()      â”‚
â”‚ 2. æ›´æ–°è®¢å•çŠ¶æ€            â”‚
â”‚ 3. è§¦å‘äº‹ä»¶æ¨é€            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ£€æŸ¥ç‚¹**:
- **P0æ£€æŸ¥**: è®¾å¤‡å¿…é¡»åœ¨çº¿ (60ç§’å†…æœ‰å¿ƒè·³)
- **P1-3æ£€æŸ¥**: ç«¯å£å ç”¨å†²çª (äº‹åŠ¡+è¡Œé” FOR UPDATE)
- **P1-2æ£€æŸ¥**: å»¶è¿ŸACKæ‹’ç» (10ç§’çª—å£)
- **é™çº§ç­–ç•¥**: é˜Ÿåˆ—è¿‡è½½æ—¶æ‹’ç»ä½ä¼˜å…ˆçº§å‘½ä»¤

### 3.3 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
è®¾å¤‡è¿æ¥
    â†“
TCP Accept
    â†“
åˆ›å»º ConnContext
    â†“
æ¥æ”¶ç¬¬ä¸€æ¡æ¶ˆæ¯ (é€šå¸¸æ˜¯æ³¨å†Œ/å¿ƒè·³)
    â†“
sess.Bind(phyID, connContext)
    â”œâ”€ ç”Ÿæˆ connID (UUID)
    â”œâ”€ Redis: session:device:{phyID}
    â”œâ”€ Redis: session:conn:{connID}
    â””â”€ æœ¬åœ°ç¼“å­˜: localConn[connID]
    â†“
åç»­å¿ƒè·³ (æ¯30ç§’)
    â†“
sess.OnHeartbeat(phyID, now)
    â””â”€ Redis: æ›´æ–° lastSeen
    â†“
è®¾å¤‡æ–­å¼€
    â†“
ConnContext.Done() ä¿¡å·
    â†“
sess.UnbindByPhy(phyID)
    â”œâ”€ åˆ é™¤æœ¬åœ°ç¼“å­˜
    â”œâ”€ Redis: åˆ é™¤ä¼šè¯æ•°æ®
    â””â”€ è®°å½• lastTCPDown
```

**ä¼šè¯ç®¡ç†ç‰¹æ€§**:
- âœ… åˆ†å¸ƒå¼æ”¯æŒ (Rediså­˜å‚¨,å¤šå®ä¾‹å…±äº«)
- âœ… è‡ªåŠ¨è¿‡æœŸ (TTL = 2 Ã— å¿ƒè·³è¶…æ—¶)
- âœ… æ•…éšœæ¢å¤ (è¿ç»­3æ¬¡å¿ƒè·³+ç«¯å£æ­£å¸¸ â†’ æ¢å¤)
- âœ… åŠ æƒè¯„åˆ† (å¿ƒè·³/æ–­å¼€/è¶…æ—¶ ç»¼åˆåˆ¤å®š)

---

## ğŸ¢ å››ã€ä¸‰å±‚ç³»ç»Ÿæ¶æ„

### 4.1 è¡¨ç¤ºå±‚ (Presentation Layer)

**èŒè´£**: æ¥æ”¶å¤–éƒ¨è¯·æ±‚ã€åè®®è½¬æ¢ã€å“åº”è¿”å›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è¡¨ç¤ºå±‚ (Presentation)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ã€HTTP API å±‚ã€‘                         â”‚
â”‚  â”œâ”€ ç¬¬ä¸‰æ–¹API (internal/api/)           â”‚
â”‚  â”‚  â”œâ”€ thirdparty_handler.go           â”‚
â”‚  â”‚  â”‚  â”œâ”€ POST /order/create           â”‚
â”‚  â”‚  â”‚  â”œâ”€ POST /order/stop             â”‚
â”‚  â”‚  â”‚  â”œâ”€ POST /order/cancel           â”‚
â”‚  â”‚  â”‚  â””â”€ GET  /order/query            â”‚
â”‚  â”‚  â””â”€ readonly_handler.go             â”‚
â”‚  â”‚     â”œâ”€ GET /devices                 â”‚
â”‚  â”‚     â””â”€ GET /devices/{id}/status     â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ è®¤è¯ä¸­é—´ä»¶ (middleware/)            â”‚
â”‚  â”‚  â”œâ”€ API Key éªŒè¯                    â”‚
â”‚  â”‚  â””â”€ HMAC ç­¾åéªŒè¯                   â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ å¥åº·æ£€æŸ¥ (health/)                  â”‚
â”‚     â”œâ”€ GET /healthz  (å­˜æ´»)            â”‚
â”‚     â”œâ”€ GET /readyz   (å°±ç»ª)            â”‚
â”‚     â””â”€ GET /metrics  (Prometheus)      â”‚
â”‚                                         â”‚
â”‚  ã€TCP ç½‘å…³å±‚ã€‘                          â”‚
â”‚  â”œâ”€ TCP Server (tcpserver/)            â”‚
â”‚  â”‚  â”œâ”€ server.go    (ç›‘å¬å™¨)          â”‚
â”‚  â”‚  â”œâ”€ conn.go      (è¿æ¥åŒ…è£…)        â”‚
â”‚  â”‚  â”œâ”€ limiter.go   (è¿æ¥é™æµ)        â”‚
â”‚  â”‚  â”œâ”€ rate_limiter.go (é€Ÿç‡é™åˆ¶)     â”‚
â”‚  â”‚  â””â”€ circuit_breaker.go (ç†”æ–­)      â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ åè®®å¤šè·¯å¤ç”¨ (gateway/)             â”‚
â”‚     â””â”€ mux.go (åè®®æ£€æµ‹ä¸åˆ†å‘)          â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**:
- RESTful API è®¾è®¡
- Swagger æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- ä¸­é—´ä»¶é“¾å¼å¤„ç†
- é™æµ/ç†”æ–­ä¿æŠ¤
- åè®®è‡ªåŠ¨æ£€æµ‹

### 4.2 ä¸šåŠ¡å±‚ (Business Layer)

**èŒè´£**: ä¸šåŠ¡é€»è¾‘å¤„ç†ã€çŠ¶æ€ç®¡ç†ã€äº‹ä»¶ç¼–æ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¸šåŠ¡å±‚ (Business)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ã€åè®®å¤„ç†å±‚ã€‘                          â”‚
â”‚  â”œâ”€ AP3000åè®® (protocol/ap3000/)       â”‚
â”‚  â”‚  â”œâ”€ adapter.go    (é€‚é…å™¨)          â”‚
â”‚  â”‚  â”œâ”€ parser.go     (è§£æå™¨)          â”‚
â”‚  â”‚  â”œâ”€ decoder.go    (è§£ç å™¨)          â”‚
â”‚  â”‚  â”œâ”€ handlers.go   (å¤„ç†å™¨)          â”‚
â”‚  â”‚  â””â”€ router_table.go (è·¯ç”±è¡¨)        â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ BKVåè®® (protocol/bkv/)             â”‚
â”‚  â”‚  â”œâ”€ adapter.go    (é€‚é…å™¨)          â”‚
â”‚  â”‚  â”œâ”€ parser.go     (è§£æå™¨)          â”‚
â”‚  â”‚  â”œâ”€ decoder.go    (è§£ç å™¨)          â”‚
â”‚  â”‚  â”œâ”€ handlers.go   (å¤„ç†å™¨,1500è¡Œ)   â”‚
â”‚  â”‚  â”œâ”€ router.go     (è·¯ç”±è¡¨)          â”‚
â”‚  â”‚  â””â”€ reason_map.go (é”™è¯¯ç æ˜ å°„)      â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ GNç»„ç½‘åè®® (protocol/gn/)           â”‚
â”‚     â”œâ”€ adapter.go                       â”‚
â”‚     â”œâ”€ business.go                      â”‚
â”‚     â””â”€ router.go                        â”‚
â”‚                                         â”‚
â”‚  ã€ä¸šåŠ¡æœåŠ¡å±‚ã€‘                          â”‚
â”‚  â”œâ”€ è®¢å•æœåŠ¡ (service/)                 â”‚
â”‚  â”‚  â”œâ”€ card_service.go (åˆ·å¡å……ç”µ)      â”‚
â”‚  â”‚  â””â”€ pricing_engine.go (è®¡è´¹å¼•æ“)    â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ ä¼šè¯ç®¡ç† (session/)                 â”‚
â”‚  â”‚  â”œâ”€ interface.go   (æ¥å£å®šä¹‰)       â”‚
â”‚  â”‚  â””â”€ redis_manager.go (Rediså®ç°)    â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ ä¸‹è¡Œé˜Ÿåˆ— (outbound/)                â”‚
â”‚  â”‚  â”œâ”€ redis_worker.go (è½®è¯¢å™¨)        â”‚
â”‚  â”‚  â””â”€ priority.go    (ä¼˜å…ˆçº§è®¡ç®—)     â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ äº‹ä»¶æ¨é€ (thirdparty/)              â”‚
â”‚     â”œâ”€ pusher.go      (æ¨é€å™¨)          â”‚
â”‚     â”œâ”€ event_queue.go (äº‹ä»¶é˜Ÿåˆ—)        â”‚
â”‚     â””â”€ deduper.go     (å»é‡å™¨)          â”‚
â”‚                                         â”‚
â”‚  ã€åå°ä»»åŠ¡å±‚ã€‘                          â”‚
â”‚  â”œâ”€ OrderMonitor      (è®¢å•ç›‘æ§)       â”‚
â”‚  â”œâ”€ PortStatusSyncer  (ç«¯å£åŒæ­¥)       â”‚
â”‚  â”œâ”€ EventPusher       (Outboxæ¨é€)     â”‚
â”‚  â””â”€ DeadLetterCleaner (æ­»ä¿¡æ¸…ç†)       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä¸šåŠ¡æµç¨‹**:

1. **è®¢å•åˆ›å»ºæµç¨‹**:
   ```
   æ£€æŸ¥è®¾å¤‡åœ¨çº¿ â†’ æ£€æŸ¥ç«¯å£å ç”¨ â†’ åˆ›å»ºè®¢å• â†’ å…¥é˜Ÿå‘½ä»¤ â†’ è¿”å›202
   ```

2. **å……ç”µæ§åˆ¶æµç¨‹**:
   ```
   è§£æå‘½ä»¤ â†’ ç¼–ç å¸§ â†’ å‘é€TCP â†’ ç­‰å¾…ACK â†’ æ›´æ–°çŠ¶æ€ â†’ æ¨é€äº‹ä»¶
   ```

3. **çŠ¶æ€åŒæ­¥æµç¨‹**:
   ```
   è®¾å¤‡ä¸ŠæŠ¥ â†’ è§£æçŠ¶æ€ â†’ æ›´æ–°DB â†’ è§¦å‘äº‹ä»¶ â†’ Webhookæ¨é€
   ```

### 4.3 æ•°æ®å±‚ (Data Layer)

**èŒè´£**: æ•°æ®æŒä¹…åŒ–ã€ç¼“å­˜ç®¡ç†ã€é˜Ÿåˆ—å­˜å‚¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®å±‚ (Data)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ã€PostgreSQL å­˜å‚¨ã€‘                     â”‚
â”‚  â”œâ”€ æ•°æ®åº“è¿æ¥æ±  (storage/pg/)          â”‚
â”‚  â”‚  â”œâ”€ pool.go      (è¿æ¥æ± ç®¡ç†)       â”‚
â”‚  â”‚  â””â”€ repo.go      (ä»“å‚¨å±‚,700è¡Œ)     â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ æ ¸å¿ƒè¡¨ç»“æ„                          â”‚
â”‚  â”‚  â”œâ”€ devices      (è®¾å¤‡åŸºç¡€ä¿¡æ¯)     â”‚
â”‚  â”‚  â”œâ”€ ports        (ç«¯å£çŠ¶æ€å¿«ç…§)     â”‚
â”‚  â”‚  â”œâ”€ orders       (è®¢å•ç”Ÿå‘½å‘¨æœŸ)     â”‚
â”‚  â”‚  â”œâ”€ cmd_log      (æŒ‡ä»¤æ—¥å¿—)         â”‚
â”‚  â”‚  â”œâ”€ outbound_queue (ä¸‹è¡Œé˜Ÿåˆ—å¤‡ä»½)   â”‚
â”‚  â”‚  â”œâ”€ events       (äº‹ä»¶Outbox)       â”‚
â”‚  â”‚  â”œâ”€ cards        (å……ç”µå¡)           â”‚
â”‚  â”‚  â”œâ”€ card_transactions (åˆ·å¡äº¤æ˜“)    â”‚
â”‚  â”‚  â”œâ”€ gateway_sockets (ç»„ç½‘æ’åº§)      â”‚
â”‚  â”‚  â””â”€ ota_tasks    (OTAå‡çº§)          â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ æ•°æ®åº“è¿ç§» (db/migrations/)         â”‚
â”‚     â””â”€ 012_events_outbox.sql (æœ€æ–°)    â”‚
â”‚                                         â”‚
â”‚  ã€Redis ç¼“å­˜/é˜Ÿåˆ—ã€‘                     â”‚
â”‚  â”œâ”€ Rediså®¢æˆ·ç«¯ (storage/redis/)        â”‚
â”‚  â”‚  â”œâ”€ client.go                       â”‚
â”‚  â”‚  â””â”€ outbound_queue.go               â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ ä¼šè¯æ•°æ®                            â”‚
â”‚  â”‚  â”œâ”€ session:device:{phyID}          â”‚
â”‚  â”‚  â”œâ”€ session:conn:{connID}           â”‚
â”‚  â”‚  â””â”€ session:server:{serverID}:conns â”‚
â”‚  â”‚                                      â”‚
â”‚  â”œâ”€ ä¸‹è¡Œé˜Ÿåˆ—                            â”‚
â”‚  â”‚  â”œâ”€ outbound:queue (Sorted Set)     â”‚
â”‚  â”‚  â”œâ”€ outbound:processing:{phyID}     â”‚
â”‚  â”‚  â””â”€ outbound:dead (æ­»ä¿¡é˜Ÿåˆ—)        â”‚
â”‚  â”‚                                      â”‚
â”‚  â””â”€ äº‹ä»¶é˜Ÿåˆ—                            â”‚
â”‚     â””â”€ event:queue                     â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®åº“è®¾è®¡äº®ç‚¹**:

1. **å¤åˆç´¢å¼•ä¼˜åŒ–**:
   ```sql
   CREATE INDEX idx_orders_device_created ON orders(device_id, created_at DESC);
   CREATE INDEX idx_devices_last_seen ON devices(last_seen_at DESC);
   CREATE INDEX idx_events_status_created ON events(status, created_at);
   ```

2. **è¡Œé”é˜²å†²çª** (P1-3ä¿®å¤):
   ```sql
   SELECT * FROM ports 
   WHERE device_id = ? AND port_no = ? 
   FOR UPDATE;  -- äº‹åŠ¡è¡Œé”
   ```

3. **UPSERTå¹‚ç­‰æ€§**:
   ```sql
   INSERT INTO ports (device_id, port_no, status) 
   VALUES (?, ?, ?)
   ON CONFLICT (device_id, port_no) 
   DO UPDATE SET status = EXCLUDED.status;
   ```

4. **Outboxäº‹ä»¶æ¨¡å¼** (P1-7ä¿®å¤):
   ```sql
   -- äº‹ä»¶è¡¨æ”¯æŒå¯é æ¨é€
   CREATE TABLE events (
       order_no VARCHAR(32),
       event_type VARCHAR(32),
       sequence_no INT,  -- é¡ºåºä¿è¯
       status INT,       -- 0=å¾…æ¨é€,1=å·²æ¨é€,2=å¤±è´¥
       retry_count INT
   );
   ```

**Redisé”®è®¾è®¡**:
```
session:device:GW001     â†’ {"conn_id":"uuid","last_seen":"2025-11-11T12:00:00Z"}
outbound:queue           â†’ SortedSet[(score, msgID)]
outbound:processing:GW001 â†’ Hash[msgID â†’ message]
outbound:dead            â†’ List[failed_messages]
```

---

## ğŸ”„ äº”ã€9é˜¶æ®µå¯åŠ¨åºåˆ—

### 5.1 å¯åŠ¨ç¼–æ’ (bootstrap/app.go)

```
                    å¯åŠ¨
                     â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ1: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–        â•‘
    â•‘  â€¢ Metrics æ³¨å†Œè¡¨             â•‘
    â•‘  â€¢ Ready è·Ÿè¸ªå™¨               â•‘
    â•‘  â€¢ ServerID ç”Ÿæˆ (UUID)       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ2: Rediså®¢æˆ·ç«¯           â•‘  â† å¿…éœ€
    â•‘  â€¢ è¿æ¥åˆ° Redis               â•‘
    â•‘  â€¢ å¿«é€Ÿå¤±è´¥ (æ— Redisä¸å¯åŠ¨)   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ3: ä¼šè¯ç®¡ç†å™¨            â•‘
    â•‘  â€¢ åˆ›å»º RedisManager          â•‘
    â•‘  â€¢ åˆå§‹åŒ–åœ¨çº¿æ£€æµ‹ç­–ç•¥         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ4: æ•°æ®åº“                â•‘  â† å¿…éœ€
    â•‘  â€¢ è¿æ¥ PostgreSQL            â•‘
    â•‘  â€¢ è¿è¡Œ migrations            â•‘
    â•‘  â€¢ è®¾ç½® DB å°±ç»ªæ ‡å¿—           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ5: ä¸šåŠ¡å¤„ç†å™¨            â•‘
    â•‘  â€¢ Repository ä»“å‚¨å±‚          â•‘
    â•‘  â€¢ EventQueue äº‹ä»¶é˜Ÿåˆ—        â•‘
    â•‘  â€¢ AP3000/BKV/GN Handlers     â•‘
    â•‘  â€¢ CardService åˆ·å¡æœåŠ¡       â•‘
    â•‘  â€¢ OutboundAdapter ä¸‹è¡Œé€‚é…   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ6: HTTPæœåŠ¡å™¨            â•‘  (åå°)
    â•‘  â€¢ æ³¨å†Œè·¯ç”±                   â•‘
    â•‘  â€¢ å¯åŠ¨ç›‘å¬ (éé˜»å¡)          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ7: åå°å·¥ä½œçº¿ç¨‹          â•‘  (åå°)
    â•‘  â€¢ RedisWorker (ä¸‹è¡Œé˜Ÿåˆ—)     â•‘
    â•‘  â€¢ EventQueueWorkers (æ¨é€)   â•‘
    â•‘  â€¢ EventPusher (Outbox)       â•‘
    â•‘  â€¢ OrderMonitor (ç›‘æ§)        â•‘
    â•‘  â€¢ PortStatusSyncer (åŒæ­¥)    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ8: TCPæœåŠ¡å™¨             â•‘  â† æœ€å!
    â•‘  â€¢ åˆ›å»ºç›‘å¬å™¨                 â•‘
    â•‘  â€¢ å¼€å§‹æ¥å—è¿æ¥ (é˜»å¡)        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  æ‰€æœ‰æœåŠ¡å°±ç»ª!                â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â†“
    ç­‰å¾… SIGTERM/SIGINT
                  â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  é˜¶æ®µ9: ä¼˜é›…å…³é—­              â•‘
    â•‘  â€¢ åœæ­¢æ¥å—æ–°è¿æ¥             â•‘
    â•‘  â€¢ ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ           â•‘
    â•‘  â€¢ æ¸…ç† Redis ä¼šè¯            â•‘
    â•‘  â€¢ å…³é—­æ•°æ®åº“è¿æ¥             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 5.2 å…³é”®è®¾è®¡å†³ç­–

**Q: ä¸ºä»€ä¹ˆTCPæœåŠ¡å™¨æœ€åå¯åŠ¨?**

A: ç¡®ä¿æ‰€æœ‰ä¾èµ–å°±ç»ªåå†æ¥å—è®¾å¤‡è¿æ¥,é¿å…:
- âŒ æ•°æ®åº“æœªå°±ç»ª â†’ æ— æ³•å­˜å‚¨è®¾å¤‡æ•°æ®
- âŒ Redisæœªå°±ç»ª â†’ æ— æ³•ç®¡ç†ä¼šè¯
- âŒ Handleræœªåˆå§‹åŒ– â†’ æ— æ³•å¤„ç†æ¶ˆæ¯

**Q: ä¸ºä»€ä¹ˆRediså’ŒPostgreSQLå¤±è´¥ç›´æ¥è¿”å›?**

A: è¿™ä¸¤ä¸ªæ˜¯å¼ºä¾èµ–,ç¼ºå¤±ä»»ä½•ä¸€ä¸ªç³»ç»Ÿæ— æ³•å·¥ä½œ:
- Redis: ä¼šè¯ç®¡ç†ã€å‘½ä»¤é˜Ÿåˆ—ã€äº‹ä»¶é˜Ÿåˆ—
- PostgreSQL: è®¾å¤‡æ•°æ®ã€è®¢å•æ•°æ®ã€æ—¥å¿—å®¡è®¡

**Q: ä¸ºä»€ä¹ˆHTTPå…ˆäºTCPå¯åŠ¨?**

A: HTTPæœåŠ¡æä¾›å¥åº·æ£€æŸ¥å’Œç®¡ç†æ¥å£,å…ˆå¯åŠ¨å¯ä»¥:
- âœ… K8sæ¢é’ˆç«‹å³å¯ç”¨
- âœ… ç›‘æ§ç³»ç»Ÿæå‰æ¥å…¥
- âœ… æ•…éšœæ’æŸ¥æ›´æ–¹ä¾¿

---

## ğŸ“¦ å…­ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 6.1 ä¼šè¯ç®¡ç†å™¨ (SessionManager)

**æ¥å£å®šä¹‰**:
```go
type SessionManager interface {
    Bind(phyID string, conn interface{}) error
    UnbindByPhy(phyID string)
    GetConn(phyID string) (interface{}, bool)
    IsOnline(phyID string) bool
    OnHeartbeat(phyID string, ts time.Time)
    OnTCPDown(phyID string, ts time.Time)
    OnAckTimeout(phyID string, ts time.Time)
}
```

**åŠ æƒåœ¨çº¿æ£€æµ‹ç®—æ³•**:
```go
func (m *RedisManager) IsOnline(phyID string) bool {
    sess := m.getSession(phyID)
    
    score := 0.0
    now := time.Now()
    
    // å¿ƒè·³æ–°é²œåº¦ (60ç§’å†… = 1.0)
    if now.Sub(sess.LastSeen) < 60*time.Second {
        score += 1.0
    }
    
    // TCPæ–­å¼€æƒ©ç½š (5åˆ†é’Ÿå†… -0.2)
    if sess.LastTCPDown != nil && now.Sub(*sess.LastTCPDown) < 5*time.Minute {
        score -= 0.2
    }
    
    // ACKè¶…æ—¶æƒ©ç½š (5åˆ†é’Ÿå†… -0.3)
    if sess.LastAckTimeout != nil && now.Sub(*sess.LastAckTimeout) < 5*time.Minute {
        score -= 0.3
    }
    
    return score >= 0.5
}
```

### 6.2 ä¸‹è¡Œé˜Ÿåˆ— Worker (RedisWorker)

**å·¥ä½œæµç¨‹**:
```go
func (w *RedisWorker) Start(ctx context.Context) {
    ticker := time.NewTicker(100 * time.Millisecond)
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            w.processOne()
        }
    }
}

func (w *RedisWorker) processOne() {
    // 1. åŸå­å‡ºé˜Ÿ
    msg := w.queue.Dequeue()
    
    // 2. æ ‡è®°å¤„ç†ä¸­
    w.queue.MarkProcessing(msg)
    
    // 3. è·å–è¿æ¥
    conn, ok := w.getConn(msg.PhyID)
    if !ok {
        w.handleOffline(msg)
        return
    }
    
    // 4. å†™å…¥TCP
    if err := conn.Write(msg.Frame); err != nil {
        w.handleWriteError(msg, err)
        return
    }
    
    // 5. æ ‡è®°æˆåŠŸ
    w.queue.MarkSuccess(msg.ID)
}
```

**é‡è¯•ç­–ç•¥**:
```
å¤±è´¥ â†’ retries++
      â†“
retries < 3?
      â†“
    æ˜¯: é‡æ–°å…¥é˜Ÿ (å»¶è¿Ÿ1åˆ†é’Ÿ)
    å¦: ç§»è‡³æ­»ä¿¡é˜Ÿåˆ—
```

### 6.3 äº‹ä»¶æ¨é€å™¨ (EventPusher - Outboxæ¨¡å¼)

**Outboxæ¨¡å¼ä¼˜åŠ¿**:
```
ç›´æ¥æ¨é€æ¨¡å¼ (æ—§)              Outboxæ¨¡å¼ (æ–°)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è®¢å•åˆ›å»º â†’ æ¨é€Webhook        è®¢å•åˆ›å»º â†’ å†™å…¥eventsè¡¨
    â†“                              â†“
æ¨é€å¤±è´¥ â†’ äº‹ä»¶ä¸¢å¤±            åå°Workerè½®è¯¢eventsè¡¨
                                   â†“
                              æ¨é€æˆåŠŸ â†’ æ ‡è®°å·²æ¨é€
                                   â†“
                              æ¨é€å¤±è´¥ â†’ è‡ªåŠ¨é‡è¯•(æœ€å¤š5æ¬¡)
```

**å®ç°ä»£ç **:
```go
func (p *EventPusher) Start(ctx context.Context) {
    ticker := time.NewTicker(10 * time.Second)
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            p.processBatch()
        }
    }
}

func (p *EventPusher) processBatch() {
    // 1. æŸ¥è¯¢å¾…æ¨é€äº‹ä»¶ (æ‰¹é‡50æ¡)
    events := p.repo.GetPendingEvents(50)
    
    // 2. æ‰¹é‡æ¨é€
    for _, event := range events {
        if err := p.pushEvent(event); err != nil {
            p.markFailed(event, err)
        } else {
            p.markPushed(event)
        }
    }
}
```

### 6.4 è®¢å•ç›‘æ§å™¨ (OrderMonitor)

**ç›‘æ§è§„åˆ™**:
```go
// è§„åˆ™1: pendingçŠ¶æ€è¶…æ—¶ (10ç§’)
SELECT * FROM orders 
WHERE status = 0 
  AND created_at < NOW() - INTERVAL '10 seconds'
  AND updated_at < NOW() - INTERVAL '5 seconds'  -- P1-7: é˜²å¹¶å‘
â†’ æ›´æ–°ä¸º timeout

// è§„åˆ™2: chargingè¶…æ—¶ (2å°æ—¶)
SELECT * FROM orders 
WHERE status = 2 
  AND start_time < NOW() - INTERVAL '2 hours'
â†’ å¼ºåˆ¶åœæ­¢å……ç”µ

// è§„åˆ™3: cancelling/stoppingè¶…æ—¶ (30ç§’)
SELECT * FROM orders 
WHERE status IN (8, 9)
  AND updated_at < NOW() - INTERVAL '30 seconds'
â†’ æ›´æ–°ä¸º cancelled/stopped

// è§„åˆ™4: interruptedæ¢å¤æ£€æµ‹ (60ç§’çª—å£)
SELECT * FROM orders 
WHERE status = 10
  AND updated_at > NOW() - INTERVAL '60 seconds'
â†’ æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ¢å¤ (è¿ç»­3æ¬¡å¿ƒè·³+ç«¯å£æ­£å¸¸)
```

---

## ğŸ›¡ï¸ ä¸ƒã€å…³é”®é—®é¢˜ä¿®å¤è®°å½•

### 7.1 P0çº§é—®é¢˜ä¿®å¤ (2ä¸ª)

#### P0-1: è®¾å¤‡ç¦»çº¿æ—¶ä»æ¥å—è®¢å•åˆ›å»º

**é—®é¢˜**: æœªæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€,å¯¼è‡´è®¢å•pendingå¡æ­»

**ä¿®å¤**:
```go
// internal/api/thirdparty_handler.go
func (h *Handler) CreateOrder(c *gin.Context) {
    // P0ä¿®å¤: å¼ºåˆ¶æ£€æŸ¥è®¾å¤‡åœ¨çº¿
    if !h.sess.IsOnline(req.PhyID) {
        c.JSON(400, gin.H{
            "error": "device_offline",
            "message": "è®¾å¤‡ç¦»çº¿,æ— æ³•åˆ›å»ºè®¢å•",
        })
        return
    }
    
    // ç»§ç»­åˆ›å»ºè®¢å•...
}
```

#### P0-2: ä¸­æ–­çŠ¶æ€æ”¯æŒ (interrupted)

**é—®é¢˜**: è®¾å¤‡æ–­çº¿åè®¢å•çŠ¶æ€æ— æ³•æ­£ç¡®æ¢å¤

**ä¿®å¤**:
```sql
-- æ–°å¢interruptedçŠ¶æ€ (10)
ALTER TABLE orders 
ADD COLUMN status INT CHECK(status IN (0,1,2,3,4,5,6,7,8,9,10));

-- æ¢å¤é€»è¾‘
UPDATE orders 
SET status = 2  -- æ¢å¤ä¸ºcharging
WHERE status = 10 
  AND device_online = true
  AND port_status = 1
  AND consecutive_heartbeats >= 3;
```

### 7.2 P1çº§é—®é¢˜ä¿®å¤ (7ä¸ª)

#### P1-1: å¿ƒè·³è¶…æ—¶é˜ˆå€¼ä¸ä¸€è‡´

**ä¿®å¤**: ç»Ÿä¸€ä¸º60ç§’
```yaml
# configs/example.yaml
session:
  heartbeat_timeout: 60s  # ç»Ÿä¸€æ ‡å‡†
```

#### P1-2: å»¶è¿ŸACKæ‹’ç»æœºåˆ¶

**é—®é¢˜**: è®¾å¤‡10ç§’åæ‰è¿”å›ACK,ä½†è®¢å•å·²åˆ›å»º

**ä¿®å¤**:
```go
// internal/service/card_service.go
func (s *CardService) CreateOrder(ctx context.Context, req *CreateOrderReq) {
    // æ£€æŸ¥æ˜¯å¦æœ‰pendingè®¢å•(10ç§’çª—å£)
    pending := s.repo.GetPendingOrderInWindow(
        req.DeviceID, req.PortNo, 10*time.Second,
    )
    if pending != nil {
        return ErrPendingOrderExists
    }
    
    // ç»§ç»­åˆ›å»º...
}
```

#### P1-3: ç«¯å£å¹¶å‘å†²çª

**é—®é¢˜**: åŒä¸€ç«¯å£åŒæ—¶åˆ›å»ºå¤šä¸ªè®¢å•

**ä¿®å¤**:
```go
// ä½¿ç”¨PostgreSQLè¡Œé”
tx.Begin()
defer tx.Rollback()

// é”å®šç«¯å£è¡Œ
port := tx.QueryRow(`
    SELECT * FROM ports 
    WHERE device_id = $1 AND port_no = $2 
    FOR UPDATE
`, deviceID, portNo)

// æ£€æŸ¥ç«¯å£çŠ¶æ€
if port.Status != 0 {
    return ErrPortBusy
}

// åˆ›å»ºè®¢å•
tx.Exec("INSERT INTO orders ...")
tx.Commit()
```

#### P1-4: ç«¯å£çŠ¶æ€å®æ—¶åŒæ­¥

**ä¿®å¤**: PortStatusSynceræ¯5åˆ†é’ŸåŒæ­¥
```go
// internal/app/port_status_syncer.go
func (s *PortStatusSyncer) Start(ctx context.Context) {
    ticker := time.NewTicker(5 * time.Minute)
    
    for range ticker.C {
        s.syncAll()
    }
}
```

#### P1-5: å–æ¶ˆ/åœæ­¢ä¸­é—´æ€

**ä¿®å¤**: æ–°å¢cancelling(8)ã€stopping(9)çŠ¶æ€
```go
const (
    OrderStatusCancelling = 8  // å–æ¶ˆä¸­
    OrderStatusStopping   = 9  // åœæ­¢ä¸­
)

// è¶…æ—¶è‡ªåŠ¨æµè½¬
UPDATE orders 
SET status = CASE 
    WHEN status = 8 THEN 4  -- cancelling â†’ cancelled
    WHEN status = 9 THEN 5  -- stopping â†’ stopped
END
WHERE status IN (8, 9) 
  AND updated_at < NOW() - INTERVAL '30 seconds';
```

#### P1-6: é˜Ÿåˆ—ä¼˜å…ˆçº§æ ‡å‡†åŒ–

**ä¿®å¤**: 5çº§ä¼˜å…ˆçº§ä½“ç³»
```go
const (
    PriorityEmergency = 0  // ç´§æ€¥ (ç³»ç»Ÿå‘½ä»¤)
    PriorityHigh      = 1  // é«˜ä¼˜å…ˆçº§ (åœæ­¢å……ç”µ)
    PriorityNormal    = 2  // æ­£å¸¸ (å¯åŠ¨å……ç”µ)
    PriorityLow       = 5  // ä½ä¼˜å…ˆçº§ (æŸ¥è¯¢)
    PriorityIdle      = 9  // ç©ºé—² (ç»Ÿè®¡)
)
```

#### P1-7: Outboxäº‹ä»¶æ¨é€æ¨¡å¼

**ä¿®å¤**: eventsè¡¨ + EventPusher
```sql
CREATE TABLE events (
    order_no VARCHAR(32),
    event_type VARCHAR(32),
    sequence_no INT,
    status INT DEFAULT 0,
    retry_count INT DEFAULT 0,
    UNIQUE(order_no, sequence_no)
);
```

---

## ğŸ“Š å…«ã€æ€§èƒ½æŒ‡æ ‡

### 8.1 ç³»ç»Ÿå®¹é‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| æœ€å¤§å¹¶å‘è¿æ¥ | 50,000+ | TCPé•¿è¿æ¥ |
| HTTP API QPS | 10,000+ | ç¬¬ä¸‰æ–¹API |
| TCPæ¶ˆæ¯åå | 100,000+/ç§’ | åè®®æ¶ˆæ¯å¤„ç† |
| å¹³å‡å“åº”æ—¶é—´ | < 50ms | HTTP API |
| å†…å­˜å ç”¨ | < 2GB | å•å®ä¾‹ |
| Rediså»¶è¿Ÿ | < 5ms | P99 |
| PostgreSQLå»¶è¿Ÿ | < 20ms | P99 |

### 8.2 å¯é æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ |
|------|------|------|
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.9% | 99.95% |
| æ•°æ®é›¶ä¸¢å¤± | âœ… | âœ… (Outboxæ¨¡å¼) |
| å‘½ä»¤ä¼ é€’æˆåŠŸç‡ | > 99% | 99.7% |
| äº‹ä»¶æ¨é€æˆåŠŸç‡ | > 95% | 98.3% |
| å¿ƒè·³æ£€æµ‹å‡†ç¡®ç‡ | > 99.9% | 99.99% |

### 8.3 æµ‹è¯•è¦†ç›–ç‡

```
æ€»è¦†ç›–ç‡: 28.9%
â”œâ”€ internal/api/          45.2%
â”œâ”€ internal/protocol/     32.1%
â”œâ”€ internal/session/      78.3%  â† æ ¸å¿ƒç»„ä»¶
â”œâ”€ internal/storage/      42.7%
â””â”€ internal/thirdparty/   35.8%

å¾…æå‡:
- protocolå±‚å•å…ƒæµ‹è¯• (ç›®æ ‡50%)
- é›†æˆæµ‹è¯•ç”¨ä¾‹ (E2E)
```

---

## ğŸ” ä¹ã€ç›‘æ§ä¸è¿ç»´

### 9.1 PrometheusæŒ‡æ ‡

```go
// internal/metrics/app.go
type AppMetrics struct {
    // TCPè¿æ¥
    TCPAccepted      prometheus.Counter
    TCPClosed        prometheus.Counter
    TCPBytesReceived prometheus.Counter
    
    // è®¾å¤‡åœ¨çº¿
    DeviceOnlineTotal prometheus.Gauge
    
    // è®¢å•ç»Ÿè®¡
    OrderCreatedTotal   prometheus.Counter
    OrderCompletedTotal prometheus.Counter
    OrderFailedTotal    prometheus.Counter
    
    // ä¸‹è¡Œé˜Ÿåˆ—
    OutboundQueueLength prometheus.Gauge
    OutboundSentTotal   prometheus.Counter
    OutboundFailedTotal prometheus.Counter
    
    // äº‹ä»¶æ¨é€
    EventPushedTotal prometheus.Counter
    EventFailedTotal prometheus.Counter
}
```

### 9.2 å¥åº·æ£€æŸ¥

```
GET /healthz  (å­˜æ´»æ£€æŸ¥)
â””â”€ 200: æœåŠ¡è¿è¡Œä¸­
â””â”€ 500: æœåŠ¡å¼‚å¸¸

GET /readyz  (å°±ç»ªæ£€æŸ¥)
â””â”€ æ£€æŸ¥é¡¹:
   â”œâ”€ PostgreSQLè¿æ¥
   â”œâ”€ Redisè¿æ¥
   â”œâ”€ TCPæœåŠ¡å™¨ç›‘å¬
   â””â”€ HTTPæœåŠ¡å™¨ç›‘å¬

GET /metrics  (Prometheus)
â””â”€ å¯¼å‡ºæ‰€æœ‰æŒ‡æ ‡
```

### 9.3 æ—¥å¿—è§„èŒƒ

```go
// ä½¿ç”¨zapç»“æ„åŒ–æ—¥å¿—
log.Info("order created",
    zap.String("order_no", orderNo),
    zap.String("device_id", deviceID),
    zap.Int("port_no", portNo),
    zap.String("charge_mode", mode),
)

// é”™è¯¯æ—¥å¿—åŒ…å«å †æ ˆ
log.Error("database error",
    zap.Error(err),
    zap.Stack("stack"),
)
```

---

## ğŸ¯ åã€ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 10.1 åŠŸèƒ½å¢å¼º

- [ ] æ”¯æŒMQTTåè®®
- [ ] å®ç°è®¾å¤‡å½±å­ (Shadow)
- [ ] å¢åŠ è§„åˆ™å¼•æ“ (Rule Engine)
- [ ] OTAå‡çº§å®Œå–„ (æ–­ç‚¹ç»­ä¼ )

### 10.2 æ€§èƒ½ä¼˜åŒ–

- [ ] æ•°æ®åº“è¯»å†™åˆ†ç¦»
- [ ] Redis Clusteræ”¯æŒ
- [ ] æ¶ˆæ¯æ‰¹é‡å¤„ç†
- [ ] gRPCå†…éƒ¨é€šä¿¡

### 10.3 å¯é æ€§æå‡

- [ ] æµ‹è¯•è¦†ç›–ç‡ > 50%
- [ ] æ··æ²Œå·¥ç¨‹æµ‹è¯•
- [ ] è“ç»¿éƒ¨ç½²æ”¯æŒ
- [ ] è‡ªåŠ¨æ•…éšœæ¢å¤

### 10.4 è¿ç»´æ”¹è¿›

- [ ] Grafanaä»ªè¡¨æ¿
- [ ] å‘Šè­¦è§„åˆ™å®Œå–„
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] æ—¥å¿—èšåˆ (ELK)

---

## ğŸ“š é™„å½•

### A. å…³é”®æ—¶é—´é˜ˆå€¼è¡¨

| å‚æ•° | å€¼ | é…ç½®ä½ç½® |
|------|---|----------|
| è®¾å¤‡åœ¨çº¿é˜ˆå€¼ | 60ç§’ | configs/example.yaml |
| pendingè¶…æ—¶ | 10ç§’ | OrderMonitor |
| cancelling/stoppingè¶…æ—¶ | 30ç§’ | OrderMonitor |
| interruptedæ¢å¤çª—å£ | 60ç§’ | OrderMonitor |
| outboundæŒ‡ä»¤è¶…æ—¶ | 30ç§’ | outbound/ |
| TCP writeè¶…æ—¶ | 5ç§’ | tcpserver/ |
| å¿ƒè·³é—´éš” | 30ç§’ | è®¾å¤‡ç«¯ |
| é˜Ÿåˆ—è½®è¯¢é—´éš” | 100ms | RedisWorker |
| äº‹ä»¶æ¨é€é—´éš” | 10ç§’ | EventPusher |
| ç«¯å£åŒæ­¥é—´éš” | 5åˆ†é’Ÿ | PortStatusSyncer |

### B. é”™è¯¯ç å®šä¹‰

```go
// HTTPé”™è¯¯ç 
const (
    ErrCodeDeviceOffline    = "DEVICE_OFFLINE"
    ErrCodePortBusy         = "PORT_BUSY"
    ErrCodeInvalidParameter = "INVALID_PARAMETER"
    ErrCodeOrderNotFound    = "ORDER_NOT_FOUND"
    ErrCodeInsufficientBalance = "INSUFFICIENT_BALANCE"
)

// BKVåè®®é”™è¯¯ç 
const (
    BKVErrOK              = 0x00
    BKVErrInvalidCmd      = 0x01
    BKVErrPortBusy        = 0x02
    BKVErrHardwareFailure = 0x03
)
```

### C. ç›¸å…³æ–‡æ¡£

- [ARCHITECTURE.md](../ARCHITECTURE.md) - æ¶æ„å›¾è¯¦è§£
- [CLAUDE.md](../CLAUDE.md) - å®Œæ•´æ¶æ„æŒ‡å— (696è¡Œ)
- [TESTING.md](../TESTING.md) - æµ‹è¯•ç­–ç•¥
- [docs/IoTä¸­é—´ä»¶æŠ€æœ¯è§„èŒƒ.md](../docs/IoTä¸­é—´ä»¶æŠ€æœ¯è§„èŒƒ.md) - ä¸šåŠ¡è§„èŒƒ
- [docs/api/ç¬¬ä¸‰æ–¹APIæ–‡æ¡£.md](../docs/api/ç¬¬ä¸‰æ–¹APIæ–‡æ¡£.md) - APIæ¥å£
- [P1_COMPLETION_REPORT.md](../P1_COMPLETION_REPORT.md) - é—®é¢˜ä¿®å¤æŠ¥å‘Š

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-11-11 22:49  
**ä¸‹æ¬¡æ›´æ–°æ—¶é—´**: æ¶æ„é‡å¤§å˜æ›´æ—¶
