# BKV协议数据格式详细规范

## 📋 协议概述

BKV协议（Binary Key-Value）是组网版充电设备使用的二进制通信协议，采用TLV（Tag-Length-Value）编码格式，支持设备状态上报、充电控制、异常处理等核心功能。

## 🔧 基本帧格式

### 标准帧结构
```
+--------+--------+--------+----------+--------+----------+--------+----------+--------+
| 包头   | 长度   | 命令   | 帧流水号 | 包类型 | 网关ID   | 数据   | 校验和   | 包尾   |
+--------+--------+--------+----------+--------+----------+--------+----------+--------+
| 2字节  | 2字节  | 2字节  | 4字节    | 1字节  | 7字节    | N字节  | 1字节    | 2字节  |
+--------+--------+--------+----------+--------+----------+--------+----------+--------+
```

### 字段详细说明
| 字段 | 长度 | 说明 | 示例 |
|------|------|------|------|
| 包头 | 2字节 | 帧起始标志 | 0xFCFE (上行), 0xFCFF (下行) |
| 长度 | 2字节 | 后续数据总长度 | 不包含包头和长度本身 |
| 命令 | 2字节 | 功能命令字 | 见命令字定义表 |
| 帧流水号 | 4字节 | 消息序列号 | 设备主动上报为0x00000000 |
| 包类型 | 1字节 | 数据方向 | 0x00=下行, 0x01=上行 |
| 网关ID | 7字节 | 设备物理ID | ASCII编码 |
| 数据 | N字节 | 业务数据 | 格式依赖命令字 |
| 校验和 | 1字节 | 前面所有字节的和 | 取低8位 |
| 包尾 | 2字节 | 帧结束标志 | 0xFCEE |

## 🎯 命令字定义

### 基础命令
| 命令字 | 方向 | 功能说明 | 协议章节 |
|--------|------|----------|----------|
| 0x0000 | 双向 | 心跳上报/回复 | 2.1.1 |
| 0x0005 | 双向 | 网络节点管理 | 2.2.5-2.2.7 |
| 0x0015 | 双向 | 控制设备/状态查询/充电结束 | 2.2.4, 2.2.8, 2.2.9 |

### BKV扩展命令
| 命令字 | 方向 | 功能说明 | 协议章节 |
|--------|------|----------|----------|
| 0x1000 | 双向 | BKV协议帧 | 2.2.3, 2.2.2 |
| 0x1004 | 上行 | BKV充电结束上报 | 2.2.2 |
| 0x1007 | 下行 | BKV服务费充电命令 | 2.2.2 |
| 0x1010 | 上行 | BKV异常事件上报 | 2.2.8 |
| 0x1011 | 双向 | BKV参数设置 | 2.2.6 |
| 0x1012 | 双向 | BKV参数查询 | 2.2.7 |

## 📡 核心协议详解

### 1. 心跳上报 (cmd 0x0000)

#### 上行格式 (设备→平台)
```
fcfe002e00000000000001822005200048693839383630343633313132303730333139343137635
62e31723436001fcafcee
```

**数据段解析:**
```
38 39 38 36 30 34 36 33 31 31 32 30 37 30 33 31 39 34 31 37 -> ICCID
63 56 2e 31 37 32 33 34 36 00 -> 版本号 "cV.1r46"
1f -> 信号强度 31
```

#### 下行格式 (平台→设备)
```
fcff0018000000000000008220052000486920200730164545a7fcee
```

**数据段解析:**
```
32 30 32 30 30 37 33 30 31 36 34 35 34 35 -> 时间戳 "20200730164545"
```

### 2. 控制设备充电 (cmd 0x0015 下行)

#### 命令格式
```
fcff001c0015001c9a5100860044594530050008070200010100f00000c8fcee
```

**数据段结构:**
```
数据长度: 1字节 (0x08)
子命令: 1字节 (0x07)
插座号: 1字节 (0x02)
插孔号: 1字节 (0x00) 0=A孔, 1=B孔
开关状态: 1字节 (0x01) 0=关, 1=开
充电模式: 1字节 (0x01) 0=按电量, 1=按时长, 3=按功率
充电时长: 2字节 (0x00f0) 240分钟
充电电量: 2字节 (0x0000) 0Wh (按时模式忽略)
```

#### 按功率充电扩展格式
```
额外字段:
支付金额: 2字节 (分)
挡位数: 1字节 (1-5)
挡位信息: 每组6字节 × 挡位数
  - 功率阈值: 2字节 (0.1W)
  - 单价: 2字节 (分/小时) 
  - 时长: 2字节 (分钟)
```

### 3. 设备回复ACK (cmd 0x0015 上行)

#### 成功回复格式
```
fcfe00190015001c9c2b0186004459453005000507010200016826fcee
```

**数据段结构:**
```
数据长度: 1字节 (0x05)
子命令: 1字节 (0x07) - 与命令一致
结果: 1字节 (0x01) 0=失败, 1=成功
插座号: 1字节 (0x02)
插孔号: 1字节 (0x00)
业务号: 2字节 (0x6826) 必须与命令一致
```

### 4. 充电结束上报 (cmd 0x0015 上行)

#### 标准格式
```
fcfe00250015000000000186004459453005001102025036302000980068000000010050002d41fcee
```

**数据段结构:**
```
数据长度: 2字节 (0x0011)
子命令: 1字节 (0x02)
插座号: 1字节
软件版本: 2字节
温度: 1字节 (℃)
RSSI: 1字节
插孔号: 1字节
插座状态: 1字节 (位定义见下文)
业务号: 2字节 (必须与开始一致)
瞬时功率: 2字节 (0.1W)
瞬时电流: 2字节 (0.001A)  
用电量: 2字节 (0.01kWh)
充电时间: 2字节 (分钟)
```

#### 按功率充电结束扩展格式
```
额外字段:
结束时间: 7字节 (YYYYMMDDHHMMSS)
结束原因: 1字节
总费用: 2字节 (分)
结算功率: 2字节 (0.1W)
挡位数: 1字节
各挡位时长: 2字节 × 挡位数
```

### 5. BKV状态上报 (cmd 0x1000)

#### BKV帧格式
```
fcfe00911000000000000182231214002700 + BKV数据 + 校验fcee
```

#### BKV数据编码 (TLV格式)
```
Tag: 1字节 - 字段标识
Length: 1字节 - Value长度  
Value: N字节 - 字段值
```

#### 关键Tag定义
| Tag | 长度 | 说明 | 示例值 |
|-----|------|------|--------|
| 0x01 | 2 | 命令字 | 0x1017 (状态上报) |
| 0x02 | 8 | 帧序列号 | 0x0000000000000000 |
| 0x03 | 7 | 网关ID | ASCII编码 |
| 0x04 | 1 | 插座序号 | 1-250 |
| 0x07 | 1 | 温度 | 摄氏度 |
| 0x0A | 2 | 业务号 | 订单标识 |
| 0x0B | 2 | 瞬时功率 | 0.1W单位 |
| 0x0C | 2 | 瞬时电流 | 0.001A单位 |
| 0x0D | 2 | 用电量 | 0.01kWh单位 |
| 0x0E | 2 | 充电时间 | 分钟单位 |
| 0x2F | 1 | 结束原因 | 见原因定义 |

### 6. BKV充电结束 (cmd 0x1004)

#### 数据格式
```
Tag 0x01: 命令字 (0x1004)
Tag 0x02: 帧序列号
Tag 0x03: 网关ID  
Tag 0x04: 插座序号
Tag 0x08: 插孔号
Tag 0x09: 插孔状态
Tag 0x0A: 订单号
Tag 0x0B: 瞬时功率
Tag 0x0C: 瞬时电流
Tag 0x0D: 已用电量
Tag 0x0E: 已充时间
Tag 0x2E: 结束时间
Tag 0x2F: 结束原因
Tag 0x12: 充电模式
Tag 0x85: 电费金额
Tag 0x86: 服务费金额
```

## 🎯 状态位定义

### 插座状态字节 (bit定义)
```
Bit 7: 在线状态 (1=在线, 0=离线)
Bit 6: 计量状态 (1=正常, 0=异常)  
Bit 5: 充电状态 (1=充电中, 0=未充电)
Bit 4: 空载状态 (1=空载, 0=有负载)
Bit 3: 温度状态 (1=正常, 0=过温)
Bit 2: 电流状态 (1=正常, 0=过流)
Bit 1: 功率状态 (1=正常, 0=过功率)
Bit 0: 预留位
```

### 充电结束原因定义
| 值 | 说明 |
|----|------|
| 0x00 | 正常结束 |
| 0x01 | 按时结束 |
| 0x02 | 按量结束 |  
| 0x03 | 空载结束
| 0x04 | 充满结束
| 0x05 | 用户停止
| 0x06 | 异常停止
| 0x07 | 过载保护
| 0x08 | 过温保护
| 0x09 | 过压保护
| 0x0A | 欠压保护
| 0x0B | 漏电保护
| 0x0C | 通信中断

## 🔧 校验和计算

### 计算方法
```
uint8_t calculate_checksum(uint8_t *data, int length) {
    uint16_t sum = 0;
    for (int i = 0; i < length; i++) {
        sum += data[i];
    }
    return (uint8_t)(sum & 0xFF);  // 取低8位
}
```

### 验证范围
- 包含从"长度"字段到"数据"字段的所有字节
- 不包含"包头"和"包尾"
- 校验和字节本身不参与计算

## 📊 数据编码规则

### 字节序
- 多字节整数采用**大端模式** (Big-Endian)
- 高字节在前，低字节在后

### 字符串编码
- ASCII编码，无NULL结尾
- 固定长度字段，不足部分补0x00

### 数值表示
| 数据类型 | 表示方法 | 示例 |
|----------|----------|------|
| 电压 | 0.1V单位 | 0x08E3 = 227.5V |
| 电流 | 0.001A单位 | 0x1000 = 4.096A |
| 功率 | 0.1W单位 | 0x1000 = 409.6W |
| 电量 | 0.01kWh单位 | 0x0050 = 0.8kWh |
| 金额 | 分单位 | 0x0064 = 1.00元 |
| 时间 | 分钟单位 | 0x002D = 45分钟 |

## ⚠️ 错误码定义

### 设备响应错误码
| 错误码 | 说明 |
|--------|------|
| 0x00 | 执行失败 |
| 0x01 | 执行成功 |
| 0x02 | 参数错误 |
| 0x03 | 状态冲突 |
| 0x04 | 设备忙 |
| 0x05 | 通信超时 |
| 0x06 | 硬件故障 |
| 0x07 | 权限不足 |

## 🧪 测试用例示例

### 心跳测试
```
上行: fcfe002e00000000000001822005200048693839383630343633313132303730333139343137635
      62e31723436001fcafcee
      
下行: fcff0018000000000000008220052000486920200730164545a7fcee
```

### 充电控制测试
```
命令: fcff001c0015001c9a5100860044594530050008070200010100f00000c8fcee
回复: fcfe00190015001c9c2b0186004459453005000507010200016826fcee
```

### 充电结束测试
```
上报: fcfe00250015000000000186004459453005001102025036302000980068000000010050002d41fcee
确认: fcff0016001500000000008600445945300500020c0101d8fcee
```

这份详细的协议规范文档提供了BKV协议的完整技术实现细节，可以直接用于设备开发、协议解析器实现和系统集成测试。