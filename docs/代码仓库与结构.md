# 代码仓库与结构

## 仓库入口

- 可执行程序：`cmd/server/main.go`（调用 `internal/app/bootstrap.Run`）
- 配置：`configs/example.yaml`（以 ENV 覆盖敏感项）
- OpenAPI：`api/openapi/openapi.yaml`
- 数据库迁移：`db/migrations/`

## 主要目录

- `internal/httpserver`：HTTP 封装（/healthz /readyz /metrics）
- `internal/tcpserver`：TCP 网关（连接上下文、读写分离）
- `internal/protocol/ap3000`：AP3000 编解码/路由
- `internal/protocol/bkv`：BKV 协议完整实现（业务层处理）
- `internal/protocol/gn`：GN 协议完整实现（组网设备通信层）
- `internal/outbound`：下行队列 Worker（WAL/ACK/重试）
- `internal/storage/pg`：PG 连接与仓储
- `internal/thirdparty`：第三方推送签名与推送器
- `internal/api`：管理只读接口路由（设备/端口/会话/订单）
- `internal/gateway`：TCP 连接处理与多协议装配（AP3000/BKV/GN）
- `internal/app`：应用级装配与引导
  - `app/metrics.go`：指标注册与 `AppMetrics`
  - `app/ready.go`：就绪聚合器
  - `app/session.go`：会话管理器与加权策略
  - `app/thirdparty.go`：第三方推送器装配
  - `app/db.go`：DB 连接与迁移封装
  - `app/http.go`：HTTP Server 封装
  - `app/tcp.go`：TCP Server 封装
  - `app/outbound.go`：Outbound Worker 启停
  - `app/bootstrap/app.go`：统一启动流程 `bootstrap.Run`

## 启动方式

```bash
IOT_CONFIG=./configs/example.yaml go run ./cmd/server
```

## 备注

- 多协议分流：在 `internal/gateway/conn_handler.go` 内，按首帧判别 AP3000、BKV 与 GN 协议。
- 指标：Prometheus 暴露于 `/metrics`，具体见 `internal/metrics`。
- 存储：包含 `internal/storage/pg`（通用）和 `internal/storage/gn`（GN协议专用）。
