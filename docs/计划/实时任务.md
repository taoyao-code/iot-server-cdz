# 实时任务与进度（M0）

更新时间：自动同步当前会话变更（人工维护）

## 总览

- 阶段：M0 纵切实现
- 目标：打通 AP3000 端到端闭环、下行可靠与超时重试、对外推送签名

## 任务看板

| 任务ID | 任务 | 状态 | 备注 |
| --- | --- | --- | --- |
| m0-baseline-audit | 扫描现有代码基线并输出差距清单 | completed | 已完成基线对齐 |
| m0-align-repo-path | 确定代码仓库路径与提交策略 | completed | 文档与代码解耦，保留当前仓库 |
| m0-ap3000-0306-persist | 完善AP3000 03/06入库与订单闭环（含测试） | completed | 已实现 `Decode03/06`、`Handle03/06`、测试通过 |
| m0-outbound-ack-retry | 下行队列ACK/超时/重试闭环与状态迁移完善 | completed | 已加 `msg_id`、`Handle82Ack`、超时退避、单测通过 |
| m0-thirdparty-hmac | 第三方推送签名规范与实现（API Key+HMAC） | completed | 已补 OpenAPI 验签说明、`SignHMAC`、`Pusher`、结算事件集成 |
| m0-bkv-adapter-skel | 厂家1(BKV)协议适配骨架（帧/心跳/状态/控制） | completed | 已创建 `internal/protocol/bkv` 适配器、路由表与测试 |
| m0-doc-repo-structure | 新增“代码仓库与结构”文档并登记入口/启动命令 | completed | 已添加 `docs/代码仓库与结构.md` |
| m0-config-ports-sync | 更新配置示例以匹配默认端口与开关 | pending | 待核对示例 |
| m0-realtime-tasks-doc | 创建并维护实时任务文档（本文件） | completed | 持续更新 |

## 最近进展

- AP3000 0x03/0x06 入库与订单闭环：合入，测试通过。
- 下行 ACK：新增迁移 `0003_outbound_msgid_up.sql`、写入 `msg_id`、`Decode82Ack`/`Handle82Ack`、路由注册完成。
- 超时重试：`Worker` 增加 `MaxRetries`、超时扫描与退避逻辑已实现，单测通过。
- 第三方推送：已定义 HMAC 验签规范（OpenAPI）、落地 `internal/thirdparty`（签名与推送器）与单测。
- BKV：新增 `Adapter`（流式解码+路由分发）、`router_test.go`、`adapter_test.go`、`replay_test.go`；最小解析与路由回放用例通过。

## 风险与待决

- ACK 与 DB 事务：当前为最终一致，未做强一致锁；后续可引入去重键（device_id+msg_id）。
- 订单金额/费率：仅入库最小字段，金额计算后续在领域服务完善。
- 第三方推送：签名规范与重试去重尚未落地。

## 全局TODO（持续维护）

- 接入网关：
  - [ ] 多协议初判与路由到 BKV/AP3000（按首帧特征）
  - [ ] 统一粘/半包解码器抽象
- 协议插件：
  - [ ] BKV 帧/指令最小集（心跳/状态/控制/参数）
  - [ ] AP3000 参数与升级指令补齐
- 会话与路由：
  - [ ] 绑定维度扩展（ICCID/IMEI）与死链回收策略
- 持久化（PG）：
  - [ ] 订单金额与对账字段补充、分区策略落地
- 第三方对接：
  - [ ] 事件推送负载示例与签名验证示例
  - [ ] 去重与失败重试策略接入（可选 Redis）
- 管理与观测：
  - [ ] 指标完善（82成功率/重发率/推送成功率）与告警阈值
- 文档：
  - [ ] `docs/代码仓库与结构.md` 建立与入口/启动命令登记
  - [ ] `configs/example.yaml` 同步第三方推送配置说明

## 下一步计划（72h）

1. 接入第三方事件推送：于 0x03 结算后触发推送（签名头：`X-Api-Key`/`X-Signature`/`X-Timestamp`/`X-Nonce`），失败重试与去重占位接入。
2. 输出事件负载示例与 OpenAPI 示例片段；在 `configs/example.yaml` 对应 `thirdparty.push` 键补充说明。
3. 补充 `docs/代码仓库与结构.md` 与配置示例同步；更新管理与观测指标（82成功率/重发率）。
