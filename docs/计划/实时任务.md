# 实时任务与进度（M0）

更新时间：自动同步当前会话变更（人工维护）

## 总览

- 阶段：M0 纵切实现
- 目标：打通 AP3000 端到端闭环、下行可靠与超时重试、对外推送签名

## 任务看板

| 任务ID | 任务 | 状态 | 备注 |
| --- | --- | --- | --- |
| m0-baseline-audit | 扫描现有代码基线并输出差距清单 | completed | 已完成基线对齐 |
| m0-align-repo-path | 确定代码仓库路径与提交策略 | completed | 文档与代码解耦，保留当前仓库 |
| m0-ap3000-0306-persist | 完善AP3000 03/06入库与订单闭环（含测试） | completed | 已实现 `Decode03/06`、`Handle03/06`、测试通过 |
| m0-outbound-ack-retry | 下行队列ACK/超时/重试闭环与状态迁移完善 | in_progress | 已加 `msg_id`、`Handle82Ack`、超时退避进行中 |
| m0-thirdparty-hmac | 第三方推送签名规范与实现（API Key+HMAC） | pending | 下一步 |
| m0-bkv-adapter-skel | 厂家1(BKV)协议适配骨架（帧/心跳/状态/控制） | pending | 方案A后并行 |
| m0-doc-repo-structure | 新增“代码仓库与结构”文档并登记入口/启动命令 | pending | 待补充 |
| m0-config-ports-sync | 更新配置示例以匹配默认端口与开关 | pending | 待核对示例 |
| m0-realtime-tasks-doc | 创建并维护实时任务文档（本文件） | in_progress | 持续更新 |

## 最近进展

- AP3000 0x03/0x06 入库与订单闭环：合入，测试通过。
- 下行 ACK：新增迁移 `0003_outbound_msgid_up.sql`、写入 `msg_id`、`Decode82Ack`/`Handle82Ack`、路由注册完成。
- 超时重试：`Worker` 增加 `MaxRetries`、超时扫描与退避逻辑已实现。

## 风险与待决

- ACK 与 DB 事务：当前为最终一致，未做强一致锁；后续可引入去重键（device_id+msg_id）。
- 订单金额/费率：仅入库最小字段，金额计算后续在领域服务完善。
- 第三方推送：签名规范与重试去重尚未落地。

## 下一步计划（72h）

1. 完成 `m0-outbound-ack-retry`：失败ACK与超时置死用例覆盖；指标补齐。
2. 落地 `m0-thirdparty-hmac`：签名、重试、去重、OpenAPI 契约。
3. 补充 `docs/代码仓库与结构.md` 与配置示例同步。
