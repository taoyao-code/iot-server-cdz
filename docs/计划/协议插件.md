## 协议插件 · 实施清单

### TODO（BKV 优先，AP3000 可延后）

- [ ] BKV：路由表最小集（心跳/状态/控制/参数/结算），映射与合法性校验、结束原因推导
- [ ] BKV：控制翻译（按时/按量/按功率），统一字段入库（设备/端口/事件/订单）
- [ ] BKV：回放用例（正常/异常/跨包/乱序/重发），解析-路由-持久化链路打通
- [ ] AP3000：参数 83/84/85/86 与升级 E0/F8（延后至 BKV 完成后）
- [ ] 01/21 互斥策略、22/12/时间应答；FF 智能端口开关
- [ ] 82 启停充翻译与合法性校验、幂等与回执匹配
- [ ] 03/06 订单闭环与功率摘要，乱序/重发抑制
- [ ] 参数读写（白名单/上下界/回读校验）、升级分片（≤3重试）
- [ ] 映射表：状态/原因/模式枚举→平台统一枚举
- [ ] 回放用例集（正常/异常/粘包/乱序/重发）

#### BKV 集成 · 细化 TODO（优先完成）

- [ ] 帧与粘/半包解码：fcfe/fcff 首帧判别与长度切分（已接入，补充校验/容错）
- [ ] 路由表最小集：心跳(0x10)/状态(0x11)/控制/参数占位，路由到适配器
- [ ] 状态与结束原因推导：对照《协议映射-厂家1与厂家2.md》补齐映射与规则
- [ ] 统一数据模型入库：设备/端口快照、事件、订单衔接（最小必要字段）
- [ ] 控制翻译：平台统一控制→BKV 指令编码（按时/按量/按功率）
- [ ] 回放用例：正常/异常/跨包/乱序；解析-路由-持久化全链路通过
- [ ] 指标与告警：解析错误率、路由分布、关键指令成功率

#### BKV 原因映射配置

- 示例文件：`configs/bkv-reason-map.example.yaml`
- 加载器：`internal/protocol/bkv/reason_map.go`（`LoadReasonMap`，`Translate`）
- 用途：将 BKV 结束原因码映射为平台统一原因码，用于订单结算与对账

### M0 目标（纵切）

- [ ] AP3000：20/21/22/82/03/06 编解码与路由
- [ ] 统一映射：状态/结束原因（以 AP3000 为基准）

### M1 目标（扩展）

- [ ] BKV：fcfe/fcff 编解码；结束原因推导规则与运行期映射字典
- [ ] 参数最小子集：83/84/85；升级通道占位（E0/F8）

### 验收

- 回放集 100% 通过；对账一致；82 成功率≥99%

#### BKV 验收补充

- 首帧判别准确率≥99.99%，错误流量不影响 AP3000 通道
- 3 组以上真实/仿真帧回放覆盖：状态/控制/结算路径

### Owner

- 待指派（协议负责人）

### 依赖

- 网关路由标签、领域服务用例、技术栈治理 [TS-Config]/[TS-OpenAPI]
