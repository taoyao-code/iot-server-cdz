## 管理与观测 · 实施清单

### TODO

- [ ] 管理 API（gin）：设备/会话/控制/参数/升级/订单/日志
- [x] 只读接口：设备列表、端口快照（OpenAPI 已补充）
- [ ] OpenAPI 契约校验；Prom 指标；pprof 暴露
- [ ] 签名鉴权（API Key+HMAC）、IP 白名单；审计日志与脱敏
- [ ] 告警阈值与演练（82成功率、重发率、p99、DB写失败、队列积压）

### M0 目标（纵切）

- [ ] 管理 API：在线设备/订单查询；OpenAPI 契约草案与校验
  - [x] `GET /api/devices`（分页：limit/offset）→ 实现于 `cmd/server/main.go`，数据来源 `internal/storage/pg/repo.go#ListDevices`
  - [x] `GET /api/devices/{phyId}/ports` → 实现于 `cmd/server/main.go`，数据来源 `internal/storage/pg/repo.go#ListPortsByPhyID`
- [ ] 指标：连接数、解析失败率、82 成功率、端到端 p99；pprof
  - [x] 会话：`GET /api/sessions/{phyId}`（在线/离线 + lastSeenAt）→ `cmd/server/main.go`，依赖 `internal/session/manager.go` 与 `repo.GetDeviceByPhyID`
  - [x] 订单：`GET /api/orders/{id}`、`GET /api/devices/{phyId}/orders` → `cmd/server/main.go`，数据来源 `repo.GetOrderByID`、`repo.ListOrdersByPhyID`

### 指标补充（BKV）

- 指标：
  - `bkv_route_total{cmd}`：BKV 按指令路由计数
  - 已有：`tcp_accept_total`、`tcp_bytes_received_total`、`session_online_count`、`session_heartbeat_total`
- 集成位置：
  - 计数在 `cmd/server/main.go` 的 BKV 路由注册处（0x10/0x11/0x30/0x82/0x90/0x83/0x84/0x85）

### M1 目标（扩展）

- [ ] Webhook 签名校验/重试去重；观测告警阈值固化与演练
- [ ] 审计脱敏与日志轮转；运维文档与SLO面板

### 验收

- 契约校验通过；指标齐全且触发有效；审计可检索与脱敏
  - OpenAPI：`api/openapi/openapi.yaml` 已包含 `healthz/readyz/metrics`、`/thirdparty/events/test-sign`、`/api/devices`、`/api/devices/{phyId}/ports`
    以及 `/api/sessions/{phyId}`、`/api/orders/{id}`、`/api/devices/{phyId}/orders`

### Owner

- 待指派（API/观测负责人）

### 依赖

- 技术栈治理 [TS-HTTP=gin]/[TS-OpenAPI]/[TS-Metrics]/[TS-Log]/[TS-Config]
