# ç¬¬ä¸‰æ–¹é›†æˆå®æ–½æŒ‡å—

> **ç‰ˆæœ¬**: v2.1.0  
> **çŠ¶æ€**: éƒ¨åˆ†å®Œæˆ - åŸºç¡€è®¾æ–½å°±ç»ªï¼Œä¸šåŠ¡é›†æˆè¿›è¡Œä¸­  
> **æ›´æ–°æ—¥æœŸ**: 2025-01-03

---

## ğŸ“Š å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆï¼ˆ100%ï¼‰

#### 1. åŸºç¡€è®¾æ–½å±‚

- âœ… 10ç§æ ‡å‡†äº‹ä»¶ç±»å‹å®šä¹‰ï¼ˆ`internal/thirdparty/events.go`ï¼‰
- âœ… Rediså¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—ï¼ˆ`internal/thirdparty/event_queue.go`ï¼‰
- âœ… Rediså»é‡æœºåˆ¶ï¼ˆ`internal/thirdparty/deduper.go`ï¼‰
- âœ… Prometheusç›‘æ§æŒ‡æ ‡ï¼ˆ`internal/thirdparty/metrics.go`ï¼‰
- âœ… 7ä¸ªç¬¬ä¸‰æ–¹æ§åˆ¶APIï¼ˆ`internal/api/thirdparty_*`ï¼‰
- âœ… API Keyè®¤è¯ä¸­é—´ä»¶ï¼ˆ`internal/api/middleware/thirdparty_auth.go`ï¼‰
- âœ… Bootstrapé›†æˆï¼ˆäº‹ä»¶é˜Ÿåˆ—Workersï¼‰

#### 2. æ–‡æ¡£

- âœ… ç¬¬ä¸‰æ–¹APIæ–‡æ¡£ï¼ˆ`docs/api/ç¬¬ä¸‰æ–¹APIæ–‡æ¡£.md`ï¼‰
- âœ… äº‹ä»¶æ¨é€è§„èŒƒï¼ˆ`docs/api/äº‹ä»¶æ¨é€è§„èŒƒ.md`ï¼‰
- âœ… CHANGELOGæ›´æ–°ï¼ˆv2.1.0ï¼‰

#### 3. æµ‹è¯•

- âœ… å•å…ƒæµ‹è¯•ï¼ˆ`internal/thirdparty/events_test.go`ï¼‰
- âœ… ç¼–è¯‘éªŒè¯é€šè¿‡

---

### ğŸ”„ è¿›è¡Œä¸­ï¼ˆ30%ï¼‰

#### 1. BKV Handlersé›†æˆ

- âœ… ç»“æ„ä½“æ‰©å±•ï¼ˆEventQueue + Deduperå­—æ®µï¼‰
- âœ… æ„é€ å‡½æ•°æ›´æ–°ï¼ˆ`NewHandlersWithServices`ï¼‰
- âœ… äº‹ä»¶æ¨é€è¾…åŠ©å‡½æ•°ï¼ˆ`event_helpers.go`ï¼‰
  - `pushEvent` - é€šç”¨æ¨é€å‡½æ•°
  - `pushOrderCreatedEvent` - è®¢å•åˆ›å»º
  - `pushOrderConfirmedEvent` - è®¢å•ç¡®è®¤
  - `pushOrderCompletedEvent` - è®¢å•å®Œæˆ
  - `pushChargingStartedEvent` - å……ç”µå¼€å§‹
  - `pushChargingEndedEvent` - å……ç”µç»“æŸ
  - `pushDeviceHeartbeatEvent` - è®¾å¤‡å¿ƒè·³
  - `pushOTAProgressEvent` - OTAè¿›åº¦
- â³ åœ¨å„ä¸ªhandlerä¸­è°ƒç”¨äº‹ä»¶æ¨é€

#### 2. ç¬¬ä¸‰æ–¹APIä¸šåŠ¡é€»è¾‘

- â³ å……ç”µæ§åˆ¶APIå®Œæ•´å®ç°
- â³ æŸ¥è¯¢APIå®Œæ•´å®ç°
- â³ å‚æ•°/OTA APIå®Œæ•´å®ç°

#### 3. é›†æˆæµ‹è¯•

- â³ äº‹ä»¶æ¨é€é›†æˆæµ‹è¯•
- â³ ç¬¬ä¸‰æ–¹APIé›†æˆæµ‹è¯•

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åœ¨handlerä¸­æ¨é€è®¢å•åˆ›å»ºäº‹ä»¶

```go
// åœ¨ HandleCardSwipe ä¸­
func (h *Handlers) HandleCardSwipe(ctx context.Context, f *Frame) error {
    // ... ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘ ...
    
    // æ¨é€è®¢å•åˆ›å»ºäº‹ä»¶ï¼ˆéé˜»å¡ï¼‰
    if h.EventQueue != nil {
        logger := zap.L() // æˆ–ä»contextè·å–
        h.pushOrderCreatedEvent(
            ctx,
            f.GatewayID,  // devicePhyID
            orderNo,       // è®¢å•å·
            portNo,        // ç«¯å£å·
            "card",        // å……ç”µæ¨¡å¼
            map[string]interface{}{
                "duration": 3600,
                "kwh_limit": 10.0,
            },
            logger,
        )
    }
    
    return nil
}
```

### ç¤ºä¾‹2: æ¨é€è®¢å•å®Œæˆäº‹ä»¶

```go
// åœ¨ HandleChargeEnd ä¸­
func (h *Handlers) HandleChargeEnd(ctx context.Context, f *Frame) error {
    // ... ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘ ...
    
    // æ¨é€è®¢å•å®Œæˆäº‹ä»¶
    if h.EventQueue != nil {
        logger := zap.L()
        h.pushOrderCompletedEvent(
            ctx,
            f.GatewayID,
            orderNo,
            portNo,
            3590,          // duration (ç§’)
            5.23,          // totalKwh
            2000.0,        // peakPower (W)
            1500.0,        // avgPower (W)
            7.85,          // totalAmount (å…ƒ)
            "normal",      // endReason
            "å……ç”µå®Œæˆ",     // endReasonMsg
            logger,
        )
    }
    
    return nil
}
```

### ç¤ºä¾‹3: æ¨é€å¿ƒè·³äº‹ä»¶

```go
// åœ¨ HandleHeartbeat ä¸­
func (h *Handlers) HandleHeartbeat(ctx context.Context, f *Frame) error {
    // ... ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘ ...
    
    // æ¨é€å¿ƒè·³äº‹ä»¶ï¼ˆå¯é€‰ï¼Œå»ºè®®é‡‡æ ·é™é¢‘ï¼‰
    if h.EventQueue != nil && shouldPushHeartbeat() { // é™é¢‘é€»è¾‘
        logger := zap.L()
        ports := []thirdparty.PortStatus{
            {PortNo: 1, State: "idle", Power: 0},
            {PortNo: 2, State: "charging", Power: 1500.5},
        }
        h.pushDeviceHeartbeatEvent(
            ctx,
            f.GatewayID,
            220.5,  // voltage
            -75,    // rssi
            35.2,   // temp
            ports,
            logger,
        )
    }
    
    return nil
}
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### Step 1: æ›´æ–°Bootstrapï¼ˆå·²å®Œæˆ âœ…ï¼‰

åœ¨`internal/app/bootstrap/app.go`ä¸­å·²é›†æˆäº‹ä»¶é˜Ÿåˆ—åˆå§‹åŒ–ã€‚

### Step 2: åœ¨BKV handlersä¸­æ·»åŠ äº‹ä»¶æ¨é€

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**: `internal/protocol/bkv/handlers.go`

**ä¿®æ”¹çš„handlers**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:

1. **é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰**
   - `HandleCardSwipe` - åˆ·å¡å……ç”µï¼Œæ¨é€è®¢å•åˆ›å»º
   - `HandleOrderConfirm` - è®¢å•ç¡®è®¤
   - `HandleChargeEnd` - å……ç”µç»“æŸï¼Œæ¨é€è®¢å•å®Œæˆ

2. **ä¸­ä¼˜å…ˆçº§ï¼ˆé‡è¦äº‹ä»¶ï¼‰**
   - `HandleOTAResponse` / `HandleOTAProgress` - OTAè¿›åº¦
   - `HandlePowerLevelEnd` - æŒ‰åŠŸç‡å……ç”µç»“æŸ

3. **ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰**
   - `HandleHeartbeat` - å¿ƒè·³ï¼ˆå»ºè®®é™é¢‘é‡‡æ ·ï¼‰
   - å…¶ä»–ç®¡ç†ç±»å‘½ä»¤

**å®æ–½æ¨¡æ¿**:

```go
// åœ¨æ¯ä¸ªhandleræœ«å°¾æ·»åŠ ï¼ˆéé˜»å¡ï¼‰
if h.EventQueue != nil {
    logger := zap.L()
    h.pushXXXEvent(ctx, devicePhyID, ..., logger)
}
```

### Step 3: æ›´æ–°æ„é€ å‡½æ•°è°ƒç”¨

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**: `internal/app/bootstrap/app.go`

å°†åŸæ¥çš„ï¼š

```go
bkvHandlers := bkv.NewHandlers(repo, bkvReason)
```

æ”¹ä¸ºï¼š

```go
bkvHandlers := bkv.NewHandlersWithServices(
    repo, 
    bkvReason, 
    cardService,  // å¦‚æœå·²æœ‰
    outbound,     // å¦‚æœå·²æœ‰
    eventQueue,   // æ–°å¢
    deduper,      // æ–°å¢
)
```

### Step 4: å®ç°ç¬¬ä¸‰æ–¹APIä¸šåŠ¡é€»è¾‘

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**: `internal/api/thirdparty_handler.go`

å½“å‰API handlerséƒ½æ˜¯TODOéª¨æ¶ï¼Œéœ€è¦å®ç°å®é™…ä¸šåŠ¡é€»è¾‘ï¼š

1. `StartCharge` - åˆ›å»ºè®¢å• + å‘é€ä¸‹è¡Œå……ç”µæŒ‡ä»¤
2. `StopCharge` - åœæ­¢å……ç”µ + æ›´æ–°è®¢å•çŠ¶æ€
3. `GetDevice` - æŸ¥è¯¢æ•°æ®åº“ + sessionåœ¨çº¿çŠ¶æ€
4. `GetOrder` - æŸ¥è¯¢è®¢å•è¯¦æƒ…
5. `ListOrders` - åˆ†é¡µæŸ¥è¯¢
6. `SetParams` - å‘é€å‚æ•°è®¾ç½®å‘½ä»¤
7. `TriggerOTA` - åˆ›å»ºOTAä»»åŠ¡

### Step 5: ç¼–å†™é›†æˆæµ‹è¯•

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼š

- `internal/thirdparty/integration_test.go` - äº‹ä»¶æ¨é€æµ‹è¯•
- `internal/api/thirdparty_api_test.go` - APIæµ‹è¯•

---

## ğŸ”§ é…ç½®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
thirdparty:
  push:
    webhook_url: "https://your-platform.com/webhook/iot"
    secret: "your-hmac-secret-key"
    max_retries: 5
    worker_count: 3
    dedup_ttl: 1h
    enable_queue: true
    enable_dedup: true
  auth:
    api_keys:
      - "sk_prod_xxxxxxxxxx"
    require_hmac: true
  ip_whitelist:
    - "1.2.3.4"  # ç¬¬ä¸‰æ–¹å¹³å°IP
```

### å¼€å‘ç¯å¢ƒé…ç½®

```yaml
thirdparty:
  push:
    webhook_url: ""  # ç•™ç©ºç¦ç”¨æ¨é€
    secret: "dev-secret"
    enable_queue: false  # å¼€å‘æ—¶å¯ç¦ç”¨
    enable_dedup: false
  auth:
    api_keys:
      - "sk_test_1234567890"
    require_hmac: false  # å¼€å‘æ—¶å¯ç¦ç”¨ç­¾åéªŒè¯
```

---

## ğŸ“Š å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | çŠ¶æ€ | é¢„è®¡å·¥æ—¶ |
|------|------|----------|
| åŸºç¡€è®¾æ–½æ­å»º | âœ… å®Œæˆ | 4å°æ—¶ |
| BKV handlersé›†æˆ | ğŸ”„ 30% | 4å°æ—¶ |
| ç¬¬ä¸‰æ–¹APIå®ç° | â³ æœªå¼€å§‹ | 3å°æ—¶ |
| é›†æˆæµ‹è¯•ç¼–å†™ | â³ æœªå¼€å§‹ | 3å°æ—¶ |
| æ–‡æ¡£å®Œå–„ | âœ… å®Œæˆ | 1å°æ—¶ |
| **æ€»è®¡** | **40%** | **15å°æ—¶** |

**å·²æŠ•å…¥**: 6å°æ—¶  
**å‰©ä½™**: 9å°æ—¶

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. äº‹ä»¶æ¨é€

- âœ… ä½¿ç”¨è¾…åŠ©å‡½æ•°å°è£…ï¼ˆ`push*Event`ï¼‰
- âœ… éé˜»å¡è°ƒç”¨ï¼ˆä¸å½±å“ä¸»ä¸šåŠ¡ï¼‰
- âœ… æ£€æŸ¥EventQueueæ˜¯å¦é…ç½®
- âœ… æä¾›loggerç”¨äºè°ƒè¯•
- âš ï¸ å¿ƒè·³äº‹ä»¶éœ€è¦é™é¢‘ï¼ˆé¿å…è¿‡å¤šæ¨é€ï¼‰

### 2. é”™è¯¯å¤„ç†

- æ¨é€å¤±è´¥ä¸åº”å½±å“ä¸šåŠ¡é€»è¾‘
- Workerè‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- DLQä¿åº•ï¼ˆå¤±è´¥äº‹ä»¶è¿›æ­»ä¿¡é˜Ÿåˆ—ï¼‰
- ç›‘æ§æŒ‡æ ‡è®°å½•

### 3. æ€§èƒ½ä¼˜åŒ–

- å¼‚æ­¥é˜Ÿåˆ—ï¼ˆéé˜»å¡ï¼‰
- Rediså»é‡ï¼ˆé¿å…é‡å¤æ¨é€ï¼‰
- Workerå¹¶å‘æ•°å¯é…ç½®ï¼ˆé»˜è®¤3ä¸ªï¼‰
- å¿ƒè·³ç­‰é«˜é¢‘äº‹ä»¶é™é¢‘é‡‡æ ·

---

## ğŸš€ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. å®Œæˆæ ¸å¿ƒhandlersçš„äº‹ä»¶æ¨é€é›†æˆ
2. å®ç°ç¬¬ä¸‰æ–¹APIçš„å®Œæ•´ä¸šåŠ¡é€»è¾‘
3. ç¼–å†™é›†æˆæµ‹è¯•

### ä¸­æœŸï¼ˆ1æœˆå†…ï¼‰

1. å®é™…è®¾å¤‡è”è°ƒ
2. ç¬¬ä¸‰æ–¹å¹³å°å¯¹æ¥
3. æ€§èƒ½å‹åŠ›æµ‹è¯•
4. ç›‘æ§å‘Šè­¦é…ç½®

### é•¿æœŸï¼ˆ3æœˆ+ï¼‰

1. æ ¹æ®åé¦ˆä¼˜åŒ–
2. æ”¯æŒæ›´å¤šäº‹ä»¶ç±»å‹
3. æ”¯æŒMQæ¨é€æ¨¡å¼
4. æ‰¹é‡æ¨é€ä¼˜åŒ–

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š

- APIæ–‡æ¡£ï¼š`docs/api/ç¬¬ä¸‰æ–¹APIæ–‡æ¡£.md`
- äº‹ä»¶è§„èŒƒï¼š`docs/api/äº‹ä»¶æ¨é€è§„èŒƒ.md`
- CHANGELOGï¼š`CHANGELOG.md` (v2.1.0)

---

**ç‰ˆæœ¬å†å²**:

- v1.0 (2025-01-03): åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€è®¾æ–½å®Œæˆ
