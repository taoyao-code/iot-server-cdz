# IoTå……ç”µæ¡©å®Œæ•´æµ‹è¯•è§„åˆ’

**ç‰ˆæœ¬:** v1.0  
**æ—¥æœŸ:** 2025-10-20  
**æµ‹è¯•ç¯å¢ƒ:** ç”Ÿäº§æµ‹è¯•ç¯å¢ƒ  
**å®é™…è®¾å¤‡:** 2å° (82210225000520, 82241218000382)

---

## ğŸ“‹ ç›®å½•

[TOC]

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚ (æœ€ç»ˆç”¨æˆ·,éœ€è¦å……ç”µ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ â‘  æ‰«ç /åˆ·å¡
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰æ–¹å¹³å°/å°ç¨‹åº   â”‚ (å•†æˆ·å¹³å°,ç”¨æˆ·ç•Œé¢)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ â‘¡ APIè°ƒç”¨
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IoTæœåŠ¡å™¨(æœ¬ç³»ç»Ÿ)  â”‚ â† â‘¢ TCPé•¿è¿æ¥å¿ƒè·³
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ â‘£ ä¸‹å‘å……ç”µæŒ‡ä»¤(0x82)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å……ç”µè®¾å¤‡(BKVç½‘å…³)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ â‘¤ æ§åˆ¶ç«¯å£é€šç”µ
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å……ç”µæ’åº§/ç«¯å£      â”‚ â†’ â‘¥ ç»™ç”¨æˆ·è®¾å¤‡ä¾›ç”µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
     ç”¨æˆ·è®¾å¤‡å……ç”µä¸­...
       â†“
     â‘¦ å®æ—¶ä¸ŠæŠ¥(0x06)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IoTæœåŠ¡å™¨          â”‚ â†’ â‘§ Webhookæ¨é€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰æ–¹å¹³å°         â”‚ (æ¥æ”¶å®æ—¶æ•°æ®)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ è§’è‰²ä¸èŒè´£

### 1. ç”¨æˆ· (ç»ˆç«¯æ¶ˆè´¹è€…)

**è®¾å¤‡:** ç”µåŠ¨è‡ªè¡Œè½¦ã€æ‰‹æœºç­‰éœ€å……ç”µè®¾å¤‡

**æ“ä½œæµç¨‹:**

1. æ‰¾åˆ°å……ç”µæ¡©
2. æ‰«æäºŒç»´ç  / åˆ·å……ç”µå¡
3. é€‰æ‹©å……ç”µæ¨¡å¼(æ—¶é•¿/ç”µé‡/å……æ»¡è‡ªåœ)
4. æ’å…¥å……ç”µæ’å¤´
5. å¼€å§‹å……ç”µ
6. å……ç”µå®Œæˆåæ‹”å‡ºæ’å¤´
7. æ”¯ä»˜/æŸ¥çœ‹è´¦å•

### 2. ç¬¬ä¸‰æ–¹å¹³å° (å•†æˆ·/è¿è¥å¹³å°)

**è§’è‰²:** å¾®ä¿¡å°ç¨‹åºã€æ”¯ä»˜å®å°ç¨‹åºã€å•†æˆ·åå°

**èŒè´£:**

- ç”¨æˆ·ç•Œé¢å±•ç¤º
- è®¢å•ç®¡ç†
- æ”¯ä»˜å¤„ç†
- è®¾å¤‡ç®¡ç†
- æ•°æ®ç»Ÿè®¡

**ä¸IoTæœåŠ¡å™¨äº¤äº’:**

#### ä¸»åŠ¨è°ƒç”¨API

```http
POST /api/v1/third/devices/{phy_id}/charge  - å¯åŠ¨å……ç”µ
POST /api/v1/third/devices/{phy_id}/stop    - åœæ­¢å……ç”µ
GET  /api/v1/third/devices/{phy_id}         - æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
GET  /api/v1/third/orders/{order_no}        - æŸ¥è¯¢è®¢å•
```

#### æ¥æ”¶Webhookæ¨é€

```
è®¾å¤‡æ³¨å†Œ     â†’ device.registered
è®¾å¤‡å¿ƒè·³     â†’ device.heartbeat (é‡‡æ ·10æ¬¡æ¨1æ¬¡)
è®¢å•åˆ›å»º     â†’ order.created
å……ç”µå¼€å§‹     â†’ charging.started
å……ç”µè¿›è¡Œ     â†’ charging.progress (æ¯åˆ†é’Ÿ1æ¬¡)
å……ç”µç»“æŸ     â†’ charging.ended
è®¢å•å®Œæˆ     â†’ order.completed
è®¾å¤‡å‘Šè­¦     â†’ device.alarm
```

### 3. IoTæœåŠ¡å™¨ (æœ¬ç³»ç»Ÿ)

**æ ¸å¿ƒèŒè´£:**

- TCPé•¿è¿æ¥ç®¡ç† (ç«¯å£7000)
- åè®®è§£æ (BKV/AP3000/GN)
- è®¾å¤‡çŠ¶æ€ç®¡ç† (Redis Session)
- è®¢å•ç®¡ç† (PostgreSQL)
- æŒ‡ä»¤ä¸‹å‘ (Redisé˜Ÿåˆ—)
- äº‹ä»¶æ¨é€ (Webhook)
- æ•°æ®æŒä¹…åŒ–

**å…³é”®ç»„ä»¶:**

```
TCP Server       - æ¥æ”¶è®¾å¤‡è¿æ¥
Protocol Router  - è·¯ç”±åè®®å¸§
Session Manager  - ç®¡ç†è®¾å¤‡ä¼šè¯
Database         - æŒä¹…åŒ–æ•°æ®
Redis Queue      - ä¸‹è¡ŒæŒ‡ä»¤é˜Ÿåˆ—
Outbound Worker  - å‘é€ä¸‹è¡ŒæŒ‡ä»¤
Event Queue      - æ¨é€äº‹ä»¶é˜Ÿåˆ—
```

### 4. å……ç”µè®¾å¤‡ (BKVç½‘å…³)

**ç¡¬ä»¶ç»„æˆ:**

- ä¸»æ§æ¿ (DTU)
- é€šä¿¡æ¨¡å— (4G/5G)
- ç»§ç”µå™¨æ§åˆ¶æ¿
- å……ç”µæ’åº§ (1-250ä¸ª)

**è®¾å¤‡IDä¿¡æ¯:**

- è®¾å¤‡1: `82210225000520`
- è®¾å¤‡2: `82241218000382`

**ä¸Šè¡Œåè®® (è®¾å¤‡â†’æœåŠ¡å™¨):**

```
0x0000 (0x20) - è®¾å¤‡æ³¨å†Œ/å¿ƒè·³
0x0021        - è®¾å¤‡çŠ¶æ€å¿ƒè·³
0x0002        - åˆ·å¡äº‹ä»¶
0x0003        - å……ç”µç»“ç®—
0x0006        - å……ç”µè¿›åº¦å¿ƒè·³
```

**ä¸‹è¡Œåè®® (æœåŠ¡å™¨â†’è®¾å¤‡):**

```
0x0082 - å¯åŠ¨/åœæ­¢å……ç”µ
0x008A - ä¿®æ”¹å……ç”µæ—¶é•¿/ç”µé‡
0x0081 - æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
0x0083-0x0089 - å‚æ•°è®¾ç½®
0x00E0-0x00E2 - OTAå‡çº§
```

**è®¾å¤‡èƒ½åŠ›:**

- å¿ƒè·³é—´éš”: 11ç§’
- é‡è¿æœºåˆ¶: æ–­çº¿å5-10ç§’é‡è¿
- ç½‘ç»œ: 4G/5Gç§»åŠ¨ç½‘ç»œ
- åè®®: BKV v8.6

---

## ğŸ”„ å®Œæ•´å……ç”µæµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·æ“ä½œ         ç¬¬ä¸‰æ–¹å¹³å°       IoTæœåŠ¡å™¨        å……ç”µè®¾å¤‡        æ•°æ®åº“/Redis
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚ 1.æ‰«ç /åˆ·å¡     â”‚               â”‚               â”‚                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚ 2.è°ƒç”¨å……ç”µAPI â”‚               â”‚                 â”‚
   â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚ 3.åˆ›å»ºè®¢å•    â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚ 4.æ¨é€æŒ‡ä»¤åˆ°é˜Ÿåˆ—                â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚ 5.APIå“åº”     â”‚               â”‚                 â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚ 6.Workerå–æŒ‡ä»¤â”‚                 â”‚
   â”‚                 â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚ 7.ä¸‹å‘0x82å‘½ä»¤â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚ 8.æ’å…¥æ’å¤´      â”‚               â”‚               â”‚                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚ 9.æ£€æµ‹æ’å…¥      â”‚
   â”‚                 â”‚               â”‚               â”‚ 10.ç»§ç”µå™¨é—­åˆ   â”‚
   â”‚                 â”‚               â”‚               â”‚ 11.å¼€å§‹å……ç”µ     â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚12.ä¸ŠæŠ¥0x06å¿ƒè·³â”‚                 â”‚
   â”‚                 â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚13.æ›´æ–°è®¢å•è¿›åº¦â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚14.æ¨é€äº‹ä»¶    â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚15.Webhookæ¨é€ â”‚               â”‚                 â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚ 16.å®æ—¶æŸ¥çœ‹è¿›åº¦  â”‚               â”‚               â”‚                 â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚  (æŒç»­å……ç”µ...)  â”‚   (æ¯11ç§’0x06)â”‚                 â”‚
   â”‚                 â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚ 17.æ‹”å‡ºæ’å¤´     â”‚               â”‚               â”‚                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚18.æ£€æµ‹æ‹”å‡º      â”‚
   â”‚                 â”‚               â”‚               â”‚19.ç»§ç”µå™¨æ–­å¼€    â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚20.ä¸ŠæŠ¥0x03ç»“ç®—â”‚                 â”‚
   â”‚                 â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚21.ç»“ç®—è®¢å•    â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚               â”‚22.æ¨é€å®Œæˆäº‹ä»¶â”‚                 â”‚
   â”‚                 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚                 â”‚23.Webhookæ¨é€ â”‚               â”‚                 â”‚
   â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                 â”‚
   â”‚                 â”‚               â”‚               â”‚                 â”‚
   â”‚ 24.æŸ¥çœ‹è´¦å•     â”‚               â”‚               â”‚                 â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚                 â”‚
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤è¯´æ˜

### é˜¶æ®µ1: å‡†å¤‡é˜¶æ®µ

#### 1.1 è®¾å¤‡ä¸Šçº¿

**è®¾å¤‡æ“ä½œ:**

- è®¾å¤‡ä¸Šç”µ
- é€šä¿¡æ¨¡å—è¿æ¥ç§»åŠ¨ç½‘ç»œ
- TCPè¿æ¥åˆ°æœåŠ¡å™¨ (IP:Port = 182.43.177.92:7065)

**é¢„æœŸæ—¥å¿—:**

```json
{"msg":"TCP connection accepted","remote_addr":"39.144.x.x:xxxxx"}
{"msg":"Protocol identified","protocol":"bkv"}
{"msg":"BKV frame received","cmd":"0x0000","gateway_id":"82210225000520"}
```

**éªŒè¯:**

```bash
# æŸ¥çœ‹è®¾å¤‡æ˜¯å¦åœ¨çº¿
docker exec -it iot-postgres-prod psql -U iot -d iot_server -c "
SELECT phy_id, last_seen_at, 
       NOW() - last_seen_at AS offline_duration
FROM devices 
WHERE phy_id IN ('82210225000520', '82241218000382')
ORDER BY last_seen_at DESC;
"
```

**é¢„æœŸç»“æœ:**

```
phy_id           | last_seen_at              | offline_duration
-----------------|---------------------------|------------------
82210225000520   | 2025-10-20 14:22:11+08    | 00:00:05
82241218000382   | 2025-10-20 14:22:11+08    | 00:00:03
```

#### 1.2 ç¬¬ä¸‰æ–¹å¹³å°å‡†å¤‡

**é…ç½®Webhookæ¥æ”¶åœ°å€:**

```yaml
# configs/production.yaml
third_party:
  webhook_url: "https://your-platform.com/api/iot/webhook"
  webhook_secret: "your-secret-key"
  enable_queue: true
```

**ç¬¬ä¸‰æ–¹å¹³å°éœ€å‡†å¤‡:**

```python
# webhookæ¥æ”¶ç«¯ç‚¹
@app.post("/api/iot/webhook")
def receive_webhook(request):
    # éªŒè¯ç­¾å
    signature = request.headers.get("X-Signature")
    timestamp = request.headers.get("X-Timestamp")
    nonce = request.headers.get("X-Nonce")
    
    # éªŒè¯ç­¾å(HMAC-SHA256)
    if not verify_signature(request.body, signature, timestamp, nonce):
        return {"error": "invalid signature"}, 401
    
    # å¤„ç†äº‹ä»¶
    event = request.json()
    event_type = event["event_type"]
    
    if event_type == "order.created":
        handle_order_created(event["data"])
    elif event_type == "charging.started":
        handle_charging_started(event["data"])
    elif event_type == "charging.progress":
        handle_charging_progress(event["data"])
    elif event_type == "order.completed":
        handle_order_completed(event["data"])
    
    return {"success": True}, 200
```

---

### é˜¶æ®µ2: å……ç”µå¯åŠ¨æµç¨‹

#### 2.1 ç”¨æˆ·å‘èµ·å……ç”µ

**åœºæ™¯A: æ‰«ç å……ç”µ (æ¨è)**

```
ç”¨æˆ·æ“ä½œ:
1. æ‰“å¼€å¾®ä¿¡å°ç¨‹åº
2. æ‰«æè®¾å¤‡ä¸Šçš„äºŒç»´ç 
   äºŒç»´ç å†…å®¹: https://your-platform.com/charge?device=82210225000520&port=1
3. é€‰æ‹©å……ç”µæ¨¡å¼:
   - æŒ‰æ—¶é•¿: å……ç”µ1å°æ—¶ (10å…ƒ)
   - æŒ‰ç”µé‡: å……ç”µ5åº¦ (7.5å…ƒ)
   - å……æ»¡è‡ªåœ: (é¢„ä¼°15å…ƒ)
4. ç¡®è®¤æ”¯ä»˜
```

**åœºæ™¯B: åˆ·å¡å……ç”µ**

```
ç”¨æˆ·æ“ä½œ:
1. æ‰¾åˆ°å……ç”µæ¡©
2. åˆ·å……ç”µå¡ (å¡å·: 1000000001, ä½™é¢: 100å…ƒ)
3. è®¾å¤‡æ£€æµ‹åˆ°åˆ·å¡

è®¾å¤‡ä¸ŠæŠ¥:
CMD: 0x0002 (åˆ·å¡äº‹ä»¶)
æ•°æ®: å¡å·ã€ç«¯å£å·ã€å¡å†…ä½™é¢

IoTæœåŠ¡å™¨å¤„ç†:
1. éªŒè¯å¡ç‰‡æœ‰æ•ˆæ€§
2. æ£€æŸ¥ä½™é¢
3. è‡ªåŠ¨ä¸‹å‘å……ç”µæŒ‡ä»¤
```

#### 2.2 ç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨å……ç”µAPI

**APIè¯·æ±‚ç¤ºä¾‹:**

```bash
curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: test-api-key-12345" \
  -H "X-Timestamp: $(date +%s)" \
  -H "X-Nonce: $(uuidgen)" \
  -d '{
    "port_no": 1,
    "charge_mode": 1,
    "duration": 3600,
    "amount": 1000,
    "price_per_kwh": 150,
    "service_fee": 100
  }'
```

**è¯·æ±‚å‚æ•°è¯´æ˜:**

- `port_no`: ç«¯å£å· (1-16,æˆ–255=æ™ºèƒ½é€‰æ‹©)
- `charge_mode`: å……ç”µæ¨¡å¼
  - 1 = æŒ‰æ—¶é•¿
  - 2 = æŒ‰ç”µé‡
  - 3 = æŒ‰åŠŸç‡
  - 4 = å……æ»¡è‡ªåœ
- `duration`: æ—¶é•¿(ç§’) - mode=1æ—¶å¿…å¡«
- `amount`: é‡‘é¢(åˆ†)
- `price_per_kwh`: ç”µä»·(åˆ†/åº¦)
- `service_fee`: æœåŠ¡è´¹ç‡(åƒåˆ†æ¯”)

**APIå“åº”:**

```json
{
  "code": 0,
  "message": "charge started successfully",
  "data": {
    "order_no": "THD1729407600001",
    "device_phy_id": "82210225000520",
    "port_no": 1,
    "status": "pending"
  },
  "request_id": "req-abc123",
  "timestamp": 1729407600
}
```

#### 2.3 IoTæœåŠ¡å™¨å¤„ç†

**å†…éƒ¨æµç¨‹:**

```go
// 1. éªŒè¯è®¾å¤‡å­˜åœ¨
devID, err := repo.EnsureDevice(ctx, "82210225000520")

// 2. æ£€æŸ¥è®¾å¤‡åœ¨çº¿
isOnline := sessionMgr.IsOnline("82210225000520", time.Now())
// æ³¨æ„: å³ä½¿ç¦»çº¿ä¹Ÿä¼šä¸‹å‘æŒ‡ä»¤,è®¾å¤‡ä¸Šçº¿åä¼šæ”¶åˆ°

// 3. åˆ›å»ºè®¢å•
orderNo := "THD1729407600001"
INSERT INTO orders (device_id, order_no, port_no, status, amount, ...)
VALUES (devID, orderNo, 1, 'pending', 1000, ...)

// 4. æ„é€ BKV 0x82å……ç”µæŒ‡ä»¤
cmd := 0x82
payload := encodeBKVChargeCommand(
    mode: 1,        // æŒ‰æ—¶é•¿
    balance: 1000,  // ä½™é¢(åˆ†)
    portNo: 1,      // ç«¯å£1
    chargeCmd: 1,   // å¼€å§‹å……ç”µ
    duration: 3600, // 3600ç§’
    orderNo: orderNo,
)

// 5. æ¨é€åˆ°Redisä¸‹è¡Œé˜Ÿåˆ—
outboundQueue.Enqueue(ctx, OutboundMessage{
    DeviceID: devID,
    PhyID: "82210225000520",
    Cmd: 0x82,
    MsgID: generateMsgID(),
    Payload: payload,
    Priority: 5,
})

// 6. æ¨é€è®¢å•åˆ›å»ºäº‹ä»¶
eventQueue.Push(Event{
    Type: "order.created",
    DevicePhyID: "82210225000520",
    Data: orderData,
})
```

#### 2.4 Outbound Workerå‘é€æŒ‡ä»¤

**Workerè½®è¯¢:**

```go
// æ¯500msæ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
for {
    msg := redisQueue.Pop()
    if msg != nil {
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿
        if sessionMgr.IsOnline(msg.PhyID) {
            conn := sessionMgr.GetConn(msg.PhyID)
            // å‘é€BKVå¸§
            frame := BuildBKVFrame(
                GatewayID: msg.PhyID,
                Cmd: msg.Cmd,
                MsgID: msg.MsgID,
                Data: msg.Payload,
            )
            conn.Write(frame)
            
            // è®°å½•å‘é€æ—¥å¿—
            logCmdLog(deviceID, msgID, cmd, direction_DOWN)
        } else {
            // è®¾å¤‡ç¦»çº¿,æ¨è¿Ÿé‡è¯•
            redisQueue.DelayRetry(msg, 30*time.Second)
        }
    }
    time.Sleep(500 * time.Millisecond)
}
```

**é¢„æœŸæ—¥å¿—:**

```json
{"msg":"outbound message sent","device":"82210225000520","cmd":"0x82","msg_id":12345}
```

#### 2.5 è®¾å¤‡æ¥æ”¶å¹¶æ‰§è¡Œ

**è®¾å¤‡å†…éƒ¨æµç¨‹:**

```c
// ä¼ªä»£ç 
void handle_0x82_command(Frame* frame) {
    // è§£æå‚æ•°
    uint8_t mode = frame->data[0];
    uint32_t balance = read_uint32(frame->data + 1);
    uint8_t portNo = frame->data[5];
    uint8_t chargeCmd = frame->data[6];
    uint16_t duration = read_uint16(frame->data + 7);
    char orderNo[17];
    memcpy(orderNo, frame->data + 9, 16);
    
    if (chargeCmd == 1) {
        // å¼€å§‹å……ç”µ
        set_relay(portNo, ON);  // ç»§ç”µå™¨é—­åˆ
        start_timer(portNo, duration);
        save_order(portNo, orderNo);
        
        // åº”ç­”æœåŠ¡å™¨
        send_ack(frame->msgID, 0x00); // 0x00=æˆåŠŸ
        
        // ç­‰å¾…æ’å¤´æ’å…¥...
        wait_for_plug_insert(portNo);
        
        // æ’å…¥åå‘é€0x04ç¡®è®¤
        send_0x04_order_confirm(portNo, orderNo);
        
        // å¼€å§‹å®šæ—¶ä¸ŠæŠ¥0x06
        start_heartbeat_0x06(portNo);
    }
}
```

**è®¾å¤‡åº”ç­”å¸§ (0x82å“åº”):**

```
CMD: 0x82
MsgID: 12345 (ä¸æœåŠ¡å™¨ä¸‹å‘ç›¸åŒ)
Data: 
  [0] = 0x00 (æˆåŠŸ) / 0x01-0xFF (å¤±è´¥åŸå› )
  [1] = è®¢å•å·16å­—èŠ‚
  [17] = ç«¯å£å·
  [18] = ç­‰å¾…å……ç”µç«¯å£æ•°
```

#### 2.6 ç”¨æˆ·æ’å…¥æ’å¤´

**ç‰©ç†æ“ä½œ:**

```
ç”¨æˆ·å°†ç”µåŠ¨è½¦å……ç”µå™¨æ’å…¥å……ç”µæ¡©ç«¯å£1
```

**è®¾å¤‡æ£€æµ‹:**

```c
// å…‰ç”µæ£€æµ‹æ’å¤´æ’å…¥
if (plug_sensor[portNo] == INSERTED) {
    // å‘é€0x04è®¢å•ç¡®è®¤
    send_order_confirm_0x04();
}
```

**ä¸ŠæŠ¥0x04è®¢å•ç¡®è®¤:**

```
CMD: 0x0004
Data:
  è®¢å•å·: 16å­—èŠ‚ (ä¸0x82ä¸‹å‘çš„ç›¸åŒ)
  ç«¯å£å·: 1å­—èŠ‚
  çŠ¶æ€: 0x00=ç¡®è®¤, 0x01=æ‹’ç»
```

**IoTæœåŠ¡å™¨å¤„ç†0x04:**

```go
func HandleOrderConfirm(frame *Frame) {
    orderNo := parseOrderNo(frame.Data[:16])
    portNo := frame.Data[16]
    status := frame.Data[17]
    
    if status == 0x00 {
        // ç¡®è®¤æˆåŠŸ,æ›´æ–°è®¢å•çŠ¶æ€
        UPDATE orders SET status = 'charging', start_time = NOW()
        WHERE order_no = orderNo
        
        // æ¨é€å……ç”µå¼€å§‹äº‹ä»¶
        eventQueue.Push({
            Type: "charging.started",
            Data: {order_no, port_no, start_time}
        })
    }
}
```

---

### é˜¶æ®µ3: å……ç”µè¿›è¡Œé˜¶æ®µ

#### 3.1 è®¾å¤‡å®æ—¶ä¸ŠæŠ¥ (0x06å¿ƒè·³)

**ä¸ŠæŠ¥é¢‘ç‡:**

- å……ç”µä¸­: æ¯11ç§’ä¸ŠæŠ¥ä¸€æ¬¡
- å†…å®¹: å½“å‰åŠŸç‡ã€ç´¯è®¡ç”µé‡ã€å……ç”µæ—¶é•¿

**0x06å¸§æ ¼å¼:**

```
CMD: 0x0006
Data:
  [0-15]  è®¢å•å· (16å­—èŠ‚)
  [16]    ç«¯å£å·
  [17-18] å……ç”µæ—¶é•¿ (ç§’)
  [19-20] å½“å‰åŠŸç‡ (0.1W)
  [21-22] ç´¯è®¡ç”µé‡ (0.01åº¦)
  [23-24] å³°å€¼åŠŸç‡ (0.1W)
  [25-28] æ—¶é—´æˆ³
  [29-30] åŒºé—´ç”µé‡ (0.01åº¦)
  ...
```

**IoTæœåŠ¡å™¨å¤„ç†:**

```go
func HandleChargingHeartbeat(frame *Frame) {
    orderNo := parseOrderNo(frame.Data[:16])
    portNo := frame.Data[16]
    duration := parseUint16(frame.Data[17:19])
    power := parseUint16(frame.Data[19:21]) // å•ä½0.1W
    kwh := parseUint16(frame.Data[21:23])   // å•ä½0.01åº¦
    peakPower := parseUint16(frame.Data[23:25])
    
    // æ›´æ–°è®¢å•è¿›åº¦
    UPDATE orders SET
        duration_sec = duration,
        current_power = power,
        total_kwh = kwh,
        peak_power = peakPower,
        updated_at = NOW()
    WHERE order_no = orderNo
    
    // æ›´æ–°ç«¯å£çŠ¶æ€
    UPDATE ports SET
        status = 1,  // å……ç”µä¸­
        power_w = power / 10,
        updated_at = NOW()
    WHERE device_id = devID AND port_no = portNo
    
    // æ¨é€å……ç”µè¿›åº¦äº‹ä»¶ (æ¯åˆ†é’Ÿæ¨é€ä¸€æ¬¡,é™ä½é¢‘ç‡)
    if duration % 60 == 0 {
        eventQueue.Push({
            Type: "charging.progress",
            Data: {
                order_no: orderNo,
                duration: duration,
                kwh: kwh / 100.0,
                power: power / 10.0,
            }
        })
    }
}
```

**é¢„æœŸæ—¥å¿—:**

```json
{"msg":"BKV frame received","cmd":"0x0006","gateway_id":"82210225000520","data_len":35}
{"msg":"charging progress updated","order_no":"THD1729407600001","duration":60,"kwh":0.15}
```

#### 3.2 ç¬¬ä¸‰æ–¹å¹³å°æ¥æ”¶å®æ—¶æ•°æ®

**Webhookæ¨é€å†…å®¹:**

```json
{
  "event_id": "charging.progress-THD1729407600001-1729407660",
  "event_type": "charging.progress",
  "device_phy_id": "82210225000520",
  "timestamp": 1729407660,
  "nonce": "a1b2c3d4",
  "data": {
    "order_no": "THD1729407600001",
    "port_no": 1,
    "duration_sec": 60,
    "total_kwh": 0.15,
    "current_power": 1500.5,
    "peak_power": 1800.0,
    "voltage": 220.5,
    "current": 6.8,
    "temp": 35
  }
}
```

**ç¬¬ä¸‰æ–¹å¹³å°å±•ç¤º:**

```
å……ç”µä¸­...
â”â”â”â”â”â”â”â”â”â” 25%

å·²å……ç”µæ—¶é•¿: 15åˆ†é’Ÿ
å½“å‰åŠŸç‡: 1500W
ç´¯è®¡ç”µé‡: 2.35åº¦
é¢„è®¡è´¹ç”¨: Â¥3.52
```

#### 3.3 æŸ¥è¯¢å®æ—¶çŠ¶æ€

**ç¬¬ä¸‰æ–¹å¹³å°ä¸»åŠ¨æŸ¥è¯¢:**

```bash
# APIæŸ¥è¯¢è®¢å•
curl -X GET "http://182.43.177.92:7055/api/v1/third/orders/THD1729407600001" \
  -H "X-Api-Key: test-api-key-12345"
```

**å“åº”:**

```json
{
  "code": 0,
  "data": {
    "order_no": "THD1729407600001",
    "device_phy_id": "82210225000520",
    "port_no": 1,
    "status": "charging",
    "start_time": 1729407600,
    "duration_sec": 900,
    "total_kwh": 2.35,
    "current_power": 1500.5,
    "peak_power": 1800.0,
    "amount": 1000
  }
}
```

---

### é˜¶æ®µ4: å……ç”µç»“æŸæµç¨‹

#### 4.1 æ­£å¸¸ç»“æŸ (ç”¨æˆ·æ‹”å‡ºæ’å¤´)

**ç”¨æˆ·æ“ä½œ:**

```
å……ç”µå®Œæˆå,ç”¨æˆ·æ‹”å‡ºå……ç”µæ’å¤´
```

**è®¾å¤‡æ£€æµ‹:**

```c
// å…‰ç”µä¼ æ„Ÿå™¨æ£€æµ‹æ‹”å‡º
if (plug_sensor[portNo] == REMOVED) {
    // ç»§ç”µå™¨æ–­å¼€
    set_relay(portNo, OFF);
    
    // åœæ­¢è®¡æ—¶
    stop_timer(portNo);
    
    // è¯»å–æœ€ç»ˆæ•°æ®
    uint32_t totalDuration = get_charge_duration(portNo);
    uint16_t totalKwh = get_total_kwh(portNo);
    uint16_t peakPower = get_peak_power(portNo);
    
    // å‘é€0x03ç»“ç®—å¸§
    send_settlement_0x03(
        orderNo,
        portNo,
        totalDuration,
        totalKwh,
        peakPower,
        endReason = 0x00  // æ­£å¸¸ç»“æŸ
    );
}
```

**0x03ç»“ç®—å¸§:**

```
CMD: 0x0003
Data:
  [0-15]  è®¢å•å· (16å­—èŠ‚)
  [16]    ç«¯å£å·
  [17-20] å……ç”µæ—¶é•¿ (ç§’)
  [21-22] æ€»ç”µé‡ (0.01åº¦)
  [23-24] æ€»é‡‘é¢ (åˆ†)
  [25]    ç»“ç®—åŸå› 
  [26-27] å³°å€¼åŠŸç‡ (0.1W)
  [28-31] æ—¶é—´æˆ³
  ...
```

**IoTæœåŠ¡å™¨å¤„ç†0x03:**

```go
func HandleSettlement(frame *Frame) {
    orderNo := parseOrderNo(frame.Data[:16])
    portNo := frame.Data[16]
    duration := parseUint32(frame.Data[17:21])
    kwh := parseUint16(frame.Data[21:23])
    amount := parseUint16(frame.Data[23:25])
    reason := frame.Data[25]
    peakPower := parseUint16(frame.Data[26:28])
    
    // ç»“ç®—è®¢å•
    err := repo.SettleOrder(ctx, devID, portNo, orderNo, 
        duration, kwh, reason)
    
    // æ›´æ–°è®¢å•æœ€ç»ˆçŠ¶æ€
    UPDATE orders SET
        status = 'completed',
        end_time = NOW(),
        duration_sec = duration,
        total_kwh = kwh,
        peak_power = peakPower,
        final_amount = calculate_amount(kwh, price_per_kwh),
        end_reason = reason,
        updated_at = NOW()
    WHERE order_no = orderNo
    
    // æ›´æ–°ç«¯å£çŠ¶æ€
    UPDATE ports SET
        status = 0,  // ç©ºé—²
        power_w = 0,
        updated_at = NOW()
    WHERE device_id = devID AND port_no = portNo
    
    // æ¨é€è®¢å•å®Œæˆäº‹ä»¶
    eventQueue.Push({
        Type: "order.completed",
        Data: {
            order_no: orderNo,
            duration: duration,
            total_kwh: kwh / 100.0,
            final_amount: calculate_amount(...),
            end_reason: parseReason(reason),
        }
    })
}
```

**ç»“ç®—åŸå› ç :**

```
0x00 = æ­£å¸¸ç»“æŸ
0x01 = å……æ»¡è‡ªåœ
0x02 = ä½™é¢ä¸è¶³
0x03 = è¿œç¨‹åœæ­¢
0x04 = è®¾å¤‡æ•…éšœ
0x05 = è¶…æ—¶
0x06 = ç”¨æˆ·ä¸»åŠ¨åœæ­¢
```

#### 4.2 ç¬¬ä¸‰æ–¹å¹³å°æ¥æ”¶å®Œæˆäº‹ä»¶

**Webhookæ¨é€:**

```json
{
  "event_type": "order.completed",
  "device_phy_id": "82210225000520",
  "data": {
    "order_no": "THD1729407600001",
    "port_no": 1,
    "duration_sec": 3600,
    "total_kwh": 5.23,
    "peak_power": 1800.0,
    "avg_power": 1480.0,
    "final_amount": 7.85,
    "end_reason": "normal",
    "end_reason_msg": "ç”¨æˆ·æ‹”å‡ºæ’å¤´",
    "start_time": 1729407600,
    "end_time": 1729411200
  }
}
```

**ç¬¬ä¸‰æ–¹å¹³å°å¤„ç†:**

```python
def handle_order_completed(data):
    order_no = data["order_no"]
    
    # 1. æ›´æ–°æœ¬åœ°è®¢å•çŠ¶æ€
    db.execute("""
        UPDATE local_orders SET
            status = 'completed',
            duration = %s,
            total_kwh = %s,
            final_amount = %s
        WHERE order_no = %s
    """, (data["duration_sec"], data["total_kwh"], 
          data["final_amount"], order_no))
    
    # 2. è®¡è´¹/æ‰£æ¬¾
    charge_user(order_no, data["final_amount"])
    
    # 3. æ¨é€ç”¨æˆ·é€šçŸ¥
    send_wechat_notification(user_id, f"å……ç”µå®Œæˆ,æ¶ˆè´¹{data['final_amount']}å…ƒ")
    
    # 4. ç”Ÿæˆç”µå­å°ç¥¨
    generate_receipt(order_no, data)
```

---

## ğŸ§ª å®Œæ•´æµ‹è¯•åœºæ™¯çŸ©é˜µ

### åœºæ™¯1: åŸºç¡€å……ç”µæµç¨‹æµ‹è¯•

| æµ‹è¯•é¡¹ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | éªŒè¯æ–¹æ³• |
|--------|---------|---------|---------|---------|
| 1.1 æ‰«ç å……ç”µ-æŒ‰æ—¶é•¿ | è®¾å¤‡åœ¨çº¿ | æ‰«ç â†’é€‰æ‹©1å°æ—¶â†’æ”¯ä»˜â†’æ’å…¥æ’å¤´ | å……ç”µå¯åŠ¨,1å°æ—¶ååœæ­¢ | æŸ¥è¯¢è®¢å•çŠ¶æ€ |
| 1.2 æ‰«ç å……ç”µ-æŒ‰ç”µé‡ | è®¾å¤‡åœ¨çº¿ | æ‰«ç â†’é€‰æ‹©5åº¦â†’æ”¯ä»˜â†’æ’å…¥æ’å¤´ | å……ç”µå¯åŠ¨,5åº¦ååœæ­¢ | æ£€æŸ¥æ€»ç”µé‡ |
| 1.3 æ‰«ç å……ç”µ-å……æ»¡è‡ªåœ | è®¾å¤‡åœ¨çº¿ | æ‰«ç â†’é€‰æ‹©å……æ»¡â†’æ”¯ä»˜â†’æ’å…¥æ’å¤´ | å……ç”µå¯åŠ¨,å……æ»¡åè‡ªåŠ¨åœæ­¢ | æ£€æŸ¥ç»“ç®—åŸå›  |
| 1.4 åˆ·å¡å……ç”µ | è®¾å¤‡åœ¨çº¿ | åˆ·å¡â†’æ’å…¥æ’å¤´ | è‡ªåŠ¨å¯åŠ¨,æŒ‰å¡ç‰‡è®¾ç½®å……ç”µ | æ£€æŸ¥å¡ç‰‡ä½™é¢æ‰£é™¤ |

### åœºæ™¯2: APIè°ƒç”¨æµ‹è¯•

| æµ‹è¯•é¡¹ | API | é¢„æœŸç»“æœ |
|--------|-----|---------|
| 2.1 å¯åŠ¨å……ç”µ | POST /third/devices/{id}/charge | è¿”å›è®¢å•å·,æŒ‡ä»¤ä¸‹å‘æˆåŠŸ |
| 2.2 åœæ­¢å……ç”µ | POST /third/devices/{id}/stop | è®¾å¤‡åœæ­¢å……ç”µ,è®¢å•ç»“ç®— |
| 2.3 æŸ¥è¯¢è®¾å¤‡ | GET /third/devices/{id} | è¿”å›è®¾å¤‡åœ¨çº¿çŠ¶æ€å’Œç«¯å£çŠ¶æ€ |
| 2.4 æŸ¥è¯¢è®¢å• | GET /third/orders/{order_no} | è¿”å›è®¢å•è¯¦æƒ…å’Œå®æ—¶è¿›åº¦ |
| 2.5 è®¾ç½®å‚æ•° | POST /third/devices/{id}/params | å‚æ•°ä¸‹å‘æˆåŠŸ,è®¾å¤‡åº”ç­” |

### åœºæ™¯3: è®¾å¤‡çŠ¶æ€æµ‹è¯•

| æµ‹è¯•é¡¹ | è§¦å‘æ¡ä»¶ | é¢„æœŸè¡Œä¸º | éªŒè¯ |
|--------|---------|---------|------|
| 3.1 è®¾å¤‡ä¸Šçº¿ | è®¾å¤‡å¼€æœº/é‡å¯ | å‘é€0x0000æ³¨å†Œ,å¿ƒè·³å¼€å§‹ | last_seen_atæ›´æ–° |
| 3.2 è®¾å¤‡ç¦»çº¿ | æ–­ç½‘/å…³æœº | 30ç§’æ— å¿ƒè·³åˆ¤å®šç¦»çº¿ | sessionè¿‡æœŸ |
| 3.3 è®¾å¤‡é‡è¿ | ç½‘ç»œæ¢å¤ | 5-10ç§’å†…é‡æ–°è¿æ¥ | æ—¥å¿—æ˜¾ç¤ºæ–°è¿æ¥ |
| 3.4 IPå˜åŒ– | åŸºç«™åˆ‡æ¢ | æ–­å¼€â†’é‡è¿,æ–°IP | æ—¥å¿—æ˜¾ç¤ºIPå˜åŒ– |

### åœºæ™¯4: å¼‚å¸¸æƒ…å†µæµ‹è¯•

| æµ‹è¯•é¡¹ | å¼‚å¸¸æƒ…å†µ | é¢„æœŸå¤„ç† | éªŒè¯ |
|--------|---------|---------|------|
| 4.1 å……ç”µä¸­æ–­ç½‘ | æ‹”æ‰è®¾å¤‡ç½‘çº¿ | è®¾å¤‡ç¦»çº¿,é‡è¿åç»§ç»­å……ç”µ | è®¢å•çŠ¶æ€ä¿æŒ |
| 4.2 å……ç”µä¸­æ‹”å‡ºæ’å¤´ | ç”¨æˆ·ä¸­é€”æ‹”å‡º | ç«‹å³ç»“ç®—,æŒ‰å®é™…ä½¿ç”¨è®¡è´¹ | æ£€æŸ¥ç»“ç®—æ•°æ® |
| 4.3 è®¾å¤‡æ•…éšœ | ç»§ç”µå™¨æ•…éšœ | ä¸ŠæŠ¥æ•…éšœç ,å……ç”µåœæ­¢ | æ¨é€å‘Šè­¦äº‹ä»¶ |
| 4.4 ä½™é¢ä¸è¶³ | åˆ·å¡å……ç”µä½™é¢ä¸è¶³ | æ‹’ç»å¯åŠ¨æˆ–ä¸­é€”åœæ­¢ | æ£€æŸ¥ç»“ç®—åŸå›  |
| 4.5 ç«¯å£å ç”¨ | æŒ‡å®šç«¯å£å·²åœ¨å……ç”µ | è¿”å›ç«¯å£å¿™é”™è¯¯ | APIè¿”å›é”™è¯¯ç  |
| 4.6 è®¢å•å†²çª | åŒç«¯å£é‡å¤ä¸‹å‘ | æ‹’ç»æ–°è®¢å• | æ£€æŸ¥è®¢å•çŠ¶æ€ |

### åœºæ™¯5: å¹¶å‘æµ‹è¯•

| æµ‹è¯•é¡¹ | å¹¶å‘æ“ä½œ | é¢„æœŸç»“æœ |
|--------|---------|---------|
| 5.1 å¤šç«¯å£åŒæ—¶å……ç”µ | åŒæ—¶å¯åŠ¨ç«¯å£1-4 | æ‰€æœ‰ç«¯å£ç‹¬ç«‹å·¥ä½œ |
| 5.2 å¤šè®¾å¤‡åŒæ—¶å……ç”µ | ä¸¤å°è®¾å¤‡åŒæ—¶æ“ä½œ | äº’ä¸å¹²æ‰° |
| 5.3 é«˜é¢‘APIè°ƒç”¨ | 1ç§’å†…10æ¬¡è¯·æ±‚ | é™æµä¿æŠ¤,è¿”å›429 |

---

## ğŸ¯ è¯¦ç»†æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ TC001: æ‰«ç å……ç”µ-æŒ‰æ—¶é•¿-æ­£å¸¸å®Œæˆ

**å‰ç½®æ¡ä»¶:**

- âœ… è®¾å¤‡ `82210225000520` åœ¨çº¿
- âœ… ç«¯å£1ç©ºé—²
- âœ… ç¬¬ä¸‰æ–¹å¹³å°Webhookå·²é…ç½®

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: ç”¨æˆ·æ‰«ç 

```
æ“ä½œ: ç”¨æˆ·æ‰«æè®¾å¤‡ä¸Šçš„äºŒç»´ç 
å°ç¨‹åº: æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯å’Œå¯ç”¨ç«¯å£
```

#### Step 2: é€‰æ‹©å……ç”µæ¨¡å¼

```
æ“ä½œ: é€‰æ‹©"æŒ‰æ—¶é•¿" - 1å°æ—¶(3600ç§’)
é‡‘é¢: 10å…ƒ (1000åˆ†)
ç¡®è®¤: ç‚¹å‡»"å¼€å§‹å……ç”µ"
```

#### Step 3: ç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨API

```bash
curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: test-api-key" \
  -d '{
    "port_no": 1,
    "charge_mode": 1,
    "duration": 3600,
    "amount": 1000,
    "price_per_kwh": 150,
    "service_fee": 100
  }'
```

**é¢„æœŸå“åº”:**

```json
{
  "code": 0,
  "message": "charge started successfully",
  "data": {
    "order_no": "THD1729407600001",
    "device_phy_id": "82210225000520",
    "port_no": 1
  }
}
```

#### Step 4: éªŒè¯è®¢å•åˆ›å»º

```sql
SELECT order_no, status, port_no, amount, created_at 
FROM orders 
WHERE order_no = 'THD1729407600001';
```

**é¢„æœŸç»“æœ:**

```
order_no          | status  | port_no | amount | created_at
------------------|---------|---------|--------|-------------------
THD1729407600001  | pending | 1       | 1000   | 2025-10-20 14:00:00
```

#### Step 5: éªŒè¯ä¸‹è¡ŒæŒ‡ä»¤å…¥é˜Ÿ

```bash
# æ£€æŸ¥Redisé˜Ÿåˆ—
docker exec -it iot-redis-prod redis-cli
> LLEN outbound:82210225000520
(integer) 1

> LINDEX outbound:82210225000520 0
# åº”åŒ…å«0x82å……ç”µæŒ‡ä»¤
```

#### Step 6: è§‚å¯Ÿæ—¥å¿—-æŒ‡ä»¤ä¸‹å‘

```bash
docker logs -f iot-server-prod | grep "82210225000520"
```

**é¢„æœŸæ—¥å¿—:**

```json
{"msg":"outbound message dequeued","device":"82210225000520","cmd":"0x82"}
{"msg":"BKV frame sent","gateway_id":"82210225000520","cmd":"0x82","msg_id":12345}
```

#### Step 7: éªŒè¯è®¾å¤‡åº”ç­”

```json
{"msg":"BKV frame received","cmd":"0x82","gateway_id":"82210225000520","msg_id":12345}
{"msg":"device ack received","status":"success"}
```

#### Step 8: ç”¨æˆ·æ’å…¥æ’å¤´

**æ“ä½œ:** ç‰©ç†æ’å…¥å……ç”µæ’å¤´åˆ°ç«¯å£1

**ç­‰å¾…:** 2-5ç§’ (è®¾å¤‡æ£€æµ‹)

#### Step 9: éªŒè¯è®¢å•ç¡®è®¤ (0x04)

```json
{"msg":"BKV frame received","cmd":"0x0004","gateway_id":"82210225000520"}
{"msg":"order confirmed","order_no":"THD1729407600001","port_no":1}
```

**éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°:**

```sql
SELECT status, start_time FROM orders WHERE order_no = 'THD1729407600001';
```

**é¢„æœŸ:**

```
status   | start_time
---------|-------------------
charging | 2025-10-20 14:00:35
```

#### Step 10: éªŒè¯ç¬¬ä¸‰æ–¹æ¥æ”¶"å……ç”µå¼€å§‹"äº‹ä»¶

**Webhookè¯·æ±‚:**

```json
POST https://your-platform.com/api/iot/webhook
{
  "event_type": "charging.started",
  "data": {
    "order_no": "THD1729407600001",
    "port_no": 1,
    "start_time": 1729407635
  }
}
```

**ç¬¬ä¸‰æ–¹å¹³å°éªŒè¯:**

```python
# æ£€æŸ¥æ¥æ”¶åˆ°çš„äº‹ä»¶
events = db.query("SELECT * FROM received_events WHERE event_type='charging.started'")
assert len(events) == 1
assert events[0].order_no == "THD1729407600001"
```

#### Step 11: è§‚å¯Ÿå……ç”µè¿›åº¦ (æŒç»­60åˆ†é’Ÿ)

**æ¯11ç§’è®¾å¤‡ä¸ŠæŠ¥0x06:**

```json
// ç¬¬1æ¬¡ (11ç§’)
{"cmd":"0x0006","duration":11,"kwh":5,"power":1500}

// ç¬¬6æ¬¡ (60ç§’)
{"cmd":"0x0006","duration":60,"kwh":25,"power":1500}

// ç¬¬60æ¬¡ (660ç§’)
{"cmd":"0x0006","duration":660,"kwh":275,"power":1500}
```

**æ•°æ®åº“éªŒè¯:**

```sql
SELECT duration_sec, total_kwh, current_power, updated_at
FROM orders 
WHERE order_no = 'THD1729407600001';
```

**æ¯åˆ†é’ŸéªŒè¯ä¸€æ¬¡Webhookæ¨é€:**

```json
// 1åˆ†é’Ÿæ—¶
{"event_type":"charging.progress","data":{"duration":60,"kwh":0.25}}

// 10åˆ†é’Ÿæ—¶
{"event_type":"charging.progress","data":{"duration":600,"kwh":2.5}}

// 30åˆ†é’Ÿæ—¶
{"event_type":"charging.progress","data":{"duration":1800,"kwh":7.5}}
```

#### Step 12: å……ç”µå®Œæˆ (60åˆ†é’Ÿå)

**å®šæ—¶å™¨åˆ°è¾¾:**

- è®¾å¤‡å†…éƒ¨è®¡æ—¶å™¨è¾¾åˆ°3600ç§’
- è‡ªåŠ¨æ–­å¼€ç»§ç”µå™¨
- å‘é€0x03ç»“ç®—

**æˆ–ç”¨æˆ·ä¸»åŠ¨æ‹”å‡º:**

- ç”¨æˆ·åœ¨50åˆ†é’Ÿæ—¶æ‹”å‡ºæ’å¤´
- è®¾å¤‡æ£€æµ‹æ‹”å‡º
- ç«‹å³å‘é€0x03ç»“ç®—

#### Step 13: éªŒè¯ç»“ç®—æ•°æ®

**0x03ç»“ç®—å¸§æ•°æ®:**

```
è®¢å•å·: THD1729407600001
æ—¶é•¿: 3600ç§’ (1å°æ—¶)
ç”µé‡: 523 (5.23åº¦)
é‡‘é¢: 785åˆ† (7.85å…ƒ)
åŸå› : 0x00 (æ­£å¸¸ç»“æŸ)
å³°å€¼åŠŸç‡: 18000 (1800W)
```

**æ•°æ®åº“éªŒè¯:**

```sql
SELECT 
    order_no,
    status,
    duration_sec,
    total_kwh,
    final_amount,
    end_reason,
    end_time
FROM orders 
WHERE order_no = 'THD1729407600001';
```

**é¢„æœŸç»“æœ:**

```
order_no         | status    | duration_sec | total_kwh | final_amount | end_reason | end_time
-----------------|-----------|--------------|-----------|--------------|------------|-------------------
THD1729407600001 | completed | 3600         | 523       | 785          | 0          | 2025-10-20 15:00:35
```

#### Step 14: éªŒè¯æœ€ç»ˆWebhookæ¨é€

**order.completedäº‹ä»¶:**

```json
{
  "event_type": "order.completed",
  "data": {
    "order_no": "THD1729407600001",
    "duration_sec": 3600,
    "total_kwh": 5.23,
    "final_amount": 7.85,
    "end_reason": "normal"
  }
}
```

#### Step 15: ç¬¬ä¸‰æ–¹å¹³å°å±•ç¤ºè´¦å•

```
å……ç”µè´¦å•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è®¢å•å·: THD1729407600001
è®¾å¤‡: 82210225000520
ç«¯å£: 1å·å£

å……ç”µæ—¶é•¿: 60åˆ†é’Ÿ
æ¶ˆè´¹ç”µé‡: 5.23åº¦
ç”µä»·: 1.50å…ƒ/åº¦
æœåŠ¡è´¹: 0.10å…ƒ/åº¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åˆè®¡: Â¥7.85

å¼€å§‹æ—¶é—´: 2025-10-20 14:00:35
ç»“æŸæ—¶é—´: 2025-10-20 15:00:35
ç»“æŸåŸå› : å……ç”µå®Œæˆ
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… è®¢å•çŠ¶æ€: completed
- âœ… æ—¶é•¿è¯¯å·®: <5ç§’
- âœ… ç”µé‡åˆç†: 5-6åº¦(1å°æ—¶@1500W)
- âœ… é‡‘é¢æ­£ç¡®: æŒ‰ç”µä»·è®¡ç®—
- âœ… æ¨é€å®Œæ•´: æ”¶åˆ°æ‰€æœ‰äº‹ä»¶
- âœ… ç«¯å£çŠ¶æ€: æ¢å¤ç©ºé—²

---

### æµ‹è¯•ç”¨ä¾‹ TC002: è¿œç¨‹åœæ­¢å……ç”µ

**å‰ç½®æ¡ä»¶:**

- è®¢å• `THD1729407700001` æ­£åœ¨å……ç”µä¸­
- å·²å……ç”µ20åˆ†é’Ÿ

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: ç¬¬ä¸‰æ–¹å¹³å°è°ƒç”¨åœæ­¢API

```bash
curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/stop" \
  -H "X-Api-Key: test-api-key" \
  -d '{
    "port_no": 1,
    "order_no": "THD1729407700001",
    "reason": "user_cancelled"
  }'
```

#### Step 2: IoTæœåŠ¡å™¨ä¸‹å‘0x82åœæ­¢æŒ‡ä»¤

```
Cmd: 0x82
ChargeCmd: 0 (åœæ­¢)
OrderNo: THD1729407700001
PortNo: 1
```

#### Step 3: è®¾å¤‡æ‰§è¡Œåœæ­¢

```c
set_relay(1, OFF);  // ç»§ç”µå™¨æ–­å¼€
send_settlement_0x03(reason = 0x03); // è¿œç¨‹åœæ­¢
```

#### Step 4: éªŒè¯ç»“ç®—

```sql
SELECT status, end_reason FROM orders WHERE order_no = 'THD1729407700001';
-- é¢„æœŸ: status='completed', end_reason=3
```

#### Step 5: éªŒè¯æ¨é€

```json
{
  "event_type": "order.completed",
  "data": {
    "end_reason": "remote_stop",
    "duration_sec": 1200
  }
}
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… è®¾å¤‡ç«‹å³åœæ­¢å……ç”µ
- âœ… æŒ‰å®é™…ä½¿ç”¨è®¡è´¹(20åˆ†é’Ÿ)
- âœ… ç»“ç®—åŸå› æ­£ç¡®(0x03)

---

### æµ‹è¯•ç”¨ä¾‹ TC003: å……ç”µä¸­è®¾å¤‡æ–­ç½‘

**å‰ç½®æ¡ä»¶:**

- è®¢å•æ­£åœ¨å……ç”µä¸­
- å·²å……ç”µ10åˆ†é’Ÿ

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: æ¨¡æ‹Ÿè®¾å¤‡æ–­ç½‘

```
æ“ä½œ: æ‹”æ‰è®¾å¤‡ç½‘çº¿ / å…³é—­4Gæ¨¡å—
```

#### Step 2: è§‚å¯ŸIoTæœåŠ¡å™¨æ—¥å¿—

```json
// 30ç§’å
{"msg":"TCP read error","error":"EOF"}
{"msg":"connection will close","remote_addr":"39.144.x.x"}
```

#### Step 3: éªŒè¯Sessionè¿‡æœŸ

```bash
# æ£€æŸ¥Redis session
docker exec -it iot-redis-prod redis-cli
> GET session:82210225000520
(nil)  # å·²è¿‡æœŸ
```

#### Step 4: è®¾å¤‡ç«¯è¡Œä¸º

```
è®¾å¤‡ç»§ç»­å……ç”µ (ç¦»çº¿æ¨¡å¼)
- ç»§ç”µå™¨ä¿æŒé—­åˆ
- æœ¬åœ°è®¡æ—¶ç»§ç»­
- æ•°æ®æš‚å­˜æœ¬åœ°
```

#### Step 5: æ¢å¤ç½‘ç»œ

```
æ“ä½œ: æ¢å¤ç½‘ç»œè¿æ¥
é¢„æœŸ: 5-10ç§’å†…é‡è¿
```

#### Step 6: è®¾å¤‡é‡è¿åä¸ŠæŠ¥

```json
// é‡è¿
{"msg":"TCP connection accepted","remote_addr":"39.144.x.x"}

// é¦–æ¬¡å¿ƒè·³æºå¸¦ç¦»çº¿æœŸé—´æ•°æ®
{"cmd":"0x0006","duration":650,"kwh":270} // åŒ…å«ç¦»çº¿æœŸé—´çš„ç´¯è®¡
```

#### Step 7: éªŒè¯æ•°æ®ä¸€è‡´æ€§

```sql
SELECT duration_sec, total_kwh FROM orders WHERE order_no = ?;
-- åº”åŒ…å«ç¦»çº¿æœŸé—´çš„æ•°æ®
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… ç¦»çº¿ä¸å½±å“å……ç”µ
- âœ… é‡è¿åæ•°æ®åŒæ­¥
- âœ… è®¢å•æ•°æ®å®Œæ•´

---

### æµ‹è¯•ç”¨ä¾‹ TC004: è®¢å•è¿›è¡Œä¸­è®¾å¤‡é‡å¯

**å‰ç½®æ¡ä»¶:**

- è®¢å•æ­£åœ¨å……ç”µä¸­

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: é‡å¯è®¾å¤‡

```
æ“ä½œ: é‡å¯è®¾å¤‡(æ¨¡æ‹Ÿæ–­ç”µé‡å¯)
```

#### Step 2: è®¾å¤‡é‡å¯åè¡Œä¸º

**Option A: è®¢å•ä¸¢å¤± (è®¾å¤‡æœªæŒä¹…åŒ–)**

```
è®¾å¤‡é‡å¯ â†’ å†…å­˜æ¸…ç©º â†’ è®¢å•ä¸¢å¤± â†’ éœ€é‡æ–°å¯åŠ¨
```

**Option B: è®¢å•æ¢å¤ (è®¾å¤‡æœ‰EEPROM)**

```c
// è®¾å¤‡å¯åŠ¨æ—¶ä»EEPROMè¯»å–æœªå®Œæˆè®¢å•
void on_startup() {
    load_active_orders_from_eeprom();
    for (order in active_orders) {
        resume_charging(order);
        send_0x06_heartbeat(order); // é€šçŸ¥æœåŠ¡å™¨æ¢å¤
    }
}
```

#### Step 3: éªŒè¯è®¢å•çŠ¶æ€

```
æ£€æŸ¥: è®¢å•æ˜¯å¦ç»§ç»­,è¿˜æ˜¯å·²ç»“ç®—
é¢„æœŸ: æ ¹æ®è®¾å¤‡å®ç°å†³å®š
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- å¦‚è®¾å¤‡æ”¯æŒæ¢å¤: âœ… è®¢å•ç»§ç»­
- å¦‚è®¾å¤‡ä¸æ”¯æŒ: âœ… è®¢å•æ ‡è®°ä¸ºå¼‚å¸¸,é€€æ¬¾

---

### æµ‹è¯•ç”¨ä¾‹ TC005: å¤šç«¯å£å¹¶å‘å……ç”µ

**å‰ç½®æ¡ä»¶:**

- è®¾å¤‡æœ‰4ä¸ªç«¯å£
- 4ä¸ªç«¯å£éƒ½ç©ºé—²

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: åŒæ—¶å¯åŠ¨4ä¸ªç«¯å£

```bash
# å¹¶å‘è°ƒç”¨API (å¯ç”¨è„šæœ¬)
for port in 1 2 3 4; do
  curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge" \
    -H "Content-Type: application/json" \
    -H "X-Api-Key: test-api-key" \
    -d "{\"port_no\":$port,\"charge_mode\":1,\"duration\":3600,\"amount\":1000}" &
done
wait
```

#### Step 2: éªŒè¯4ä¸ªè®¢å•åˆ›å»º

```sql
SELECT port_no, order_no, status FROM orders 
WHERE device_id = (SELECT id FROM devices WHERE phy_id = '82210225000520')
AND status IN ('pending', 'charging')
ORDER BY port_no;
```

**é¢„æœŸ:**

```
port_no | order_no          | status
--------|-------------------|----------
1       | THD1729407600001  | pending
2       | THD1729407600002  | pending
3       | THD1729407600003  | pending
4       | THD1729407600004  | pending
```

#### Step 3: æ’å…¥4ä¸ªæ’å¤´

**æ“ä½œ:** ä¾æ¬¡æ’å…¥ç«¯å£1-4çš„æ’å¤´

**é¢„æœŸ:** æ¯ä¸ªç«¯å£ç‹¬ç«‹ç¡®è®¤(0x04),ç‹¬ç«‹ä¸ŠæŠ¥(0x06)

#### Step 4: è§‚å¯Ÿå¿ƒè·³æ•°æ®

```json
// ç«¯å£1
{"cmd":"0x0006","port_no":1,"duration":60,"power":1500}

// ç«¯å£2  
{"cmd":"0x0006","port_no":2,"duration":55,"power":1600}

// ç«¯å£3
{"cmd":"0x0006","port_no":3,"duration":50,"power":1400}

// ç«¯å£4
{"cmd":"0x0006","port_no":4,"duration":45,"power":1550}
```

#### Step 5: éªŒè¯æ€»åŠŸç‡ä¸è¶…é™

```sql
SELECT SUM(power_w) AS total_power 
FROM ports 
WHERE device_id = (SELECT id FROM devices WHERE phy_id = '82210225000520')
AND status = 1;
```

**é¢„æœŸ:** æ€»åŠŸç‡ < è®¾å¤‡é¢å®šåŠŸç‡ (ä¾‹å¦‚6000W)

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… 4ä¸ªç«¯å£ç‹¬ç«‹å·¥ä½œ
- âœ… æ•°æ®äº’ä¸å¹²æ‰°
- âœ… æ€»åŠŸç‡å—æ§

---

## ğŸš¨ å¼‚å¸¸åœºæ™¯æµ‹è¯•

### å¼‚å¸¸1: è®¾å¤‡ç¦»çº¿æ—¶ä¸‹å‘å……ç”µæŒ‡ä»¤

**åœºæ™¯:**

```
è®¾å¤‡ç¦»çº¿ â†’ ç¬¬ä¸‰æ–¹è°ƒç”¨å……ç”µAPI â†’ æŒ‡ä»¤å¦‚ä½•å¤„ç†?
```

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: æ–­å¼€è®¾å¤‡è¿æ¥

```bash
# åœ¨è®¾å¤‡ç«¯æ–­å¼€ç½‘ç»œ
# æˆ–åœ¨æœåŠ¡å™¨ç«¯å¼ºåˆ¶æ–­å¼€
docker exec -it iot-server-prod sh -c "
  # æ‰¾åˆ°è®¾å¤‡è¿æ¥å¹¶å…³é—­(éœ€è¦é¢å¤–å·¥å…·)
"
```

#### Step 2: ç­‰å¾…Sessionè¿‡æœŸ

```bash
# é»˜è®¤6åˆ†é’Ÿè¶…æ—¶
sleep 360
```

#### Step 3: éªŒè¯è®¾å¤‡ç¦»çº¿

```bash
curl "http://182.43.177.92:7055/api/devices/82210225000520" | jq '.online'
# é¢„æœŸ: false
```

#### Step 4: è°ƒç”¨å……ç”µAPI

```bash
curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge" \
  -H "X-Api-Key: test-api-key" \
  -d '{...}'
```

**é¢„æœŸè¡Œä¸º:**

```
1. APIè¿”å›æˆåŠŸ(ä¸é˜»æ­¢ä¸‹å‘)
2. è®¢å•åˆ›å»ºæˆåŠŸ
3. æŒ‡ä»¤è¿›å…¥Redisé˜Ÿåˆ—
4. Workeræ£€æµ‹è®¾å¤‡ç¦»çº¿,æš‚ä¸å‘é€
5. æŒ‡ä»¤ä¿ç•™åœ¨é˜Ÿåˆ—ä¸­,ç­‰å¾…è®¾å¤‡ä¸Šçº¿
```

#### Step 5: è®¾å¤‡é‡æ–°ä¸Šçº¿

```
è®¾å¤‡è¿æ¥ â†’ Workeræ£€æµ‹åˆ°åœ¨çº¿ â†’ å‘é€ç´¯ç§¯çš„æŒ‡ä»¤
```

#### Step 6: éªŒè¯æŒ‡ä»¤é€è¾¾

```
è®¾å¤‡æ”¶åˆ°0x82 â†’ åº”ç­” â†’ å¼€å§‹å……ç”µ(å¦‚å·²æ’å…¥æ’å¤´)
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… ç¦»çº¿ä¸å½±å“APIè°ƒç”¨
- âœ… æŒ‡ä»¤å»¶è¿Ÿé€è¾¾
- âœ… æœ€ç»ˆå……ç”µæ­£å¸¸

---

### å¼‚å¸¸2: ç«¯å£æ•…éšœ

**åœºæ™¯:**

```
å……ç”µä¸­ç«¯å£å‡ºç°æ•…éšœ â†’ è®¾å¤‡ä¸ŠæŠ¥æ•…éšœç  â†’ æœåŠ¡å™¨å¦‚ä½•å¤„ç†?
```

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: æ¨¡æ‹Ÿç«¯å£æ•…éšœ

```
æ¨¡æ‹Ÿæ–¹æ³•:
- çŸ­è·¯ä¿æŠ¤è§¦å‘
- è¿‡æµä¿æŠ¤è§¦å‘
- æ¸©åº¦è¿‡é«˜
```

#### Step 2: è®¾å¤‡ä¸ŠæŠ¥æ•…éšœ (0x06æˆ–0x21å¿ƒè·³)

```
ç«¯å£çŠ¶æ€å­—æ®µ:
  bit0-1: å……ç”µçŠ¶æ€
  bit2-7: æ•…éšœç 
  
æ•…éšœç :
  0x04 = çŸ­è·¯
  0x08 = è¿‡æµ
  0x10 = è¿‡æ¸©
```

#### Step 3: IoTæœåŠ¡å™¨å¤„ç†

```go
if portStatus & 0xFC != 0 {  // æœ‰æ•…éšœ
    faultCode := (portStatus >> 2) & 0x3F
    
    // æ›´æ–°ç«¯å£çŠ¶æ€
    UPDATE ports SET status = 2, fault_code = faultCode
    
    // è‡ªåŠ¨åœæ­¢å……ç”µ
    if order.Status == "charging" {
        SettleOrder(order, reason="fault")
    }
    
    // æ¨é€å‘Šè­¦äº‹ä»¶
    eventQueue.Push({
        Type: "device.alarm",
        Data: {
            device_phy_id: "82210225000520",
            port_no: 1,
            fault_code: faultCode,
            fault_msg: "ç«¯å£çŸ­è·¯ä¿æŠ¤",
        }
    })
}
```

#### Step 4: ç¬¬ä¸‰æ–¹å¹³å°æ¥æ”¶å‘Šè­¦

```json
{
  "event_type": "device.alarm",
  "data": {
    "alarm_type": "port_fault",
    "port_no": 1,
    "fault_code": 4,
    "fault_msg": "çŸ­è·¯ä¿æŠ¤è§¦å‘"
  }
}
```

#### Step 5: éªŒè¯ç”¨æˆ·é€šçŸ¥

```
å°ç¨‹åºå¼¹çª—: "å……ç”µå¼‚å¸¸åœæ­¢,è®¾å¤‡ç«¯å£æ•…éšœ,å·²è‡ªåŠ¨é€€æ¬¾"
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… è‡ªåŠ¨åœæ­¢å……ç”µ
- âœ… æŒ‰å®é™…ä½¿ç”¨ç»“ç®—
- âœ… æ¨é€å‘Šè­¦é€šçŸ¥
- âœ… ç”¨æˆ·æ”¶åˆ°é€€æ¬¾

---

### å¼‚å¸¸3: é‡å¤ä¸‹å‘å……ç”µæŒ‡ä»¤

**åœºæ™¯:**

```
ç«¯å£1æ­£åœ¨å……ç”µ â†’ å†æ¬¡å¯¹ç«¯å£1ä¸‹å‘å……ç”µ â†’ å¦‚ä½•å¤„ç†?
```

**æµ‹è¯•æ­¥éª¤:**

#### Step 1: å¯åŠ¨ç¬¬ä¸€ä¸ªè®¢å•

```
è®¢å•1: THD1729407800001 æ­£åœ¨å……ç”µä¸­
ç«¯å£: 1
```

#### Step 2: å†æ¬¡è°ƒç”¨API

```bash
curl -X POST ".../charge" -d '{"port_no":1,...}'
```

**é¢„æœŸå“åº”:**

```json
{
  "code": 409,
  "message": "port is busy",
  "data": {
    "current_order": "THD1729407800001",
    "port_no": 1,
    "status": "charging"
  }
}
```

**æˆ–:**

```json
{
  "code": 0,
  "message": "replaced previous order",
  "data": {
    "old_order": "THD1729407800001",
    "new_order": "THD1729407800002"
  }
}
```

**å¤„ç†ç­–ç•¥:**

- **ç­–ç•¥A (ä¸¥æ ¼):** æ‹’ç»æ–°è®¢å•,è¿”å›é”™è¯¯
- **ç­–ç•¥B (æ›¿æ¢):** ç»“ç®—æ—§è®¢å•,å¯åŠ¨æ–°è®¢å•

#### Step 3: éªŒè¯è®¢å•çŠ¶æ€

```sql
-- ç­–ç•¥A
SELECT status FROM orders WHERE order_no = 'THD1729407800001';
-- é¢„æœŸ: charging (ä¸å˜)

-- ç­–ç•¥B  
SELECT status FROM orders WHERE order_no = 'THD1729407800001';
-- é¢„æœŸ: completed (è¢«ç»“ç®—)
```

**æµ‹è¯•é€šè¿‡æ ‡å‡†:**

- âœ… è¡Œä¸ºç¬¦åˆè®¾è®¡ç­–ç•¥
- âœ… ä¸äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´

---

## ğŸ”¬ å®Œæ•´æµ‹è¯•æµç¨‹ (å®æ“æ­¥éª¤)

### ç¯å¢ƒå‡†å¤‡

#### 1. ç¡®è®¤è®¾å¤‡åœ¨çº¿

```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs --tail 50 iot-server-prod | grep "82210225000520\|82241218000382"

# åº”çœ‹åˆ°å¿ƒè·³æ—¥å¿—
{"msg":"BKV frame received","cmd":"0x0000","gateway_id":"82210225000520"}
```

#### 2. é…ç½®ç¬¬ä¸‰æ–¹Webhook (æµ‹è¯•ç”¨)

```bash
# å¯åŠ¨ä¸€ä¸ªç®€å•çš„webhookæ¥æ”¶æœåŠ¡
cd /tmp
cat > webhook_receiver.py << 'EOF'
from flask import Flask, request
import json
from datetime import datetime

app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.json
    timestamp = datetime.now().strftime('%H:%M:%S')
    print(f"\n[{timestamp}] æ”¶åˆ°äº‹ä»¶: {data['event_type']}")
    print(json.dumps(data, indent=2, ensure_ascii=False))
    return {"success": True}, 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8888)
EOF

python3 webhook_receiver.py &
```

#### 3. æ›´æ–°IoTé…ç½®

```yaml
# configs/production.yaml
third_party:
  webhook_url: "http://localhost:8888/webhook"
  enable_queue: true
```

#### 4. é‡å¯æœåŠ¡

```bash
docker restart iot-server-prod
```

---

### æµ‹è¯•æ‰§è¡Œ

#### æµ‹è¯•1: åŸºç¡€å……ç”µæµç¨‹ (æ—¶é•¿æ¨¡å¼)

**å‡†å¤‡ç‰©å“:**

- è®¾å¤‡: 82210225000520
- ç«¯å£: 1å·å£
- å……ç”µå™¨: ç”µåŠ¨è½¦å……ç”µå™¨

**æ“ä½œæ¸…å•:**

```
â–¡ 1. è°ƒç”¨å……ç”µAPI
   curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge" \
     -H "Content-Type: application/json" \
     -H "X-Api-Key: test-api-key" \
     -d '{
       "port_no": 1,
       "charge_mode": 1,
       "duration": 300,
       "amount": 500,
       "price_per_kwh": 150,
       "service_fee": 50
     }'

â–¡ 2. è®°å½•è¿”å›çš„è®¢å•å·: _________________

â–¡ 3. æŸ¥çœ‹IoTæ—¥å¿—,ç¡®è®¤æŒ‡ä»¤ä¸‹å‘:
   docker logs --tail 20 iot-server-prod | grep "0x82"
   
â–¡ 4. æ’å…¥å……ç”µæ’å¤´åˆ°ç«¯å£1
   æ—¶é—´: _________
   
â–¡ 5. ç­‰å¾…5ç§’,æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è®¢å•ç¡®è®¤(0x04):
   docker logs --tail 10 iot-server-prod | grep "0x0004"
   
â–¡ 6. è§‚å¯Ÿå……ç”µæŒ‡ç¤ºç¯ (åº”è¯¥äº®èµ·)
   
â–¡ 7. æŸ¥çœ‹æ•°æ®åº“è®¢å•çŠ¶æ€:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT status, start_time FROM orders WHERE order_no = 'è®¢å•å·';"
   
   é¢„æœŸçŠ¶æ€: charging
   
â–¡ 8. ç­‰å¾…1åˆ†é’Ÿ,æŸ¥çœ‹å……ç”µè¿›åº¦:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT duration_sec, total_kwh, current_power FROM orders WHERE order_no = 'è®¢å•å·';"
   
   é¢„æœŸ: duration_sec > 50, total_kwh > 0
   
â–¡ 9. æŸ¥çœ‹Webhookæ—¥å¿—,ç¡®è®¤æ”¶åˆ°è¿›åº¦æ¨é€:
   (æŸ¥çœ‹webhook_receiver.pyè¾“å‡º)
   
â–¡ 10. ç­‰å¾…5åˆ†é’Ÿ (300ç§’),å……ç”µè‡ªåŠ¨åœæ­¢
   
â–¡ 11. æˆ–æ‰‹åŠ¨æ‹”å‡ºæ’å¤´è§¦å‘ç»“æŸ
   
â–¡ 12. æŸ¥çœ‹ç»“ç®—æ•°æ®:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT status, duration_sec, total_kwh, final_amount, end_reason 
      FROM orders WHERE order_no = 'è®¢å•å·';"
   
   é¢„æœŸ: status = 'completed'
   
â–¡ 13. ç¡®è®¤æ”¶åˆ°å®Œæˆäº‹ä»¶æ¨é€:
   (webhook_receiver.pyåº”æ˜¾ç¤º order.completed)
```

**è®°å½•è¡¨:**

| æ—¶é—´ç‚¹ | äº‹ä»¶ | æ•°æ® | æ—¥å¿—/æˆªå›¾ |
|--------|------|------|-----------|
| 14:00:00 | APIè°ƒç”¨ | è®¢å•å·:_______ | |
| 14:00:02 | æŒ‡ä»¤ä¸‹å‘ | MsgID:_______ | |
| 14:00:10 | æ’å…¥æ’å¤´ | ç«¯å£1 | |
| 14:00:15 | è®¢å•ç¡®è®¤ | 0x04æ”¶åˆ° | |
| 14:01:00 | 1åˆ†é’Ÿè¿›åº¦ | ç”µé‡:_____åº¦ | |
| 14:02:00 | 2åˆ†é’Ÿè¿›åº¦ | ç”µé‡:_____åº¦ | |
| 14:03:00 | 3åˆ†é’Ÿè¿›åº¦ | ç”µé‡:_____åº¦ | |
| 14:04:00 | 4åˆ†é’Ÿè¿›åº¦ | ç”µé‡:_____åº¦ | |
| 14:05:00 | å……ç”µç»“æŸ | æ€»ç”µé‡:___åº¦ | |
| 14:05:02 | ç»“ç®—å®Œæˆ | é‡‘é¢:___å…ƒ | |

---

#### æµ‹è¯•2: è¿œç¨‹åœæ­¢å……ç”µ

**å‡†å¤‡:**

- ä½¿ç”¨æµ‹è¯•1åˆ›å»ºçš„å……ç”µè®¢å•
- åœ¨å……ç”µè¿›è¡Œ2åˆ†é’Ÿåæ‰§è¡Œ

**æ“ä½œ:**

```
â–¡ 1. è®°å½•å½“å‰å……ç”µè¿›åº¦:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT duration_sec, total_kwh FROM orders WHERE order_no = 'è®¢å•å·';"
   
   å½“å‰æ—¶é•¿: _____ ç§’
   å½“å‰ç”µé‡: _____ åº¦

â–¡ 2. è°ƒç”¨åœæ­¢API:
   curl -X POST "http://182.43.177.92:7055/api/v1/third/devices/82210225000520/stop" \
     -H "X-Api-Key: test-api-key" \
     -d '{"port_no":1,"order_no":"è®¢å•å·"}'

â–¡ 3. è§‚å¯Ÿè®¾å¤‡,ç¡®è®¤ç»§ç”µå™¨æ–­å¼€ (æŒ‡ç¤ºç¯ç†„ç­)
   
â–¡ 4. æŸ¥çœ‹æ—¥å¿—,ç¡®è®¤æ”¶åˆ°0x03ç»“ç®—:
   docker logs --tail 20 iot-server-prod | grep "0x0003"
   
â–¡ 5. éªŒè¯æœ€ç»ˆç»“ç®—:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT status, duration_sec, total_kwh, end_reason 
      FROM orders WHERE order_no = 'è®¢å•å·';"
   
   é¢„æœŸ: 
     status = 'completed'
     end_reason = 3 (è¿œç¨‹åœæ­¢)
     duration_sec â‰ˆ 120ç§’

â–¡ 6. ç¡®è®¤Webhookæ¨é€:
   (åº”æ”¶åˆ° order.completed äº‹ä»¶)
```

---

#### æµ‹è¯•3: å……ç”µä¸­æ‹”æ’æµ‹è¯•

**æ“ä½œ:**

```
â–¡ 1. å¯åŠ¨å……ç”µ (åŒæµ‹è¯•1)

â–¡ 2. å……ç”µ1åˆ†é’Ÿå,æ‹”å‡ºæ’å¤´

â–¡ 3. ç­‰å¾…10ç§’

â–¡ 4. éªŒè¯è®¢å•ç»“ç®—:
   é¢„æœŸ: æŒ‰1åˆ†é’Ÿè®¡è´¹

â–¡ 5. é‡æ–°æ’å…¥åŒä¸€æ’å¤´

â–¡ 6. è§‚å¯Ÿè®¾å¤‡è¡Œä¸º:
   Option A: ç»§ç»­å……ç”µ (è®¢å•æ¢å¤)
   Option B: ä¸å……ç”µ (è®¢å•å·²ç»“ç®—)
   
   å®é™…è¡Œä¸º: _________________
```

---

#### æµ‹è¯•4: è®¾å¤‡æ–­ç½‘æ¢å¤æµ‹è¯•

**æ“ä½œ:**

```
â–¡ 1. å¯åŠ¨å……ç”µ

â–¡ 2. å……ç”µ2åˆ†é’Ÿå,æ–­å¼€è®¾å¤‡ç½‘ç»œ
   (æ‹”ç½‘çº¿/å…³é—­4Gæ¨¡å—)

â–¡ 3. è§‚å¯Ÿ:
   - è®¾å¤‡æœ¬åœ°ç»§ç»­å……ç”µ: æ˜¯/å¦ ______
   - IoTæ—¥å¿—æ˜¾ç¤ºè¿æ¥æ–­å¼€: æ˜¯/å¦ ______

â–¡ 4. ç­‰å¾…2åˆ†é’Ÿ (ç¦»çº¿å……ç”µ)

â–¡ 5. æ¢å¤ç½‘ç»œ

â–¡ 6. è§‚å¯Ÿé‡è¿æ—¥å¿—:
   docker logs --tail 50 iot-server-prod | grep "82210225000520"
   
   é¢„æœŸ: 5-10ç§’å†…çœ‹åˆ° "TCP connection accepted"

â–¡ 7. æŸ¥çœ‹é¦–æ¬¡å¿ƒè·³æ•°æ®:
   docker logs --tail 20 iot-server-prod | grep "0x0006"
   
   é¢„æœŸ: durationåº”åŒ…å«ç¦»çº¿æœŸé—´(çº¦240ç§’)

â–¡ 8. éªŒè¯è®¢å•æ•°æ®å®Œæ•´æ€§:
   docker exec -it iot-postgres-prod psql -U iot -d iot_server -c \
     "SELECT duration_sec FROM orders WHERE order_no = 'è®¢å•å·';"
   
   é¢„æœŸ: â‰¥ 240ç§’
```

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] è®¾å¤‡ä¸Šçº¿æ³¨å†Œ
- [ ] å¿ƒè·³ä¿æŒè¿æ¥
- [ ] å……ç”µæŒ‡ä»¤ä¸‹å‘
- [ ] è®¢å•åˆ›å»ºå’Œç®¡ç†
- [ ] å……ç”µè¿›åº¦å®æ—¶ä¸ŠæŠ¥
- [ ] è®¢å•ç»“ç®—
- [ ] ç¬¬ä¸‰æ–¹äº‹ä»¶æ¨é€
- [ ] è¿œç¨‹æ§åˆ¶ (å¯åŠ¨/åœæ­¢)
- [ ] å¼‚å¸¸å¤„ç† (æ•…éšœ/æ–­ç½‘)

### æ•°æ®å‡†ç¡®æ€§

- [ ] å……ç”µæ—¶é•¿è¯¯å·® < 5ç§’
- [ ] ç”µé‡è®¡é‡è¯¯å·® < 2%
- [ ] é‡‘é¢è®¡ç®—æ­£ç¡®
- [ ] æ—¶é—´æˆ³å‡†ç¡®

### å¯é æ€§

- [ ] è®¾å¤‡æ–­çº¿é‡è¿ < 10ç§’
- [ ] æŒ‡ä»¤ä¸‹å‘æˆåŠŸç‡ > 99%
- [ ] è®¢å•æ•°æ®ä¸ä¸¢å¤±
- [ ] å¹¶å‘å……ç”µäº’ä¸å¹²æ‰°

### æ€§èƒ½

- [ ] APIå“åº”æ—¶é—´ < 200ms
- [ ] æŒ‡ä»¤ä¸‹å‘å»¶è¿Ÿ < 1ç§’
- [ ] Webhookæ¨é€å»¶è¿Ÿ < 2ç§’
- [ ] æ•°æ®åº“æŸ¥è¯¢ < 100ms

---

## ğŸ› ï¸ æµ‹è¯•å·¥å…·è„šæœ¬

### 1. å……ç”µæµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# test_charge.sh

DEVICE_ID="82210225000520"
PORT_NO="1"
API_URL="http://182.43.177.92:7055/api/v1/third"
API_KEY="test-api-key"

echo "=== å……ç”µæµ‹è¯•è„šæœ¬ ==="
echo "è®¾å¤‡: $DEVICE_ID"
echo "ç«¯å£: $PORT_NO"
echo ""

# 1. æ£€æŸ¥è®¾å¤‡åœ¨çº¿
echo "1. æ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€..."
curl -s "$API_URL/devices/$DEVICE_ID" \
  -H "X-Api-Key: $API_KEY" | jq '.data.online'

# 2. å¯åŠ¨å……ç”µ
echo ""
echo "2. å¯åŠ¨å……ç”µ..."
RESPONSE=$(curl -s -X POST "$API_URL/devices/$DEVICE_ID/charge" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: $API_KEY" \
  -d "{
    \"port_no\": $PORT_NO,
    \"charge_mode\": 1,
    \"duration\": 300,
    \"amount\": 500
  }")

echo "$RESPONSE" | jq '.'

ORDER_NO=$(echo "$RESPONSE" | jq -r '.data.order_no')
echo ""
echo "è®¢å•å·: $ORDER_NO"

# 3. ç­‰å¾…ç”¨æˆ·æ’å…¥æ’å¤´
echo ""
read -p "è¯·æ’å…¥å……ç”µæ’å¤´åˆ°ç«¯å£ $PORT_NO ,ç„¶åæŒ‰å›è½¦ç»§ç»­..."

# 4. ç›‘æ§å……ç”µè¿›åº¦
echo ""
echo "3. ç›‘æ§å……ç”µè¿›åº¦ (æ¯10ç§’æŸ¥è¯¢ä¸€æ¬¡,å…±30æ¬¡)..."
for i in {1..30}; do
    sleep 10
    PROGRESS=$(curl -s "$API_URL/orders/$ORDER_NO" -H "X-Api-Key: $API_KEY")
    DURATION=$(echo "$PROGRESS" | jq -r '.data.duration_sec')
    KWH=$(echo "$PROGRESS" | jq -r '.data.total_kwh')
    POWER=$(echo "$PROGRESS" | jq -r '.data.current_power')
    STATUS=$(echo "$PROGRESS" | jq -r '.data.status')
    
    echo "[$i] æ—¶é•¿:${DURATION}s ç”µé‡:${KWH}åº¦ åŠŸç‡:${POWER}W çŠ¶æ€:$STATUS"
    
    if [ "$STATUS" = "completed" ]; then
        echo "å……ç”µå·²å®Œæˆ!"
        break
    fi
done

# 5. æœ€ç»ˆç»“ç®—
echo ""
echo "4. æœ€ç»ˆç»“ç®—æ•°æ®:"
curl -s "$API_URL/orders/$ORDER_NO" -H "X-Api-Key: $API_KEY" | jq '.data'
```

### 2. è®¾å¤‡ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor_device.sh

DEVICE_ID="${1:-82210225000520}"

echo "=== è®¾å¤‡ç›‘æ§ ==="
echo "è®¾å¤‡ID: $DEVICE_ID"
echo ""

while true; do
    clear
    echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # åœ¨çº¿çŠ¶æ€
    echo ""
    echo "ğŸ“¡ åœ¨çº¿çŠ¶æ€:"
    docker exec -it iot-postgres-prod psql -U iot -d iot_server -t -c "
    SELECT 
        phy_id,
        CASE 
            WHEN last_seen_at > NOW() - INTERVAL '30 seconds' THEN 'ğŸŸ¢ åœ¨çº¿'
            ELSE 'ğŸ”´ ç¦»çº¿'
        END AS status,
        last_seen_at,
        NOW() - last_seen_at AS offline_duration
    FROM devices 
    WHERE phy_id = '$DEVICE_ID';
    "
    
    # ç«¯å£çŠ¶æ€
    echo ""
    echo "ğŸ”Œ ç«¯å£çŠ¶æ€:"
    docker exec -it iot-postgres-prod psql -U iot -d iot_server -t -c "
    SELECT 
        p.port_no,
        CASE p.status
            WHEN 0 THEN 'ç©ºé—²'
            WHEN 1 THEN 'å……ç”µä¸­'
            ELSE 'æ•…éšœ'
        END AS status,
        COALESCE(p.power_w, 0) || 'W' AS power
    FROM ports p
    JOIN devices d ON p.device_id = d.id
    WHERE d.phy_id = '$DEVICE_ID'
    ORDER BY p.port_no;
    "
    
    # æ´»è·ƒè®¢å•
    echo ""
    echo "ğŸ“‹ æ´»è·ƒè®¢å•:"
    docker exec -it iot-postgres-prod psql -U iot -d iot_server -t -c "
    SELECT 
        o.order_no,
        o.port_no,
        o.status,
        COALESCE(o.duration_sec, 0) || 's' AS duration,
        COALESCE(o.total_kwh, 0) || 'åº¦' AS kwh,
        COALESCE(o.current_power, 0) || 'W' AS power
    FROM orders o
    JOIN devices d ON o.device_id = d.id
    WHERE d.phy_id = '$DEVICE_ID'
    AND o.status IN ('pending', 'charging')
    ORDER BY o.created_at DESC;
    "
    
    # æœ€æ–°æ—¥å¿—
    echo ""
    echo "ğŸ“ æœ€æ–°æ—¥å¿— (æœ€è¿‘3æ¡):"
    docker logs --tail 100 iot-server-prod 2>&1 | \
        grep "$DEVICE_ID" | tail -3
    
    sleep 5
done
```

### 3. æ‰¹é‡æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# batch_test.sh

DEVICES=("82210225000520" "82241218000382")
API_URL="http://182.43.177.92:7055/api/v1/third"

echo "=== æ‰¹é‡å……ç”µæµ‹è¯• ==="

for device in "${DEVICES[@]}"; do
    for port in 1 2; do
        echo ""
        echo "æµ‹è¯•: $device ç«¯å£ $port"
        
        # å¯åŠ¨å……ç”µ
        ORDER=$(curl -s -X POST "$API_URL/devices/$device/charge" \
          -H "Content-Type: application/json" \
          -H "X-Api-Key: test-api-key" \
          -d "{
            \"port_no\": $port,
            \"charge_mode\": 1,
            \"duration\": 180,
            \"amount\": 300
          }" | jq -r '.data.order_no')
        
        echo "è®¢å•åˆ›å»º: $ORDER"
        
        # ç­‰å¾…ç¡®è®¤
        sleep 15
        
        # æŸ¥è¯¢çŠ¶æ€
        STATUS=$(curl -s "$API_URL/orders/$ORDER" \
          -H "X-Api-Key: test-api-key" | jq -r '.data.status')
        
        echo "å½“å‰çŠ¶æ€: $STATUS"
    done
done
```

---

## ğŸ“ˆ æ€§èƒ½å‹åŠ›æµ‹è¯•

### å‹åŠ›æµ‹è¯•1: é«˜é¢‘APIè°ƒç”¨

```bash
# ä½¿ç”¨ Apache Bench
ab -n 1000 -c 10 \
  -H "X-Api-Key: test-api-key" \
  -T "application/json" \
  -p charge_payload.json \
  http://182.43.177.92:7055/api/v1/third/devices/82210225000520/charge

# charge_payload.json
{
  "port_no": 1,
  "charge_mode": 1,
  "duration": 60,
  "amount": 100
}
```

**éªŒæ”¶æ ‡å‡†:**

- QPS > 100
- å¹³å‡å“åº”æ—¶é—´ < 200ms
- é”™è¯¯ç‡ < 1%

### å‹åŠ›æµ‹è¯•2: å¤§é‡è®¾å¤‡å¿ƒè·³

**æ¨¡æ‹Ÿå™¨æµ‹è¯•:**

```go
// simulator.go
func SimulateDevices(count int) {
    for i := 0; i < count; i++ {
        go func(id int) {
            deviceID := fmt.Sprintf("SIM%010d", id)
            conn := connectTCP("182.43.177.92:7065")
            
            for {
                sendHeartbeat(conn, deviceID)
                time.Sleep(11 * time.Second)
            }
        }(i)
    }
}
```

**éªŒæ”¶æ ‡å‡†:**

- æ”¯æŒ1000+è®¾å¤‡åŒæ—¶åœ¨çº¿
- å¿ƒè·³å¤„ç†å»¶è¿Ÿ < 100ms
- CPUä½¿ç”¨ç‡ < 50%

---

## âœ… æœ€ç»ˆéªŒæ”¶æ¸…å•

### åŸºç¡€åŠŸèƒ½

- [ ] è®¾å¤‡æ³¨å†Œå’Œä¸Šçº¿
- [ ] å¿ƒè·³ä¿æ´»æœºåˆ¶
- [ ] å……ç”µæŒ‡ä»¤ä¸‹å‘ (0x82)
- [ ] è®¢å•ç¡®è®¤ (0x04)
- [ ] å……ç”µè¿›åº¦ä¸ŠæŠ¥ (0x06)
- [ ] è®¢å•ç»“ç®— (0x03)
- [ ] è¿œç¨‹åœæ­¢å……ç”µ

### APIåŠŸèƒ½

- [ ] å¯åŠ¨å……ç”µAPI
- [ ] åœæ­¢å……ç”µAPI
- [ ] æŸ¥è¯¢è®¾å¤‡API
- [ ] æŸ¥è¯¢è®¢å•API
- [ ] è®¤è¯å’Œé‰´æƒ
- [ ] é™æµä¿æŠ¤

### äº‹ä»¶æ¨é€

- [ ] device.registered
- [ ] device.heartbeat
- [ ] order.created
- [ ] charging.started
- [ ] charging.progress
- [ ] order.completed
- [ ] device.alarm
- [ ] ç­¾åéªŒè¯

### å¼‚å¸¸å¤„ç†

- [ ] è®¾å¤‡ç¦»çº¿æ¢å¤
- [ ] æ–­ç½‘ç»­å……
- [ ] ç«¯å£æ•…éšœå¤„ç†
- [ ] è®¢å•å†²çªå¤„ç†
- [ ] é‡å¤æŒ‡ä»¤è¿‡æ»¤

### æ•°æ®å‡†ç¡®æ€§

- [ ] æ—¶é•¿è®¡é‡å‡†ç¡®
- [ ] ç”µé‡è®¡é‡å‡†ç¡®
- [ ] é‡‘é¢è®¡ç®—æ­£ç¡®
- [ ] æ—¶é—´æˆ³æ­£ç¡®

### æ€§èƒ½æŒ‡æ ‡

- [ ] APIå“åº” < 200ms
- [ ] æ”¯æŒ100+ QPS
- [ ] 1000+è®¾å¤‡åœ¨çº¿
- [ ] å†…å­˜ä½¿ç”¨ < 500MB
- [ ] CPUä½¿ç”¨ < 30%

---

## ğŸ“ é—®é¢˜è¯Šæ–­å·¥å…·

### å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# 1. æ£€æŸ¥è®¾å¤‡åœ¨çº¿
docker exec -it iot-postgres-prod psql -U iot -d iot_server -c "
SELECT phy_id, 
       CASE WHEN last_seen_at > NOW() - INTERVAL '30 seconds' 
            THEN 'åœ¨çº¿' ELSE 'ç¦»çº¿' END AS status
FROM devices WHERE phy_id IN ('82210225000520', '82241218000382');
"

# 2. æŸ¥çœ‹æ´»è·ƒè®¢å•
docker exec -it iot-postgres-prod psql -U iot -d iot_server -c "
SELECT order_no, port_no, status, duration_sec, total_kwh
FROM orders 
WHERE status IN ('pending', 'charging')
ORDER BY created_at DESC LIMIT 10;
"

# 3. æŸ¥çœ‹ä¸‹è¡Œé˜Ÿåˆ—
docker exec -it iot-redis-prod redis-cli LLEN outbound:82210225000520

# 4. æŸ¥çœ‹æœ€æ–°é”™è¯¯
docker logs --tail 100 iot-server-prod 2>&1 | grep "error"

# 5. å®æ—¶ç›‘æ§
docker logs -f iot-server-prod | grep "82210225000520"
```

---

**END OF TEST PLAN**

**ä¸‹ä¸€æ­¥:** æŒ‰æ­¤è®¡åˆ’é€é¡¹æ‰§è¡Œæµ‹è¯•,è®°å½•ç»“æœ,å‘ç°é—®é¢˜åŠæ—¶ä¿®å¤ã€‚
