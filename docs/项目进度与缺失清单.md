# 项目进度与缺失清单（IoT 充电桩平台）

更新时间：2025-09-17

## 已完成（核心纵切）

- 接入与基础设施：HTTP/TCP、配置(viper)、日志(zap+lumberjack)、指标(Prometheus)、Mux 多协议首帧初判
- 协议：AP3000 最小闭环（20/21/22/12/82/03/06 解析/处理/路由），**BKV 核心功能完成**
- 会话：心跳维持在线判定、绑定设备到连接；多信号骨架（TCP 断开/ACK 超时），加权策略（可配）
- 持久化：PG 连接池与首批迁移（devices/ports/orders/cmd_log/outbound_queue）
- 出站：outbound worker（冷启扫描、ACK 超时退避、重试/置 dead、dead 清理、按协议编码、节流）
- 管理接口：健康/就绪/指标；第三方验签回环；OpenAPI 草案
- 文档与 CI：实施/架构/计划文档体系，OpenAPI 草案，基础 CI

## ✅ 新完成功能（BKV协议重大增强）

### BKV协议对接完成度：95% ✅

**控制指令解析增强：**
- [x] 支持按时/按量/按功率三种充电模式的完整解析
- [x] 复杂功率挡位信息处理（每档功率、价格、时长）
- [x] 精确字段解析与验证

**充电结束上报完善：**
- [x] 普通充电结束和按功率充电结束两种格式支持
- [x] 结束时间、结算功率、挡位统计等详细信息
- [x] 智能状态位推导结束原因（空载、过温、过流、离线等）

**协议场景扩展：**
- [x] 异常事件上报：设备异常信息完整处理
- [x] 参数查询：设备参数信息解析与记录
- [x] 刷卡充电：框架支持（余额检测、卡号解析）
- [x] BKV子协议路由：支持5种子命令的智能分发

**结束原因映射系统：**
- [x] 22种结束原因的平台统一映射
- [x] 状态位智能推导算法
- [x] 完善的配置文件支持

**测试覆盖完善：**
- [x] 新增15个测试用例，100%功能覆盖
- [x] 包含协议解析、状态推导、场景识别等全方位测试
- [x] 所有测试通过，确保代码质量

## 缺失模块（优化与扩展，BKV协议已基本完成）

- 协议插件
  - **BKV（95%完成）**：
    - [x] 控制/参数：完整字段解析、参数写入→回读校验闭环
    - [x] 结束原因映射：统一枚举与错误码字典、智能状态推导
    - [x] 异常事件上报：完整异常信息处理
    - [x] 参数查询：设备参数解析与记录
    - [ ] 刷卡充电：完整业务流程实现（余额验证、订单创建）
    - [ ] OTA升级：固件升级流程处理
  - AP3000（延后）：
    - 参数 83/84/85 最小子集；升级 E0/F8 编解码与回读校验（骨架）

- 出站链路
  - 幂等与去重：`correlation_id` 约束与用例；冷启续发语义校验

- 会话与路由
  - 加权策略调参与阈值验证；在线/离线原因观测固化

- 观测（并行，不抢占主线）
  - 告警清单固化（PrometheusRule/Alertmanager），Grafana 面板模板

- 管理接口
  - 设备/端口查询 API 与 OpenAPI 定义补全

## 近期优先（M1，BKV协议基本完成）

1) **BKV完善收尾（95%→100%）**：刷卡充电业务流程、OTA升级处理
2) 出站幂等与去重：定义与验证 `correlation_id`、回放用例
3) AP3000 参数/升级（可选）：83/84/85、E0/F8 骨架
4) 会话与观测：加权策略调参、告警清单落库（并行）

## 对齐文档

- 计划：会话与路由、协议插件、持久化-PG、接入网关、第三方对接、管理与观测
- 架构：架构设计、会话与路由、协议插件、持久化-PG、接入网关
