# 项目进度与缺失清单（IoT 充电桩平台）

更新时间：自动同步当前会话

## 已完成（核心纵切）

- 接入与基础设施：HTTP/TCP、配置(viper)、日志(zap+lumberjack)、指标(Prometheus)、Mux 多协议首帧初判
- 协议：AP3000 最小闭环（20/21/22/12/82/03/06 解析/处理/路由），BKV 适配器骨架与回放用例
- 会话：心跳维持在线判定、绑定设备到连接
- 持久化：PG 连接池与首批迁移（devices/ports/orders/cmd_log/outbound_queue）
- 出站：outbound worker 骨架（ACK/重试闭环基础）
- 管理接口：只读 API 骨架（设备/端口查询）
- 文档与 CI：实施/架构/计划文档体系，OpenAPI 草案，基础 CI

## 缺失模块（形成完整平台所需，协议优先：BKV>AP3000）

- 协议插件
  - BKV（优先）：完整命令集（心跳/状态/控制/参数/结算）、结束原因映射、控制指令翻译、全链路回放
  - AP3000（延后）：参数 83/84/85/86、升级 E0/F8 编解码与回读校验

### BKV 配置与实现进展

- 配置键：`protocols.bkv.reason_map_path`（默认示例：`configs/bkv-reason-map.example.yaml`）
- 代码：`internal/protocol/bkv/reason_map.go`、`handlers.go`（心跳/状态/结算）
- 接线：`cmd/server/main.go` 按配置加载原因映射并注入处理器
  - 统一枚举与错误码字典；粘/半包、乱序/重发、异常回放全链路用例
- 接入网关与可靠性
  - 连接写队列（优先级：控制>心跳）、合并写、≥500ms 节流
  - ACK 超时 15s、≤1 次重发、dead 队列、冷启续发扫描
  - 白名单（IP/设备）、限速（设备/全局）、错误流量隔离
- 出站链路
  - 真实发送器：outbox→TCP 写、幂等键、ACK 关联、退避策略
- 会话与路由
  - 三标识绑定 ICCID/物理ID/IMEI 与漂移重绑；一致性哈希与平滑重分配
  - 离线判定多信号融合（TCP/心跳/ACK）与阈值配置
- 持久化与数据治理
  - COPY/批量写、分区与保留、索引、VACUUM/备份恢复演练
  - 订单金额/费率/对账字段补齐，事件/审计表完善
- 第三方对接
  - Webhook 推送（HMAC、重试去重、告警）、拉取分页/时间窗、第三方控制入口（限频/审计）
- 管理与观测
  - 管理 API（设备/会话/控制/参数/升级/订单/日志）、OpenAPI 契约校验
  - 指标面板与告警（82 成功率/重发率/端到端 p99/DB 写失败/队列积压）、日志脱敏、pprof
- 审计与回放
  - HEX 落盘与索引、按设备/时段检索、筛选回放工具；脱敏
- 安全与运维
  - API Key/HMAC、IP/设备白名单、密钥管理；部署脚本、SLO/扩缩容、Runbook
- 测试与质量
  - 覆盖性单测/集成、k6 压测、golangci-lint、回放驱动回归集

## 近期优先（M1）

1) 出站可靠链路：写队列/节流、ACK 超时/重试、dead/冷启续发
2) 协议扩展：BKV 最小集与结束原因映射；AP3000 83/84/85 最小子集
3) 观测：82 成功率/重发率/端到端 p99 指标与告警；只读 OpenAPI 固化
4) 会话增强：三标识绑定、多信号离线判定
5) 数据与审计：订单/对账字段、回放工具化

## 对齐文档

- 计划：会话与路由、协议插件、持久化-PG、接入网关、第三方对接、管理与观测
- 架构：架构设计、会话与路由、协议插件、持久化-PG、接入网关
