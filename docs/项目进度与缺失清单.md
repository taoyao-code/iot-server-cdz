# 项目进度与缺失清单（IoT 充电桩平台）

更新时间：2025-09-12

## 已完成（核心纵切）

- 接入与基础设施：HTTP/TCP、配置(viper)、日志(zap+lumberjack)、指标(Prometheus)、Mux 多协议首帧初判
- 协议：AP3000 最小闭环（20/21/22/12/82/03/06 解析/处理/路由），BKV 适配器骨架与回放用例
- 会话：心跳维持在线判定、绑定设备到连接
- 持久化：PG 连接池与首批迁移（devices/ports/orders/cmd_log/outbound_queue）
- 出站：outbound worker 骨架（ACK/重试闭环基础；按协议编码并节流）
- 管理接口：只读 API 骨架（设备/端口查询）
- 文档与 CI：实施/架构/计划文档体系，OpenAPI 草案，基础 CI

## 缺失模块（形成完整平台所需，协议优先：BKV>AP3000）

- 协议插件
  - BKV（优先）：完整命令集（心跳/状态/控制/参数/结算）、结束原因映射、控制指令翻译、全链路回放
  - AP3000（延后）：参数 83/84/85/86、升级 E0/F8 编解码与回读校验

### BKV 配置与实现进展

- 配置键：`protocols.bkv.reason_map_path`（默认示例：`configs/bkv-reason-map.example.yaml`）
- 代码：`internal/protocol/bkv/reason_map.go`、`handlers.go`（心跳/状态/结算/ACK/控制/参数占位）
- 接线：`cmd/server/main.go` 启动按配置加载原因映射并注入 BKV 处理器
  - 结束原因映射已可用；后续补齐统一枚举与错误码字典
- 接入网关与可靠性
  - 连接写队列（优先级：控制>心跳，代码侧具备异步写与队列）；合并写与≥500ms 节流（由 outbound、会话控制）
  - ACK 超时 15s、≤1 次重发、dead 队列语义在 `outbound_queue.status`（3=failed/dead）
  - 冷启续发扫描：需要在 worker 增补启动时对 `status=1` 超时项/`status=0` 到期项的快速扫描
  - 白名单（IP/设备）、限速（设备/全局）、错误流量隔离：配置已预留，逻辑待实现
- 出站链路
  - 已接入 outbox→协议编码(AP3000/BKV)→TCP 写，支持节流与重试；ACK 关联（通过 msg_id）
  - 需补：dead 保留与清理策略、冷启续发扫描周期化
- 会话与路由
  - 三标识绑定 ICCID/物理ID/IMEI 与漂移重绑（占位：现以物理ID为主）；一致性哈希与平滑重分配（计划）
  - 离线判定多信号融合（TCP/心跳/ACK）与阈值配置（现以心跳为主）
- 持久化与数据治理
  - COPY/批量写、分区与保留、索引、VACUUM/备份恢复演练（计划）
  - 订单金额/费率/对账字段补齐，事件/审计表完善（计划）
- 第三方对接
  - Webhook 推送（HMAC、重试去重、告警）能力已接线，需结合业务事件补
  - 拉取分页/时间窗、第三方控制入口（限频/审计）（计划）
- 管理与观测
  - 管理 API（设备/会话/控制/参数/升级/订单/日志）与 OpenAPI 契约校验（只读为主，待扩展）
  - 指标面板与告警（82 成功率/重发率/端到端 p99/DB 写失败/队列积压）；现有指标缺少 82 成功率/重发率，需要新增
- 审计与回放
  - HEX 落盘与索引、按设备/时段检索、筛选回放工具；脱敏（计划）
- 安全与运维
  - API Key/HMAC、IP/设备白名单、密钥管理；部署脚本、SLO/扩缩容、Runbook（计划）
- 测试与质量
  - 覆盖性单测/集成、k6 压测、golangci-lint、回放驱动回归集（基础已建，需扩展）

## 近期优先（M1）

1) 出站可靠链路：
   - 写队列/节流完善；ACK 超时/重试/退避；dead 标记与保留清理；冷启续发扫描
2) 协议扩展：
   - BKV 最小集与结束原因映射闭环；AP3000 83/84/85 最小子集
3) 观测：
   - 82 成功率/重发率/端到端 p99 指标与告警；只读 OpenAPI 固化
4) 会话增强：
   - 三标识绑定、多信号离线判定
5) 数据与审计：
   - 订单/对账字段、回放工具化

## 对齐文档

- 计划：会话与路由、协议插件、持久化-PG、接入网关、第三方对接、管理与观测
- 架构：架构设计、会话与路由、协议插件、持久化-PG、接入网关
