# IoT ä¸­é—´ä»¶æŠ€æœ¯è§„èŒƒ P0 ä¿®å¤å®ŒæˆçŠ¶æ€

**ç‰ˆæœ¬**: v2.2  
**å®Œæˆæ—¥æœŸ**: 2025-01-06  
**ä¿®å¤èŒƒå›´**: P0 çº§ 4 ä¸ªé˜»å¡æ€§é€»è¾‘æ¼æ´

---

## âœ… P0 çº§ä¿®å¤å®ŒæˆçŠ¶æ€

### P1-1: å¿ƒè·³è¶…æ—¶é˜ˆå€¼

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¿®æ”¹æ–‡ä»¶**:

- `configs/example.yaml`
- `configs/local.yaml`
- `configs/production.yaml`

**ä¿®æ”¹å†…å®¹**: `heartbeat_timeout_sec: 360` â†’ `60`

---

### P1-3: ç«¯å£å¹¶å‘å†²çª

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¿®æ”¹æ–‡ä»¶**: `internal/api/thirdparty_handler.go`

**æ ¸å¿ƒé€»è¾‘**:

- äº‹åŠ¡ + `FOR UPDATE` è¡Œé”
- ç«¯å£å ç”¨æ£€æŸ¥åŒ…å«ä¸­é—´æ€: `status IN (0,1,2,8,9,10)`
- åŒæ—¶é”å®š `orders` å’Œ `device_ports` è¡¨

---

### P0-1: è®¾å¤‡ç¦»çº¿å¯åˆ›å•

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¿®æ”¹æ–‡ä»¶**: `internal/api/thirdparty_handler.go` (Line 123-135)

**æ ¸å¿ƒé€»è¾‘**:

- åˆ›å»ºè®¢å•å‰æ£€æŸ¥ `sess.IsOnline()`
- ç¦»çº¿è®¾å¤‡è¿”å› 503 çŠ¶æ€ç 

---

### P0-2: å……ç”µä¸­è®¢å•æ–­çº¿æ¢å¤é€»è¾‘

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¿®æ”¹æ–‡ä»¶**:

- `internal/storage/pg/repo.go` (+4 æ–¹æ³•)
- `internal/protocol/bkv/handlers.go` (Line 143, 1669)
- `internal/thirdparty/events.go` (+1 äº‹ä»¶)

**æ ¸å¿ƒé€»è¾‘**:

1. **æ•°æ®å±‚**:

   - `RecoverOrder(orderNo)` - æ¢å¤ä¸º charging
   - `FailOrder(orderNo, reason)` - æ ‡è®°å¤±è´¥
   - `GetInterruptedOrders(deviceID)` - æŸ¥è¯¢ä¸­æ–­è®¢å•
   - `MarkChargingOrdersAsInterrupted(deviceID)` - æ ‡è®°ä¸º interrupted

2. **åè®®å±‚**:

   - `HandleHeartbeat` é›†æˆæ¢å¤æ£€æŸ¥
   - `checkInterruptedOrdersRecovery` éªŒè¯è¿ç»­ 3 æ¬¡å¿ƒè·³

3. **äº‹ä»¶å±‚**:
   - æ–°å¢ `EventOrderFailed` äº‹ä»¶

---

## ğŸ—‚ï¸ æ•°æ®åº“è¿ç§»çŠ¶æ€

**æ•°æ®åº“**: PostgreSQL (182.43.177.92)  
**è¿ç§»æ–‡ä»¶**: `db/migrations/full_schema.sql` (434 è¡Œ)  
**åº”ç”¨ç‰ˆæœ¬**: 9 ä¸ªç‰ˆæœ¬å…¨éƒ¨åº”ç”¨

```
1  | åˆå§‹åŒ– Schema
2  | æ·»åŠ ç´¢å¼•
3  | è®¢å•è¡¨æ‰©å±•
5  | è®¾å¤‡è¡¨ä¼˜åŒ–
6  | ä¼šè¯è¡¨
7  | äº‹ä»¶æ¨é€
8  | è®¢å•çŠ¶æ€æ‰©å±•
9  | ç«¯å£è¡¨ä¼˜åŒ–
11 | æ€§èƒ½ä¼˜åŒ–
```

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

**æœåŠ¡å™¨**: 182.43.177.92  
**å®¹å™¨**: `iot-server-prod` (Up, healthy)  
**TCP ç«¯å£**: 7065  
**HTTP ç«¯å£**: 7055  
**ç‰ˆæœ¬**: v2.2  
**æœ€åéƒ¨ç½²**: 2025-01-06

---

## ğŸ“ éªŒè¯ç»“æœ

| æ£€æŸ¥é¡¹     | çŠ¶æ€ | éªŒè¯æ–¹å¼                                    |
| ---------- | ---- | ------------------------------------------- |
| å¿ƒè·³é…ç½®   | âœ…   | `grep heartbeat_timeout_sec configs/*.yaml` |
| ç¦»çº¿æ£€æŸ¥   | âœ…   | Line 123-135 ä»£ç å®¡æŸ¥                       |
| æ¢å¤é€»è¾‘   | âœ…   | Line 1034, 1051, 1062, 1669 ä»£ç å®¡æŸ¥        |
| æ•°æ®åº“è¿ç§» | âœ…   | `SELECT version FROM schema_migrations`     |
| æœåŠ¡è¿è¡Œ   | âœ…   | `docker ps \| grep iot-server-prod`         |

---

_å®Œæˆäº 2025-01-06_
