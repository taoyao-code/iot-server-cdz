# IOTæœåŠ¡å™¨å®Œæ•´æ•°æ®æµå›¾ ğŸ”„

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0  
**åˆ›å»ºæ—¶é—´:** 2025-10-20  
**é€‚ç”¨ç‰ˆæœ¬:** iot-server v1.0.0

---

## ğŸ“Š æ•´ä½“æ¶æ„æ•°æ®æµ

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚         ç¨‹åºå…¥å£ (main.go)                    â”‚
                            â”‚      func main()                             â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    åŠ è½½é…ç½® (config.Load)                     â”‚
                            â”‚  - è¯»å– YAML é…ç½®æ–‡ä»¶                         â”‚
                            â”‚  - ç¯å¢ƒå˜é‡è¦†ç›–                               â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   åˆå§‹åŒ–æ—¥å¿— (logging.InitLogger)             â”‚
                            â”‚  - é…ç½®æ—¥å¿—çº§åˆ«                               â”‚
                            â”‚  - è®¾ç½®æ—¥å¿—è¾“å‡º                               â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚      å¯åŠ¨åº”ç”¨ (bootstrap.Run)                 â”‚
                            â”‚         9ä¸ªå¯åŠ¨é˜¶æ®µ                            â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                             â–¼                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   HTTPæœåŠ¡         â”‚       â”‚   TCPæœåŠ¡          â”‚       â”‚   WorkeræœåŠ¡       â”‚
    â”‚   (ç«¯å£7055)       â”‚       â”‚   (ç«¯å£7054)       â”‚       â”‚   (åå°ä»»åŠ¡)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¯åŠ¨é˜¶æ®µæ•°æ®æµ

### é˜¶æ®µ1-4: åŸºç¡€ç»„ä»¶åˆå§‹åŒ–

```
bootstrap.Run()
    â”‚
    â”œâ”€â–º é˜¶æ®µ1: åˆå§‹åŒ–åŸºç¡€ç»„ä»¶ (ç¬¬32-39è¡Œ)
    â”‚   â”‚
    â”‚   â”œâ”€â–º NewMetrics()
    â”‚   â”‚   â””â”€â–º Prometheusæ³¨å†Œè¡¨ + æŒ‡æ ‡æ”¶é›†å™¨
    â”‚   â”‚       â””â”€â–º è¿”å›: reg, appm
    â”‚   â”‚
    â”‚   â”œâ”€â–º NewReady()
    â”‚   â”‚   â””â”€â–º åˆ›å»ºå°±ç»ªçŠ¶æ€ç®¡ç†å™¨
    â”‚   â”‚
    â”‚   â””â”€â–º GenerateServerID()
    â”‚       â””â”€â–º ç”ŸæˆUUIDä½œä¸ºæœåŠ¡å™¨å®ä¾‹ID
    â”‚           â””â”€â–º ç”¨äºRedisä¼šè¯ç®¡ç†
    â”‚
    â”œâ”€â–º é˜¶æ®µ2: åˆå§‹åŒ–Redis (ç¬¬41-48è¡Œ)
    â”‚   â”‚
    â”‚   â””â”€â–º NewRedisClient(cfg.Redis, log)
    â”‚       â”‚
    â”‚       â”œâ”€â–º è¿æ¥RedisæœåŠ¡å™¨
    â”‚       â”‚   â””â”€â–º åœ°å€: redis:6379
    â”‚       â”‚
    â”‚       â”œâ”€â–º è®¾ç½®è¿æ¥æ± 
    â”‚       â”‚   â”œâ”€â–º pool_size: 20
    â”‚       â”‚   â””â”€â–º min_idle_conns: 5
    â”‚       â”‚
    â”‚       â””â”€â–º è¿”å›: redisClient
    â”‚           â””â”€â–º ç”¨äº: ä¼šè¯ç®¡ç†ã€äº‹ä»¶é˜Ÿåˆ—ã€å»é‡
    â”‚
    â”œâ”€â–º é˜¶æ®µ3: åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨ (ç¬¬50-51è¡Œ)
    â”‚   â”‚
    â”‚   â””â”€â–º NewSessionAndPolicy(cfg.Session, redisClient, serverID, log)
    â”‚       â”‚
    â”‚       â”œâ”€â–º åˆ›å»ºRedisManager
    â”‚       â”‚   â”œâ”€â–º å­˜å‚¨è®¾å¤‡ä¼šè¯åˆ°Redis
    â”‚       â”‚   â””â”€â–º Keyæ ¼å¼: session:device:{phyID}
    â”‚       â”‚
    â”‚       â”œâ”€â–º åˆ›å»ºWeightedPolicy
    â”‚       â”‚   â””â”€â–º è®¡ç®—è®¾å¤‡åœ¨çº¿æƒé‡
    â”‚       â”‚
    â”‚       â””â”€â–º è¿”å›: sess, policy
    â”‚
    â””â”€â–º é˜¶æ®µ4: è¿æ¥æ•°æ®åº“ (ç¬¬53-61è¡Œ)
        â”‚
        â””â”€â–º ConnectDBAndMigrate(ctx, cfg.Database, "db/migrations", log)
            â”‚
            â”œâ”€â–º è¿æ¥PostgreSQL
            â”‚   â””â”€â–º DSN: postgres://iot:***@postgres:5432/iot_server
            â”‚
            â”œâ”€â–º æ‰§è¡Œæ•°æ®åº“è¿ç§»
            â”‚   â””â”€â–º åº”ç”¨ db/migrations/*.sql
            â”‚
            â””â”€â–º è¿”å›: dbpool
                â””â”€â–º è¿æ¥æ± : maxOpenConns=20, maxIdleConns=10
```

---

### é˜¶æ®µ5: ä¸šåŠ¡å¤„ç†å™¨åˆå§‹åŒ– ğŸ”¥

```
é˜¶æ®µ5: åˆå§‹åŒ–ä¸šåŠ¡å¤„ç†å™¨ (ç¬¬63-102è¡Œ)
    â”‚
    â”œâ”€â–º åˆ›å»ºRepository (ç¬¬64è¡Œ)
    â”‚   â””â”€â–º repo = &pgstorage.Repository{Pool: dbpool}
    â”‚       â””â”€â–º ç”¨äºæ‰€æœ‰æ•°æ®åº“æ“ä½œ
    â”‚
    â”œâ”€â–º åŠ è½½BKVåŸå› ç æ˜ å°„ (ç¬¬66-74è¡Œ)
    â”‚   â””â”€â–º LoadReasonMap(cfg.Protocols.BKV.ReasonMapPath)
    â”‚       â””â”€â–º ä»YAMLæ–‡ä»¶åŠ è½½
    â”‚           â””â”€â–º bkvReason (ç”¨äºé”™è¯¯ç ç¿»è¯‘)
    â”‚
    â”œâ”€â–º åˆ›å»ºç¬¬ä¸‰æ–¹æ¨é€å™¨ (ç¬¬76è¡Œ)
    â”‚   â””â”€â–º NewPusherIfEnabled(cfg.Thirdparty.Push.WebhookURL, secret)
    â”‚       â””â”€â–º pusher (ç”¨äºWebhookæ¨é€)
    â”‚
    â”œâ”€â–º åˆ›å»ºäº‹ä»¶é˜Ÿåˆ—å’Œå»é‡å™¨ (ç¬¬78-83è¡Œ)
    â”‚   â””â”€â–º NewEventQueue(cfg.Thirdparty.Push, redisClient, pusher, log)
    â”‚       â”‚
    â”‚       â”œâ”€â–º EventQueue
    â”‚       â”‚   â”œâ”€â–º Redis Key: thirdparty:event:queue
    â”‚       â”‚   â””â”€â–º ç”¨äºå¼‚æ­¥äº‹ä»¶æ¨é€
    â”‚       â”‚
    â”‚       â””â”€â–º Deduper
    â”‚           â”œâ”€â–º Redis Key: thirdparty:dedup:{eventID}
    â”‚           â””â”€â–º ç”¨äºäº‹ä»¶å»é‡ (TTL: 1å°æ—¶)
    â”‚
    â”œâ”€â–º åˆ›å»ºOutboundé€‚é…å™¨ (ç¬¬86è¡Œ)
    â”‚   â””â”€â–º NewOutboundAdapter(dbpool, repo)
    â”‚       â””â”€â–º outboundAdapter (ç”¨äºBKVä¸‹è¡Œæ¶ˆæ¯)
    â”‚
    â”œâ”€â–º åˆ›å»ºAP3000 Handlers (ç¬¬91è¡Œ)
    â”‚   â””â”€â–º handlerSet = &ap3000.Handlers{
    â”‚           Repo: repo,
    â”‚           Pusher: pusher,
    â”‚           PushURL: pushURL,
    â”‚           Metrics: appm
    â”‚       }
    â”‚
    â””â”€â–º åˆ›å»ºBKV Handlers (ç¬¬95è¡Œ) ğŸ”¥
        â””â”€â–º bkvHandlers = bkv.NewHandlersWithServices(
                repo,            âœ… æ•°æ®åº“Repository
                bkvReason,       âœ… åŸå› ç æ˜ å°„
                nil,             âš ï¸ CardService (å¾…å®ç°)
                outboundAdapter, âœ… ä¸‹è¡Œæ¶ˆæ¯å‘é€å™¨
                eventQueue,      âœ… äº‹ä»¶é˜Ÿåˆ—
                deduper          âœ… å»é‡å™¨
            )
            â”‚
            â””â”€â–º è¿”å›: bkvHandlers (åŒ…å«6ä¸ªä¾èµ–)
                â””â”€â–º é€šè¿‡é—­åŒ…ä¼ é€’ç»™TCPæœåŠ¡
```

---

### é˜¶æ®µ6-8: æœåŠ¡å¯åŠ¨

```
é˜¶æ®µ6-7: å¯åŠ¨HTTPå’ŒWorkeræœåŠ¡ (ç¬¬104-147è¡Œ)
    â”‚
    â”œâ”€â–º åˆ›å»ºHTTPæœåŠ¡å™¨ (ç¬¬106è¡Œ)
    â”‚   â””â”€â–º NewHTTPServer(cfg.HTTP, metricsPath, metricsHandler, readyFn)
    â”‚       â”‚
    â”‚       â”œâ”€â–º ç›‘å¬åœ°å€: :8080 (å®¹å™¨å†…)
    â”‚       â””â”€â–º å¯¹å¤–ç«¯å£: 7055
    â”‚
    â”œâ”€â–º æ³¨å†ŒHTTPè·¯ç”± (ç¬¬116-123è¡Œ)
    â”‚   â”œâ”€â–º /healthz         - å¥åº·æ£€æŸ¥
    â”‚   â”œâ”€â–º /metrics         - PrometheusæŒ‡æ ‡
    â”‚   â”œâ”€â–º /api/devices     - è®¾å¤‡æŸ¥è¯¢
    â”‚   â”œâ”€â–º /api/orders      - è®¢å•æŸ¥è¯¢
    â”‚   â””â”€â–º /api/ports       - ç«¯å£çŠ¶æ€æŸ¥è¯¢
    â”‚
    â”œâ”€â–º å¯åŠ¨HTTPæœåŠ¡ (ç¬¬125-130è¡Œ)
    â”‚   â””â”€â–º go httpSrv.Start()  (éé˜»å¡)
    â”‚
    â”œâ”€â–º å¯åŠ¨ä¸‹è¡Œé˜Ÿåˆ—Worker (ç¬¬134-144è¡Œ)
    â”‚   â””â”€â–º redisWorker.Start(ctx)
    â”‚       â”‚
    â”‚       â”œâ”€â–º ä»Redisé˜Ÿåˆ—è¯»å–ä¸‹è¡Œæ¶ˆæ¯
    â”‚       â”‚   â””â”€â–º Redis Key: outbound:queue:{serverID}
    â”‚       â”‚
    â”‚       â”œâ”€â–º è·å–è®¾å¤‡è¿æ¥
    â”‚       â”‚   â””â”€â–º sess.GetConn(phyID)
    â”‚       â”‚
    â”‚       â””â”€â–º å‘é€æ¶ˆæ¯åˆ°è®¾å¤‡
    â”‚
    â””â”€â–º å¯åŠ¨äº‹ä»¶é˜Ÿåˆ—Workers (ç¬¬147è¡Œ)
        â””â”€â–º StartEventQueueWorkers(ctx, eventQueue, workerCount, log)
            â”‚
            â”œâ”€â–º å¯åŠ¨3ä¸ªWorker (é»˜è®¤)
            â”‚
            â””â”€â–º æ¯ä¸ªWorker:
                â”œâ”€â–º ä»Redisé˜Ÿåˆ—è¯»å–äº‹ä»¶
                â”œâ”€â–º è°ƒç”¨Webhookæ¨é€
                â””â”€â–º å¤±è´¥é‡è¯• (æœ€å¤š5æ¬¡)

é˜¶æ®µ8: å¯åŠ¨TCPæœåŠ¡ ğŸ”¥ (ç¬¬149-170è¡Œ)
    â”‚
    â”œâ”€â–º åˆ›å»ºTCPæœåŠ¡å™¨ (ç¬¬150è¡Œ)
    â”‚   â””â”€â–º NewTCPServer(cfg.TCP, log)
    â”‚       â”œâ”€â–º ç›‘å¬åœ°å€: :7000 (å®¹å™¨å†…)
    â”‚       â””â”€â–º å¯¹å¤–ç«¯å£: 7065
    â”‚
    â”œâ”€â–º è®¾ç½®æŒ‡æ ‡å›è°ƒ (ç¬¬151-154è¡Œ)
    â”‚   â”œâ”€â–º TCPAccepted.Inc()
    â”‚   â””â”€â–º TCPBytesReceived.Add(n)
    â”‚
    â”œâ”€â–º è®¾ç½®è¿æ¥å¤„ç†å™¨ (ç¬¬155-159è¡Œ)
    â”‚   â””â”€â–º SetConnHandler(gateway.NewConnHandler(
    â”‚           cfg.Protocols,
    â”‚           sess,
    â”‚           policy,
    â”‚           appm,
    â”‚           func() *ap3000.Handlers { return handlerSet },
    â”‚           func() *bkv.Handlers { return bkvHandlers }  ğŸ”¥
    â”‚       ))
    â”‚       â”‚
    â”‚       â””â”€â–º é—­åŒ…æ•è·bkvHandlers (åŒ…å«6ä¸ªä¾èµ–)
    â”‚
    â””â”€â–º å¯åŠ¨TCPæœåŠ¡ (ç¬¬161-166è¡Œ)
        â””â”€â–º tcpSrv.Start()
            â”‚
            â”œâ”€â–º ç›‘å¬ç«¯å£ :7000
            â”‚
            â””â”€â–º ç­‰å¾…è®¾å¤‡è¿æ¥
```

---

## ğŸŒŠ TCPè¿æ¥æ•°æ®æµ

### è®¾å¤‡è¿æ¥å»ºç«‹æµç¨‹

```
è®¾å¤‡ â”€â”€â”€TCPè¿æ¥â”€â”€â”€â–º TCPæœåŠ¡å™¨ (:7065)
                        â”‚
                        â–¼
                   æ¥å—è¿æ¥
                        â”‚
                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  åˆ›å»ºConnContext          â”‚
         â”‚  - conn: net.Conn        â”‚
         â”‚  - ctx: context.Context  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è°ƒç”¨ConnHandler          â”‚
         â”‚  gateway.NewConnHandler() â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  åˆ›å»ºåè®®é€‚é…å™¨           â”‚
         â”‚  - ap3000.NewAdapter()   â”‚
         â”‚  - bkv.NewAdapter()      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æ³¨å†Œå‘½ä»¤å¤„ç†å™¨ (24ä¸ª)    â”‚
         â”‚  bkvAdapter.Register()   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  åˆ›å»ºMux                  â”‚
         â”‚  tcpserver.NewMux()      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ç»‘å®šåˆ°è¿æ¥               â”‚
         â”‚  mux.BindToConn(cc)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                ç­‰å¾…æ•°æ®åŒ…
```

---

### æ•°æ®åŒ…å¤„ç†æµç¨‹ ğŸ”¥

```
è®¾å¤‡å‘é€æ•°æ®åŒ…
    â”‚
    â–¼
TCPè¿æ¥æ¥æ”¶æ•°æ®
    â”‚
    â”œâ”€â–º åŸå§‹æ•°æ®: []byte
    â”‚   â””â”€â–º ç¤ºä¾‹: fcfe 002e 0000 00000001 82 82200520004869 [payload] checksum fcee
    â”‚
    â–¼
Mux.Read(buf)
    â”‚
    â”œâ”€â–º è¯»å–å¸§å¤´
    â”‚   â””â”€â–º 0xFCFE (ä¸Šè¡Œ) æˆ– 0xFCFF (ä¸‹è¡Œ)
    â”‚
    â”œâ”€â–º è¯†åˆ«åè®®
    â”‚   â”œâ”€â–º BKVåè®® (0xFCFE/0xFCFF)
    â”‚   â””â”€â–º AP3000åè®® (å…¶ä»–)
    â”‚
    â–¼
BKV Adapter.Decode()  (internal/protocol/bkv/parser.go)
    â”‚
    â”œâ”€â–º è§£æå¸§ç»“æ„
    â”‚   â”œâ”€â–º å¸§å¤´: 0xFCFE (2å­—èŠ‚)
    â”‚   â”œâ”€â–º é•¿åº¦: uint16 (2å­—èŠ‚)
    â”‚   â”œâ”€â–º å‘½ä»¤: uint16 (2å­—èŠ‚) ğŸ”¥
    â”‚   â”œâ”€â–º æ¶ˆæ¯ID: uint32 (4å­—èŠ‚)
    â”‚   â”œâ”€â–º æ–¹å‘: uint8 (1å­—èŠ‚)
    â”‚   â”œâ”€â–º ç½‘å…³ID: [7]byte (7å­—èŠ‚)
    â”‚   â”œâ”€â–º æ•°æ®: []byte (å¯å˜é•¿åº¦)
    â”‚   â”œâ”€â–º æ ¡éªŒå’Œ: uint8 (1å­—èŠ‚)
    â”‚   â””â”€â–º å¸§å°¾: 0xFCEE (1å­—èŠ‚)
    â”‚
    â”œâ”€â–º æ ¡éªŒæ•°æ®
    â”‚   â”œâ”€â–º éªŒè¯å¸§å¤´/å¸§å°¾
    â”‚   â””â”€â–º éªŒè¯æ ¡éªŒå’Œ (ç´¯åŠ æ¨¡256)
    â”‚
    â””â”€â–º åˆ›å»ºFrameå¯¹è±¡
        â””â”€â–º Frame{
                Cmd: 0x0000,
                MsgID: 1,
                GatewayID: "82200520004869",
                Data: [payload],
            }
        â”‚
        â–¼
æ ¹æ®å‘½ä»¤ç è·¯ç”± (Adapter.Route)
    â”‚
    â”œâ”€â–º æŸ¥æ‰¾æ³¨å†Œçš„Handler
    â”‚   â””â”€â–º handlers[0x0000] = wrapBKVHandler(...)
    â”‚
    â””â”€â–º è°ƒç”¨Handlerå‡½æ•°
        â”‚
        â–¼
wrapBKVHandleræ‰§è¡Œ
    â”‚
    â”œâ”€â–º æŒ‡æ ‡ä¸ŠæŠ¥
    â”‚   â””â”€â–º appm.BKVRouteTotal.WithLabelValues("0000").Inc()
    â”‚
    â”œâ”€â–º ä¼šè¯ç»‘å®š
    â”‚   â””â”€â–º bindIfNeeded(f.GatewayID)
    â”‚       â””â”€â–º sess.Bind(phyID, conn)
    â”‚           â””â”€â–º Redis: session:device:{phyID}
    â”‚
    â”œâ”€â–º è·å–Handlers
    â”‚   â””â”€â–º bh := getBKVHandlers()  ğŸ”¥
    â”‚       â””â”€â–º è¿”å›: bkvHandlers (åŒ…å«6ä¸ªä¾èµ–)
    â”‚
    â””â”€â–º è°ƒç”¨å…·ä½“Handleræ–¹æ³•
        â”‚
        â–¼
HandleHeartbeat(ctx, frame)  (ç¤ºä¾‹)
    â”‚
    â”œâ”€â–º ç©ºæŒ‡é’ˆæ£€æŸ¥
    â”‚   â””â”€â–º if h == nil || h.Repo == nil { return nil }
    â”‚
    â”œâ”€â–º æå–è®¾å¤‡ä¿¡æ¯
    â”‚   â””â”€â–º devicePhyID = frame.GatewayID
    â”‚       â””â”€â–º "82200520004869"
    â”‚
    â”œâ”€â–º æ•°æ®åº“æ“ä½œ (ä½¿ç”¨ h.Repo)
    â”‚   â”‚
    â”‚   â”œâ”€â–º EnsureDevice(ctx, phyID)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º SELECT id FROM devices WHERE phy_id = $1
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â–º å¦‚æœä¸å­˜åœ¨:
    â”‚   â”‚       â””â”€â–º INSERT INTO devices (phy_id, created_at) VALUES ($1, NOW())
    â”‚   â”‚
    â”‚   â””â”€â–º è¿”å›: deviceID (int64)
    â”‚
    â”œâ”€â–º äº‹ä»¶æ¨é€ (ä½¿ç”¨ h.EventQueue)
    â”‚   â”‚
    â”‚   â””â”€â–º if h.EventQueue != nil {
    â”‚           event := &StandardEvent{
    â”‚               EventID: uuid.New(),
    â”‚               EventType: "device.heartbeat",
    â”‚               DevicePhyID: phyID,
    â”‚               Timestamp: time.Now(),
    â”‚               Data: {...}
    â”‚           }
    â”‚           h.EventQueue.Enqueue(ctx, event)
    â”‚       }
    â”‚       â”‚
    â”‚       â””â”€â–º Redis: RPUSH thirdparty:event:queue {event_json}
    â”‚
    â”œâ”€â–º è®°å½•å‘½ä»¤æ—¥å¿— (ä½¿ç”¨ h.Repo)
    â”‚   â”‚
    â”‚   â””â”€â–º InsertCmdLog(ctx, deviceID, msgID, cmd, direction, payload, success)
    â”‚       â”‚
    â”‚       â””â”€â–º INSERT INTO cmd_log (
    â”‚               device_id, msg_id, cmd, direction, payload, success, created_at
    â”‚           ) VALUES ($1, $2, $3, $4, $5, $6, NOW())
    â”‚
    â””â”€â–º è¿”å› nil (æˆåŠŸ)
```

---

## ğŸ“¤ ä¸‹è¡Œæ¶ˆæ¯æ•°æ®æµ

### ä¸‹è¡Œæ¶ˆæ¯å‘é€æµç¨‹

```
APIè¯·æ±‚ (HTTP)
    â”‚
    â””â”€â–º POST /api/control
        â””â”€â–º Body: { "phy_id": "xxx", "cmd": "start_charge", ... }
        â”‚
        â–¼
API Handler (internal/api/routes.go)
    â”‚
    â”œâ”€â–º éªŒè¯è¯·æ±‚å‚æ•°
    â”‚
    â”œâ”€â–º æ„é€ BKVæ§åˆ¶å‘½ä»¤
    â”‚   â””â”€â–º cmd: 0x0015
    â”‚       data: [æ§åˆ¶å‚æ•°]
    â”‚
    â””â”€â–º è°ƒç”¨Outboundå‘é€
        â”‚
        â–¼
OutboundAdapter.SendDownlink(gatewayID, cmd, msgID, data)
    â”‚
    â”œâ”€â–º æ„é€ BKVä¸‹è¡Œå¸§
    â”‚   â””â”€â–º Build(cmd, msgID, gatewayID, data)
    â”‚       â””â”€â–º è¿”å›: []byte (å®Œæ•´å¸§)
    â”‚
    â”œâ”€â–º è·å–DeviceID
    â”‚   â””â”€â–º repo.EnsureDevice(ctx, gatewayID)
    â”‚
    â”œâ”€â–º æ’å…¥åˆ°PostgreSQLé˜Ÿåˆ—
    â”‚   â””â”€â–º INSERT INTO outbound_queue (
    â”‚           device_id, phy_id, cmd, payload, priority, msg_id
    â”‚       ) VALUES ($1, $2, $3, $4, 100, $5)
    â”‚
    â””â”€â–º æ¨é€åˆ°Redisé˜Ÿåˆ—
        â””â”€â–º RPUSH outbound:queue:{serverID} {message_json}
        â”‚
        â–¼
RedisWorker æ¥æ”¶ (åå°è¿è¡Œ)
    â”‚
    â”œâ”€â–º BLPOP outbound:queue:{serverID} 5
    â”‚   â””â”€â–º é˜»å¡ç­‰å¾…ï¼Œ5ç§’è¶…æ—¶
    â”‚
    â”œâ”€â–º è§£ææ¶ˆæ¯
    â”‚   â””â”€â–º {phy_id, cmd, payload, msg_id}
    â”‚
    â”œâ”€â–º è·å–è®¾å¤‡è¿æ¥
    â”‚   â””â”€â–º conn, ok := sess.GetConn(phy_id)
    â”‚       â”‚
    â”‚       â””â”€â–º Redis: GET session:device:{phy_id}
    â”‚           â””â”€â–º è¿”å›: {conn_id, server_id}
    â”‚
    â”œâ”€â–º å‘é€åˆ°è®¾å¤‡
    â”‚   â””â”€â–º conn.Write(payload)
    â”‚       â”‚
    â”‚       â””â”€â–º TCP: å‘é€å­—èŠ‚æµ
    â”‚
    â””â”€â–º ç­‰å¾…ACK (å¯é€‰)
        â””â”€â–º è¶…æ—¶æ—¶é—´: 30ç§’
```

---

## ğŸ¯ äº‹ä»¶æ¨é€æ•°æ®æµ

### äº‹ä»¶æ¨é€æµç¨‹

```
ä¸šåŠ¡Handlerå¤„ç†
    â”‚
    â””â”€â–º ç”Ÿæˆäº‹ä»¶
        â””â”€â–º event := &StandardEvent{
                EventID: uuid.New(),
                EventType: "device.heartbeat",
                DevicePhyID: phyID,
                Timestamp: time.Now(),
                Data: map[string]interface{}{
                    "voltage": 220.0,
                    "rssi": -50,
                }
            }
        â”‚
        â–¼
æ£€æŸ¥å»é‡ (ä½¿ç”¨ h.Deduper)
    â”‚
    â”œâ”€â–º ç”Ÿæˆäº‹ä»¶æŒ‡çº¹
    â”‚   â””â”€â–º fingerprint = hash(event_type + device_id + timestamp_minute)
    â”‚
    â”œâ”€â–º Redis: SETNX thirdparty:dedup:{fingerprint} 1 EX 3600
    â”‚   â”‚
    â”‚   â”œâ”€â–º å¦‚æœè¿”å›1: é¦–æ¬¡å‡ºç°ï¼Œç»§ç»­æ¨é€
    â”‚   â””â”€â–º å¦‚æœè¿”å›0: é‡å¤äº‹ä»¶ï¼Œè·³è¿‡
    â”‚
    â””â”€â–º å¦‚æœæ˜¯é¦–æ¬¡å‡ºç°
        â”‚
        â–¼
å…¥é˜Ÿäº‹ä»¶ (ä½¿ç”¨ h.EventQueue)
    â”‚
    â”œâ”€â–º åºåˆ—åŒ–äº‹ä»¶
    â”‚   â””â”€â–º json.Marshal(event)
    â”‚
    â”œâ”€â–º æ¨é€åˆ°Redisé˜Ÿåˆ—
    â”‚   â””â”€â–º RPUSH thirdparty:event:queue {event_json}
    â”‚
    â””â”€â–º æ—¥å¿—è®°å½•
        â””â”€â–º log.Debug("event enqueued", event_id, event_type)
        â”‚
        â–¼
EventQueue Worker å¤„ç† (åå°è¿è¡Œï¼Œ3ä¸ªWorker)
    â”‚
    â”œâ”€â–º BLPOP thirdparty:event:queue 5
    â”‚   â””â”€â–º é˜»å¡ç­‰å¾…äº‹ä»¶
    â”‚
    â”œâ”€â–º è§£æäº‹ä»¶
    â”‚   â””â”€â–º json.Unmarshal(data, &event)
    â”‚
    â”œâ”€â–º è°ƒç”¨Webhook (ä½¿ç”¨ Pusher)
    â”‚   â”‚
    â”‚   â”œâ”€â–º æ„é€ HTTPè¯·æ±‚
    â”‚   â”‚   â”œâ”€â–º URL: cfg.Thirdparty.Push.WebhookURL
    â”‚   â”‚   â”œâ”€â–º Method: POST
    â”‚   â”‚   â”œâ”€â–º Headers:
    â”‚   â”‚   â”‚   â”œâ”€â–º Content-Type: application/json
    â”‚   â”‚   â”‚   â””â”€â–º X-Signature: hmac_sha256(secret, body)
    â”‚   â”‚   â””â”€â–º Body: {event_json}
    â”‚   â”‚
    â”‚   â”œâ”€â–º å‘é€è¯·æ±‚
    â”‚   â”‚   â””â”€â–º http.Post(url, body)
    â”‚   â”‚
    â”‚   â””â”€â–º å¤„ç†å“åº”
    â”‚       â”œâ”€â–º å¦‚æœæˆåŠŸ (200-299):
    â”‚       â”‚   â””â”€â–º æ—¥å¿—è®°å½•æˆåŠŸ
    â”‚       â”‚
    â”‚       â””â”€â–º å¦‚æœå¤±è´¥:
    â”‚           â”œâ”€â–º é‡è¯•è®¡æ•° +1
    â”‚           â”œâ”€â–º å¦‚æœ < maxRetries (5æ¬¡):
    â”‚           â”‚   â””â”€â–º RPUSH thirdparty:event:queue {event_json}
    â”‚           â”‚       â””â”€â–º å»¶è¿Ÿ: 2^retries ç§’
    â”‚           â”‚
    â”‚           â””â”€â–º å¦‚æœ >= maxRetries:
    â”‚               â””â”€â–º RPUSH thirdparty:event:dlq {event_json}
    â”‚                   â””â”€â–º è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
    â”‚
    â””â”€â–º è®°å½•æŒ‡æ ‡
        â”œâ”€â–º event_pushed_total.Inc()
        â””â”€â–º event_push_duration_seconds.Observe(duration)
```

---

## ğŸ”„ ä¼šè¯ç®¡ç†æ•°æ®æµ

### ä¼šè¯ç»‘å®šæµç¨‹

```
è®¾å¤‡è¿æ¥å»ºç«‹
    â”‚
    â”œâ”€â–º TCP Accept
    â”‚   â””â”€â–º net.Conn
    â”‚
    â””â”€â–º ç¬¬ä¸€ä¸ªå¿ƒè·³åŒ…åˆ°è¾¾
        â”‚
        â–¼
bindIfNeeded(phyID)
    â”‚
    â”œâ”€â–º æ£€æŸ¥æ˜¯å¦å·²ç»‘å®š
    â”‚   â””â”€â–º if boundPhy != phyID
    â”‚
    â”œâ”€â–º ç»‘å®šä¼šè¯
    â”‚   â””â”€â–º sess.Bind(phyID, conn)
    â”‚       â”‚
    â”‚       â”œâ”€â–º ç”ŸæˆconnID
    â”‚       â”‚   â””â”€â–º connID = uuid.New()
    â”‚       â”‚
    â”‚       â”œâ”€â–º ä¿å­˜æœ¬åœ°è¿æ¥
    â”‚       â”‚   â””â”€â–º localConn[connID] = conn
    â”‚       â”‚
    â”‚       â”œâ”€â–º ä¿å­˜åˆ°Redis
    â”‚       â”‚   â”‚
    â”‚       â”‚   â”œâ”€â–º session:device:{phyID}
    â”‚       â”‚   â”‚   â””â”€â–º {
    â”‚       â”‚   â”‚         "phy_id": phyID,
    â”‚       â”‚   â”‚         "conn_id": connID,
    â”‚       â”‚   â”‚         "server_id": serverID,
    â”‚       â”‚   â”‚         "last_seen": timestamp
    â”‚       â”‚   â”‚       }
    â”‚       â”‚   â”‚
    â”‚       â”‚   â”œâ”€â–º session:conn:{connID}
    â”‚       â”‚   â”‚   â””â”€â–º phyID
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€â–º session:server:{serverID}:conns
    â”‚       â”‚       â””â”€â–º SADD connID
    â”‚       â”‚
    â”‚       â””â”€â–º è®¾ç½®TTL
    â”‚           â””â”€â–º EXPIRE 360ç§’
    â”‚
    â””â”€â–º æ›´æ–°boundPhy
        â””â”€â–º boundPhy = phyID

è®¾å¤‡å¿ƒè·³æ›´æ–°
    â”‚
    â””â”€â–º sess.OnHeartbeat(phyID, time.Now())
        â”‚
        â”œâ”€â–º è¯»å–Redisä¼šè¯æ•°æ®
        â”‚   â””â”€â–º GET session:device:{phyID}
        â”‚
        â”œâ”€â–º æ›´æ–°last_seenæ—¶é—´
        â”‚
        â”œâ”€â–º ä¿å­˜å›Redis
        â”‚   â””â”€â–º SET session:device:{phyID} {updated_data}
        â”‚
        â””â”€â–º åˆ·æ–°TTL
            â””â”€â–º EXPIRE session:device:{phyID} 360

è®¾å¤‡æ–­å¼€è¿æ¥
    â”‚
    â””â”€â–º <-cc.Done()
        â”‚
        â”œâ”€â–º è§£ç»‘ä¼šè¯
        â”‚   â””â”€â–º sess.UnbindByPhy(phyID)
        â”‚       â”‚
        â”‚       â”œâ”€â–º åˆ é™¤Redisæ•°æ®
        â”‚       â”‚   â”œâ”€â–º DEL session:device:{phyID}
        â”‚       â”‚   â”œâ”€â–º DEL session:conn:{connID}
        â”‚       â”‚   â””â”€â–º SREM session:server:{serverID}:conns connID
        â”‚       â”‚
        â”‚       â””â”€â–º åˆ é™¤æœ¬åœ°è¿æ¥
        â”‚           â””â”€â–º delete(localConn, connID)
        â”‚
        â”œâ”€â–º è®°å½•TCPå…³é—­
        â”‚   â””â”€â–º sess.OnTCPClosed(phyID, time.Now())
        â”‚
        â””â”€â–º æ›´æ–°æŒ‡æ ‡
            â””â”€â–º appm.SessionOfflineTotal.WithLabelValues("tcp").Inc()
```

---

## ğŸ“Š æ•°æ®åº“æ“ä½œæ•°æ®æµ

### è®¾å¤‡æ•°æ®å­˜å‚¨æµç¨‹

```
Handlerå¤„ç†
    â”‚
    â””â”€â–º repo.EnsureDevice(ctx, phyID)
        â”‚
        â”œâ”€â–º æŸ¥è¯¢è®¾å¤‡
        â”‚   â””â”€â–º SELECT id, phy_id FROM devices WHERE phy_id = $1
        â”‚
        â”œâ”€â–º å¦‚æœå­˜åœ¨:
        â”‚   â””â”€â–º è¿”å› deviceID
        â”‚
        â””â”€â–º å¦‚æœä¸å­˜åœ¨:
            â””â”€â–º INSERT INTO devices (
                    phy_id, created_at, updated_at
                ) VALUES ($1, NOW(), NOW())
                RETURNING id
                â”‚
                â””â”€â–º è¿”å› deviceID

ç«¯å£çŠ¶æ€æ›´æ–°
    â”‚
    â””â”€â–º repo.UpsertPortState(ctx, deviceID, portNo, status, powerW)
        â”‚
        â””â”€â–º INSERT INTO ports (
                device_id, port_no, status, power_w, updated_at
            ) VALUES ($1, $2, $3, $4, NOW())
            ON CONFLICT (device_id, port_no)
            DO UPDATE SET
                status = EXCLUDED.status,
                power_w = EXCLUDED.power_w,
                updated_at = NOW()

è®¢å•åˆ›å»º/æ›´æ–°
    â”‚
    â””â”€â–º repo.UpsertOrderProgress(ctx, deviceID, portNo, orderNo, durationSec, kwh01, status, powerW01)
        â”‚
        â””â”€â–º INSERT INTO orders (
                device_id, port_no, order_no, 
                start_time, kwh_0p01, status, 
                created_at, updated_at
            ) VALUES ($1, $2, $3, NOW(), $4, $5, NOW(), NOW())
            ON CONFLICT (order_no)
            DO UPDATE SET
                kwh_0p01 = EXCLUDED.kwh_0p01,
                status = EXCLUDED.status,
                updated_at = NOW()

å‘½ä»¤æ—¥å¿—è®°å½•
    â”‚
    â””â”€â–º repo.InsertCmdLog(ctx, deviceID, msgID, cmd, direction, payload, success)
        â”‚
        â””â”€â–º INSERT INTO cmd_log (
                device_id, msg_id, cmd, direction, 
                payload, success, created_at
            ) VALUES ($1, $2, $3, $4, $5, $6, NOW())
```

---

## ğŸ” å®Œæ•´ç¤ºä¾‹ï¼šå¿ƒè·³æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾å¤‡ 82200520004869 å‘é€å¿ƒè·³                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        TCPæ•°æ®åŒ…: fcfe 002e 0000 00000001 82 82200520004869 [data] 5a fcee
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TCPæœåŠ¡å™¨æ¥æ”¶ (ç«¯å£7054)                                              â”‚
â”‚  - è¯»å–å­—èŠ‚æµ                                                          â”‚
â”‚  - åˆ›å»ºConnContext                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Muxè·¯ç”±                                                              â”‚
â”‚  - è¯»å–å¸§å¤´: 0xFCFE                                                   â”‚
â”‚  - è¯†åˆ«ä¸ºBKVåè®®                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BKV Parserè§£æ                                                       â”‚
â”‚  - å¸§å¤´: 0xFCFE                                                       â”‚
â”‚  - é•¿åº¦: 46å­—èŠ‚                                                        â”‚
â”‚  - å‘½ä»¤: 0x0000 (å¿ƒè·³) ğŸ”¥                                             â”‚
â”‚  - æ¶ˆæ¯ID: 1                                                          â”‚
â”‚  - æ–¹å‘: 0x82 (ä¸Šè¡Œ)                                                  â”‚
â”‚  - ç½‘å…³ID: 82200520004869                                             â”‚
â”‚  - æ•°æ®: [...]                                                        â”‚
â”‚  - æ ¡éªŒå’Œ: 0x5A                                                       â”‚
â”‚  - å¸§å°¾: 0xFCEE                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘½ä»¤è·¯ç”±                                                              â”‚
â”‚  - æŸ¥æ‰¾handlers[0x0000]                                               â”‚
â”‚  - æ‰¾åˆ°: wrapBKVHandler(HandleHeartbeat)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  wrapBKVHandleræ‰§è¡Œ                                                   â”‚
â”‚  1. æŒ‡æ ‡ä¸ŠæŠ¥: BKVRouteTotal{cmd="0000"}.Inc()                         â”‚
â”‚  2. ä¼šè¯ç»‘å®š: bindIfNeeded("82200520004869")                          â”‚
â”‚     â””â”€â–º Rediså†™å…¥: session:device:82200520004869                      â”‚
â”‚  3. è·å–Handlers: bh = getBKVHandlers() ğŸ”¥                            â”‚
â”‚     â””â”€â–º è¿”å›: bkvHandlers (åŒ…å«6ä¸ªä¾èµ–)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HandleHeartbeatæ‰§è¡Œ                                                  â”‚
â”‚                                                                       â”‚
â”‚  1. ç©ºæŒ‡é’ˆæ£€æŸ¥                                                         â”‚
â”‚     â””â”€â–º if h == nil || h.Repo == nil { return nil }                  â”‚
â”‚                                                                       â”‚
â”‚  2. æå–è®¾å¤‡ä¿¡æ¯                                                       â”‚
â”‚     â””â”€â–º phyID = "82200520004869"                                      â”‚
â”‚                                                                       â”‚
â”‚  3. æ•°æ®åº“æ“ä½œ (h.Repo)                                                â”‚
â”‚     â”œâ”€â–º EnsureDevice(ctx, "82200520004869")                           â”‚
â”‚     â”‚   â””â”€â–º PostgreSQL:                                               â”‚
â”‚     â”‚       SELECT id FROM devices WHERE phy_id='82200520004869'     â”‚
â”‚     â”‚       â””â”€â–º è¿”å›: deviceID = 123                                  â”‚
â”‚     â”‚                                                                 â”‚
â”‚     â””â”€â–º InsertCmdLog(ctx, 123, 1, 0x0000, 0, [data], true)           â”‚
â”‚         â””â”€â–º PostgreSQL:                                               â”‚
â”‚             INSERT INTO cmd_log VALUES (123, 1, 0, 0, [data], true)  â”‚
â”‚                                                                       â”‚
â”‚  4. äº‹ä»¶æ¨é€ (h.EventQueue)                                            â”‚
â”‚     â””â”€â–º if h.EventQueue != nil {                                      â”‚
â”‚           event = {                                                   â”‚
â”‚             event_id: "uuid-xxx",                                     â”‚
â”‚             event_type: "device.heartbeat",                           â”‚
â”‚             device_phy_id: "82200520004869",                          â”‚
â”‚             timestamp: "2025-10-20T09:52:25",                         â”‚
â”‚             data: {voltage: 220, rssi: -50}                           â”‚
â”‚           }                                                           â”‚
â”‚           EventQueue.Enqueue(ctx, event)                              â”‚
â”‚           â””â”€â–º Redis: RPUSH thirdparty:event:queue {event_json}       â”‚
â”‚         }                                                             â”‚
â”‚                                                                       â”‚
â”‚  5. å»é‡æ£€æŸ¥ (h.Deduper)                                               â”‚
â”‚     â””â”€â–º fingerprint = hash("heartbeat-82200520004869-202501091430")  â”‚
â”‚         Redis: SETNX thirdparty:dedup:{fingerprint} 1 EX 3600        â”‚
â”‚                                                                       â”‚
â”‚  6. è¿”å› nil (æˆåŠŸ)                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åå°å¼‚æ­¥å¤„ç†                                                          â”‚
â”‚                                                                       â”‚
â”‚  EventQueue Worker (åå°çº¿ç¨‹):                                         â”‚
â”‚  â”œâ”€â–º BLPOP thirdparty:event:queue 5                                   â”‚
â”‚  â”œâ”€â–º è·å–äº‹ä»¶                                                          â”‚
â”‚  â”œâ”€â–º POST https://third-party.com/webhook                             â”‚
â”‚  â”‚   Headers: X-Signature: hmac_sha256(...)                           â”‚
â”‚  â”‚   Body: {event_json}                                               â”‚
â”‚  â””â”€â–º å“åº”: 200 OK                                                     â”‚
â”‚      â””â”€â–º æ—¥å¿—: "event pushed successfully"                            â”‚
â”‚                                                                       â”‚
â”‚  Redisä¼šè¯åˆ·æ–° (å¿ƒè·³æ›´æ–°):                                             â”‚
â”‚  â””â”€â–º sess.OnHeartbeat("82200520004869", now)                          â”‚
â”‚      â””â”€â–º Redis: SET session:device:82200520004869 {...}               â”‚
â”‚          EXPIRE session:device:82200520004869 360                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡æ•°æ®æµ

```
ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­
    â”‚
    â”œâ”€â–º TCPè¿æ¥æŒ‡æ ‡
    â”‚   â”œâ”€â–º TCPAccepted.Inc()
    â”‚   â”œâ”€â–º TCPBytesReceived.Add(n)
    â”‚   â””â”€â–º OnlineGauge.Set(count)
    â”‚
    â”œâ”€â–º åè®®å¤„ç†æŒ‡æ ‡
    â”‚   â”œâ”€â–º BKVRouteTotal{cmd="0000"}.Inc()
    â”‚   â”œâ”€â–º BKVParseTotal{result="success"}.Inc()
    â”‚   â””â”€â–º AP3000RouteTotal{cmd="20"}.Inc()
    â”‚
    â”œâ”€â–º ä¼šè¯æŒ‡æ ‡
    â”‚   â”œâ”€â–º SessionOfflineTotal{type="tcp"}.Inc()
    â”‚   â””â”€â–º HeartbeatTotal.Inc()
    â”‚
    â””â”€â–º äº‹ä»¶æ¨é€æŒ‡æ ‡
        â”œâ”€â–º EventPushedTotal{result="success"}.Inc()
        â””â”€â–º EventPushDurationSeconds.Observe(duration)
        â”‚
        â–¼
Prometheusæ‹‰å– (HTTP /metrics)
    â”‚
    â”œâ”€â–º GET http://localhost:7055/metrics
    â”‚
    â””â”€â–º è¿”å›æŒ‡æ ‡
        â””â”€â–º # HELP tcp_accepted_total
            # TYPE tcp_accepted_total counter
            tcp_accepted_total 1234
            
            # HELP bkv_route_total
            # TYPE bkv_route_total counter
            bkv_route_total{cmd="0000"} 567
            
            ...
```

---

## ğŸ¯ æ€»ç»“ï¼šå®Œæ•´æ•°æ®æµå›¾

```
                    ç¨‹åºå¯åŠ¨
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    é…ç½®åŠ è½½        æ—¥å¿—åˆå§‹åŒ–      åŸºç¡€ç»„ä»¶
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  bootstrap.Run()      â”‚
            â”‚  9ä¸ªå¯åŠ¨é˜¶æ®µ           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    Redisåˆå§‹åŒ–    æ•°æ®åº“è¿æ¥    BKV Handlersåˆ›å»º ğŸ”¥
    â”œâ”€ä¼šè¯ç®¡ç†      â”œâ”€è¿ç§»æ‰§è¡Œ    â”œâ”€6ä¸ªä¾èµ–æ³¨å…¥
    â”œâ”€äº‹ä»¶é˜Ÿåˆ—      â””â”€è¿æ¥æ±       â”œâ”€Repo
    â””â”€å»é‡          åˆ›å»ºRepository â”œâ”€Reason
        â”‚               â”‚           â”œâ”€CardService (nil)
        â”‚               â”‚           â”œâ”€Outbound âœ…
        â”‚               â”‚           â”œâ”€EventQueue âœ…
        â”‚               â”‚           â””â”€Deduper âœ…
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  å¯åŠ¨æœåŠ¡              â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  â€¢ HTTP (7055)        â”‚
            â”‚  â€¢ TCP (7065) ğŸ”¥      â”‚
            â”‚  â€¢ RedisWorker        â”‚
            â”‚  â€¢ EventWorkers       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    HTTPè¯·æ±‚        TCPè¿æ¥        åå°ä»»åŠ¡
    â”œâ”€å¥åº·æ£€æŸ¥      â”œâ”€åè®®è§£æ      â”œâ”€ä¸‹è¡Œæ¶ˆæ¯
    â”œâ”€è®¾å¤‡æŸ¥è¯¢      â”œâ”€å‘½ä»¤è·¯ç”±      â””â”€äº‹ä»¶æ¨é€
    â”œâ”€è®¢å•æŸ¥è¯¢      â”œâ”€Handleræ‰§è¡Œ
    â””â”€æ§åˆ¶ä¸‹å‘      â”‚  â”œâ”€æ•°æ®åº“æ“ä½œ
                    â”‚  â”œâ”€ä¼šè¯ç®¡ç†
                    â”‚  â”œâ”€äº‹ä»¶å…¥é˜Ÿ
                    â”‚  â””â”€æŒ‡æ ‡ä¸ŠæŠ¥
                    â”‚
                    â””â”€â–º ä¸šåŠ¡å®Œæˆ
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    PostgreSQL      Redis           ç¬¬ä¸‰æ–¹Webhook
    â”œâ”€è®¾å¤‡è¡¨        â”œâ”€ä¼šè¯          â””â”€äº‹ä»¶æ¨é€
    â”œâ”€ç«¯å£è¡¨        â”œâ”€é˜Ÿåˆ—
    â”œâ”€è®¢å•è¡¨        â””â”€å»é‡
    â””â”€æ—¥å¿—è¡¨
```

---

## âœ… å…³é”®æ•°æ®æµèŠ‚ç‚¹

| èŠ‚ç‚¹ | ä½ç½® | ä½œç”¨ | æ•°æ®æ ¼å¼ |
|------|------|------|---------|
| **ç¨‹åºå…¥å£** | main.go:19 | å¯åŠ¨åº”ç”¨ | - |
| **é…ç½®åŠ è½½** | config.Load() | è¯»å–YAML | Configç»“æ„ä½“ |
| **BKV Handlersåˆ›å»º** | bootstrap.go:95 | åˆå§‹åŒ–å¤„ç†å™¨ | *Handlers (6ä¸ªä¾èµ–) |
| **é—­åŒ…ä¼ é€’** | bootstrap.go:158 | æ•è·handlers | func() *Handlers |
| **TCPè¿æ¥** | tcpserver.Start() | ç›‘å¬ç«¯å£ | net.Conn |
| **åè®®è§£æ** | bkv.Decode() | è§£æå¸§ | *Frame |
| **å‘½ä»¤è·¯ç”±** | Adapter.Route() | åˆ†å‘å¤„ç† | cmd â†’ handler |
| **Handleræ‰§è¡Œ** | HandleXxx() | ä¸šåŠ¡é€»è¾‘ | ctx, frame |
| **æ•°æ®åº“æ“ä½œ** | repo.Xxx() | æŒä¹…åŒ– | SQL |
| **Redisæ“ä½œ** | redis.Xxx() | ç¼“å­˜/é˜Ÿåˆ— | Key-Value |
| **äº‹ä»¶æ¨é€** | EventQueue.Enqueue() | å¼‚æ­¥æ¨é€ | JSON |
| **æŒ‡æ ‡ä¸ŠæŠ¥** | appm.Xxx.Inc() | ç›‘æ§ | Prometheusæ ¼å¼ |

---

**æ–‡æ¡£å®Œæˆï¼æ‰€æœ‰æ•°æ®æµæ¸…æ™°å±•ç¤ºï¼** ğŸ‰
