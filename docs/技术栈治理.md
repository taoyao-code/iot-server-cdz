## 技术栈治理（Tech Stack Governance）

### 目录

- 1. 目标与范围
- 2. 技术栈总览（组件、版本、用途、Owner）
- 3. 版本与升级策略（LTS、兼容、Deprecation）
- 4. 配置治理（集中清单、环境矩阵、变更流程）
- 5. 环境与部署矩阵
- 6. 依赖白名单与第三方库准入
- 7. 决策记录（ADR）与变更审批

### 1. 目标与范围

- 解决“技术选型分散”问题，统一在此文档维护组件、版本、配置与变更策略；各模块文档只引用本页。

### 2. 技术栈总览

| 领域 | 组件/库 | 版本策略 | 用途 | Owner |
| --- | --- | --- | --- | --- |
| 语言与运行时 | Go | 1.24.x LTS | 全服务 | 平台负责人 |
| HTTP 框架 | gin | 约束同 Go | 管理/第三方 API | API 负责人 |
| 配置 | Viper | latest 稳定 | 读取 YAML/ENV | 平台负责人 |
| 日志 | zap + lumberjack | latest 稳定 | 结构化日志/滚动 | 观测负责人 |
| 指标 | prometheus/client_golang | latest 稳定 | Metrics 暴露 | 观测负责人 |
| 限速 | uber-go/ratelimit、redis_rate(可选) | 固定次要版本 | 设备/全局限速 | 网关负责人 |
| PG 驱动 | pgx/pgxpool | 与 PG 兼容矩阵 | 数据持久化 | 数据负责人 |
| 迁移 | golang-migrate | 固定版本 | DDL 迁移 | 数据负责人 |
| 调度 | robfig/cron | 固定版本 | 定时续发/清理 | 平台负责人 |
| OpenAPI | oapi-codegen（仅校验） | 固定版本 | 契约校验 | API 负责人 |

#### 2.1 组件标识（引用标签）

- [TS-HTTP]：HTTP 框架与路由
- [TS-Config]：配置系统与加载策略
- [TS-Log]：日志与滚动
- [TS-Metrics]：指标采集与暴露
- [TS-RateLimit]：限速（本地/分布式）
- [TS-DB]：PostgreSQL 驱动与连接池
- [TS-Migrate]：数据库迁移工具
- [TS-Scheduler]：定时调度
- [TS-OpenAPI]：OpenAPI 契约校验

### 3. 版本与升级策略

- 固定主版本 + 受控次版本：季度评估，月度小版本升级；Staging 验证通过后生产灰度。
- 兼容性：遵循 SemVer；不兼容升级需 ADR；保留回滚窗口与数据备份。
- Deprecation：公告期≥2个迭代；提供替代方案与迁移指南。

### 4. 配置治理

- 集中清单：在 `configs/example.yaml` 维护所有键、默认值与说明；模块文档不再重复。
- 变更流程：配置变更需评审与变更单，Staging 回放验证后灰度放量。
- 加密：敏感配置（密钥、DSN）使用环境变量或密钥管理（如 Vault/云密钥）。

### 附录A 配置键清单（集中维护）

- 配置键的唯一来源为 `configs/example.yaml`。各模块文档仅“引用键名”，不重复定义默认值或库。

### 附录B 环境变量约定

- 所有敏感值仅通过环境变量或密钥管理注入，键名在 `configs/example.yaml` 中带有注释说明。

### 5. 环境与部署矩阵

| 环境 | 目的 | 数据 | 升级策略 | 监控 |
| --- | --- | --- | --- | --- |
| dev | 开发自测 | 仿真/小量真实 | 随时 | 基本 |
| staging | 联调与回放 | 数据脱敏/回放集 | 周期灰度 | 完整 |
| prod | 生产 | 真实 | 变更窗口+回滚 | 完整 |

### 6. 依赖白名单与第三方库准入

- 白名单：仅允许表中列出的库；新增库需提交 ADR，阐明必要性/替代比较/安全评估。
- 安全：许可证审查；无维护/高风险库不准入；定期 `go audit` 与 CVE 检查。

### 7. 决策记录（ADR）

- 位置：`docs/adr/ADR-YYYYMMDD-<topic>.md`；包含：背景、决策、替代方案、影响、回滚方案。
- 必需：框架更换、存储迁移、协议重大兼容策略、第三方对接模式变更。
