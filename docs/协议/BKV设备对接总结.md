# BKV è®¾å¤‡å¯¹æ¥è§„èŒƒ

> æœ€åæ›´æ–°ï¼š2025-10-31  
> åè®®ç‰ˆæœ¬ï¼šç»„ç½‘è®¾å¤‡ 2024(1) - ç« èŠ‚ 2.2.8  
> éªŒè¯è®¾å¤‡ï¼š82241218000382ï¼ˆå•æœºç‰ˆï¼Œæ’åº§å· 0ï¼Œ2 ä¸ªæ’å­”ï¼‰

---

## ä¸€ã€è®¾å¤‡ç±»å‹è¯†åˆ«

| è®¾å¤‡ç±»å‹   | æ’åº§å·    | æ’å­”æ•°      | ç‰¹å¾               |
| ---------- | --------- | ----------- | ------------------ |
| **å•æœºç‰ˆ** | 0ï¼ˆå›ºå®šï¼‰ | 2 ä¸ªï¼ˆ0/1ï¼‰ | å•æœºè®¾å¤‡ï¼Œæ— ç»„ç½‘   |
| ç»„ç½‘ç‰ˆ     | 1-250     | 2 ä¸ª/æ’åº§   | å¤šæ’åº§é€šè¿‡ç½‘å…³ç®¡ç† |

**è¯†åˆ«æ–¹æ³•**ï¼šæµ‹è¯•æ’åº§å· 1â†’ å¤±è´¥åˆ™ä¸ºå•æœºç‰ˆï¼ˆç”¨ 0ï¼‰

---

## äºŒã€åè®®æ ¼å¼ï¼ˆ0x0015 æ§åˆ¶å‘½ä»¤ï¼‰

### 2.0 çŠ¶æ€ä¸ŠæŠ¥ 0x1017 å­—æ®µè§£é‡Š

> ä¸‹è¿°è¡¨æ ¼å¯¹ç”¨æˆ·æä¾›çš„ç¤ºæ„å›¾é€é¡¹è¡¥å……æ–‡å­—è¯´æ˜ï¼Œä¾¿äºåœ¨æ²¡æœ‰å›¾åƒçš„åœºæ™¯ä¸­ä»èƒ½å¿«é€Ÿå®šä½å­—æ®µå«ä¹‰ã€‚

#### é¡¶å±‚çŠ¶æ€ä¸ŠæŠ¥ï¼ˆä¸Šè¡Œï¼‰

| Key  | åç§°                | è¯´æ˜                                                                 |
| ---- | ------------------- | -------------------------------------------------------------------- |
| 0x01 | CMD                 | å›ºå®šä¸º `0x1017`ï¼Œæ ‡è¯†å½“å‰ BKV å­å¸§æ˜¯çŠ¶æ€ä¸ŠæŠ¥                         |
| 0x02 | Request_ID          | è®¾å¤‡ä¾§ä¸»åŠ¨ä¸ŠæŠ¥æ—¶å¸§åºåˆ—å›ºå®šä¸º `0x00`ï¼Œè‹¥æ˜¯åº”ç­”å¸§åˆ™æºå¸¦è¯·æ±‚åºå·         |
| 0x03 | Charge_ID           | ç½‘å…³ç¼–å·ï¼ˆGateway IDï¼‰ï¼Œç”¨æ¥åœ¨å¹³å°ä¾§å®šä½ç‰©ç†è®¾å¤‡                     |
| 0x94 | Socket_Status       | æ’åº§çŠ¶æ€é›†ç¾¤çš„å…¥å£æ ‡è®°ï¼Œåç»­ TLV å­—æ®µæè¿°è¯¥æ’åº§ä¸‹çš„å„ç±»å±æ€§           |

#### 0x94 â€“ æ’åº§å­åè®®å­—æ®µ

| Key  | åç§°          | è¯´æ˜                                                                           |
| ---- | ------------- | ------------------------------------------------------------------------------ |
| 0x4A | NODE_Number   | æ’åº§åºå·ï¼ˆç»„ç½‘åœºæ™¯ä¸­ 1~250ï¼Œå¯¹åº”â€œæ’åº§å·â€ï¼‰                                     |
| 0x3E | FW_version    | å›ºä»¶/è½¯ä»¶ç‰ˆæœ¬ï¼ˆ2 å­—èŠ‚ï¼Œå¤§ç«¯ï¼‰ï¼Œç”¨äºå¯¹é½å‡çº§ç‰ˆæœ¬                                |
| 0x07 | MCU_TEMP      | å•ç‰‡æœºå®æ—¶æ¸©åº¦ï¼Œå•ä½ â„ƒï¼Œä¾¿äºç›‘æ§ç¡¬ä»¶çƒ­çŠ¶æ€                                     |
| 0x96 | Plug_RSSI     | æ— çº¿ä¿¡å·å¼ºåº¦ï¼ˆRSSIï¼‰ï¼Œé€šå¸¸ä¸ºå¸¦ç¬¦å·æ•°ï¼Œç”¨äºè¯„ä¼°ç½‘å…³åˆ°æ’åº§çš„é“¾è·¯è´¨é‡             |
| 0x5B | Plug å±æ€§é›†åˆ | åç»­ç´§è·Ÿä¸€ä¸ªæˆ–å¤šä¸ª â€œæ’å­”å±æ€§â€ å—ï¼Œæ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªç‰©ç†æ’å­”ï¼ˆA/B ç­‰ï¼‰            |

#### 0x5B â€“ æ’å­”å­åè®®å­—æ®µ

| Key  | åç§°            | è¯´æ˜                                                                                                 |
| ---- | --------------- | ---------------------------------------------------------------------------------------------------- |
| 0x08 | PLUG_NUM        | æ’å­”ç¼–å·ï¼Œå•æœºç‰ˆ 0=å·¦/1=å³ï¼Œç»„ç½‘ç‰ˆä¾æ¬¡ç¼–å·                                                           |
| 0x09 | PLUG_Status     | æ’å­”çŠ¶æ€ä½å›¾ï¼Œbit7 åœ¨çº¿ã€bit4 å……ç”µä¸­ç­‰ï¼ˆè¯¦è§ä¸‹æ–‡â€œçŠ¶æ€å­—èŠ‚â€è§£é‡Šï¼‰                                     |
| 0x0A | PLUG_Order      | ä¸šåŠ¡å·ï¼ˆè®¢å•å·ä½ 2 å­—èŠ‚ï¼‰ï¼Œç”¨äºæŠŠçŠ¶æ€/è®¡é‡ç»‘å®šåˆ°å…·ä½“å……ç”µè®¢å•                                         |
| 0x95 | Voltage         | ç”µå‹ï¼Œå•ä½ 0.1Vï¼Œä¾‹å¦‚ `0x08E3=2275` è¡¨ç¤º 227.5V                                                      |
| 0x0B | PLUG_Power      | ç¬æ—¶åŠŸç‡ï¼Œå•ä½ 0.1Wï¼Œä¾‹å¦‚ `0x1000=4096` è¡¨ç¤º 409.6W                                                  |
| 0x0C | PLUG_Current    | ç¬æ—¶ç”µæµï¼Œå•ä½ 0.001Aï¼Œä¾‹å¦‚ `0x1000` è¡¨ç¤º 4.096A                                                     |
| 0x0D | PLUG_Electricity| å……ç”µé‡ï¼Œå•ä½ 0.01kWhï¼Œå¯¹åº”å•æ¬¡å……ç”µè‡ªå¼€å§‹åçš„ç´¯è®¡ç”¨ç”µ                                                 |
| 0x0E | PLUG_ChargedTime| å……ç”µæ—¶é•¿ï¼Œå•ä½åˆ†é’Ÿï¼Œå¸¸ç”¨æ¥åˆ¤æ–­ 5 åˆ†é’Ÿä¸ŠæŠ¥å‘¨æœŸåŠè¶…æ—¶ä¿æŠ¤                                              |

> ğŸ¯ è¿™äº›å­—æ®µå³ä¸º 5 åˆ†é’Ÿå‘¨æœŸæˆ–çŠ¶æ€å˜åŒ–æ—¶å¿…é¡»ä¸ŠæŠ¥çš„æœ€å°é›†åˆï¼Œè§£ææ­£ç¡®åæ–¹å¯é©±åŠ¨ ports è¡¨ã€äº‹ä»¶æ¨é€ä¸ç›‘æ§æŒ‡æ ‡ã€‚

### 2.1 ä¸‹è¡Œæ§åˆ¶

```
æ ¼å¼ï¼š[é•¿åº¦2B][0x07][æ’åº§1B][æ’å­”1B][å¼€å…³1B][æ¨¡å¼1B][æ—¶é•¿2B][ä¸šåŠ¡å·2B]
ç¤ºä¾‹ï¼š0008 07 00 00 01 01 003c 0000
      ^^^^ å‚æ•°é•¿åº¦ï¼ˆä¸å«0x07ï¼‰
           ^^ æ§åˆ¶å‘½ä»¤
              ^^ æ’åº§0ï¼ˆå•æœºç‰ˆï¼‰
                 ^^ æ’å­”0ï¼ˆAå­”ï¼‰/01ï¼ˆBå­”ï¼‰
                    ^^ å¼€å…³ï¼š1=å¼€,0=å…³
                       ^^ æ¨¡å¼ï¼š1=æŒ‰æ—¶é•¿,0=æŒ‰ç”µé‡
                          ^^^^ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
                               ^^^^ ä¸šåŠ¡å·
```

**å…³é”®ç‚¹**ï¼š

- é•¿åº¦ = å‚æ•°å­—èŠ‚æ•°ï¼ˆ**ä¸å« 0x07 å‘½ä»¤å­—èŠ‚**ï¼‰
- å•æœºç‰ˆæ’åº§å·**å¿…é¡»ä¸º 0**
- API ç«¯å£ â†’ åè®®æ’å­”ï¼šport1â†’0, port2â†’1

### 2.2 è®¾å¤‡ ACK

```
æ ¼å¼ï¼š[é•¿åº¦2B][0x07][ç»“æœ1B][æ’åº§1B][æ’å­”1B][ä¸šåŠ¡å·2B]
ç¤ºä¾‹ï¼š0005 07 01 00 00 0001
           ^^ ^^ ^^ ^^
           |  |  |  â””â”€ æ’å­”å·
           |  |  â””â”€â”€â”€â”€ æ’åº§å·
           |  â””â”€â”€â”€â”€â”€â”€â”€ ç»“æœï¼š01=æˆåŠŸ,00=å¤±è´¥
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ§åˆ¶å‘½ä»¤
```

**è§£æé¡ºåº**ï¼š`inner[1]=result, inner[2]=socketNo, inner[3]=portNo`

### 2.3 å……ç”µä¸ŠæŠ¥ï¼ˆ0x02ï¼‰

```
æ ¼å¼ï¼š[é•¿åº¦2B][0x02][æ’åº§1B][ç‰ˆæœ¬2B][æ¸©åº¦1B][RSSI1B][æ’å­”1B][çŠ¶æ€1B][ä¸šåŠ¡å·2B][åŠŸç‡2B][ç”µæµ2B][ç”¨ç”µé‡2B][æ—¶é•¿2B]
ç¤ºä¾‹ï¼š0011 02 00 0000 00 00 01 98 0001 0000 0000 0050 002d
      ^^^^ 17å­—èŠ‚
              ^^ æ’å­”å·
                       ^^ çŠ¶æ€å­—èŠ‚ï¼ˆbitè§£æè§ä¸‹ï¼‰
                                 ^^^^ åŠŸç‡ï¼ˆ0.1Wï¼‰
                                      ^^^^ ç”µæµï¼ˆ0.001Aï¼‰
                                           ^^^^ ç”¨ç”µé‡ï¼ˆ0.01kWhï¼‰
                                                ^^^^ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
```

**çŠ¶æ€å­—èŠ‚**ï¼ˆ8bitï¼‰ï¼š

```
bit7: åœ¨çº¿ | bit6: é¢„ç•™ | bit5: è®¡é‡æ­£å¸¸ | bit4: å……ç”µä¸­
bit3: ç©ºè½½ | bit2: æ¸©åº¦æ­£å¸¸ | bit1: ç”µæµæ­£å¸¸ | bit0: åŠŸç‡æ­£å¸¸
```

**ä¸ŠæŠ¥æ—¶æœº**ï¼šå……ç”µç»“æŸ/å‘¨æœŸ 5 åˆ†é’Ÿ/çŠ¶æ€å˜åŒ–

---

## ä¸‰ã€ä»£ç å®ç°è¦ç‚¹

### 3.1 æ’åº§å·è®¾ç½®ï¼ˆ`internal/api/thirdparty_handler.go`ï¼‰

```go
// å•æœºç‰ˆè®¾å¤‡å¿…é¡»ç”¨æ’åº§å·0
socketNo := uint8(0)

// ç”Ÿæˆæ§åˆ¶payload
innerPayload := h.encodeStartControlPayload(socketNo, mapped, ...)

// é•¿åº¦å­—æ®µ = å‚æ•°å­—èŠ‚æ•°ï¼ˆä¸å«0x07ï¼‰
paramLen := len(innerPayload) - 1
payload[0] = byte(paramLen >> 8)
payload[1] = byte(paramLen)
copy(payload[2:], innerPayload)
```

### 3.2 ACK è§£æï¼ˆ`internal/protocol/bkv/handlers.go`ï¼‰

```go
// ä¸¥æ ¼æŒ‰åè®®é¡ºåºè§£æ
result := inner[1]     // 01=æˆåŠŸ, 00=å¤±è´¥
socketNo := inner[2]   // æ’åº§å·
portNo := inner[3]     // æ’å­”å·ï¼š0=Aå­”,1=Bå­”
businessNo := uint16(inner[4]) // ä¸šåŠ¡å·ä½å­—èŠ‚

// åè®®æ’å­”å·â†’APIç«¯å£å·
apiPortNo := int(portNo) + 1  // æ’å­”0â†’ç«¯å£1, æ’å­”1â†’ç«¯å£2
```

### 3.3 å……ç”µä¸ŠæŠ¥å¤„ç†

```go
// è§£æå……ç”µæ•°æ®
power := int(f.Data[12])<<8 | int(f.Data[13])    // 0.1W
current := int(f.Data[14])<<8 | int(f.Data[15])  // 0.001A
energy := int(f.Data[16])<<8 | int(f.Data[17])   // 0.01kWh
duration := int(f.Data[18])<<8 | int(f.Data[19]) // åˆ†é’Ÿ
status := f.Data[9] // çŠ¶æ€å­—èŠ‚

// Metricsé‡‡é›†ï¼ˆå¯é€‰ï¼‰
if h.Metrics != nil {
    deviceID := fmt.Sprintf("%d", devID)
    portNo := fmt.Sprintf("%d", apiPortNo)
    h.Metrics.GetChargeReportPowerGauge().WithLabelValues(deviceID, portNo).Set(float64(power) / 10.0)
    // ... å…¶ä»–æŒ‡æ ‡
}
```

---

## å››ã€æµ‹è¯•ç”¨ä¾‹

### ç«¯å£ 1 å……ç”µæµç¨‹ï¼ˆ12:00:50ï¼‰

```
1. APIè¯·æ±‚ï¼šPOST /api/v1/charge/start {port_no:1}
2. ä¸‹è¡Œå¸§ï¼š  00080700000101003c0000 ï¼ˆæ’åº§0+æ’å­”0ï¼‰
3. è®¾å¤‡ACKï¼š 0005070100000001 ï¼ˆæˆåŠŸï¼‰
4. è¯­éŸ³æ’­æŠ¥ï¼š"å·¦è¾¹æ’å­”å·²æ‰“å¼€"
5. åœæ­¢å‘½ä»¤ï¼š00080700000001000000 ï¼ˆå¼€å…³=0ï¼‰
6. åœæ­¢ACKï¼š 0005070100000000 ï¼ˆæˆåŠŸï¼‰
7. å……ç”µä¸ŠæŠ¥ï¼š0011020000000000... ï¼ˆçŠ¶æ€æ¢å¤ç©ºé—²ï¼‰
```

### ç«¯å£ 2 å……ç”µæµç¨‹ï¼ˆ12:02:08ï¼‰

```
1. APIè¯·æ±‚ï¼šPOST /api/v1/charge/start {port_no:2}
2. ä¸‹è¡Œå¸§ï¼š  00080700010101003c0000 ï¼ˆæ’åº§0+æ’å­”1ï¼‰
3. è®¾å¤‡ACKï¼š 0005070100010001 ï¼ˆæˆåŠŸï¼‰
4. è¯­éŸ³æ’­æŠ¥ï¼š"å³è¾¹æ’å­”å·²æ‰“å¼€" â†’ "å³è¾¹æ’å­”å·²æ’å…¥"
5. åœæ­¢å‘½ä»¤ï¼š00080700010001000000
6. åœæ­¢ACKï¼š 0005070100010000 ï¼ˆæˆåŠŸï¼‰
7. å……ç”µä¸ŠæŠ¥ï¼šç«¯å£2çŠ¶æ€=01ï¼ˆæ›¾å……ç”µï¼‰
```

**è®¢å•çŠ¶æ€æµè½¬**ï¼š`pending â†’ charging â†’ cancelled`

---

## äº”ã€æ•…éšœæ’æŸ¥

| é—®é¢˜               | æ£€æŸ¥é¡¹   | è§£å†³æ–¹æ³•                |
| ------------------ | -------- | ----------------------- |
| ACK è¿”å›å¤±è´¥ï¼ˆ00ï¼‰ | æ’åº§å·   | å•æœºç‰ˆå¿…é¡»ç”¨ 0          |
|                    | é•¿åº¦å­—æ®µ | å‚æ•°å­—èŠ‚æ•°ï¼ˆä¸å« 0x07ï¼‰ |
|                    | æ’å­”å·   | å¿…é¡»ä¸º 0 æˆ– 1           |
| è®¢å•å¡ pending     | è®¾å¤‡åœ¨çº¿ | æ£€æŸ¥ Redis ä¼šè¯         |
|                    | ä¸‹è¡Œé˜Ÿåˆ— | æŸ¥çœ‹ outbound_queue è¡¨  |
|                    | ACK è§£æ | éªŒè¯ result å­—æ®µå¤„ç†    |
| è®¾å¤‡æ— å“åº”         | TCP è¿æ¥ | æ£€æŸ¥ session çŠ¶æ€       |
|                    | å‘½ä»¤æ ¼å¼ | éªŒè¯åè®®å¤´/æ ¡éªŒå’Œ       |
|                    | é˜Ÿåˆ—å µå¡ | æ£€æŸ¥ Redis é˜Ÿåˆ—         |

---

## å…­ã€ç›‘æ§æŒ‡æ ‡ï¼ˆPrometheusï¼‰

```
# å……ç”µçŠ¶æ€è®¡æ•°
charge_report_total{device_id,port_no,status} counter

# å®æ—¶åŠŸç‡ï¼ˆWï¼‰
charge_report_power_watts{device_id,port_no} gauge

# å®æ—¶ç”µæµï¼ˆAï¼‰
charge_report_current_amperes{device_id,port_no} gauge

# ç´¯è®¡ç”µé‡ï¼ˆWhï¼‰
charge_report_energy_wh_total{device_id,port_no} counter
```

**é‡‡é›†ä½ç½®**ï¼š`internal/protocol/bkv/handlers.go` å……ç”µä¸ŠæŠ¥å¤„ç†å‡½æ•°

---

## ä¸ƒã€ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶                                 | åŠŸèƒ½                     |
| ------------------------------------ | ------------------------ |
| `internal/api/thirdparty_handler.go` | ç¬¬ä¸‰æ–¹ APIï¼Œå……ç”µæ§åˆ¶å…¥å£ |
| `internal/protocol/bkv/handlers.go`  | åè®®å¤„ç†ï¼ŒACK è§£æ       |
| `internal/protocol/bkv/voice.go`     | æ§åˆ¶å‘½ä»¤ç¼–ç              |
| `internal/metrics/metrics.go`        | Prometheus æŒ‡æ ‡å®šä¹‰      |
| `internal/app/bootstrap/app.go`      | ä¾èµ–æ³¨å…¥                 |
| `test/e2e/charge_test.go`            | ç«¯åˆ°ç«¯æµ‹è¯•               |

**åè®®æ–‡æ¡£**ï¼š`docs/åè®®/è®¾å¤‡å¯¹æ¥æŒ‡å¼•-ç»„ç½‘è®¾å¤‡2024(1).txt` ç« èŠ‚ 2.2.8

---

## å››ã€æµ‹è¯•ç”¨ä¾‹

### ç«¯å£ 1 å……ç”µæµç¨‹

```
1. APIè¯·æ±‚ï¼šPOST /api/v1/charge/start {port_no:1}
2. ä¸‹è¡Œå¸§ï¼š  00080700000101003c0000 ï¼ˆæ’åº§0+æ’å­”0ï¼‰
3. è®¾å¤‡ACKï¼š 0005070100000001 ï¼ˆæˆåŠŸï¼‰
4. åœæ­¢å‘½ä»¤ï¼š00080700000001000000 ï¼ˆå¼€å…³=0ï¼‰
5. å……ç”µä¸ŠæŠ¥ï¼š0011020000000000... ï¼ˆçŠ¶æ€æ¢å¤ç©ºé—²ï¼‰
```

### ç«¯å£ 2 å……ç”µæµç¨‹

```
1. APIè¯·æ±‚ï¼šPOST /api/v1/charge/start {port_no:2}
2. ä¸‹è¡Œå¸§ï¼š  00080700010101003c0000 ï¼ˆæ’åº§0+æ’å­”1ï¼‰
3. è®¾å¤‡ACKï¼š 0005070100010001 ï¼ˆæˆåŠŸï¼‰
4. åœæ­¢å‘½ä»¤ï¼š00080700010001000000
5. å……ç”µä¸ŠæŠ¥ï¼šç«¯å£2çŠ¶æ€=01ï¼ˆæ›¾å……ç”µï¼‰
```

---

## äº”ã€æ•…éšœæ’æŸ¥

| é—®é¢˜               | æ£€æŸ¥é¡¹   | è§£å†³æ–¹æ³•                |
| ------------------ | -------- | ----------------------- |
| ACK è¿”å›å¤±è´¥ï¼ˆ00ï¼‰ | æ’åº§å·   | å•æœºç‰ˆå¿…é¡»ç”¨ 0          |
|                    | é•¿åº¦å­—æ®µ | å‚æ•°å­—èŠ‚æ•°ï¼ˆä¸å« 0x07ï¼‰ |
|                    | æ’å­”å·   | å¿…é¡»ä¸º 0 æˆ– 1           |
| è®¢å•å¡ pending     | è®¾å¤‡åœ¨çº¿ | æ£€æŸ¥ Redis ä¼šè¯         |
|                    | ä¸‹è¡Œé˜Ÿåˆ— | æŸ¥çœ‹ outbound_queue è¡¨  |
|                    | ACK è§£æ | éªŒè¯ result å­—æ®µå¤„ç†    |
| è®¾å¤‡æ— å“åº”         | TCP è¿æ¥ | æ£€æŸ¥ session çŠ¶æ€       |
|                    | å‘½ä»¤æ ¼å¼ | éªŒè¯åè®®å¤´/æ ¡éªŒå’Œ       |
|                    | é˜Ÿåˆ—å µå¡ | æ£€æŸ¥ Redis é˜Ÿåˆ—         |

---
