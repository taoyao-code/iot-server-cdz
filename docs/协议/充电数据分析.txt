╰ go run ./minimal_bkv_service.go
2025/11/22 22:03:30 已加载组网配置: 信道=1, 插座数量=1
2025/11/22 22:03:30.152613 BKV 最小协议测试服务启动，监听地址: :7065
2025/11/22 22:03:30.152967 自动下发充电控制命令: true
2025/11/22 22:03:34.826458 新连接: 127.0.0.1:59695
2025/11/22 22:03:36.627556 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:03:36.628907 [TX] 127.0.0.1:59695 cmd=0x0005 msgID=6921c2b8 gateway=82241218000382 len=32 raw=fcff001c00056921c2b80082241218000382000808010185412180088984fcee
2025/11/22 22:03:36.628972 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222033640fcee
2025/11/22 22:03:36.671734 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:03:36.671784 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222033640fcee
2025/11/22 22:03:40.055409 [RX] 127.0.0.1:59695 cmd=0x0005 msgID=6921c2b8 gateway=82241218000382 len=25 raw=fcfe001500056921c2b80182241218000382000108017efcee
2025/11/22 22:03:40.055473 收到组网刷新ACK(127.0.0.1:59695)
2025/11/22 22:03:40.055531 [TX] 127.0.0.1:59695 cmd=0x0015 msgID=6921c2bc gateway=82241218000382 len=25 raw=fcff001500156921c2bc008224121800038200011d01a6fcee
2025/11/22 22:03:40.065160 [RX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=149 raw=fcfe0091100000000000018224121800038204010110170a010200000000000000000901038224121800038265019403014a0104013effff0301071d0301961e28015b030108000301098004010a000004019508f904010b000204010c000204010d000004010e000028015b030108010301098004010a000004019508f904010b000104010c000104010d000004010e00001efcee
2025/11/22 22:03:40.065280 [TX] 127.0.0.1:59695 cmd=0x0015 msgID=6921c2bc gateway=82241218000382 len=32 raw=fcff001c00156921c2bc00822412180003820008070100010100010001a2fcee
2025/11/22 22:03:40.065317 [TX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=51 raw=fcff002f100000000000008224121800038204010110170a010200000000000000000901038224121800038203010f0144fcee
2025/11/22 22:03:40.272837 [RX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=149 raw=fcfe0091100000000000018224121800038204010110170a010200000000000000000901038224121800038265019403014a0104013effff0301071d0301961e28015b030108000301098004010a000004019508f704010b000104010c000204010d000004010e000028015b030108010301098004010a000004019508f704010b000104010c000104010d000004010e000019fcee
2025/11/22 22:03:40.272925 [TX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=51 raw=fcff002f100000000000008224121800038204010110170a010200000000000000000901038224121800038203010f0144fcee
2025/11/22 22:03:41.111140 [RX] 127.0.0.1:59695 cmd=0x0015 msgID=6921c2bc gateway=82241218000382 len=29 raw=fcfe001900156921c2bc01822412180003820005070101000009a3fcee
2025/11/22 22:03:41.587158 [RX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=149 raw=fcfe0091100000000000018224121800038204010110170a010200000000000000000901038224121800038265019403014a0104013effff0301071d0301961e28015b030108000301099004010a000904019508f704010b000404010c002a04010d000004010e000028015b030108010301098004010a000004019508f704010b000104010c000104010d000004010e00005dfcee
2025/11/22 22:03:41.587239 [TX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=51 raw=fcff002f100000000000008224121800038204010110170a010200000000000000000901038224121800038203010f0144fcee
2025/11/22 22:03:44.347184 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:03:44.347233 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222203444efcee
2025/11/22 22:04:40.376693 [RX] 127.0.0.1:59695 cmd=0x0015 msgID=00000000 gateway=82241218000382 len=41 raw=fcfe0025001500000000018224121800038200110201ffff1d1e00b00009019401590000000186fcee
2025/11/22 22:04:40.376752 [TX] 127.0.0.1:59695 cmd=0x0015 msgID=00000000 gateway=82241218000382 len=26 raw=fcff0016001500000000008224121800038200020c010190fcee
2025/11/22 22:04:41.463143 [RX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=149 raw=fcfe0091100000000000018224121800038204010110170a010200000000000000000901038224121800038265019403014a0104013effff0301071d0301961e28015b030108000301098004010a000004019508f904010b001104010c003804010d000004010e000028015b030108010301098004010a000004019508f904010b000104010c000104010d000004010e000063fcee
2025/11/22 22:04:41.463186 [TX] 127.0.0.1:59695 cmd=0x1000 msgID=00000000 gateway=82241218000382 len=51 raw=fcff002f100000000000008224121800038204010110170a010200000000000000000901038224121800038203010f0144fcee
2025/11/22 22:04:44.251521 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:04:44.251771 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222204444ffcee
2025/11/22 22:05:44.082735 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:05:44.082797 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222054450fcee
2025/11/22 22:06:43.880896 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:06:43.881038 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222064350fcee
2025/11/22 22:07:43.962206 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:07:43.962328 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222074351fcee
2025/11/22 22:08:43.669089 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:08:43.669225 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222084352fcee
2025/11/22 22:09:43.575025 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:09:43.575120 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222094353fcee
2025/11/22 22:10:45.221536 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:10:45.221648 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222210455cfcee
2025/11/22 22:11:45.127381 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:11:45.127519 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222211455dfcee
2025/11/22 22:12:43.041618 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:12:43.041736 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222212435cfcee
2025/11/22 22:13:42.889534 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:13:42.889669 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222213425cfcee
2025/11/22 22:14:42.792076 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:14:42.792173 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222214425dfcee
2025/11/22 22:15:42.631136 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:15:42.631226 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222215425efcee
2025/11/22 22:16:42.498539 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:16:42.498664 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222216425ffcee
2025/11/22 22:17:42.404668 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:17:42.404759 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222174260fcee
2025/11/22 22:18:42.170053 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:18:42.170305 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222184261fcee
2025/11/22 22:19:43.858384 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:19:43.858560 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222194363fcee
2025/11/22 22:20:41.839133 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:20:41.839987 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222204168fcee
2025/11/22 22:21:41.676559 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:21:41.676701 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff001800000000000000822412180003822025112222214169fcee
2025/11/22 22:22:41.618581 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:22:41.618702 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222222416afcee
2025/11/22 22:23:41.407984 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:23:41.408274 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222223416bfcee
2025/11/22 22:24:41.255682 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:24:41.255825 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222224416cfcee
2025/11/22 22:25:41.128689 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:25:41.129385 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222225416dfcee
2025/11/22 22:26:41.140185 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:26:41.140278 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222226416efcee
2025/11/22 22:27:40.838124 [RX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=50 raw=fcfe002e000000000000018224121800038238393836303835353130323444313938383139363230302e312e31371152fcee
2025/11/22 22:27:40.838314 [TX] 127.0.0.1:59695 cmd=0x0000 msgID=00000000 gateway=82241218000382 len=28 raw=fcff00180000000000000082241218000382202511222227406efcee
2025/11/22 22:29:16.783129 读取失败(127.0.0.1:59695): EOF
2025/11/22 22:29:16.783675 连接关闭: 127.0.0.1:59695

================================
一、背景与目标
================================

本文件基于 `minimal_bkv_service.go` 的实际测试日志（见上方原始日志），对“启动充电”完整链路涉及的设备数据、协议报文和主项目落库/缓存状态进行一次端到端梳理，目标是：

1. 明确“充电控制”真正需要的最小数据集；
2. 识别并标记冗余、含糊或从未正确维护的状态字段；
3. 约束“单一真相来源”（Single Source of Truth），避免 DB / 缓存 / 设备之间的状态不一致；
4. 为后续代码简化和 Schema 清理提供依据（遵守 KISS / DRY / YAGNI）。

本分析仅描述当前实现与测试结果，不直接修改数据库结构；任何 Schema 变更需通过 OpenSpec 变更流程单独落地。

================================
二、测试流程数据还原（基于 minimal_bkv_service）
================================

结合上述日志，可以还原一次“组网 + 查询状态 + 启动充电 + 充电过程上报”的关键时序（简化）：

1. 设备上线与心跳
   - `cmd=0x0000` 心跳上报，网关 ID 为物理设备号 `82241218000382`。
   - 平台（测试服务）响应 `cmd=0x0000` 心跳 ACK，并记录当前时间戳。

2. 组网刷新与 ACK
   - 在首次心跳后，测试服务根据 `network_config.json` 下发 `cmd=0x0005` 组网“刷新列表”命令：
     - payload 中包含信道、插座号、MAC 等信息。
   - 设备随后回 `cmd=0x0005` 上行帧，对应 `isNetworkRefreshAck`，表示组网刷新成功。

3. 主动查询插座状态（0x0015/0x1D）
   - 收到组网 ACK 后，测试服务下发一次 `cmd=0x0015`、子命令 `0x1D`（查询插座状态）：
     - 内层 payload 为 `[lenH][lenL][0x1D][socketNo]`。
   - 设备回 `cmd=0x1000 + 0x94 TLV`，其中包含 `SocketStatus`：
     - TLV 0x5B 内是插孔属性，映射到 `PortStatus`（Status 位图、功率、电压、电流等）。

4. 自动下发充电命令
   - 当 `cfg.AutoControl=true`，且：
     - 已收到心跳，且（如配置了组网）已收到组网刷新 ACK，
   - 测试服务在下一次心跳时构造并下发一次充电命令：
     - 按时/按量：`cmd=0x0015` 子命令 `0x07`；
     - 按功率：`cmd=0x0015` 子命令 `0x17`（本日志为 0x17）。
   - 使用 `sentControl/sentPowerControl` 标志保证“只发一次”。

5. 充电过程与结束
   - 期间设备会持续通过 0x94 上报插座电压/功率/电流等状态；
   - 结束时通过 `cmd=0x0015`、子命令 `0x02/0x18` 上报充电结束，平台对该帧解析并结算订单、收敛端口状态。

结论：测试服务里的成功路径高度依赖“心跳 → 组网 ACK → 状态查询（0x1D/0x94）→ 再下发控制”，而不是“直接同步调用下发充电命令”。

================================
三、主项目充电链路与数据落地（简化视图）
================================

1. 启动充电 API（`ThirdPartyHandler.StartCharge`）
   - 校验请求参数（端口号、充电模式、金额等）。
   - `EnsureDevice` 确认设备存在（必要时插入 `devices` 记录）。
   - 通过 `SessionManager.IsOnline(devicePhyID, now)` 判断设备是否在线：
     - 在线性判断以 Redis 会话为真相源。
   - 清理超时 pending 订单（>5 分钟自动取消）。
   - P1-4：`verifyPortStatus` 检查端口状态是否与 DB 一致（避免端口已在充电却创建新订单）。
   - P1-3：事务 + 行锁保证：
     - 无其他活跃订单占用同一端口；
     - `ports` 表中的端口状态可用。
   - 创建 pending 订单（`orders.status=0`），生成 `order_no` / `business_no`。
   - 入队 BKV 下行控制命令（0x0015/0x07 或 0x17）到 `outbound_queue`。
   - 主动入队一次插座状态查询命令（0x001D），由协议栈统一解析并写回 `ports.status`。
   - 调用 `waitForDeviceReady`：
     - 在 5 秒内轮询 `ports.status`，直到端口从“空载”过渡到“可充电/充电中”或超时。

2. 设备上行数据如何写入 DB
   - 心跳/状态上报（0x94）：
     - `HandleSocketStateReport` / `HandleSocketStateResponse` 解析 `SocketStatus` → `PortStatus`；
     - 使用 `Repo.UpsertPortState` 落库到 `ports.status`（BKV 位图）与 `ports.power_w`。
     - `EnsureDevice` 同步刷新 `devices.last_seen_at`。
   - 控制 ACK / 充电开始：
     - `HandleControl` 解析 `cmd=0x0015` 上行 ACK，更新订单状态（pending → charging），并同步 `ports.status` 为充电中位图。
   - 充电结束/对账：
     - `HandleChargingEnd` / `HandleControl` 解析充电结束上报，调用 `SettleOrder` 结算订单；
     - 将端口状态收敛为 idle（`0x09` = 在线 + 空载）。
   - 后台一致性任务：
     - `PortStatusSyncer` 定期检查“订单状态 ↔ 端口状态”是否一致，并自动收敛异常状态；
     - 依赖 `SessionManager.IsOnline` 与 `devices.last_seen_at` 做离线判断。

3. 会话与缓存
   - 会话层（Redis）：
     - `SessionManager` 保存连接信息和心跳时间，用于实时在线判断。
   - DB 中的 `last_seen_at`：
     - 由协议处理层更新，作为“最近心跳时间”的持久化快照。
   - OpenSpec 规范（consistency-lifecycle）明确：
     - “设备在线状态：以 SessionManager 为准，DB 视为缓存。”

================================
四、持久化状态与缓存：逐项分析
================================

这里按“设备 / 端口 / 订单 / 队列与日志 / 会话”划分，分析哪些数据是必须的，哪些存在冗余或语义不清。

----------------------------
4.1 设备级（devices 表）
----------------------------

当前字段（与充电控制相关）：

- `phy_id`：设备物理 ID，必须，所有协议和 API 的主键。
- `last_seen_at`：最后一次心跳时间：
  - 由协议栈在接收到心跳/状态上报时更新；
  - 用于 API 显示、离线诊断和后台任务过滤（“最近 60 秒在线设备”等）；
  - 与 Redis 会话中的在线状态有弱一致关系（DB 为持久化快照）。

结论：

- `phy_id`、`last_seen_at`：必须保留；
- 设备在线状态不再单独存储在 devices 表的布尔列中：
  - 真相源为 `SessionManager.IsOnline`；
  - DB 仅通过 `last_seen_at` 提供弱一致缓存；
  - 早期的布尔在线字段已通过 Schema 变更清理，避免产生误导。

----------------------------
4.2 端口级（ports 表）
----------------------------

字段：

- `device_id` + `port_no`：联合主键，标识物理端口，必须存在。
- `status`（INT）：
  - 存的是 BKV 位图，而不是业务枚举；
  - 统一约定（与 `PortStatus` 一致）：
    - `bit7 (0x80)`：充电中；
    - `bit3 (0x08)`：空载/空闲；
    - `bit0 (0x01)`：在线；
  - 常见状态：
    - `0x81`：在线+充电中；
    - `0x09`：在线+空载（空闲）；
    - `0x00`：离线或故障占位。
  - 来源：
    - 0x94 插座状态上报；
    - 0x001D 查询响应；
    - 控制 ACK / 充电结束上报 / 后台自愈逻辑。
- `power_w`（INT，可空）：
  - 记录当前功率（瓦），从协议中的 0.1W / 0.01kWh 等字段换算而来；
  - 主要用于监控指标和诊断（如 `charge_report_power_watts`）。

结论：

- `status`：是“端口侧单一真相”的快照，必须保留；
  - 等价于 minimal_bkv_service 中从 0x94 解析出的 `PortStatus.Status`；
  - 不建议再引入额外“端口是否充电中”等冗余列。
- `power_w`：
  - 不是状态机的一部分，而是观测值；
  - 没有其它位置重复存储，因此不构成一致性问题；
  - 可视需求保留，未来如无消费场景可以考虑删除，但当前属于“有用但非关键”数据。

----------------------------
4.3 订单级（orders 表）
----------------------------

与充电控制强相关的字段：

- `device_id` / `port_no`：绑定设备与端口；
- `order_no`：平台订单号；
- `business_no`：BKV 协议业务号，作为设备侧业务关联键；
- `status`：订单状态机：
  - pending / confirmed / charging / stopping / cancelling / interrupted / completed / failed 等；
  - 是业务真相源，端口状态需要与之在 30–60s 内收敛一致；
- `start_time` / `end_time` / `kwh_0p01` / `amount_cent` / `end_reason`：
  - 用于结算、对账和第三方推送；
  - 无明显冗余。

结论：

- 订单状态机与业务对账绑定，当前字段均为必要业务数据；
- 不存在“两个字段描述同一状态”的明显冗余；
- 一致性问题主要体现在：
  - `orders.status` 与 `ports.status` 有可能临时不一致（通过 PortStatusSyncer 和 OrderMonitor 收敛）。

----------------------------
4.4 队列与日志（outbound_queue / cmd_log）
----------------------------

- `outbound_queue`：
  - 存储下行命令（cmd、payload、超时、重试计数等）；
  - 每条记录对应一次 BKV 控制命令，状态独立于订单/端口；
  - 是实现“至少一次下发 + 失败重试”的基础组件，不是冗余状态。
- `cmd_log`：
  - 记录上/下行帧及解析结果（success/err_code/duration_ms 等）；
  - 用于诊断和历史追踪；
  - 与业务状态存在明显语义差异（“一次帧处理是否成功” vs “订单是否成功”），不构成冗余。

结论：

- outbound_queue / cmd_log 是事务外侧的“过程日志”，虽然从业务上是冗余信息，但在运维和排障上价值极高；
- 不建议删除，仅需保证它们不被业务逻辑视为“真相源”即可（即不会仅凭 cmd_log 推导业务状态）。

----------------------------
4.5 会话缓存（SessionManager / Redis）
----------------------------

- `SessionManager`（Redis）：
  - 维护 TCP 连接与最近心跳时间；
  - 提供 `IsOnline` / `IsOnlineWeighted` 等接口；
  - OpenSpec 已明确：设备在线状态以 SessionManager 为单一真相源。
- DB 中的 `last_seen_at`：
  - 仅作为“已知最近在线时间”的持久化快照；
  - 是 Session 状态的冗余缓存，但属于“有用缓存”，用于：
    - 后台任务过滤（最近 N 分钟在线设备）；
    - 历史数据查询与诊断。

结论：

- 对“在线状态”而言：
  - 真相源：SessionManager；
  - DB：`last_seen_at` 为有用缓存，额外的布尔在线字段已在 Schema 层清理，不再参与在线状态判断。

================================
五、冗余 / 含糊数据与代码清单（建议清理）
================================

1. 冗余在线状态字段（已清理）
   - 问题（历史）：
     - 早期在 devices 表中引入过布尔在线列，设计上是“在线状态持久化”，但生产路径不更新；
     - 与 SessionManager / `last_seen_at` 语义重叠，且数值不可信；
     - 曾导致部分测试脚本直接更新该字段，但这些更新不会影响真正的在线判断。
   - 现状：
     - 相关布尔在线字段已在 Schema 变更中删除；
     - 业务侧统一依赖 `SessionManager.IsOnline` + `last_seen_at` 进行在线判断；
     - 禁止新增任何类似的冗余在线状态列。

2. 端口状态的多重表示（需要保持一套标准）
   - 当前标准：
     - BKV 位图（0x80/0x08/0x01）→ `ports.status`；
     - 0/1/2 业务枚举仅存在于 `SocketStateResponse.Status`，在 `HandleSocketStateResponse` 中即时映射为位图。
   - 风险：
     - 旧代码如果直接以 0/1/2 判定 `ports.status`，会出现严重误判；
     - 任意新代码若自行解读 `status`，应统一使用位图含义。
   - 建议：
     - 所有“端口是否充电中/空闲/在线”的判断，必须使用位图规则（bit7/bit3/bit0）；
     - 如果发现存在“status==2 表示充电”的旧逻辑，应统一删除或改写为位图解析。

3. 未使用或长期 TODO 的同步逻辑
   - 示例：`syncPortStatusPeriodic` 当前仅包含 TODO 注释，尚未被调度；
   - 鉴于已有 PortStatusSyncer + 一致性规范：
     - 如果未来不打算实现额外的周期任务，应在代码中明确删除或转为文档设计，而不是保留空实现；
     - 若确有规划，应在 OpenSpec 中补充对应的能力描述和任务列表。

总结原则：

- 只保留“一处真相源 + 必要缓存”，保证：
  - 在线状态：SessionManager（真相） + `last_seen_at`（缓存）；
  - 端口状态：`ports.status`（真相）；
  - 订单状态：`orders.status`（真相），与端口状态在 30–60s 内收敛。
- 任何未被明确维护、或在规范中未出现的状态字段（如早期 devices 表上的布尔在线列）都应视为清理候选。

================================
六、最小必要数据集（面向充电控制）
================================

在不牺牲对账与诊断能力的前提下，结合当前测试流程与实际实现，充电控制相关的“最小必要持久化数据”可以抽象为：

1. 设备层：
   - `devices.phy_id`
   - `devices.last_seen_at`

2. 端口层：
   - `ports.device_id`
   - `ports.port_no`
   - `ports.status`（BKV 位图）
   - `ports.power_w`（可选，但对监控有价值）

3. 订单层：
   - `orders.device_id` / `orders.port_no`
   - `orders.order_no` / `orders.business_no`
   - `orders.status`
   - `orders.start_time` / `orders.end_time`
   - `orders.kwh_0p01` / `orders.amount_cent`
   - `orders.end_reason` / `orders.charge_mode`
   - `orders.failure_reason`（可选，但有助于错误诊断）

4. 队列与日志：
   - `outbound_queue`：保证控制命令可靠下发；
   - `cmd_log`：保存完整的协议交互轨迹，便于复盘。

其它状态（如早期的布尔在线字段、临时中间状态标志位等）如果既不参与业务决策，也不用于一致性自愈，且无法保证被持续维护，应优先考虑删除或降级为纯日志字段。

================================
七、状态不一致风险与缓解策略（概览）
================================

1. 设备在线状态不一致
   - 风险来源：
     - SessionManager 与 DB 字段（尤其是早期的布尔在线列）观测结果不同；
   - 当前策略：
     - 所有业务决策统一调用 `SessionManager.IsOnline`；
     - `last_seen_at` 仅作显示与诊断；
     - 建议：彻底停止依赖任何额外布尔在线字段，从代码层面统一移除或避免新增。

2. 端口状态与订单状态不一致
   - 风险场景：
     - 设备充电结束上报丢失；
     - 控制 ACK 丢失或延迟；
     - 订单状态更新成功但端口状态未更新，反之亦然。
   - 当前收敛机制：
     - 协议处理层在关键事件（ACK、结束上报）中同步更新 `ports.status`；
     - PortStatusSyncer 周期检查并调用 `FinalizeOrderAndPort` 收敛异常；
     - fallback 停止逻辑中通过 0x001D 查询 + 短轮询观察端口状态变化。

3. 主项目与测试协议行为不一致
   - 测试服务：严格“心跳 → 组网 ACK → 状态查询 → 控制”；
   - 主项目：最初直接下发控制，现在通过：
     - `SessionManager.IsOnline` 保证在线；
     - `verifyPortStatus` + `waitForDeviceReady` 保证端口状态已从“空载/未准备好”过渡到可充电状态；
   - 结论：
     - 通过端口状态轮询与查询命令，主项目已经在行为上向测试服务对齐；
     - 已在数据层面清理冗余在线字段，让所有状态判断只依赖上述“最小必要数据集”。

以上分析为后续代码和 Schema 简化提供了边界：在不破坏现有 P0/P1 修复和一致性策略的前提下，可以安全删除的冗余数据仅限于那些“未维护、未使用或语义不明”的字段和代码分支，其余持久化状态与缓存应以单一真相原则进行约束，而不是简单移除。 
