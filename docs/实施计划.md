## IoT 平台实施计划（PG 方案）

### 目录

- 1. 里程碑与时间
- 2. 交付物
- 3. 任务分解（模块实施清单）
- 4. 验收标准
- 5. 风险与缓解

### 1. 里程碑与时间

- M0（5-7天，纵切验证）：
  - TCP 网关（net）+ AP3000 最小闭环（20/21/22/82/03/06）
  - PG 建表与迁移（设备/端口快照、订单、事件、指令日志、outbound_queue）
  - REST 查询（在线设备/订单详情）+ 指标（连接数、解析失败率、82 成功率、p99）
  - 回放最小样例集（文档样例→hex）与 k6 冒烟
- M1（3-5天，扩展能力）：
  - 接入 BKV（fcfe/fcff）与结束原因推导；83/84/85 最小子集
  - 下行 WAL 完整（节流0.5s/超时15s/一次重发/幂等键）与冷启续发
  - 第三方对接入口（Webhook 验证/限频）与观测告警阈值固化
- M2（后续1-2周）：升级通道（E0/F8）、回放工具完善、压测与SLO验收、运维手册
- Tx（并行）：技术栈治理落地（中心文档、配置清单、ADR）。

### 2. 交付物

- 运行服务（/healthz,/readyz,/metrics）；OpenAPI 文档；PG 迁移脚本；压测报告与SLO达成记录；运维手册。
- 协议回放样例与说明；BKV 运行期原因映射字典占位（configs/bkv-reason-map.example.yaml）。

### 3. 任务分解（模块实施清单）

- 仓库初始化
  - 建立 `cmd/server`、`internal/*`、`pkg/*`、`db/migrations`、`configs`；接入 Viper、zap、Prom、pprof；环境配置模板。
  - 验收：服务可启动；`/healthz`、`/readyz`、`/metrics` 正常；日志/配置生效。
- 数据库
  - 生成核心表 DDL 与日分区模板；建立必要索引；初始化角色/权限；连接池策略（pgx+pgbouncer）。
  - 验收：迁移可重复执行；分区创建脚本通过；写入基准 COPY ≥10k rows/s（本地）。
- 接入网关
  - 帧状态机（半/粘包）、DNY+小端+校验、消息ID回显；首包 ICCID/link；错误码字典；优先级队列（控制>心跳）。
  - 验收：解析用例（正常/边界/粘包）全过；控制延迟 p99≤200ms；错误码符合约定。
  - 详见：`docs/计划/接入网关.md`
- 协议V1
  - 路由表集中：20/21/22/12；01/21 互斥策略配置化；22/12 请求-应答；心跳入库摘要。
  - 验收：模拟器回放覆盖 20/21/22/12 正常与异常；入库正确；互斥策略正确。
  - 详见：`docs/计划/协议插件.md`
- 会话/限速
  - 三标识绑定与漂移处理；一致性哈希；设备级令牌桶；多信号离线判定（TCP/心跳/ACK）。
  - 验收：离线误判率<0.1%；限速有效抑制突发；路由稳定。
  - 详见：`docs/计划/会话与路由.md`
- 控制与结算
  - 82：单设备队列、0.5s 节流、15s 超时+一次重发、幂等键、FF 智能端口；
  - 03/06：订单闭环入库、功率摘要；重复抑制与乱序容忍。
  - 验收：82 成功率≥99%；闭环成功≥99%；乱序/重发用例通过。
  - 详见：`docs/计划/领域服务.md`
- 参数与升级
  - 83/84/85/86：参数白名单与上下界校验、回读校验；
  - E0/F8：分片窗口、≤3 次重试、失败回滚与记录。
  - 验收：参数读写一致；升级成功率≥95%，失败可回滚。
  - 详见：`docs/计划/领域服务.md`
- 审计与回放
  - HEX 文件落盘与索引；回放工具（筛选/时间窗/设备）；敏感字段脱敏。
  - 验收：回放复现率≥95%；审计可按设备/时段检索。
  - 详见：`docs/计划/管理与观测.md`
- 安全与运维
  - API Key + HMAC 签名；IP/设备白名单；日志脱敏（ICCID/IMEI）；监控指标与阈值；备份与归档策略。
  - 验收：签名校验/时间窗模拟；告警能触发；备份可恢复。
  - 详见：`docs/计划/管理与观测.md`
- 第三方对接
  - 推送：Webhook 签名与重试去重；拉取：REST 查询；控制：第三方→平台的 82/参数/升级入口。
  - 验收：回调服务仿真；签名/重试/幂等验证；批量 82 控制延迟 p99≤200ms。
  - 详见：`docs/计划/第三方对接.md`

- 技术栈治理（新增）
  - 建立 `docs/技术栈治理.md`；补充 `configs/example.yaml`；创建 `docs/adr` 目录与模板。
  - 验收：各模块文档引用中心文档；技术栈表完整；ADR 模板可用。

### 4. 验收标准

- 单实例(4C8G)：≥5k 在线、峰值 ≥500 QPS；p99 ≤200ms；82 成功率≥99%；崩溃后 WAL 续发≥99%。

### 5. 风险与缓解

- DB 写压力：批量写/COPY；分区按日；BRIN/复合索引；VACUUM 策略。
- 队列堆积：优先级与批次分发；退避重试；限速与背压。
- 兼容性：长度/版本分支；01/21 开关；FF 智能端口；异常场景回放集。
