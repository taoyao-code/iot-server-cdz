## IoT 平台实施计划（PG 方案）

### 当前进度（M0 验收纵切）

- 已完成（代码与测试）：接入层/配置/日志/指标；AP3000 最小闭环（20/21/22/12/82/03/06）；BKV 骨架（心跳/状态/结算/ACK/控制/参数占位与原因映射）；会话最小管理+多信号骨架与加权策略；PG 迁移；出站队列与 Worker（冷启扫描/退避重试/dead 清理/节流/协议编码）；只读 HTTP API。

- 文档映射：接入网关/协议插件/持久化-PG 已标注代码路径与配置键；OpenAPI 草案已提交；观测指标与告警建议已补充。

### 偏离检查

- 优先级纠偏：协议优先顺序为 BKV > AP3000，观测与告警并行、但不抢占主线开发时长。

### M1 任务（严格 BKV > AP3000）

1) BKV 控制/参数最小闭环
   - 解析字段细化；参数写入→回读(0x85)成功判定；日志/审计一致；单测覆盖
2) 出站幂等与去重
   - `correlation_id` 约束；重复去重；回放用例验证；冷启续发语义
3) AP3000 参数/升级（延后）
   - 83/84/85 最小子集；E0/F8 升级骨架（分片窗口、≤3重试、失败回滚占位）
4) 会话与观测
   - 加权策略参数调优（`session.weighted.*`）；在线/离线指标固化；PrometheusRule 清单与 Grafana 模板

### 任务分解（节选）

- 协议V1（BKV）
  - 路由表集中；控制/参数解析与最小闭环；原因映射统一
  - 验收：模拟器回放覆盖控制/参数正常与异常；回读校验通过；落库正确
- 出站可靠性
  - 幂等键与去重；重试退避策略参数化；冷启续发
  - 验收：重复去重有效；冷启后续发正确；队列/ACK 指标达标
- AP3000（延后）
  - 参数与升级骨架与最小用例
- 会话/观测
  - 多信号离线判定参数化；面板与告警规则固化
