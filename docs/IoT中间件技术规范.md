# å……ç”µæ¡© IoT ä¸­é—´ä»¶ç³»ç»Ÿ - æŠ€æœ¯è§„èŒƒæ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.3
> **æ›´æ–°æ—¥æœŸ**: 2025-01-10
> **ç³»ç»Ÿå®šä½**: å……ç”µè®¾å¤‡ä¸ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ä¸­é—´ä»¶
> **æ ¸å¿ƒèŒè´£**: è®¾å¤‡ç®¡ç†ã€åè®®é€‚é…ã€çŠ¶æ€åŒæ­¥ã€æŒ‡ä»¤è½¬å‘ã€äº‹ä»¶æ¨é€

## ğŸ“‹ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | å˜æ›´è¯´æ˜                                                                                   |
| ---- | ---------- | ------------------------------------------------------------------------------------------ |
| v2.3 | 2025-01-10 | **è¡¥å……å®Œæ•´å¯¹æ¥è§„èŒƒ**:æ–°å¢å®ç°çŠ¶æ€æ€»è§ˆã€ç¬¬ä¸‰æ–¹APIå®Œæ•´è§„èŒƒã€BKVåè®®è¯¦ç»†è§„èŒƒã€é”™è¯¯ç å®šä¹‰ |
| v2.2 | 2025-01-06 | **ä¿®å¤ P0 çº§ 7 ä¸ªé€»è¾‘æ¼æ´**:ç»Ÿä¸€çŠ¶æ€æµè½¬å®šä¹‰ã€æ—¶é—´é˜ˆå€¼ã€è¡¥å……å…³é”®ä¸šåŠ¡æµç¨‹ã€å®Œå–„ä¸­æ–­æ¢å¤é€»è¾‘ |
| v2.1 | 2025-11-01 | æ–°å¢ 11 ä¸ªæ¼æ´ä¿®å¤æ–¹æ¡ˆã€3 ä¸ªä¸­é—´æ€(cancelling/stopping/interrupted)                        |
| v2.0 | 2024-12-01 | æ‰©å±•è®¢å•çŠ¶æ€æœºã€å®Œå–„å¼‚å¸¸å¤„ç†æµç¨‹                                                           |
| v1.0 | 2024-11-01 | åˆå§‹ç‰ˆæœ¬                                                                                   |

**âš ï¸ é‡è¦æ›´æ–°ï¼ˆv2.3ï¼‰**ï¼š

- âœ… **æ–°å¢å®ç°çŠ¶æ€æ€»è§ˆ**: æ¸…æ™°æ ‡æ³¨å·²å®ç°/å¾…å®ç°åŠŸèƒ½ï¼Œé¢„è®¡å·¥æœŸ
- âœ… **è¡¥å……ç¬¬ä¸‰æ–¹APIå®Œæ•´è§„èŒƒ**: åŒ…å«è®¤è¯ã€æ¥å£å®šä¹‰ã€é”™è¯¯ç ã€Webhookè§„èŒƒ
- âœ… **è¡¥å……BKVåè®®è¯¦ç»†è§„èŒƒ**: å¸§æ ¼å¼ã€å‘½ä»¤å®šä¹‰ã€è¿æ¥æµç¨‹ã€å……ç”µæ§åˆ¶æµç¨‹
- âœ… **ç»Ÿä¸€æ—¶é—´é˜ˆå€¼è¡¨**: æ˜ç¡®æ‰€æœ‰å…³é”®æ—¶é—´å‚æ•°å’Œé…ç½®ä½ç½®
- âœ… **ä¿®å¤æ–‡æ¡£bug**: åˆ é™¤é‡å¤ç« èŠ‚ã€ä¼˜åŒ–ç»“æ„

**âš ï¸ é‡è¦æ›´æ–°ï¼ˆv2.2ï¼‰**ï¼š

- âœ… **ä¿®å¤å†…éƒ¨çŸ›ç›¾**: ç»Ÿä¸€çŠ¶æ€æµè½¬å®šä¹‰(cancelling/stopping è¶…æ—¶ â†’cancelled/stopped,é timeout)
- âœ… **ä¿®å¤æ—¶é—´é˜ˆå€¼ä¸ä¸€è‡´**: æ˜ç¡®åŒºåˆ†è®¾å¤‡åœ¨çº¿é˜ˆå€¼ 60sã€è®¢å• ACK è¶…æ—¶ 10sã€æŒ‡ä»¤æ‰§è¡Œè¶…æ—¶ 30s
- âœ… **è¡¥å……å…³é”®æµç¨‹**: charging çŠ¶æ€å–æ¶ˆé€»è¾‘ã€stopped vs completed ä¼˜å…ˆçº§
- âœ… **å®Œå–„å¹¶å‘æ§åˆ¶**: ç«¯å£å ç”¨æ£€æŸ¥åŒ…å«ä¸­é—´æ€ã€åŒæ—¶é” orders å’Œ device_ports è¡¨
- âœ… **ä¼˜åŒ–åŒæ­¥ç­–ç•¥**: ç§»é™¤åŒæ­¥ç­‰å¾… 5 ç§’çš„æ­»é”è®¾è®¡,æ”¹ä¸ºå¼‚æ­¥è½®è¯¢
- âœ… **å®Œå–„ä¸­æ–­æ¢å¤**: æ˜ç¡®æ¢å¤æ£€æµ‹æ¡ä»¶(è¿ç»­ 3 æ¬¡å¿ƒè·³+ç«¯å£çŠ¶æ€æ­£å¸¸)
- âœ… **ä¿®å¤ç›‘æ§ä»»åŠ¡**: å¢åŠ  updated_at æ£€æŸ¥é¿å…å¹¶å‘å†²çª

**âš ï¸ é‡è¦æ›´æ–°ï¼ˆv2.1ï¼‰**ï¼š

- æ–°å¢è¯†åˆ« **11 ä¸ªå…³é”®é€»è¾‘æ¼æ´**ï¼ˆP0Ã—2, P1Ã—6, P2Ã—3ï¼‰
- å¼•å…¥ä¸­é—´æ€ï¼š`cancelling`, `stopping`, `interrupted`
- å¢åŠ  Outbox äº‹ä»¶æ¨é€æ¨¡å¼
- å®Œå–„ä¼šè¯ç®¡ç†å’Œå¹¶å‘æ§åˆ¶æœºåˆ¶

---

## ğŸ“Š å®ç°çŠ¶æ€æ€»è§ˆï¼ˆv2.3æ›´æ–°ï¼‰

### å·²å®ç°åŠŸèƒ½ âœ…

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® |
|---------|---------|---------|
| **ä¸­é—´æ€æ”¯æŒ** | âœ… å·²å®ç° | `internal/api/thirdparty_handler.go:23-29` |
| â””â”€ OrderStatusCancelling (8) | âœ… | å–æ¶ˆä¸­çŠ¶æ€ |
| â””â”€ OrderStatusStopping (9) | âœ… | åœæ­¢ä¸­çŠ¶æ€ |
| â””â”€ OrderStatusInterrupted (10) | âœ… | ä¸­æ–­çŠ¶æ€ï¼ˆP0-2ï¼‰ |
| **P1é—®é¢˜ä¿®å¤(7/7å®Œæˆ)** | âœ… å·²å®ç° | è¯¦è§P1_COMPLETION_REPORT.md |
| â””â”€ P1-1: å¿ƒè·³è¶…æ—¶60ç§’ | âœ… | `configs/*.yaml`, `internal/app/session_test.go` |
| â””â”€ P1-2: å»¶è¿ŸACKæ‹’ç»ï¼ˆ10ç§’çª—å£ï¼‰ | âœ… | `internal/service/card_service.go` |
| â””â”€ P1-3: ç«¯å£å¹¶å‘å†²çªï¼ˆäº‹åŠ¡+è¡Œé”ï¼‰ | âœ… | `internal/api/thirdparty_handler.go` |
| â””â”€ P1-4: ç«¯å£çŠ¶æ€åŒæ­¥ | âœ… | `internal/app/port_status_syncer.go` |
| â””â”€ P1-5: å–æ¶ˆ/åœæ­¢ä¸­é—´æ€ | âœ… | `internal/api/thirdparty_handler.go` |
| â””â”€ P1-6: é˜Ÿåˆ—ä¼˜å…ˆçº§æ ‡å‡†åŒ– | âœ… | `internal/outbound/priority.go` |
| â””â”€ P1-7: Outboxäº‹ä»¶æ¨é€æ¨¡å¼ | âœ… | `internal/app/event_pusher.go` |
| **äº‹ä»¶æ¨é€æœºåˆ¶** | âœ… å·²å®ç° | `internal/thirdparty/` |
| â””â”€ EventQueue | âœ… | å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ— |
| â””â”€ Pusher | âœ… | Webhookæ¨é€å™¨ |
| â””â”€ Deduper | âœ… | äº‹ä»¶å»é‡ |
| **è®¢å•ç®¡ç†** | âœ… å·²å®ç° | `internal/storage/pg/repo.go` |
| **BKVåè®®è§£æ** | âœ… å·²å®ç° | `internal/protocol/bkv/` |
| **ä¼šè¯ç®¡ç†** | âœ… å·²å®ç° | `internal/session/` |
| **æ­»ä¿¡é˜Ÿåˆ—æ¸…ç†å™¨** | âœ… å·²å®ç° | `internal/app/dead_letter_cleaner.go` |
| **å¡æœåŠ¡** | âœ… å·²å®ç° | `internal/service/card_service.go` |

### ~~å¾…å®ç°/å¾…å®Œå–„åŠŸèƒ½~~ â†’ ä¼˜åŒ–å»ºè®® â³

> **âœ… æ›´æ–°**: æ‰€æœ‰P1çº§åˆ«é—®é¢˜å·²å®Œæˆä¿®å¤ï¼ˆ2025-11-10ï¼‰ï¼Œè¯¦è§ `P1_COMPLETION_REPORT.md`

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|------|
| ~~ğŸ”´ P0-1~~ | ~~è®¾å¤‡ç¦»çº¿å¼ºåˆ¶æ£€æŸ¥~~ | âœ… å·²å®Œæˆ | å·²é›†æˆåˆ°P1-1å¿ƒè·³è¶…æ—¶æ£€æµ‹ |
| ~~ğŸŸ¡ P1-2~~ | ~~å»¶è¿ŸACKæ‹’ç»æœºåˆ¶~~ | âœ… å·²å®Œæˆ | CardServiceå·²å®ç°10ç§’è¶…æ—¶çª—å£ |
| ~~ğŸŸ¡ P1-3~~ | ~~ç«¯å£å¹¶å‘å†²çªè¡Œé”~~ | âœ… å·²å®Œæˆ | ä½¿ç”¨PostgreSQLäº‹åŠ¡+FOR UPDATE |
| ~~ğŸŸ¡ P1-4~~ | ~~ç«¯å£çŠ¶æ€å®æ—¶åŒæ­¥~~ | âœ… å·²å®Œæˆ | PortStatusSynceræ¯5åˆ†é’ŸåŒæ­¥ |
| ~~ğŸŸ¡ P1-6~~ | ~~é˜Ÿåˆ—ä¼˜å…ˆçº§ä¸é™çº§ç­–ç•¥~~ | âœ… å·²å®Œæˆ | 5çº§ä¼˜å…ˆçº§+é˜Ÿåˆ—è¿‡è½½ä¿æŠ¤ |
| ~~ğŸŸ¡ P1-7~~ | ~~Outboxäº‹ä»¶æ¨é€æ¨¡å¼~~ | âœ… å·²å®Œæˆ | EventPusheræ¯10ç§’æ‰¹é‡æ¨é€ |
| ğŸŸ¢ P2-3 | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | â³ å¾…ä¼˜åŒ– | å»ºè®®æ·»åŠ orders(device_id, status)ç´¢å¼• |

**æµ‹è¯•è¦†ç›–ç‡**: 28.9% (ç›®æ ‡: >50%)

### å…³é”®æ—¶é—´é˜ˆå€¼ï¼ˆç»Ÿä¸€è§„èŒƒï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ | é…ç½®ä½ç½® |
|------|---|------|---------|
| **è®¾å¤‡åœ¨çº¿é˜ˆå€¼** | **60ç§’** | last_seenè¶…æ—¶åˆ¤å®šè®¾å¤‡ç¦»çº¿ | `configs/example.yaml` |
| pending â†’ timeout | 10ç§’ | è®¾å¤‡ACKè¶…æ—¶ | è®¢å•ç›‘æ§ä»»åŠ¡ |
| cancelling/stoppingè¶…æ—¶ | 30ç§’ | ä¸­é—´æ€è¶…æ—¶è‡ªåŠ¨æµè½¬ | è®¢å•ç›‘æ§ä»»åŠ¡ |
| interruptedæ¢å¤çª—å£ | 60ç§’ | è®¾å¤‡æ–­çº¿åç­‰å¾…æ¢å¤æ—¶é—´ | è®¢å•ç›‘æ§ä»»åŠ¡ |
| outboundæŒ‡ä»¤è¶…æ—¶ | 30ç§’ | ä¸‹è¡ŒæŒ‡ä»¤å‘é€è¶…æ—¶ | `internal/outbound/` |
| TCP writeè¶…æ—¶ | 5ç§’ | TCPå†™è¶…æ—¶ | `internal/tcpserver/` |

---

## ğŸ“‹ ç›®å½•

- [å®ç°çŠ¶æ€æ€»è§ˆ](#å®ç°çŠ¶æ€æ€»è§ˆv23æ›´æ–°)
- [1. ç³»ç»Ÿå®šä½ä¸æ¶æ„](#1-ç³»ç»Ÿå®šä½ä¸æ¶æ„)
- [2. è®¾å¤‡çŠ¶æ€ç®¡ç†](#2-è®¾å¤‡çŠ¶æ€ç®¡ç†)
- [3. è®¢å•ç”Ÿå‘½å‘¨æœŸ](#3-è®¢å•ç”Ÿå‘½å‘¨æœŸ)
- [4. å®Œæ•´ä¸šåŠ¡æµç¨‹](#4-å®Œæ•´ä¸šåŠ¡æµç¨‹)
  - [4.6 ç¬¬ä¸‰æ–¹APIå®Œæ•´è§„èŒƒ](#46-ç¬¬ä¸‰æ–¹apiå®Œæ•´è§„èŒƒ)
  - [4.7 BKVåè®®è¯¦ç»†è§„èŒƒ](#47-bkvåè®®è¯¦ç»†è§„èŒƒ)
- [5. å¼‚å¸¸åœºæ™¯å¤„ç†](#5-å¼‚å¸¸åœºæ™¯å¤„ç†)
- [6. å…³é”®æ£€æŸ¥ç‚¹ä¸é€»è¾‘æ¼æ´ä¿®å¤](#6-å…³é”®æ£€æŸ¥ç‚¹ä¸é€»è¾‘æ¼æ´ä¿®å¤)
- [7. ç›‘æ§ä¸å‘Šè­¦](#7-ç›‘æ§ä¸å‘Šè­¦)
- [é™„å½•](#é™„å½•)

---

## 1. ç³»ç»Ÿå®šä½ä¸æ¶æ„

### 1.1 ç³»ç»Ÿå®šä½

**æœ¬ç³»ç»Ÿæ˜¯é€šä¿¡ä¸­é—´ä»¶ï¼Œä¸æ˜¯ä¸šåŠ¡ç³»ç»Ÿï¼**

```mermaid
graph LR
    A[ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿ] -->|HTTP API| B[IoTä¸­é—´ä»¶<br/>æœ¬ç³»ç»Ÿ]
    B -->|TCP/BKV| C[å……ç”µè®¾å¤‡]
    A -.è´Ÿè´£.- A1[ç”¨æˆ·è®¤è¯<br/>æ”¯ä»˜æ‰£æ¬¾<br/>è´¦æˆ·ç®¡ç†]
    B -.è´Ÿè´£.- B1[è®¾å¤‡è¿æ¥<br/>åè®®è½¬æ¢<br/>çŠ¶æ€åŒæ­¥]
    C -.è´Ÿè´£.- C1[å……ç”µæ‰§è¡Œ<br/>çŠ¶æ€ä¸ŠæŠ¥<br/>å®æ—¶ç›‘æ§]
```

#### âœ… æœ¬ç³»ç»Ÿè´Ÿè´£

| èŒè´£æ¨¡å—         | å…·ä½“åŠŸèƒ½                                               | å…³é”®ç»„ä»¶                                                 |
| ---------------- | ------------------------------------------------------ | -------------------------------------------------------- |
| **è®¾å¤‡è¿æ¥ç®¡ç†** | TCP é•¿è¿æ¥ç»´æŠ¤ã€å¿ƒè·³æ£€æµ‹ã€ä¼šè¯ç®¡ç†ã€åœ¨çº¿åˆ¤å®š           | `internal/tcpserver/`<br/>`internal/session/`            |
| **åè®®é€‚é…**     | BKV/AP3000 åè®®è§£æã€æŒ‡ä»¤ç¼–ç /è§£ç ã€æ•°æ®æ ¼å¼è½¬æ¢       | `internal/protocol/bkv/`<br/>`internal/protocol/ap3000/` |
| **çŠ¶æ€åŒæ­¥**     | è®¾å¤‡çŠ¶æ€ç»´æŠ¤ã€è®¢å•çŠ¶æ€è¿½è¸ªã€ç«¯å£å ç”¨ç®¡ç†ã€å……ç”µè¿›åº¦ç¼“å­˜ | `internal/storage/pg/`<br/>`internal/session/`           |
| **æŒ‡ä»¤è½¬å‘**     | ä¸‹è¡ŒæŒ‡ä»¤é˜Ÿåˆ—ã€ACK ç¡®è®¤æœºåˆ¶ã€è¶…æ—¶é‡è¯•ã€ç»“æœé€šçŸ¥         | `internal/outbound/`<br/>`internal/gateway/`             |
| **äº‹ä»¶æ¨é€**     | çŠ¶æ€å˜æ›´æ¨é€ã€å¼‚å¸¸äº‹ä»¶é€šçŸ¥ã€å……ç”µè¿›åº¦ä¸ŠæŠ¥               | `internal/thirdparty/`                                   |

#### âŒ æœ¬ç³»ç»Ÿä¸è´Ÿè´£

- âŒ ç”¨æˆ·è´¦æˆ·ç®¡ç†ï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰
- âŒ æ”¯ä»˜ä¸æ‰£æ¬¾ï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰
- âŒ èµ„é‡‘å†»ç»“/é€€æ¬¾ï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰
- âŒ ä¼˜æƒ åˆ¸/æ´»åŠ¨ï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰
- âŒ ç”¨æˆ·ç•Œé¢ï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰
- âŒ ä¸šåŠ¡è§„åˆ™åˆ¶å®šï¼ˆç¬¬ä¸‰æ–¹è´Ÿè´£ï¼‰

> **å…³é”®å‡è®¾**ï¼šç¬¬ä¸‰æ–¹è°ƒç”¨æœ¬ç³»ç»Ÿ API å‰ï¼Œå·²å®Œæˆç”¨æˆ·èº«ä»½éªŒè¯ã€ä½™é¢æ£€æŸ¥ã€é¢„æ‰£æ¬¾ç­‰æ“ä½œã€‚

### 1.2 ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "ç¬¬ä¸‰æ–¹ä¸šåŠ¡ç³»ç»Ÿ"
        TP[ç¬¬ä¸‰æ–¹APIè°ƒç”¨æ–¹<br/>å·²å®Œæˆæ‰£æ¬¾]
    end

    subgraph "IoTä¸­é—´ä»¶ç³»ç»Ÿ æœ¬ç³»ç»Ÿ"
        HTTP[HTTP APIå±‚<br/>internal/api]
        TCP[TCP Server<br/>internal/tcpserver]
        Session[ä¼šè¯ç®¡ç†<br/>internal/session<br/>Redis]
        Queue[ä¸‹è¡Œé˜Ÿåˆ—<br/>internal/outbound<br/>PostgreSQL]
        DB[(PostgreSQL<br/>è®¾å¤‡/è®¢å•/äº‹ä»¶)]
        Push[äº‹ä»¶æ¨é€<br/>internal/thirdparty]
    end

    subgraph "å……ç”µè®¾å¤‡"
        Device[BKVè®¾å¤‡<br/>30ç§’å¿ƒè·³]
    end

    TP -->|1. POST /v1/order/create| HTTP
    HTTP -->|2. æ£€æŸ¥è®¾å¤‡åœ¨çº¿| Session
    Session -->|3. last_seen < 60s?| DB
    HTTP -->|4. åˆ›å»ºè®¢å•| DB
    HTTP -->|5. å…¥é˜ŸæŒ‡ä»¤| Queue
    Queue -->|6. TCPå‘é€| TCP
    TCP -->|7. 0x1011æ§åˆ¶| Device
    Device -->|8. ACK| TCP
    TCP -->|9. æ›´æ–°çŠ¶æ€| DB
    DB -->|10. è§¦å‘æ¨é€| Push
    Push -->|11. POST /callback| TP
```

### 1.3 æ ¸å¿ƒåŸåˆ™

#### ğŸ”´ åŸåˆ™ 1ï¼šè®¾å¤‡çŠ¶æ€ä¼˜å…ˆï¼ˆæœ€é‡è¦ï¼‰

> **ğŸš« è®¾å¤‡ç¦»çº¿æ—¶å¿…é¡»æ‹’ç»åˆ›å»ºè®¢å•**
>
> - è®¾å¤‡ä¸åœ¨çº¿ â†’ æŒ‡ä»¤æ— æ³•ä¸‹å‘ â†’ è®¢å•æ°¸ä¹… pending
> - ç¬¬ä¸‰æ–¹å¯èƒ½å·²æ‰£æ¬¾ï¼Œä½†å……ç”µæ— æ³•å¯åŠ¨
> - ç”¨æˆ·æŠ•è¯‰é£é™©é«˜ï¼Œå½±å“ä¸šåŠ¡ä½“éªŒ

**å…³é”®å®ç°**ï¼š

- åœ¨ `CreateOrder` API ä¸­å¼ºåˆ¶æ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
- åˆ¤å®šé€»è¾‘ï¼š`time.Now() - device.LastSeenAt < 60ç§’`
- ç¦»çº¿æ—¶è¿”å› 503 é”™è¯¯ï¼Œæ˜ç¡®æç¤ºè®¾å¤‡ä¸å¯ç”¨

#### åŸåˆ™ 2ï¼šçŠ¶æ€ä¸€è‡´æ€§

- æœ¬ç³»ç»Ÿç»´æŠ¤çš„è®¾å¤‡/è®¢å•çŠ¶æ€å¿…é¡»ä¸è®¾å¤‡å®é™…çŠ¶æ€ä¸€è‡´
- æ‰€æœ‰çŠ¶æ€å˜æ›´å¿…é¡»æœ‰è®¾å¤‡ ACK ç¡®è®¤
- å»¶è¿Ÿ ACKï¼ˆè¶…è¿‡ 10 ç§’ï¼‰å¿…é¡»è¢«æ‹’ç»ï¼Œé˜²æ­¢çŠ¶æ€æ··ä¹±

#### åŸåˆ™ 3ï¼šå¯é é€šä¿¡

- æŒ‡ä»¤ä¸‹å‘å¿…é¡»æœ‰ ACK ç¡®è®¤ï¼ˆ`internal/outbound/queue.go`ï¼‰
- è¶…æ—¶æœºåˆ¶é˜²æ­¢æ°¸ä¹…ç­‰å¾…ï¼ˆ10 ç§’è¶…æ—¶ï¼‰
- å¹‚ç­‰æ€§æ”¯æŒé‡è¯•ï¼ˆmessage_id å»é‡ï¼‰

#### åŸåˆ™ 4ï¼šå¯è§‚æµ‹æ€§

- æ‰€æœ‰å…³é”®æ“ä½œå¯è¿½è¸ªï¼ˆ`internal/metrics/metrics.go`ï¼‰
- å¼‚å¸¸å¿…é¡»æ¨é€åˆ°ç¬¬ä¸‰æ–¹ï¼ˆ`internal/thirdparty/pusher.go`ï¼‰
- ç›‘æ§æŒ‡æ ‡å®Œæ•´ï¼ˆPrometheusï¼‰

---

## 2. è®¾å¤‡çŠ¶æ€ç®¡ç†

### 2.1 è®¾å¤‡åœ¨çº¿åˆ¤å®š

**åˆ¤å®šé€»è¾‘**ï¼š

- è®¾å¤‡åœ¨çº¿å®šä¹‰ï¼š`device.IsOnline = (time.Now() - device.LastSeenAt) < 60ç§’`
- BKV åè®®ï¼šè®¾å¤‡æ¯ 30 ç§’å‘é€å¿ƒè·³ (0x1007)
- æ”¶åˆ°å¿ƒè·³åæ›´æ–° `last_seen_at` å­—æ®µ

**å…³é”®é…ç½®**ï¼š
| å‚æ•° | å€¼ | è¯´æ˜ |
|-----|---|------|
| å¿ƒè·³å‘¨æœŸ | 30 ç§’ | BKV è®¾å¤‡å¿ƒè·³é—´éš” |
| åœ¨çº¿é˜ˆå€¼ | 30 ç§’ | `last_seen_at < 30ç§’` è§†ä¸ºåœ¨çº¿ |
| æ¨èé˜ˆå€¼ | **60 ç§’** | è€ƒè™‘ç½‘ç»œå»¶è¿Ÿï¼Œå»ºè®®è®¾ä¸ºå¿ƒè·³å‘¨æœŸ \* 2 |

**âœ… P1-1 å·²ä¿®å¤ - å¿ƒè·³è¶…æ—¶çª—å£é—®é¢˜**ï¼š

å®é™…å¿ƒè·³å‘¨æœŸè®¡ç®—ï¼š

- è®¾å¤‡å‘é€é—´éš”ï¼š30 ç§’
- ç½‘ç»œå»¶è¿Ÿï¼šçº¦ 2 ç§’
- æœåŠ¡å™¨å¤„ç†ï¼šçº¦ 1 ç§’
- å®é™…æ€»è®¡ï¼šçº¦ 33 ç§’

**å·²å®æ–½æ–¹æ¡ˆ**ï¼š

- âœ… åœ¨çº¿é˜ˆå€¼å·²è®¾ä¸º **60 ç§’**ï¼ˆå¿ƒè·³å‘¨æœŸ Ã— 2ï¼‰
- âœ… é…ç½®æ–‡ä»¶ï¼š`configs/example.yaml`, `configs/local.yaml`, `configs/production.yaml`
- âœ… é…ç½®é¡¹ï¼š`session.heartbeat_timeout_sec: 60`
- âœ… æµ‹è¯•éªŒè¯ï¼š`internal/app/session_test.go`
- âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

### 2.2 è®¾å¤‡è¿æ¥çŠ¶æ€

```mermaid
stateDiagram-v2
    [*] --> Disconnected: åˆå§‹çŠ¶æ€
    Disconnected --> Connected: TCPè¿æ¥å»ºç«‹
    Connected --> Online: æ”¶åˆ°å¿ƒè·³(0x1007)
    Online --> Online: æŒç»­å¿ƒè·³(30s)
    Online --> Offline: å¿ƒè·³è¶…æ—¶(>60s)
    Offline --> Online: æ¢å¤å¿ƒè·³
    Connected --> Disconnected: TCPæ–­å¼€
    Offline --> Disconnected: TCPæ–­å¼€
```

### 2.3 ç«¯å£çŠ¶æ€

æ¯ä¸ªè®¾å¤‡æœ‰ 1-2 ä¸ªå……ç”µç«¯å£ï¼š

```mermaid
stateDiagram-v2
    [*] --> free: åˆå§‹çŠ¶æ€
    free --> occupied: æ’æª(0x100F)
    occupied --> charging: å¼€å§‹å……ç”µ(0x1011)
    charging --> occupied: åœæ­¢å……ç”µ
    occupied --> free: æ‹”æª
    free --> fault: æ•…éšœ
    occupied --> fault: æ•…éšœ
    charging --> fault: æ•…éšœ
    fault --> free: æ¢å¤
```

| çŠ¶æ€       | å€¼  | å«ä¹‰             | èƒ½å¦æ¥å• | æ•°æ®åº“å­—æ®µ      |
| ---------- | --- | ---------------- | -------- | --------------- |
| `free`     | 0   | ç©ºé—²ï¼Œæ— æ’æª     | âœ… å¯ä»¥  | `port_status=0` |
| `occupied` | 1   | æœ‰æªæ’å…¥ï¼Œæœªå……ç”µ | âœ… å¯ä»¥  | `port_status=1` |
| `charging` | 2   | å……ç”µä¸­           | âŒ ç¦æ­¢  | `port_status=2` |
| `fault`    | 3   | æ•…éšœ             | âŒ ç¦æ­¢  | `port_status=3` |

**æ£€æŸ¥é€»è¾‘**ï¼ˆ`internal/storage/pg/device_repo.go`ï¼‰ï¼š

åˆ›å»ºè®¢å•å‰éœ€è¦è¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

1. **æ£€æŸ¥è®¾å¤‡åœ¨çº¿**ï¼š`time.Since(device.LastSeenAt) > 60ç§’` â†’ æ‹’ç»
2. **æ£€æŸ¥ç«¯å£å­˜åœ¨**ï¼šç«¯å£å·æ˜¯å¦åœ¨è®¾å¤‡ç«¯å£åˆ—è¡¨ä¸­
3. **æ£€æŸ¥ç«¯å£çŠ¶æ€**ï¼š
   - `port.Status == "charging"` â†’ æ‹’ç»ï¼ˆç«¯å£å……ç”µä¸­ï¼‰
   - `port.Status == "fault"` â†’ æ‹’ç»ï¼ˆç«¯å£æ•…éšœï¼‰
4. **æ£€æŸ¥ç«¯å£å ç”¨**ï¼šä½¿ç”¨æ•°æ®åº“è¡Œé”æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒè®¢å•

---

## 3. è®¢å•ç”Ÿå‘½å‘¨æœŸ

### 3.1 è®¢å•çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> pending: ç¬¬ä¸‰æ–¹åˆ›å»ºè®¢å•

    pending --> confirmed: è®¾å¤‡ACKç¡®è®¤(10ç§’å†…)
    pending --> timeout: è®¾å¤‡æ— å“åº”(10ç§’)
    pending --> cancelling: ç¬¬ä¸‰æ–¹å–æ¶ˆ

    confirmed --> charging: å¼€å§‹å……ç”µ
    confirmed --> cancelling: ç¬¬ä¸‰æ–¹å–æ¶ˆ

    charging --> interrupted: è®¾å¤‡ç¦»çº¿
    charging --> stopping: ç¬¬ä¸‰æ–¹åœæ­¢(å”¯ä¸€é€”å¾„)
    charging --> completed: æ­£å¸¸ç»“æŸ
    charging --> failed: è®¾å¤‡æ•…éšœ

    interrupted --> charging: 60ç§’å†…æ¢å¤
    interrupted --> failed: 60ç§’æœªæ¢å¤

    cancelling --> cancelled: è®¾å¤‡ACKç¡®è®¤
    cancelling --> cancelled: 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
    cancelling --> completed: è®¾å¤‡å·²å®Œæˆ(ç«æ€å¤„ç†)
    cancelling --> failed: è®¾å¤‡æ•…éšœ

    stopping --> stopped: è®¾å¤‡ACKç¡®è®¤
    stopping --> stopped: 30ç§’è¶…æ—¶è‡ªåŠ¨åœæ­¢
    stopping --> completed: è®¾å¤‡å·²å®Œæˆ(ç«æ€å¤„ç†)
    stopping --> failed: è®¾å¤‡æ•…éšœ

    timeout --> [*]
    cancelled --> [*]
    completed --> [*]
    failed --> [*]
    stopped --> [*]
```

**çŠ¶æ€æµè½¬è¯´æ˜(v2.2 ä¿®æ­£)**:

- **charging çŠ¶æ€ç¦æ­¢ç›´æ¥å–æ¶ˆ**: å¿…é¡»å…ˆåœæ­¢å……ç”µ(stopping),å†å˜ä¸º stopped ç»ˆæ€
- **cancelling/stopping è¶…æ—¶å¤„ç†**: 30 ç§’æœªæ”¶åˆ°è®¾å¤‡ ACK,è‡ªåŠ¨å˜ä¸º cancelled/stopped(**ä¸æ˜¯ timeout çŠ¶æ€**)
- **interrupted æ¢å¤æ¡ä»¶**: è®¾å¤‡è¿ç»­ 3 æ¬¡å¿ƒè·³æ­£å¸¸ä¸”ç«¯å£çŠ¶æ€ä»ä¸º charging
- **timeout çŠ¶æ€ä»…ç”¨äº pending**: è®¢å•åˆ›å»º 10 ç§’å†…è®¾å¤‡æœª ACK

````

### 3.2 çŠ¶æ€å®šä¹‰

| çŠ¶æ€          | å€¼  | å«ä¹‰                 | èƒ½å¦å–æ¶ˆ    | æ•°æ®åº“ `status` |
| ------------- | --- | -------------------- | ----------- | --------------- |
| `pending`     | 0   | ç­‰å¾…è®¾å¤‡ç¡®è®¤         | âœ…          | 0               |
| `confirmed`   | 1   | è®¾å¤‡å·²ç¡®è®¤ï¼Œå‡†å¤‡å……ç”µ | âœ…          | 1               |
| `charging`    | 2   | æ­£åœ¨å……ç”µ             | âŒ åªèƒ½åœæ­¢ | 2               |
| `completed`   | 3   | å……ç”µå®Œæˆ             | âŒ          | 3               |
| `timeout`     | 4   | è®¾å¤‡ 10 ç§’æ— å“åº”     | âŒ          | 4               |
| `cancelled`   | 5   | å·²å–æ¶ˆ               | âŒ          | 5               |
| `failed`      | 6   | å……ç”µå¤±è´¥             | âŒ          | 6               |
| `stopped`     | 7   | å·²åœæ­¢               | âŒ          | 7               |
| `cancelling`  | 8   | å–æ¶ˆä¸­ï¼ˆä¸­é—´æ€ï¼‰     | âŒ          | 8               |
| `stopping`    | 9   | åœæ­¢ä¸­ï¼ˆä¸­é—´æ€ï¼‰     | âŒ          | 9               |
| `interrupted` | 10  | å……ç”µä¸­æ–­ï¼ˆä¸´æ—¶æ€ï¼‰   | âŒ          | 10              |

### 3.3 å…³é”®æ—¶é—´çª—å£

| é˜¶æ®µ                | è¶…æ—¶æ—¶é—´   | è¡Œä¸º                                      | ä»£ç ä½ç½®                             |
| ------------------- | ---------- | ----------------------------------------- | ------------------------------------ |
| **è®¾å¤‡åœ¨çº¿é˜ˆå€¼**    | **60 ç§’**  | last_seen è¶…æ—¶åˆ¤å®šè®¾å¤‡ç¦»çº¿                | `internal/storage/pg/device_repo.go` |
| pending â†’ confirmed | **10 ç§’**  | è®¾å¤‡ ACK è¶…æ—¶ï¼Œè‡ªåŠ¨å˜ä¸º timeout           | `internal/service/order_monitor.go`  |
| cancelling/stopping | **30 ç§’**  | æŒ‡ä»¤ ACK è¶…æ—¶ï¼Œè‡ªåŠ¨å˜ä¸º cancelled/stopped | `internal/service/order_monitor.go`  |
| pending æ¸…ç†        | **5 åˆ†é’Ÿ** | åå°ä»»åŠ¡æ¸…ç†é•¿æœŸ pending è®¢å•             | `internal/app/order_monitor.go`      |
| outbound æŒ‡ä»¤       | **30 ç§’**  | ä¸‹è¡ŒæŒ‡ä»¤å‘é€è¶…æ—¶                          | `internal/outbound/queue.go`         |
| TCP write           | **5 ç§’**   | TCP å†™è¶…æ—¶                                | `internal/tcpserver/conn.go`         |

**æ—¶é—´é˜ˆå€¼è¯´æ˜**:

- **60 ç§’**: è®¾å¤‡åœ¨çº¿åˆ¤å®š(åŸºäº BKV å¿ƒè·³ 30 ç§’+å®¹é”™ 30 ç§’)
- **10 ç§’**: pending è®¢å•ç­‰å¾…è®¾å¤‡ç¡®è®¤çš„æœ€é•¿æ—¶é—´
- **30 ç§’**: cancelling/stopping ä¸­é—´æ€ç­‰å¾…è®¾å¤‡å“åº”çš„æœ€é•¿æ—¶é—´

---

## 4. å®Œæ•´ä¸šåŠ¡æµç¨‹

### 4.1 ä¸‹è¡ŒæŒ‡ä»¤æµï¼ˆç¬¬ä¸‰æ–¹ â†’ è®¾å¤‡ï¼‰

```mermaid
sequenceDiagram
    participant TP as ç¬¬ä¸‰æ–¹ç³»ç»Ÿ
    participant API as HTTP API
    participant DB as PostgreSQL
    participant Queue as Outbound Queue
    participant TCP as TCP Server
    participant Dev as å……ç”µè®¾å¤‡

    TP->>API: POST /v1/order/create<br/>{device_id, port_no, mode}

    Note over API: å…³é”®æ£€æŸ¥ç‚¹
    API->>DB: 1. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨
    API->>DB: 2. æ£€æŸ¥è®¾å¤‡åœ¨çº¿(last_seen<30s)
    API->>DB: 3. æ£€æŸ¥ç«¯å£å¯ç”¨(port_status!=2)
    API->>DB: 4. æ£€æŸ¥ç«¯å£æ˜¯å¦æœ‰è®¢å•(è¡Œé”)

    alt æ£€æŸ¥å¤±è´¥
        DB-->>API: è®¾å¤‡ç¦»çº¿/ç«¯å£è¢«å ç”¨
        API-->>TP: 400/503/409 é”™è¯¯
    else æ£€æŸ¥é€šè¿‡
        API->>DB: åˆ›å»ºè®¢å•(status=pending)
        DB-->>API: order_no: THD1234567890

        API->>Queue: å…¥é˜Ÿä¸‹è¡ŒæŒ‡ä»¤<br/>{cmd: 0x1011, order_no}
        API-->>TP: 200 OK<br/>{order_no, status: pending}

        Note over Queue,TCP: å¼‚æ­¥å¤„ç†
        Queue->>TCP: ä»é˜Ÿåˆ—å–æŒ‡ä»¤
        TCP->>Dev: å‘é€ 0x1011 æ§åˆ¶æŒ‡ä»¤

        Dev->>TCP: ACK ç¡®è®¤(3ç§’å†…)
        TCP->>DB: æ›´æ–°è®¢å•(status=confirmed)
        TCP->>Queue: æ ‡è®°æŒ‡ä»¤å·²å‘é€

        Note over DB: è§¦å‘äº‹ä»¶æ¨é€
        DB->>TP: POST /callback<br/>{order_no, status: confirmed}
    end
````

### 4.2 ä¸Šè¡ŒçŠ¶æ€æµï¼ˆè®¾å¤‡ â†’ ç¬¬ä¸‰æ–¹ï¼‰

```mermaid
sequenceDiagram
    participant Dev as å……ç”µè®¾å¤‡
    participant TCP as TCP Server
    participant DB as PostgreSQL
    participant Push as Event Pusher
    participant TP as ç¬¬ä¸‰æ–¹ç³»ç»Ÿ

    loop æ¯30ç§’
        Dev->>TCP: å¿ƒè·³ 0x1007
        TCP->>DB: UPDATE devices SET last_seen_at=NOW()
    end

    Dev->>TCP: ç«¯å£çŠ¶æ€ 0x100F<br/>{port_no, status}
    TCP->>DB: UPDATE device_ports SET status=?

    Dev->>TCP: å……ç”µå¼€å§‹äº‹ä»¶
    TCP->>DB: UPDATE orders SET status=charging
    DB->>Push: è§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶
    Push->>TP: POST /callback<br/>{order_no, status: charging}

    loop æ¯åˆ†é’Ÿ
        Dev->>TCP: å……ç”µè¿›åº¦<br/>{kwh, remaining_time}
        TCP->>DB: UPDATE orders SET kwh=?, ...
        DB->>Push: è§¦å‘è¿›åº¦äº‹ä»¶
        Push->>TP: POST /callback<br/>{order_no, kwh, progress}
    end

    Dev->>TCP: å……ç”µç»“æŸäº‹ä»¶
    TCP->>DB: UPDATE orders SET status=completed
    DB->>Push: è§¦å‘å®Œæˆäº‹ä»¶
    Push->>TP: POST /callback<br/>{order_no, status: completed, total_kwh}
```

### 4.3 è®¾å¤‡å¯ç”¨æ€§æ£€æŸ¥æµç¨‹

```mermaid
flowchart TD
    Start[ç¬¬ä¸‰æ–¹è¯·æ±‚åˆ›å»ºè®¢å•] --> Check1{è®¾å¤‡æ˜¯å¦å­˜åœ¨?}
    Check1 -->|NO| Error1[404: device not found]
    Check1 -->|YES| Check2{è®¾å¤‡æ˜¯å¦åœ¨çº¿?<br/>online=true}

    Check2 -->|NO| Error2[503: device is offline]
    Check2 -->|YES| Check3{å¿ƒè·³æ—¶é—´?<br/>last_seen < 60s}

    Check3 -->|NO| Error3[503: device heartbeat timeout]
    Check3 -->|YES| Check4{è®¾å¤‡çŠ¶æ€?<br/>status != fault}

    Check4 -->|NO| Error4[503: device is in fault state]
    Check4 -->|YES| Check5{ç«¯å£çŠ¶æ€?<br/>port_status != charging}

    Check5 -->|NO| Error5[409: port is charging]
    Check5 -->|YES| Check6{ç«¯å£æ˜¯å¦è¢«è®¢å•å ç”¨?<br/>status IN (0,1,2,8,9,10)<br/>åŒ…å«ä¸­é—´æ€}

    Check6 -->|YES| Error6[409: port is occupied]
    Check6 -->|NO| Success[âœ… éªŒè¯é€šè¿‡<br/>åˆ›å»ºè®¢å•]

    Error1 --> End
    Error2 --> End
    Error3 --> End
    Error4 --> End
    Error5 --> End
    Error6 --> End
    Success --> End[è¿”å›ç»“æœ]
```

**ä»£ç å®ç°ä½ç½®**ï¼š

- `internal/api/thirdparty_handler.go::CreateOrder()`
- `internal/storage/pg/device_repo.go::CanCreateOrder()`

### 4.4 å–æ¶ˆè®¢å•æµç¨‹

**é€‚ç”¨çŠ¶æ€**: `pending`, `confirmed` (**charging çŠ¶æ€ä¸å…è®¸ç›´æ¥å–æ¶ˆ**)

**æµç¨‹**:

1. ç¬¬ä¸‰æ–¹è°ƒç”¨å–æ¶ˆè®¢å•æ¥å£
2. æ£€æŸ¥è®¢å•å½“å‰çŠ¶æ€
   - å¦‚æœæ˜¯`pending`æˆ–`confirmed`: æ‰§è¡Œå–æ¶ˆæµç¨‹
   - å¦‚æœæ˜¯`charging`: **æ‹’ç»å–æ¶ˆè¯·æ±‚**,è¿”å›é”™è¯¯ç `ORDER_IS_CHARGING`,æç¤ºå¿…é¡»å…ˆåœæ­¢å……ç”µ
   - å¦‚æœå·²æ˜¯ç»ˆæ€(`completed`/`cancelled`/`stopped`ç­‰): è¿”å›é”™è¯¯"è®¢å•å·²ç»“æŸ"
3. å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º `cancelling` (ä¸­é—´æ€)
4. ä¸‹å‘å–æ¶ˆæŒ‡ä»¤åˆ°è®¾å¤‡ï¼ˆ0x1011 with cancel flagï¼‰
5. è®¾å¤‡ ACK åï¼Œè®¢å•å˜ä¸º `cancelled`
6. æ¨é€å–æ¶ˆæˆåŠŸäº‹ä»¶åˆ°ç¬¬ä¸‰æ–¹

**è¶…æ—¶å¤„ç†**: 30 ç§’å†…æœªæ”¶åˆ° ACKï¼Œè®¢å•è‡ªåŠ¨å˜ä¸º `cancelled` (**ä¸æ˜¯ timeout çŠ¶æ€**)

**charging çŠ¶æ€å–æ¶ˆé€»è¾‘**:

- ç”¨æˆ·å¿…é¡»å…ˆè°ƒç”¨"åœæ­¢å……ç”µ"æ¥å£ â†’ `charging`å˜ä¸º`stopping` â†’ æ”¶åˆ° ACK åå˜ä¸º`stopped`
- `stopped`æ˜¯ç»ˆæ€,æ— æ³•å†æµè½¬
- **ä¸šåŠ¡è¯­ä¹‰åŒºåˆ«**:
  - **å–æ¶ˆ** = è®¢å•æœªæ‰§è¡Œå‰æ’¤é”€(pending/confirmed é˜¶æ®µ)
  - **åœæ­¢** = è®¢å•æ‰§è¡Œä¸­ä¸»åŠ¨ç»ˆæ­¢(charging é˜¶æ®µ)

**ä»£ç å®ç°ä½ç½®**: `internal/api/thirdparty_handler.go::CancelOrder()`

### 4.5 åœæ­¢å……ç”µæµç¨‹

**é€‚ç”¨çŠ¶æ€**: `charging`

**æµç¨‹**:

1. ç¬¬ä¸‰æ–¹è°ƒç”¨åœæ­¢å……ç”µæ¥å£
2. å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º `stopping` (ä¸­é—´æ€)
3. ä¸‹å‘åœæ­¢æŒ‡ä»¤åˆ°è®¾å¤‡
4. è®¾å¤‡ ACK åï¼Œè®¢å•å˜ä¸º `stopped`
5. æ¨é€åœæ­¢æˆåŠŸäº‹ä»¶åˆ°ç¬¬ä¸‰æ–¹

**è¶…æ—¶å¤„ç†**: 30 ç§’å†…æœªæ”¶åˆ° ACKï¼Œè®¢å•è‡ªåŠ¨å˜ä¸º `stopped` (**ä¸æ˜¯ timeout çŠ¶æ€**)

**stopped vs completed ä¼˜å…ˆçº§**:

- å¦‚æœç”¨æˆ·ç‚¹"åœæ­¢"çš„åŒæ—¶è®¾å¤‡ä¸ŠæŠ¥"å……ç”µå®Œæˆ",ä»¥**è®¾å¤‡ä¸ŠæŠ¥ completed ä¸ºå‡†**
- **ä¼˜å…ˆçº§**: `completed` > `stopped` (è®¾å¤‡å®é™…çŠ¶æ€ä¼˜å…ˆäºç”¨æˆ·æ„å›¾)
- **å®ç°æ–¹å¼**: åœ¨çŠ¶æ€æ›´æ–°æ—¶æ£€æŸ¥ timestamp,å–æœ€æ–°çš„äº‹ä»¶

**ä»£ç å®ç°ä½ç½®**: `internal/api/thirdparty_handler.go::StopOrder()`

### 4.6 ç¬¬ä¸‰æ–¹APIå®Œæ•´è§„èŒƒ

#### 4.6.1 è®¤è¯æœºåˆ¶

**API Keyè®¤è¯**ï¼š
```http
X-API-Key: {api_key}
X-Timestamp: {unix_timestamp}
X-Signature: {hmac_sha256_signature}
```

**ç­¾åè®¡ç®—**ï¼š
```
signature = HMAC_SHA256(
    secret_key,
    "{method}\n{path}\n{timestamp}\n{body}"
)
```

#### 4.6.2 å¯åŠ¨å……ç”µAPI

**æ¥å£**: `POST /api/v1/third/devices/{device_id}/charge`

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "port_no": 1,
  "charge_mode": 1,
  "amount": 10000,
  "duration_minutes": 60,
  "price_per_kwh": 150,
  "service_fee": 100
}
```

**æˆåŠŸå“åº”(200)**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_no": "THD1234567890",
    "status": "pending",
    "device_id": "82241218000382",
    "port_no": 1
  },
  "request_id": "req_xxx",
  "timestamp": 1704528000
}
```

**é”™è¯¯å“åº”**:
| HTTPçŠ¶æ€ç  | ä¸šåŠ¡é”™è¯¯ç  | è¯´æ˜ |
|-----------|-----------|------|
| 400 | 40001 | å‚æ•°é”™è¯¯ |
| 403 | 40301 | ç­¾åéªŒè¯å¤±è´¥ |
| 404 | 40401 | è®¾å¤‡ä¸å­˜åœ¨ |
| 404 | 40402 | ç«¯å£ä¸å­˜åœ¨ |
| 409 | 40901 | ç«¯å£è¢«å ç”¨ |
| 503 | 50301 | è®¾å¤‡ç¦»çº¿ |
| 503 | 50302 | è®¾å¤‡å¿ƒè·³è¶…æ—¶ |
| 503 | 50303 | è®¾å¤‡æ•…éšœ |

#### 4.6.3 åœæ­¢å……ç”µAPI

**æ¥å£**: `POST /api/v1/third/orders/{order_no}/stop`

**è¯·æ±‚ä½“**: `{}` (ç©ºå¯¹è±¡)

**æˆåŠŸå“åº”(200)**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_no": "THD1234567890",
    "status": "stopping",
    "old_status": "charging"
  },
  "request_id": "req_xxx",
  "timestamp": 1704528000
}
```

#### 4.6.4 å–æ¶ˆè®¢å•API

**æ¥å£**: `POST /api/v1/third/orders/{order_no}/cancel`

**è¯·æ±‚ä½“**: `{}` (ç©ºå¯¹è±¡)

**æˆåŠŸå“åº”(200)**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_no": "THD1234567890",
    "status": "cancelling",
    "old_status": "pending"
  },
  "request_id": "req_xxx",
  "timestamp": 1704528000
}
```

**é”™è¯¯å“åº”**:
| HTTPçŠ¶æ€ç  | ä¸šåŠ¡é”™è¯¯ç  | è¯´æ˜ |
|-----------|-----------|------|
| 400 | 40002 | è®¢å•ä¸å¯å–æ¶ˆï¼ˆchargingçŠ¶æ€éœ€å…ˆåœæ­¢ï¼‰ |
| 404 | 40403 | è®¢å•ä¸å­˜åœ¨ |
| 409 | 40902 | è®¢å•å·²ç»“æŸ |

#### 4.6.5 æŸ¥è¯¢è®¢å•API

**æ¥å£**: `GET /api/v1/third/orders/{order_no}`

**æˆåŠŸå“åº”(200)**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_no": "THD1234567890",
    "device_id": "82241218000382",
    "port_no": 1,
    "status": 2,
    "status_text": "charging",
    "start_time": "2025-01-06T10:00:00Z",
    "end_time": null,
    "kwh": 1.234,
    "amount_cent": 10000,
    "duration_seconds": 1800
  },
  "request_id": "req_xxx",
  "timestamp": 1704528000
}
```

#### 4.6.6 Webhookå›è°ƒæ¥å£

ç¬¬ä¸‰æ–¹éœ€æä¾›Webhook URLæ¥æ”¶äº‹ä»¶æ¨é€ã€‚

**æ¥å£**: `POST {third_party_webhook_url}/callback`

**è¯·æ±‚å¤´**:
```http
Content-Type: application/json
X-Event-Type: {event_type}
X-Event-ID: {event_id}
X-Timestamp: {timestamp}
X-Signature: {hmac_sha256_signature}
```

**è¯·æ±‚ä½“ç¤ºä¾‹(è®¢å•çŠ¶æ€å˜æ›´)**:
```json
{
  "event_id": "order.confirmed-82241218000382-1704528000123456789",
  "event_type": "order.confirmed",
  "device_phy_id": "82241218000382",
  "timestamp": 1704528000,
  "nonce": "abc12345",
  "data": {
    "order_no": "THD1234567890",
    "device_id": "82241218000382",
    "port_no": 1,
    "old_status": "pending",
    "new_status": "confirmed"
  }
}
```

**äº‹ä»¶ç±»å‹æ¸…å•**:
| äº‹ä»¶ç±»å‹ | è¯´æ˜ | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `device.registered` | è®¾å¤‡æ³¨å†Œ | è®¾å¤‡é¦–æ¬¡è¿æ¥ |
| `device.heartbeat` | è®¾å¤‡å¿ƒè·³ | æ¯30ç§’ |
| `order.created` | è®¢å•åˆ›å»º | ç¬¬ä¸‰æ–¹åˆ›å»ºè®¢å• |
| `order.confirmed` | è®¢å•ç¡®è®¤ | è®¾å¤‡ACKç¡®è®¤ |
| `order.timeout` | è®¢å•è¶…æ—¶ | pendingçŠ¶æ€10ç§’æ— å“åº” |
| `charging.started` | å……ç”µå¼€å§‹ | è®¢å•å˜ä¸ºcharging |
| `charging.progress` | å……ç”µè¿›åº¦ | æ¯åˆ†é’Ÿä¸ŠæŠ¥ |
| `charging.ended` | å……ç”µç»“æŸ | å……ç”µå®Œæˆ |
| `order.completed` | è®¢å•å®Œæˆ | è®¾å¤‡ä¸ŠæŠ¥å®Œæˆ |
| `order.stopped` | è®¢å•åœæ­¢ | ç”¨æˆ·ä¸»åŠ¨åœæ­¢ |
| `order.cancelled` | è®¢å•å–æ¶ˆ | ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ |
| `order.failed` | è®¢å•å¤±è´¥ | è®¾å¤‡æ•…éšœ/æ–­çº¿ |
| `device.offline` | è®¾å¤‡ç¦»çº¿ | å¿ƒè·³è¶…æ—¶60ç§’ |
| `device.alarm` | è®¾å¤‡å‘Šè­¦ | è®¾å¤‡ä¸ŠæŠ¥æ•…éšœ |

**ç¬¬ä¸‰æ–¹å“åº”è¦æ±‚**:
```json
{
  "code": 0,
  "message": "success"
}
```

- HTTPçŠ¶æ€ç 200è§†ä¸ºæˆåŠŸ
- é200çŠ¶æ€ç å°†è§¦å‘é‡è¯•ï¼ˆæœ€å¤š5æ¬¡ï¼‰
- è¶…æ—¶æ—¶é—´ï¼š5ç§’

### 4.7 BKVåè®®è¯¦ç»†è§„èŒƒ

#### 4.7.1 å¸§æ ¼å¼å®šä¹‰

**åŸºæœ¬å¸§ç»“æ„**:
```
[èµ·å§‹æ ‡å¿—] [æ•°æ®é•¿åº¦] [æ•°æ®åŸŸ] [æ ¡éªŒå’Œ]
  2 Byte    2 Byte     N Byte    å¯é€‰
```

**å®Œæ•´å¸§ç¤ºä¾‹**:
```
FC FE 00 10 10 11 AB CD 12 34 56 78 01 02 03 04 05 06 07 08 ...
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚            â””â”€ æ•°æ®åŸŸ(Nå­—èŠ‚)
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€ ç½‘å…³ID(4å­—èŠ‚)
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”´â”€ æ¶ˆæ¯ID(2å­—èŠ‚)
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”´â”€ å‘½ä»¤ç (2å­—èŠ‚)
â”‚  â”‚  â””â”€â”€â”´â”€ æ•°æ®é•¿åº¦(2å­—èŠ‚,å¤§ç«¯åº)
â””â”€â”€â”´â”€ èµ·å§‹æ ‡å¿—(0xFC 0xFEæˆ–0xFC 0xFF)
```

#### 4.7.2 å…³é”®å‘½ä»¤å®šä¹‰

**0x0000 - å¿ƒè·³å¸§**
- **æ–¹å‘**: è®¾å¤‡ â†’ å¹³å°
- **å‘¨æœŸ**: 30ç§’
- **æ•°æ®åŸŸ**: ç©ºæˆ–çŠ¶æ€ä¿¡æ¯
- **ç”¨é€”**: ç»´æŒè¿æ¥ï¼Œæ›´æ–°last_seen_at

**0x1004 - ç½‘ç»œèŠ‚ç‚¹å¸§**
- **æ–¹å‘**: è®¾å¤‡ â†’ å¹³å°
- **è§¦å‘**: è®¾å¤‡ä¸Šçº¿/é‡è¿
- **æ•°æ®åŸŸ**: è®¾å¤‡ä¿¡æ¯ï¼ˆICCID, IMEI, å›ºä»¶ç‰ˆæœ¬ç­‰ï¼‰
- **ç”¨é€”**: è®¾å¤‡æ³¨å†Œ

**0x100F - ç«¯å£çŠ¶æ€ä¸ŠæŠ¥**
- **æ–¹å‘**: è®¾å¤‡ â†’ å¹³å°
- **è§¦å‘**: ç«¯å£çŠ¶æ€å˜åŒ–
- **æ•°æ®åŸŸ**:
  ```
  [ç«¯å£å·(1B)] [çŠ¶æ€(1B)] [åŠŸç‡(2B)] ...
  çŠ¶æ€: 0=free, 1=occupied, 2=charging, 3=fault
  ```

**0x1010 - åˆ·å¡å……ç”µä¸ŠæŠ¥**
- **æ–¹å‘**: è®¾å¤‡ â†’ å¹³å°
- **è§¦å‘**: ç”¨æˆ·åˆ·å¡
- **æ•°æ®åŸŸ**:
  ```
  [å¡å·(8B)] [ç«¯å£å·(1B)] [ä½™é¢(4B)] ...
  ```

**0x1011 - æ§åˆ¶æŒ‡ä»¤**
- **æ–¹å‘**: å¹³å° â†’ è®¾å¤‡
- **ç”¨é€”**: å¯åŠ¨/åœæ­¢å……ç”µ
- **æ•°æ®åŸŸ**:
  ```
  [æ“ä½œç±»å‹(1B)] [ç«¯å£å·(1B)] [å‚æ•°...]
  æ“ä½œç±»å‹: 0x01=å¯åŠ¨, 0x02=åœæ­¢
  ```

**0x1012 - æŸ¥è¯¢ç«¯å£çŠ¶æ€**
- **æ–¹å‘**: å¹³å° â†’ è®¾å¤‡
- **ç”¨é€”**: å®æ—¶æŸ¥è¯¢ç«¯å£çŠ¶æ€ï¼ˆP1-4éœ€è¦ï¼‰
- **æ•°æ®åŸŸ**: `[ç«¯å£å·(1B)]`
- **å“åº”**: é€šè¿‡0x100Fä¸ŠæŠ¥

**0x0F - ACKç¡®è®¤å¸§**
- **æ–¹å‘**: è®¾å¤‡ â†’ å¹³å°
- **è§¦å‘**: å“åº”ä¸‹è¡ŒæŒ‡ä»¤
- **æ•°æ®åŸŸ**:
  ```
  [åŸæ¶ˆæ¯ID(2B)] [ç»“æœç (1B)] [é”™è¯¯ç (2B)]
  ç»“æœç : 0x00=æˆåŠŸ, 0x01=å¤±è´¥
  ```

#### 4.7.3 è®¾å¤‡è¿æ¥æµç¨‹

```mermaid
sequenceDiagram
    participant D as BKVè®¾å¤‡
    participant S as IoTæœåŠ¡å™¨

    D->>S: TCPè¿æ¥å»ºç«‹(ç«¯å£6000)
    S->>D: è¿æ¥æˆåŠŸ
    D->>S: 0x1004 ç½‘ç»œèŠ‚ç‚¹(æ³¨å†Œ)
    S->>D: 0x0F ACKç¡®è®¤
    S->>S: åˆ›å»ºè®¾å¤‡è®°å½•

    loop æ¯30ç§’
        D->>S: 0x0000 å¿ƒè·³
        S->>S: æ›´æ–°last_seen_at
    end

    D->>S: 0x100F ç«¯å£çŠ¶æ€(åˆå§‹åŒ–)
    S->>S: è®°å½•ç«¯å£çŠ¶æ€

    Note over D,S: è®¾å¤‡è¿›å…¥åœ¨çº¿çŠ¶æ€
```

#### 4.7.4 å……ç”µæ§åˆ¶æµç¨‹

```mermaid
sequenceDiagram
    participant TP as ç¬¬ä¸‰æ–¹
    participant S as IoTæœåŠ¡å™¨
    participant D as BKVè®¾å¤‡

    TP->>S: POST /charge (å¯åŠ¨å……ç”µ)
    S->>S: æ£€æŸ¥è®¾å¤‡åœ¨çº¿
    S->>S: åˆ›å»ºè®¢å•(pending)
    S->>TP: 200 OK {order_no}

    S->>D: 0x1011 æ§åˆ¶æŒ‡ä»¤(å¯åŠ¨,msgID=123)
    D->>D: æ‰§è¡Œå¯åŠ¨
    D->>S: 0x0F ACKç¡®è®¤(msgID=123,æˆåŠŸ)
    S->>S: è®¢å•â†’confirmed
    S->>TP: Webhook: order.confirmed

    D->>S: 0x100F ç«¯å£çŠ¶æ€(charging)
    S->>S: è®¢å•â†’charging
    S->>TP: Webhook: charging.started

    loop å……ç”µä¸­
        D->>S: å……ç”µè¿›åº¦
        S->>TP: Webhook: charging.progress
    end

    D->>S: å……ç”µç»“æŸ
    S->>S: è®¢å•â†’completed
    S->>TP: Webhook: order.completed
```

#### 4.7.5 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | åå…­è¿›åˆ¶ | è¯´æ˜ |
|-------|---------|------|
| 0x0000 | 0x00 0x00 | æˆåŠŸ |
| 0x0001 | 0x00 0x01 | å‚æ•°é”™è¯¯ |
| 0x0002 | 0x00 0x02 | ç«¯å£ä¸å­˜åœ¨ |
| 0x0003 | 0x00 0x03 | ç«¯å£è¢«å ç”¨ |
| 0x0004 | 0x00 0x04 | ç«¯å£æ•…éšœ |
| 0x0005 | 0x00 0x05 | å……ç”µå¤±è´¥ |
| 0x00FF | 0x00 0xFF | æœªçŸ¥é”™è¯¯ |

---

## 5. å¼‚å¸¸åœºæ™¯å¤„ç†

### 5.1 åœºæ™¯ 1ï¼šè®¾å¤‡ç¦»çº¿æ—¶åˆ›å»ºè®¢å•

```mermaid
sequenceDiagram
    participant TP as ç¬¬ä¸‰æ–¹
    participant API as API
    participant DB as DB

    TP->>API: POST /v1/order/create
    API->>DB: SELECT * FROM devices WHERE id=?
    DB-->>API: {online: false, last_seen: 125ç§’å‰}

    Note over API: âŒ æ£€æŸ¥å¤±è´¥ï¼šè®¾å¤‡ç¦»çº¿
    API-->>TP: 503 Service Unavailable<br/>{<br/>  "code": 50301,<br/>  "message": "device is offline",<br/>  "data": {<br/>    "device_id": "82241218000382",<br/>    "last_seen": "2åˆ†é’Ÿå‰",<br/>    "suggestion": "è¯·é€‰æ‹©å…¶ä»–è®¾å¤‡"<br/>  }<br/>}
```

**å…³é”®**ï¼š

- âœ… ä¸åˆ›å»ºè®¢å•
- âœ… ä¸å ç”¨ç«¯å£
- âœ… æ˜ç¡®æç¤ºç”¨æˆ·
- âœ… é¿å…ç¬¬ä¸‰æ–¹å·²æ‰£æ¬¾ä½†æ— æ³•å……ç”µçš„æƒ…å†µ

### 5.2 åœºæ™¯ 2ï¼šè®¾å¤‡åœ¨å……ç”µä¸­çªç„¶ç¦»çº¿

```mermaid
sequenceDiagram
    participant Dev as è®¾å¤‡
    participant TCP as TCP Server
    participant Monitor as Order Monitor
    participant DB as DB
    participant Push as Pusher
    participant TP as ç¬¬ä¸‰æ–¹

    Note over Dev: T0: å……ç”µæ­£å¸¸è¿›è¡Œ
    Dev->>TCP: å¿ƒè·³ 0x1007
    TCP->>DB: last_seen_at = T0

    Note over Dev: T0+60s: è®¾å¤‡æ–­ç”µ

    Note over TCP,Monitor: T0+90s: å¿ƒè·³è¶…æ—¶æ£€æµ‹
    Monitor->>DB: SELECT * FROM devices<br/>WHERE last_seen < NOW() - 60s
    DB-->>Monitor: device_id: 8224..., online: false

    Monitor->>DB: SELECT * FROM orders<br/>WHERE device_id=? AND status=charging
    DB-->>Monitor: order_no: THD123...

    Monitor->>DB: UPDATE orders<br/>SET status=interrupted
    Monitor->>Push: æ¨é€è®¾å¤‡ç¦»çº¿äº‹ä»¶
    Push->>TP: POST /callback<br/>{order_no, event: device_offline}

    Note over Monitor: ç­‰å¾…60ç§’è§‚å¯Ÿæ˜¯å¦æ¢å¤

    alt è®¾å¤‡æ¢å¤
        Dev->>TCP: å¿ƒè·³æ¢å¤
        Monitor->>DB: UPDATE orders SET status=charging
    else 60ç§’åæœªæ¢å¤
        Monitor->>DB: UPDATE orders SET status=failed
        Monitor->>Push: æ¨é€è®¢å•å¤±è´¥äº‹ä»¶
        Push->>TP: POST /callback<br/>{order_no, status: failed, reason: device_offline}
    end
```

**å…³é”®**ï¼š

- âœ… æ£€æµ‹åˆ°è®¾å¤‡ç¦»çº¿ç«‹å³é€šçŸ¥ç¬¬ä¸‰æ–¹
- âœ… ç­‰å¾… 60 ç§’è§‚å¯Ÿæ˜¯å¦æ¢å¤
- âœ… ç¬¬ä¸‰æ–¹æ ¹æ®äº‹ä»¶å†³å®šæ˜¯å¦åœæ­¢è®¡è´¹

### 5.3 åœºæ™¯ 3ï¼šæŒ‡ä»¤ä¸‹å‘åè®¾å¤‡æ— å“åº”

```mermaid
sequenceDiagram
    participant TP as ç¬¬ä¸‰æ–¹
    participant API as API
    participant DB as DB
    participant Queue as Outbound Queue
    participant TCP as TCP Server
    participant Monitor as Order Monitor

    TP->>API: POST /v1/order/create
    API->>DB: åˆ›å»ºè®¢å•(status=pending)
    API->>Queue: å…¥é˜ŸæŒ‡ä»¤{cmd: 0x1011}
    API-->>TP: 200 OK {order_no, status: pending}

    Note over Queue,TCP: å¼‚æ­¥å¤„ç†
    Queue->>TCP: å‘é€æŒ‡ä»¤
    TCP->>TCP: ç­‰å¾…ACK...

    Note over Monitor: 10ç§’åæ£€æµ‹
    Monitor->>DB: SELECT * FROM orders<br/>WHERE status=pending<br/>AND created_at < NOW() - 10s
    DB-->>Monitor: order_no: THD123...

    Monitor->>DB: UPDATE orders SET status=timeout
    Monitor->>Queue: æ ‡è®°æŒ‡ä»¤å¤±è´¥
    Monitor->>TP: POST /callback<br/>{order_no, status: timeout, reason: no_ack}
```

**å…³é”®**ï¼š

- âœ… pending çŠ¶æ€æœ€å¤šä¿æŒ 10 ç§’
- âœ… è¶…æ—¶è‡ªåŠ¨å˜ä¸º timeout
- âœ… ç¬¬ä¸‰æ–¹æ”¶åˆ°è¶…æ—¶äº‹ä»¶åå¯è‡ªè¡Œå†³å®šæ˜¯å¦é€€æ¬¾

### 5.4 åœºæ™¯ 4ï¼šç«¯å£å¹¶å‘å†²çª

```mermaid
sequenceDiagram
    participant TP1 as ç¬¬ä¸‰æ–¹A
    participant TP2 as ç¬¬ä¸‰æ–¹B
    participant API as API
    participant DB as DB

    par å¹¶å‘è¯·æ±‚
        TP1->>API: POST /v1/order/create<br/>{device_id: 123, port_no: 1}
    and
        TP2->>API: POST /v1/order/create<br/>{device_id: 123, port_no: 1}
    end

    Note over API,DB: ä½¿ç”¨æ•°æ®åº“è¡Œé”
    API->>DB: BEGIN TRANSACTION
    API->>DB: SELECT * FROM orders<br/>WHERE device_id=123 AND port_no=1<br/>AND status IN (0,1,2)<br/>FOR UPDATE  -- è¡Œé”

    DB-->>API: 0 rows (ç«¯å£å¯ç”¨)
    API->>DB: INSERT INTO orders (...)
    API->>DB: COMMIT
    API-->>TP1: 200 OK {order_no: THD111...}

    Note over TP2: ç­‰å¾…è¡Œé”é‡Šæ”¾

    API->>DB: BEGIN TRANSACTION
    API->>DB: SELECT ... FOR UPDATE
    DB-->>API: 1 row (å·²è¢«å ç”¨)
    API->>DB: ROLLBACK
    API-->>TP2: 409 Conflict<br/>{<br/>  "code": 40901,<br/>  "message": "port is occupied",<br/>  "data": {<br/>    "busy_order": "THD111...",<br/>    "suggestion": "è¯·é€‰æ‹©å…¶ä»–ç«¯å£"<br/>  }<br/>}
```

**å…³é”®**ï¼š

- âœ… ä½¿ç”¨æ•°æ®åº“è¡Œé”ï¼ˆ`FOR UPDATE`ï¼‰
- âœ… é˜²æ­¢å¹¶å‘åˆ›å»ºè®¢å•
- âœ… æ˜ç¡®å‘ŠçŸ¥å“ªä¸ªè®¢å•å ç”¨äº†ç«¯å£

---

## 6. å…³é”®æ£€æŸ¥ç‚¹ä¸é€»è¾‘æ¼æ´ä¿®å¤

### 6.0 é€»è¾‘æ¼æ´æ€»è§ˆ

**å·²è¯†åˆ«æ¼æ´ç»Ÿè®¡**ï¼š

| ä¼˜å…ˆçº§   | æ•°é‡   | æ¼æ´åˆ—è¡¨                                         | æ ¸å¿ƒå½±å“             |
| -------- | ------ | ------------------------------------------------ | -------------------- |
| ğŸ”´ P0    | 2      | P0-1(è®¾å¤‡ç¦»çº¿æ£€æŸ¥), P0-2(æ–­çº¿æ¢å¤)               | èµ„é‡‘æŸå¤±ã€ç”¨æˆ·æŠ•è¯‰   |
| ğŸŸ¡ P1    | 6      | P1-1(å¿ƒè·³çª—å£), P1-2(å»¶è¿Ÿ ACK), P1-3(ç«¯å£å¹¶å‘)   | çŠ¶æ€ä¸ä¸€è‡´ã€è®¡è´¹é”™è¯¯ |
|          |        | P1-4(ç«¯å£åŒæ­¥), P1-5(å–æ¶ˆç«æ€), P1-6(é˜Ÿåˆ—ä¼˜å…ˆçº§) |                      |
|          |        | P1-7(äº‹ä»¶æ¨é€)                                   |                      |
| ğŸŸ¢ P2    | 3      | P2-1(ç›‘æ§ç«æ€), P2-2(ä¼šè¯ç®¡ç†), P2-3(å¹¶å‘æ€§èƒ½)   | æ€§èƒ½é—®é¢˜ã€ç³»ç»Ÿç¨³å®šæ€§ |
| **æ€»è®¡** | **11** | -                                                | -                    |

**ä¿®å¤ä¼˜å…ˆçº§å»ºè®®**ï¼š

1. **ç«‹å³ä¿®å¤ï¼ˆæœ¬å‘¨å†…ï¼‰**ï¼š

   - ğŸ”´ P0-1: è®¾å¤‡ç¦»çº¿æ£€æŸ¥ï¼ˆé˜²æ­¢èµ„é‡‘æŸå¤±ï¼‰
   - ğŸ”´ P0-2: æ–­çº¿æ¢å¤é€»è¾‘ï¼ˆé˜²æ­¢è¯¯è®¡è´¹ï¼‰
   - ğŸŸ¡ P1-7: äº‹ä»¶æ¨é€ä¸€è‡´æ€§ï¼ˆé˜²æ­¢è®¡è´¹é”™è¯¯ï¼‰

2. **è¿‘æœŸä¿®å¤ï¼ˆ2 å‘¨å†…ï¼‰**ï¼š

   - ğŸŸ¡ P1-4: ç«¯å£çŠ¶æ€åŒæ­¥
   - ğŸŸ¡ P1-5: å–æ¶ˆ/åœæ­¢ç«æ€
   - ğŸŸ¡ P1-6: é˜Ÿåˆ—ä¼˜å…ˆçº§

3. **æŒç»­ä¼˜åŒ–ï¼ˆ1 ä¸ªæœˆå†…ï¼‰**ï¼š
   - ğŸŸ¡ P1-1, P1-2, P1-3ï¼ˆå·²æœ‰éƒ¨åˆ†å®ç°ï¼‰
   - ğŸŸ¢ P2-1, P2-2, P2-3ï¼ˆæ€§èƒ½å’Œç¨³å®šæ€§ï¼‰

---

### 6.1 åˆ›å»ºè®¢å•å‰æ£€æŸ¥æ¸…å•

| åºå· | æ£€æŸ¥é¡¹       | éªŒè¯æ–¹å¼                                   | å¤±è´¥å“åº”                      | ä»£ç ä½ç½®                              |
| ---- | ------------ | ------------------------------------------ | ----------------------------- | ------------------------------------- |
| 1    | è®¾å¤‡å­˜åœ¨æ€§   | `SELECT * FROM devices WHERE id=?`         | 404: device not found         | `device_repo.go::GetByID`             |
| 2    | è®¾å¤‡åœ¨çº¿çŠ¶æ€ | `device.online = true`                     | 503: device is offline        | `device_repo.go::IsOnline`            |
| 3    | å¿ƒè·³æ—¶é—´     | `NOW() - last_seen_at < 60s`               | 503: device heartbeat timeout | `device_repo.go::IsOnline`            |
| 4    | è®¾å¤‡å·¥ä½œçŠ¶æ€ | `device.status != 'fault'`                 | 503: device is in fault state | `device_repo.go::CanCreateOrder`      |
| 5    | ç«¯å£å­˜åœ¨æ€§   | `port_no IN (1,2,...)`                     | 404: port not found           | `device_repo.go::GetPort`             |
| 6    | ç«¯å£çŠ¶æ€     | `port.status NOT IN ('charging', 'fault')` | 409: port is busy/fault       | `device_repo.go::CanCreateOrder`      |
| 7    | ç«¯å£å ç”¨æ£€æŸ¥ | `SELECT ... FOR UPDATE`                    | 409: port is occupied         | `order_repo.go::GetActiveOrderByPort` |

**ğŸ”´ P0 ä¿®å¤ - è®¾å¤‡ç¦»çº¿æ£€æŸ¥**ï¼š

å®ç°è¦ç‚¹ï¼š

1. åœ¨ `CreateOrder` API å…¥å£å¼ºåˆ¶æ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
2. åˆ¤å®šé€»è¾‘ï¼š`time.Since(device.LastSeenAt) > 60ç§’` â†’ æ‹’ç»
3. è¿”å› HTTP 503 é”™è¯¯ç å’Œè¯¦ç»†ç¦»çº¿ä¿¡æ¯
4. æ—¥å¿—è®°å½•ï¼šè®°å½•è®¾å¤‡ IDã€ç¦»çº¿æ—¶é•¿ã€æœ€åå¿ƒè·³æ—¶é—´
5. å“åº”æ•°æ®åŒ…å«ï¼šè®¾å¤‡ IDã€ç¦»çº¿æ—¶é•¿ã€å»ºè®®æ“ä½œ

ä»£ç ä½ç½®ï¼š`internal/api/thirdparty_handler.go::CreateOrder()`

### 6.2 å·²è¯†åˆ«é€»è¾‘æ¼æ´ä¸ä¿®å¤æ–¹æ¡ˆ

#### ğŸ”´ P0-1: è®¾å¤‡ç¦»çº¿ä»å¯åˆ›å»ºè®¢å•

**é—®é¢˜æè¿°**ï¼š

- å½“å‰ä»£ç æœªåœ¨åˆ›å»ºè®¢å•å‰æ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
- å¯èƒ½å¯¼è‡´ç¦»çº¿è®¾å¤‡æ¥å—è®¢å•ï¼Œä½†æ— æ³•æ‰§è¡Œå……ç”µ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

- åœ¨ `CreateOrder` å‰å¼ºåˆ¶æ£€æŸ¥è®¾å¤‡åœ¨çº¿
- é˜ˆå€¼å»ºè®®è®¾ä¸º 60 ç§’ï¼ˆå¿ƒè·³å‘¨æœŸ Ã— 2ï¼‰
- ç¦»çº¿æ—¶è¿”å› 503 é”™è¯¯

ä»£ç ä½ç½®ï¼š`internal/api/thirdparty_handler.go::CreateOrder()`

---

#### âœ… P1-1: å¿ƒè·³è¶…æ—¶çª—å£é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- è®¾å¤‡å¿ƒè·³å‘¨æœŸï¼š30 ç§’
- å®é™…ä¼ è¾“æ—¶é—´ï¼š30s + ç½‘ç»œå»¶è¿Ÿ 2s + å¤„ç† 1s = 33 ç§’
- åœ¨çº¿é˜ˆå€¼ï¼š30 ç§’ â†’ è¯¯åˆ¤ç¦»çº¿

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

- âœ… é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š`session.heartbeat_timeout_sec = 60`ï¼ˆå¿ƒè·³å‘¨æœŸ Ã— 2ï¼‰
- âœ… æ›´æ–°ä½ç½®ï¼š`configs/example.yaml`, `configs/local.yaml`, `configs/production.yaml`
- âœ… æµ‹è¯•éªŒè¯ï¼š`internal/app/session_test.go`
- âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### âœ… P1-2: å»¶è¿Ÿ ACK å¯¼è‡´çŠ¶æ€æ··ä¹±ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜åœºæ™¯**ï¼š

- T0ï¼šè®¢å• A åˆ›å»ºï¼Œä¸‹å‘å¯åŠ¨æŒ‡ä»¤
- T10ï¼šè®¢å• A è¶…æ—¶ï¼Œæ ‡è®°ä¸º timeout
- T15ï¼šè®¾å¤‡å‘é€è®¢å• A çš„ ACKï¼ˆå»¶è¿Ÿ 15 ç§’ï¼‰
- ç»“æœï¼šç³»ç»Ÿé”™è¯¯åœ°å°†è®¢å• A å˜ä¸º confirmedï¼Œä½†ç«¯å£å®é™…å·²è¢«è®¢å• B å ç”¨

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

1. âœ… ACK å¤„ç†æ—¶æ£€æŸ¥è®¢å•çŠ¶æ€å¿…é¡»ä¸º `pending`
2. âœ… æ£€æŸ¥ ACK æ—¶æ•ˆæ€§ï¼šåˆ›å»ºæ—¶é—´è¶…è¿‡ 10 ç§’æ‹’ç»å¤„ç†
3. âœ… æ‹’ç»å»¶è¿Ÿ ACK å¹¶è®°å½•å‘Šè­¦æ—¥å¿—
4. âœ… å®ç°ä½ç½®ï¼š`internal/service/card_service.go::HandleOrderConfirmation()`
5. âœ… æµ‹è¯•éªŒè¯ï¼š`internal/service/card_service_test.go`ï¼ˆ5ä¸ªæµ‹è¯•åœºæ™¯ï¼‰
6. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### âœ… P1-3: ç«¯å£å¹¶å‘å†²çªï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- å½“å‰ä»£ç å…ˆæ£€æŸ¥ç«¯å£çŠ¶æ€ï¼Œå†åˆ›å»ºè®¢å•
- ç«æ€æ¡ä»¶ï¼šä¸¤ä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶é€šè¿‡æ£€æŸ¥
- ç»“æœï¼šåŒä¸€ç«¯å£å¯èƒ½è¢«ä¸¤ä¸ªè®¢å•åŒæ—¶å ç”¨

**âœ… å·²å®æ–½æ–¹æ¡ˆ(v2.2 ç‰ˆæœ¬å®Œå–„)**ï¼š

1. **âœ… ä½¿ç”¨æ•°æ®åº“è¡Œé”,åŒæ—¶é” orders å’Œ device_ports è¡¨**ï¼š

   ```sql
   BEGIN;
   -- é”ä½è¯¥ç«¯å£çš„æ‰€æœ‰æ´»è·ƒè®¢å•(åŒ…å«ä¸­é—´æ€)
   SELECT * FROM orders
   WHERE device_id = ? AND port_no = ?
     AND status IN (0, 1, 2, 8, 9, 10)  -- pending, confirmed, charging, cancelling, stopping, interrupted
   FOR UPDATE;

   -- åŒæ—¶é”å®šdevice_portsè¡¨,é˜²æ­¢ç«¯å£çŠ¶æ€è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹
   SELECT * FROM device_ports
   WHERE device_id = ? AND port_no = ?
   FOR UPDATE;

   -- æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•å­˜åœ¨
   IF EXISTS(...) THEN
       ROLLBACK;
       RETURN "ç«¯å£å ç”¨";
   END IF;

   -- åˆ›å»ºæ–°è®¢å•
   INSERT INTO orders (...) VALUES (...);

   -- æ›´æ–°device_portsè¡¨
   UPDATE device_ports SET status='occupied', current_order_no=?
   WHERE device_id=? AND port_no=?;

   COMMIT;
   ```

   **å…³é”®æ”¹è¿›(v2.2)**:

   - âœ… ç«¯å£å ç”¨æ£€æŸ¥å¿…é¡»åŒ…å«ä¸­é—´æ€(8,9,10)
   - âœ… åŒæ—¶é”å®š orders å’Œ device_ports ä¸¤å¼ è¡¨,é¿å…è·¨è¡¨ä¸ä¸€è‡´

2. âœ… åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆæ£€æŸ¥å’Œåˆ›å»º
3. âœ… WHERE æ¡ä»¶ï¼š`status IN (0,1,2,8,9,10)` ç¡®ä¿é”å®šæ‰€æœ‰æ´»è·ƒè®¢å•(åŒ…å«ä¸­é—´æ€)
4. âœ… å®ç°ä½ç½®ï¼š`internal/api/thirdparty_handler.go`ï¼ˆ196-350è¡Œï¼‰
5. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### ğŸŸ¢ P2-1: è®¢å•ç›‘æ§ä»»åŠ¡ç«æ€

**é—®é¢˜æè¿°**ï¼š

- åå°ä»»åŠ¡æ¯ 30 ç§’æ‰«æè¶…æ—¶è®¢å•
- æŸ¥è¯¢åé€æ¡æ›´æ–°çŠ¶æ€
- ç«æ€ï¼šè®¾å¤‡ ACK å¯èƒ½åœ¨æŸ¥è¯¢å’Œæ›´æ–°ä¹‹é—´åˆ°è¾¾

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. ä½¿ç”¨ CASï¼ˆCompare-And-Setï¼‰åŸå­æ›´æ–°
2. å•æ¡ SQL å®ŒæˆæŸ¥è¯¢+æ›´æ–°
3. WHERE æ¡ä»¶ä¸­å†æ¬¡ç¡®è®¤çŠ¶æ€ï¼Œé˜²æ­¢ç«æ€

ä»£ç ä½ç½®ï¼š`internal/service/order_monitor.go::MonitorPendingOrders()`

---

#### ğŸ”´ P0-2: å……ç”µä¸­è®¢å•çš„è®¾å¤‡æ–­çº¿æ¢å¤é€»è¾‘ä¸å®Œæ•´

**é—®é¢˜æè¿°**ï¼š

- è®¾å¤‡ç¦»çº¿åç­‰å¾… 60 ç§’è§‚å¯Ÿæ¢å¤ï¼Œä½†æ¢å¤åçš„å¤„ç†é€»è¾‘ç¼ºå¤±
- è®¾å¤‡æ¢å¤æ—¶ï¼Œç«¯å£çŠ¶æ€å¯èƒ½å·²å˜åŒ–ï¼ˆæ‹”æª/æ•…éšœ/è¢«å…¶ä»–ç”¨æˆ·å ç”¨ï¼‰
- è®¾å¤‡çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´

**é£é™©åœºæ™¯**ï¼š

```
T0:  è®¢å•chargingï¼Œç”¨æˆ·æ­£å¸¸å……ç”µ
T30: è®¾å¤‡æ–­ç”µç¦»çº¿
T45: ç”¨æˆ·æ‹”æªç¦»å¼€
T50: è®¾å¤‡æ¢å¤ä¸Šçº¿ï¼Œç«¯å£çŠ¶æ€=freeï¼Œä½†ç³»ç»Ÿè®¢å•ä»ä¸ºcharging
ç»“æœ: ç³»ç»Ÿç»§ç»­è®¡è´¹ï¼Œä½†å®é™…å·²æ— äººå……ç”µ
```

**ä¿®å¤æ–¹æ¡ˆ(v2.2 ç‰ˆæœ¬å®Œå–„)**ï¼š

1. **å¼•å…¥ `interrupted` ä¸­é—´æ€**ï¼š

   - å½“ `charging` è®¢å•çš„è®¾å¤‡ç¦»çº¿æ—¶ â†’ è®¢å•çŠ¶æ€å˜ä¸º `interrupted`
   - è®¾å¤‡æ¢å¤åï¼Œè®¢å•è‡ªåŠ¨æµè½¬å› `charging`
   - å¦‚æœ 60 ç§’å†…æœªæ¢å¤ï¼Œè®¢å•æ ‡è®°ä¸º `failed`

2. **çŠ¶æ€æµè½¬é€»è¾‘**ï¼š

   ```
   charging â†’ interrupted (è®¾å¤‡ç¦»çº¿,last_seen > 60s)
   interrupted â†’ charging (è®¾å¤‡æ¢å¤,60ç§’å†…)
   interrupted â†’ failed (è¶…æ—¶æœªæ¢å¤,60ç§’å)
   ```

3. **æ¢å¤æ£€æµ‹é€»è¾‘(v2.2 è¡¥å……)**ï¼š

   ```go
   func OnDeviceHeartbeat(deviceID string) {
       // æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€
       db.UpdateDeviceLastSeen(deviceID)

       // æ£€æŸ¥æ˜¯å¦æœ‰interruptedè®¢å•éœ€è¦æ¢å¤
       interruptedOrders := db.Query(`
           SELECT order_no, port_no FROM orders
           WHERE device_id=? AND status=10  -- interrupted
       `)

       for _, order := range interruptedOrders {
           // æ£€æŸ¥ç«¯å£çŠ¶æ€æ˜¯å¦ä»ä¸ºcharging
           portStatus := GetPortStatus(deviceID, order.PortNo)
           if portStatus == "charging" {
               // è¿ç»­3æ¬¡å¿ƒè·³ç¡®è®¤æ¢å¤
               if CheckContinuousHeartbeat(deviceID, 3) {
                   db.UpdateOrder(order.OrderNo, charging)  // æ¢å¤ä¸ºcharging
                   PushEvent("order_resumed", order.OrderNo)
               }
           } else {
               // ç«¯å£å·²ä¸åœ¨å……ç”µ,æ ‡è®°è®¢å•å¤±è´¥
               db.UpdateOrder(order.OrderNo, failed)
               PushEvent("order_failed", order.OrderNo, "port_state_mismatch")
           }
       }
   }
   ```

4. **ç›‘æ§ä»»åŠ¡è¡¥å……**:

   ```go
   // æ£€æŸ¥è¶…æ—¶æœªæ¢å¤çš„interruptedè®¢å•
   func CheckInterruptedOrders() {
       db.Exec(`
           UPDATE orders SET status=6  -- failed
           WHERE status=10 AND updated_at < NOW() - INTERVAL '60 seconds'
       `)
   }
   ```

5. è®¾å¤‡æ¢å¤åå¿…é¡»ç«‹å³æŸ¥è¯¢ç«¯å£å®æ—¶çŠ¶æ€ï¼ˆä¸‹å‘ 0x1012 æŸ¥è¯¢å‘½ä»¤ï¼‰
6. å¯¹æ¯”ç«¯å£çŠ¶æ€ä¸è®¢å•çŠ¶æ€ï¼š
   - ç«¯å£çŠ¶æ€ä¸ä¸º charging æ—¶å¼ºåˆ¶ç»“æŸè®¢å•
   - æ›´æ–°è®¢å•ä¸º failedï¼Œæ ‡æ³¨åŸå› ï¼šport_state_mismatch
7. æ¨é€"å¼‚å¸¸ç»“æŸ"äº‹ä»¶ç»™ç¬¬ä¸‰æ–¹ï¼ŒåŒ…å«å®é™…å……ç”µæ—¶é•¿
8. è®°å½•è¯¦ç»†æ—¥å¿—ï¼šç¦»çº¿æ—¶é•¿ã€æ¢å¤æ—¶é—´ã€ç«¯å£çŠ¶æ€å˜åŒ–

**å…³é”®æ”¹è¿›(v2.2)**:

- æ˜ç¡®æ¢å¤æ£€æµ‹æ¡ä»¶:è¿ç»­ 3 æ¬¡å¿ƒè·³+ç«¯å£çŠ¶æ€=charging
- æ¢å¤åæ— éœ€é‡å‘æŒ‡ä»¤(è®¾å¤‡ä¾§è®¢å•ä»åœ¨æ‰§è¡Œ)
- 60 ç§’çª—å£å†…å¤šæ¬¡æ–­çº¿,é‡æ–°è®¡æ—¶

ä»£ç ä½ç½®ï¼š`internal/service/order_monitor.go::HandleDeviceReconnect()`

---

#### âœ… P1-4: ç«¯å£çŠ¶æ€ä¸è®¢å•çŠ¶æ€ä¸åŒæ­¥ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- ç«¯å£çŠ¶æ€ç”±è®¾å¤‡ä¸ŠæŠ¥ï¼ˆ0x100Fï¼‰ï¼Œè®¢å•çŠ¶æ€ç”±ç³»ç»Ÿç»´æŠ¤
- ä¸¤è€…æ›´æ–°æ—¶åºä¸åŒæ­¥ï¼Œå¯èƒ½å‡ºç°çŠ¶æ€é”™é…

**é£é™©åœºæ™¯**ï¼š

```
åœºæ™¯1: ç«¯å£é”æ­»
- è®¢å•timeoutï¼Œä½†åœæ­¢æŒ‡ä»¤æœªé€è¾¾è®¾å¤‡
- è®¾å¤‡ç«¯å£ä»ä¸ºchargingï¼Œç³»ç»Ÿè®¤ä¸ºfree
- åç»­è®¢å•æ— æ³•åˆ›å»ºï¼ˆç«¯å£å®é™…è¢«å ç”¨ï¼‰

åœºæ™¯2: åŒé‡ä¸‹å•
- è®¾å¤‡ä¸»åŠ¨åœæ­¢å……ç”µï¼ˆæ•…éšœ/ç”¨æˆ·æ‹”æªï¼‰ï¼Œç«¯å£â†’free
- åœæ­¢äº‹ä»¶ä¸¢å¤±ï¼Œç³»ç»Ÿè®¢å•ä»ä¸ºcharging
- æ–°è®¢å•åˆ›å»ºæˆåŠŸï¼ˆç³»ç»Ÿæœªæ„ŸçŸ¥ç«¯å£å·²freeï¼‰
```

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

1. âœ… **å®šæœŸçŠ¶æ€åŒæ­¥ä»»åŠ¡**ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰ï¼š
   - æŸ¥è¯¢æ‰€æœ‰åœ¨çº¿è®¾å¤‡çš„å…¨éƒ¨ç«¯å£çŠ¶æ€ï¼ˆ0x1012ï¼‰
   - å¯¹æ¯”æ•°æ®åº“çŠ¶æ€ï¼Œå‘ç°å·®å¼‚æ—¶è‡ªåŠ¨ä¿®å¤
2. âœ… **çŠ¶æ€ä¸ä¸€è‡´å‘Šè­¦ä¸æ¢å¤**ï¼š
   - Prometheus æŒ‡æ ‡ï¼š`port_state_mismatch_total`
   - è®°å½•è¯¦ç»†æ—¥å¿—
   - è‡ªåŠ¨æ¢å¤æœºåˆ¶
3. âœ… å®ç°ä½ç½®ï¼š`internal/app/port_status_syncer.go`ï¼ˆ312è¡Œï¼‰
4. âœ… æµ‹è¯•éªŒè¯ï¼š`internal/app/port_status_syncer_test.go`ï¼ˆ2ä¸ªæµ‹è¯•åœºæ™¯ï¼‰
5. âœ… åå°ä»»åŠ¡ï¼šå·²å¯ç”¨
6. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### âœ… P1-5: è®¢å•å–æ¶ˆ/åœæ­¢çš„æ—¶åºçª—å£æ¼æ´ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- å–æ¶ˆ/åœæ­¢è¯·æ±‚ä¸è®¾å¤‡ ACK/çŠ¶æ€å˜æ›´ä¹‹é—´å­˜åœ¨ç«æ€
- ç¼ºå°‘æŒ‡ä»¤å¹‚ç­‰æ€§è®¾è®¡å’Œä¸­é—´æ€ç®¡ç†

**é£é™©åœºæ™¯**ï¼š

```
T0: è®¢å•pendingï¼Œä¸‹å‘å¯åŠ¨æŒ‡ä»¤
T1: ç”¨æˆ·å–æ¶ˆè®¢å•
T2: è®¾å¤‡ACKåˆ°è¾¾ï¼Œè®¢å•â†’confirmed
T3: å–æ¶ˆè¯·æ±‚å¤„ç†ï¼Œä½†çŠ¶æ€å·²épendingï¼Œå–æ¶ˆå¤±è´¥
T4: è®¾å¤‡å¼€å§‹å……ç”µï¼Œç”¨æˆ·å·²ç¦»å¼€
```

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

1. âœ… **å¼•å…¥ä¸­é—´æ€**ï¼š
   - `cancelling`(çŠ¶æ€ 8)ï¼šå–æ¶ˆä¸­
   - `stopping`(çŠ¶æ€ 9)ï¼šåœæ­¢ä¸­
2. âœ… **å–æ¶ˆ/åœæ­¢æµç¨‹æ”¹é€ **ï¼š
   - ä½¿ç”¨CASæ›´æ–°ï¼šWHERE status IN (0,1) SET status=8 (cancelling)
   - ä¸‹å‘å–æ¶ˆæŒ‡ä»¤åˆ°è®¾å¤‡ï¼ˆ0x1013ï¼‰
   - è®¾å¤‡ACKç¡®è®¤ â†’ æ›´æ–°ä¸ºcancelled(5)
3. âœ… **å¤„ç† ACK æ—¶çš„çŠ¶æ€æ£€æŸ¥**ï¼š
   - å¯åŠ¨æŒ‡ä»¤ACKæ—¶æ£€æŸ¥è®¢å•çŠ¶æ€
   - å¦‚æœstatus==cancellingåˆ™æ‹’ç»å¯åŠ¨
4. âœ… **è¶…æ—¶ä¿æŠ¤**ï¼š
   - cancelling/stopping è¶…è¿‡ 30 ç§’æœªæ”¶åˆ° ACK
   - OrderMonitorè‡ªåŠ¨æ¸…ç†ï¼Œå¼ºåˆ¶æ ‡è®°ä¸º cancelled/stopped
5. âœ… å®ç°ä½ç½®ï¼š
   - `internal/api/thirdparty_handler.go::CancelOrder()`
   - `internal/app/order_monitor.go`
6. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### âœ… P1-6: ä¸‹è¡Œé˜Ÿåˆ—ç¼ºå°‘ä¼˜å…ˆçº§å’Œæ­»ä¿¡é˜Ÿåˆ—ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- æ‰€æœ‰æŒ‡ä»¤ FIFO å¤„ç†ï¼Œæ— ä¼˜å…ˆçº§åŒºåˆ†
- æŒ‡ä»¤å¤±è´¥åçš„é‡è¯•å’Œæ¸…ç†ç­–ç•¥ç¼ºå¤±
- é˜Ÿåˆ—å †ç§¯æ—¶ç¼ºå°‘é™çº§ç­–ç•¥

**é£é™©åœºæ™¯**ï¼š

```
åœºæ™¯1: ç´§æ€¥æŒ‡ä»¤å»¶è¿Ÿ
- é˜Ÿåˆ—ä¸­æœ‰100æ¡æŸ¥è¯¢æŒ‡ä»¤æ’é˜Ÿ
- ç”¨æˆ·å‘èµ·ç´§æ€¥åœæ­¢å……ç”µè¯·æ±‚
- åœæ­¢æŒ‡ä»¤æ’é˜Ÿç­‰å¾…ï¼Œå»¶è¿Ÿ1åˆ†é’Ÿæ‰§è¡Œ
- ç”¨æˆ·å¤šè®¡è´¹

åœºæ™¯2: é˜Ÿåˆ—å †ç§¯
- è®¾å¤‡å¤§é¢ç§¯ç¦»çº¿ï¼ŒæŒ‡ä»¤ç§¯å‹
- é˜Ÿåˆ—é•¿åº¦>1000ï¼Œæ–°æŒ‡ä»¤å…¥é˜Ÿå¤±è´¥
- åœ¨çº¿è®¾å¤‡ä¹Ÿæ— æ³•æ¥æ”¶æŒ‡ä»¤
```

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

1. âœ… **æŒ‡ä»¤ä¼˜å…ˆçº§åˆ†çº§**ï¼ˆ5çº§ï¼‰ï¼š
   - Emergency(1): åœæ­¢å……ç”µã€å–æ¶ˆè®¢å•
   - High(2): å¯åŠ¨å……ç”µã€æŸ¥è¯¢ç«¯å£
   - Normal(3): å‚æ•°è®¾ç½®ã€æŸ¥è¯¢ä¿¡æ¯
   - Low(4): OTAå‡çº§
   - Background(5): å®šæœŸåŒæ­¥
2. âœ… **æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶**ï¼š
   - DeadLetterCleaneræ¯å°æ—¶æ¸…ç†è¶…è¿‡24å°æ—¶çš„æ­»ä¿¡
   - æ ‡è®°å¤±è´¥åŸå› å’Œé‡è¯•æ¬¡æ•°
3. âœ… **é™çº§ç­–ç•¥**ï¼š
   - é˜Ÿåˆ—é•¿åº¦>200ï¼šæ‹’ç»ä½ä¼˜å…ˆçº§(>5)
   - é˜Ÿåˆ—é•¿åº¦>500ï¼šæ‹’ç»ä¸­ä¼˜å…ˆçº§(>2)
   - é˜Ÿåˆ—é•¿åº¦>1000ï¼šä»…æ¥å—ç´§æ€¥æŒ‡ä»¤(â‰¤1)
4. âœ… å®ç°ä½ç½®ï¼š
   - `internal/outbound/priority.go` - ä¼˜å…ˆçº§å®šä¹‰
   - `internal/app/dead_letter_cleaner.go` - æ­»ä¿¡æ¸…ç†
   - `internal/storage/redis/outbound_queue.go` - é˜Ÿåˆ—è¿‡è½½ä¿æŠ¤
5. âœ… æµ‹è¯•éªŒè¯ï¼š`internal/outbound/priority_test.go`
6. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### âœ… P1-7: äº‹ä»¶æ¨é€å¤±è´¥çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜æè¿°**ï¼š

- è®¢å•çŠ¶æ€æ›´æ–°ä¸äº‹ä»¶æ¨é€ä¸æ˜¯åŸå­æ“ä½œ
- æ¨é€å¤±è´¥æ—¶ç¼ºå°‘é‡è¯•å’Œå…œåº•æœºåˆ¶
- äº‹ä»¶å¯èƒ½ä¹±åºåˆ°è¾¾ç¬¬ä¸‰æ–¹

**é£é™©åœºæ™¯**ï¼š

```
T0: è®¢å•completedï¼Œæ•°æ®åº“å·²æ›´æ–°
T1: æ¨é€completedäº‹ä»¶åˆ°ç¬¬ä¸‰æ–¹
T2: ç¬¬ä¸‰æ–¹æœåŠ¡å®•æœºï¼Œæ¨é€å¤±è´¥
T3: ç³»ç»Ÿæ— é‡è¯•ï¼Œç¬¬ä¸‰æ–¹æ°¸è¿œæ”¶ä¸åˆ°å®Œæˆäº‹ä»¶
ç»“æœ: ç¬¬ä¸‰æ–¹è®¤ä¸ºè®¢å•ä»åœ¨chargingï¼Œç»§ç»­è®¡è´¹
```

**âœ… å·²å®æ–½æ–¹æ¡ˆ**ï¼š

1. âœ… **å¼•å…¥ Outbox æ¨¡å¼**ï¼š
   - Eventsè¡¨å­˜å‚¨äº‹ä»¶ï¼ˆåºåˆ—å·ã€é‡è¯•ã€çŠ¶æ€ï¼‰
   - æ•°æ®åº“è¿ç§»ï¼š`db/migrations/012_events_outbox.sql`
2. âœ… **è®¢å•çŠ¶æ€æ›´æ–°ä¸äº‹ä»¶å†™å…¥åœ¨åŒä¸€äº‹åŠ¡**ï¼š
   - CardServiceä½¿ç”¨äº‹åŠ¡ç‰ˆæœ¬çš„æ›´æ–°æ–¹æ³•
   - UpdateTransactionChargingWithEventç­‰æ–¹æ³•
3. âœ… **åå°äº‹ä»¶æ¨é€ä»»åŠ¡**ï¼ˆæ¯ 10 ç§’ï¼‰ï¼š
   - EventPusherå®šæœŸæ‰¹é‡æ¨é€
   - æ¨é€æˆåŠŸ/å¤±è´¥çŠ¶æ€è·Ÿè¸ª
   - é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š5æ¬¡ï¼‰
4. âœ… **äº‹ä»¶åºåˆ—å·ä¿è¯é¡ºåº**ï¼š
   - æ¯ä¸ªè®¢å•çš„äº‹ä»¶æºå¸¦é€’å¢åºåˆ—å·
   - æŒ‰åºæ¨é€ç¡®ä¿é¡ºåºä¸€è‡´æ€§
5. âœ… **æä¾› HTTP æŸ¥è¯¢æ¥å£å…œåº•**ï¼š
   - `GET /api/v1/third/orders/:order_id/events`
   - ç¬¬ä¸‰æ–¹å¯ä¸»åŠ¨æŸ¥è¯¢è¡¥å¿
6. âœ… **æ¨é€å¤±è´¥å‘Šè­¦**ï¼š
   - å®Œæ•´çš„é”™è¯¯è·Ÿè¸ªå’Œæ—¥å¿—
7. âœ… å®ç°ä½ç½®ï¼š
   - `internal/app/event_pusher.go` - åå°æ¨é€å™¨
   - `internal/service/card_service.go` - äº‹åŠ¡å†™å…¥
   - `internal/api/thirdparty_handler.go` - æŸ¥è¯¢æ¥å£
8. âœ… åå°ä»»åŠ¡ï¼šå·²å¯ç”¨
9. âœ… å®Œæˆæ—¥æœŸï¼š2025-11-10

---

#### ğŸŸ¢ P2-2: è®¾å¤‡é‡è¿åçš„ä¼šè¯çŠ¶æ€ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š

- TCP æ–­å¼€é‡è¿åï¼Œæ—§ä¼šè¯ä¸­çš„è®¢å•ä¸Šä¸‹æ–‡å¯èƒ½ä¸¢å¤±
- å¤šå®ä¾‹éƒ¨ç½²æ—¶ä¼šè¯çŠ¶æ€æ— æ³•è·¨å®ä¾‹åŒæ­¥
- ç¼ºå°‘ä¼šè¯è¿‡æœŸå’Œæ¸…ç†æœºåˆ¶

**é£é™©åœºæ™¯**ï¼š

```
åœºæ™¯1: å•å®ä¾‹é‡è¿
- è®¾å¤‡TCPæ–­å¼€ï¼Œè®¢å•ä»ä¸ºcharging
- è®¾å¤‡é‡è¿ï¼Œå»ºç«‹æ–°ä¼šè¯
- æ—§ä¼šè¯ä¸­çš„pendingæŒ‡ä»¤ä¸¢å¤±

åœºæ™¯2: å¤šå®ä¾‹é‡è¿
- è®¾å¤‡ä»å®ä¾‹Aæ–­å¼€ï¼ˆè®¢å•åœ¨Açš„å†…å­˜ä¸­ï¼‰
- è®¾å¤‡é‡è¿åˆ°å®ä¾‹B
- å®ä¾‹Bæ— æ³•æ„ŸçŸ¥è¯¥è®¾å¤‡çš„è®¢å•çŠ¶æ€
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. **ä¼šè¯çŠ¶æ€æŒä¹…åŒ–åˆ° Redis**ï¼š

   ```redis
   # Key: session:{device_id}
   {
       "device_id": "82241218000382",
       "instance_id": "server-01",
       "conn_id": "tcp-12345",
       "connected_at": 1699000000,
       "active_orders": ["THD123", "THD456"],
       "pending_commands": [
           {"msg_id": "msg001", "cmd": "0x1011", "order_no": "THD123"}
       ]
   }
   # TTL: 300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
   ```

2. **è®¾å¤‡è¿æ¥æ—¶åŠ è½½ä¼šè¯çŠ¶æ€**ï¼š

   ```go
   func OnDeviceConnect(deviceID string) {
       // ä»RedisåŠ è½½æ—§ä¼šè¯
       session := redis.Get("session:" + deviceID)

       if session != nil {
           // æ£€æŸ¥active_ordersçŠ¶æ€
           for _, orderNo := range session.ActiveOrders {
               order := db.GetOrder(orderNo)
               if order.Status == charging && device offline > 5min {
                   // è®¾å¤‡é•¿æ—¶é—´ç¦»çº¿ï¼Œè®¢å•å¤±è´¥
                   db.UpdateOrder(orderNo, failed)
               }
           }

           // æ¢å¤pending_commandsåˆ°ä¸‹è¡Œé˜Ÿåˆ—
           for _, cmd := range session.PendingCommands {
               if time.Since(cmd.CreatedAt) < 30s {
                   queue.Enqueue(cmd)
               }
           }
       }

       // åˆ›å»ºæ–°ä¼šè¯
       CreateSession(deviceID, instanceID, connID)
   }
   ```

3. **ä¼šè¯è¿‡æœŸç­–ç•¥**ï¼š
   - è®¾å¤‡ç¦»çº¿ 5 åˆ†é’Ÿå Redis ä¼šè¯è‡ªåŠ¨è¿‡æœŸ
   - è¿‡æœŸæ—¶è§¦å‘å›è°ƒï¼šæ£€æŸ¥è¯¥è®¾å¤‡çš„ charging è®¢å•
   - æ‰€æœ‰ charging è®¢å•æ ‡è®°ä¸º failedï¼ˆåŸå› ï¼šsession_expiredï¼‰
4. **ä¼šè¯å¿ƒè·³æ›´æ–°**ï¼š

   - è®¾å¤‡æ¯æ¬¡å‘é€å¿ƒè·³æ—¶æ›´æ–° Redis ä¼šè¯ TTL
   - ç¡®ä¿åœ¨çº¿è®¾å¤‡çš„ä¼šè¯ä¸ä¼šè¿‡æœŸ

5. **è·¨å®ä¾‹ä¼šè¯è¿ç§»**ï¼š
   - è®¾å¤‡é‡è¿åˆ°æ–°å®ä¾‹æ—¶ï¼Œæ›´æ–° Redis ä¸­çš„ instance_id
   - æ–°å®ä¾‹æ¥ç®¡è®¢å•å’ŒæŒ‡ä»¤é˜Ÿåˆ—
   - æ—§å®ä¾‹é€šè¿‡ Redis pub/sub æ„ŸçŸ¥è¿ç§»ï¼Œæ¸…ç†æœ¬åœ°èµ„æº

ä»£ç ä½ç½®ï¼š

- `internal/session/manager.go::LoadSession()` - åŠ è½½ä¼šè¯
- `internal/session/manager.go::PersistSession()` - æŒä¹…åŒ–ä¼šè¯
- `internal/tcpserver/handler.go::OnConnect()` - è¿æ¥å¤„ç†

---

#### ğŸŸ¢ P2-3: é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œæ­»é”é£é™©

**é—®é¢˜æè¿°**ï¼š

- ä½¿ç”¨ FOR UPDATE è¡Œé”ï¼Œé”èŒƒå›´è¿‡å¤§ï¼Œé™ä½å¹¶å‘èƒ½åŠ›
- é•¿äº‹åŠ¡å¢åŠ æ­»é”æ¦‚ç‡
- ç¼ºå°‘å¿…è¦çš„æ•°æ®åº“ç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½å·®

**é£é™©åœºæ™¯**ï¼š

```
æ­»é”åœºæ™¯:
- äº‹åŠ¡A: UPDATE orders WHERE id=1 (æŒæœ‰è®¢å•1è¡Œé”)
- äº‹åŠ¡B: UPDATE orders WHERE id=2 (æŒæœ‰è®¢å•2è¡Œé”)
- ç›‘æ§ä»»åŠ¡: SELECT * FROM orders WHERE status=0 FOR UPDATE (ç­‰å¾…å…¨è¡¨é”)
- äº‹åŠ¡A: æŸ¥è¯¢è®¾å¤‡è¡¨(ç­‰å¾…ç›‘æ§ä»»åŠ¡é‡Šæ”¾)
ç»“æœ: æ­»é”
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. **ç¼©å°é”ç²’åº¦**ï¼š

   ```go
   // é”™è¯¯åšæ³•ï¼šé”æ•´è¡Œ
   SELECT * FROM orders WHERE device_id=? AND port_no=? FOR UPDATE

   // æ­£ç¡®åšæ³•ï¼šåªé”å¿…è¦å­—æ®µï¼Œæˆ–ä½¿ç”¨ä¹è§‚é”
   SELECT id, status, version FROM orders
   WHERE device_id=? AND port_no=? AND status IN (0,1,2)
   FOR UPDATE SKIP LOCKED  -- è·³è¿‡å·²é”è¡Œ
   ```

2. **ä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”**ï¼š

   ```sql
   -- å¢åŠ versionå­—æ®µ
   ALTER TABLE orders ADD COLUMN version INT DEFAULT 0;

   -- æ›´æ–°æ—¶ä½¿ç”¨CAS
   UPDATE orders
   SET status=?, version=version+1
   WHERE order_no=? AND version=?
   -- å½±å“è¡Œæ•°=0è¡¨ç¤ºå†²çªï¼Œéœ€è¦é‡è¯•
   ```

3. **æ‹†åˆ†äº‹åŠ¡ï¼Œå‡å°‘é•¿äº‹åŠ¡**ï¼š

   ```go
   // é”™è¯¯åšæ³•ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆæ‰€æœ‰æ“ä½œ
   tx.Begin()
   tx.CheckDevice()
   tx.CheckPort()
   tx.CreateOrder()
   tx.EnqueueCommand()  // å¯èƒ½è€—æ—¶é•¿
   tx.Commit()

   // æ­£ç¡®åšæ³•ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
   tx1: æ£€æŸ¥+åˆ›å»ºè®¢å•ï¼ˆå¿«é€Ÿï¼‰
   å¼‚æ­¥: å…¥é˜ŸæŒ‡ä»¤ï¼ˆè§£è€¦ï¼‰
   tx2: æŒ‡ä»¤å‘é€å®Œæˆåæ›´æ–°çŠ¶æ€
   ```

4. **æ·»åŠ æ•°æ®åº“ç´¢å¼•**ï¼š

   ```sql
   -- ç«¯å£å ç”¨æ£€æŸ¥ä¼˜åŒ–
   CREATE INDEX idx_orders_device_port_status
   ON orders(device_id, port_no, status);

   -- è®¢å•ç›‘æ§æŸ¥è¯¢ä¼˜åŒ–
   CREATE INDEX idx_orders_status_created
   ON orders(status, created_at);

   -- è®¾å¤‡åœ¨çº¿æ£€æŸ¥ä¼˜åŒ–
   CREATE INDEX idx_devices_last_seen
   ON devices(last_seen_at);

   -- å……ç”µè®¢å•æŸ¥è¯¢ä¼˜åŒ–
   CREATE INDEX idx_orders_device_status
   ON orders(device_id, status)
   WHERE status IN (0,1,2);  -- éƒ¨åˆ†ç´¢å¼•
   ```

5. **ä½¿ç”¨åˆ†å¸ƒå¼é”ä¼˜åŒ–é«˜é¢‘æ“ä½œ**ï¼š

   ```go
   // åˆ›å»ºè®¢å•å‰è·å–åˆ†å¸ƒå¼é”
   lockKey := fmt.Sprintf("lock:device:%s:port:%d", deviceID, portNo)
   lock := redis.Lock(lockKey, 5*time.Second)

   if lock.Acquire() {
       defer lock.Release()
       // æ£€æŸ¥+åˆ›å»ºè®¢å•
   } else {
       return ErrPortBusy
   }
   ```

6. **ç›‘æ§ä»»åŠ¡æŸ¥è¯¢ä¼˜åŒ–**ï¼š

   ```go
   // é”™è¯¯åšæ³•ï¼šå…¨è¡¨æ‰«æ+é€æ¡æ›´æ–°
   orders := SELECT * FROM orders WHERE status=0
   for order in orders {
       UPDATE orders SET status=4 WHERE id=?
   }

   // æ­£ç¡®åšæ³•ï¼šå•æ¡SQLæ‰¹é‡æ›´æ–°
   UPDATE orders SET status=4
   WHERE status=0 AND created_at < NOW() - INTERVAL '10 seconds'
   RETURNING order_no  -- è¿”å›å—å½±å“çš„è®¢å•å·
   ```

7. **è¿æ¥æ± é…ç½®ä¼˜åŒ–**ï¼š

   ```yaml
   database:
     max_open_conns: 50 # æœ€å¤§è¿æ¥æ•°
     max_idle_conns: 10 # æœ€å¤§ç©ºé—²è¿æ¥
     conn_max_lifetime: 30m # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
     conn_max_idle_time: 5m # è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´
   ```

8. **æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼š
   ```
   - db_query_duration_seconds{query="create_order"}
   - db_lock_wait_seconds
   - db_deadlock_total
   - db_active_connections
   ```

ä»£ç ä½ç½®ï¼š

- `internal/storage/pg/order_repo.go::CreateOrder()` - ä¼˜åŒ–é”
- `internal/service/order_monitor.go::MonitorPendingOrders()` - æ‰¹é‡æ›´æ–°
- `configs/example.yaml` - è¿æ¥æ± é…ç½®

---

### 6.3 çŠ¶æ€æµè½¬åˆæ³•æ€§çŸ©é˜µ

| FROM â†“ / TO â†’   | pending | confirmed | charging | completed | timeout | cancelled | failed | stopped | cancelling | stopping | interrupted |
| --------------- | ------- | --------- | -------- | --------- | ------- | --------- | ------ | ------- | ---------- | -------- | ----------- |
| **pending**     | -       | âœ…        | âŒ       | âŒ        | âœ…      | âŒ        | âŒ     | âŒ      | âœ…         | âŒ       | âŒ          |
| **confirmed**   | âŒ      | -         | âœ…       | âŒ        | âŒ      | âŒ        | âŒ     | âŒ      | âœ…         | âŒ       | âŒ          |
| **charging**    | âŒ      | âŒ        | -        | âœ…        | âŒ      | âŒ        | âœ…     | âŒ      | âŒ         | âœ…       | âœ…          |
| **completed**   | âŒ      | âŒ        | âŒ       | -         | âŒ      | âŒ        | âŒ     | âŒ      | âŒ         | âŒ       | âŒ          |
| **timeout**     | âŒ      | âŒ        | âŒ       | âŒ        | -       | âŒ        | âŒ     | âŒ      | âŒ         | âŒ       | âŒ          |
| **cancelled**   | âŒ      | âŒ        | âŒ       | âŒ        | âŒ      | -         | âŒ     | âŒ      | âŒ         | âŒ       | âŒ          |
| **failed**      | âŒ      | âŒ        | âŒ       | âŒ        | âŒ      | âŒ        | -      | âŒ      | âŒ         | âŒ       | âŒ          |
| **stopped**     | âŒ      | âŒ        | âŒ       | âŒ        | âŒ      | âŒ        | âŒ     | -       | âŒ         | âŒ       | âŒ          |
| **cancelling**  | âŒ      | âŒ        | âŒ       | âœ…        | âŒ      | âœ…        | âœ…     | âŒ      | -          | âŒ       | âŒ          |
| **stopping**    | âŒ      | âŒ        | âŒ       | âœ…        | âŒ      | âŒ        | âœ…     | âœ…      | âŒ         | -        | âŒ          |
| **interrupted** | âŒ      | âŒ        | âœ…       | âŒ        | âŒ      | âŒ        | âœ…     | âŒ      | âŒ         | âŒ       | -           |

**çŠ¶æ€è¯´æ˜(v2.2 ç‰ˆæœ¬ä¿®æ­£)**ï¼š

- **cancelling**: ç”¨æˆ·å‘èµ·å–æ¶ˆï¼Œç­‰å¾…è®¾å¤‡ ACKï¼ˆpending/confirmed å¯è¿›å…¥ï¼Œ30 ç§’è¶…æ—¶è‡ªåŠ¨å˜ä¸º **cancelled**ï¼Œä¸æ˜¯ timeoutï¼‰
- **stopping**: ç”¨æˆ·å‘èµ·åœæ­¢ï¼Œç­‰å¾…è®¾å¤‡ ACKï¼ˆcharging å¯è¿›å…¥ï¼Œ30 ç§’è¶…æ—¶è‡ªåŠ¨å˜ä¸º **stopped**ï¼Œä¸æ˜¯ timeoutï¼‰
- **interrupted**: å……ç”µä¸­è®¾å¤‡ç¦»çº¿ï¼ˆä¸´æ—¶æ€ï¼Œ60 ç§’å†…è®¾å¤‡æ¢å¤å˜ä¸º chargingï¼Œè¶…æ—¶å˜ä¸º failedï¼‰
- **timeout**: ä»…ç”¨äº pending é˜¶æ®µï¼ˆè®¢å•åˆ›å»º 10 ç§’å†…è®¾å¤‡æœª ACKï¼‰

**å…³é”®ä¿®æ­£**:

- âŒ åˆ é™¤: cancellingâ†’timeoutã€stoppingâ†’timeout æµè½¬(ä¸çŠ¶æ€æœºå›¾çŸ›ç›¾)
- âœ… æ–°å¢: cancellingâ†’completedã€stoppingâ†’completed æµè½¬(å¤„ç†è®¾å¤‡å·²å®Œæˆä½†ç”¨æˆ·ç‚¹å–æ¶ˆ/åœæ­¢çš„ç«æ€)

**å®ç°è¦ç‚¹**ï¼š

1. **çŠ¶æ€æµè½¬éªŒè¯**ï¼š

   - ç»´æŠ¤åˆæ³•çŠ¶æ€æµè½¬æ˜ å°„è¡¨
   - æ›´æ–°å‰æ£€æŸ¥ FROM â†’ TO æ˜¯å¦åˆæ³•
   - éæ³•æµè½¬æ‹’ç»å¹¶è®°å½•å‘Šè­¦

2. **åŸå­æ›´æ–°**ï¼š

   - ä½¿ç”¨ CASï¼ˆCompare-And-Setï¼‰æ›´æ–°
   - WHERE æ¡ä»¶åŒ…å«å½“å‰çŠ¶æ€éªŒè¯
   - æ›´æ–°å¤±è´¥æ—¶è¿”å›é‡è¯•é”™è¯¯

3. **ç»ˆæ€ä¿æŠ¤**ï¼š
   - completedã€timeoutã€cancelledã€failed ä¸ºç»ˆæ€
   - ç»ˆæ€è®¢å•ä¸å¯å†æµè½¬

ä»£ç ä½ç½®ï¼š`internal/storage/pg/order_repo.go::UpdateStatus()`

---

## 7. ç›‘æ§ä¸å‘Šè­¦

### 7.1 å…³é”®æŒ‡æ ‡

```mermaid
graph LR
    subgraph "è®¾å¤‡ç›‘æ§"
        A1[è®¾å¤‡åœ¨çº¿ç‡<br/>target: >95%]
        A2[å¿ƒè·³è¶…æ—¶ç‡<br/>alert: >5%]
        A3[è®¾å¤‡æ•…éšœç‡<br/>alert: >2%]
    end

    subgraph "è®¢å•ç›‘æ§"
        B1[è®¢å•åˆ›å»ºæˆåŠŸç‡<br/>target: >98%]
        B2[è®¢å•è¶…æ—¶ç‡<br/>alert: >5%]
        B3[è®¾å¤‡ACKå¹³å‡æ—¶å»¶<br/>alert: >5s]
    end

    subgraph "ç³»ç»Ÿç›‘æ§"
        C1[APIå“åº”æ—¶é—´<br/>P99 <200ms]
        C2[TCPè¿æ¥æ•°<br/>monitoring]
        C3[ä¸‹è¡Œé˜Ÿåˆ—é•¿åº¦<br/>alert: >100]
    end
```

**Prometheus æŒ‡æ ‡å®šä¹‰**ï¼ˆ`internal/metrics/metrics.go`ï¼‰ï¼š

**è®¾å¤‡æŒ‡æ ‡**ï¼š

- `device_online_total`ï¼šåœ¨çº¿è®¾å¤‡æ•°é‡ï¼ˆæŒ‰åè®®åˆ†ç±»ï¼šbkv, ap3000ï¼‰
- `device_heartbeat_latency_seconds`ï¼šè®¾å¤‡å¿ƒè·³å»¶è¿Ÿç›´æ–¹å›¾

**è®¢å•æŒ‡æ ‡**ï¼š

- `order_created_total`ï¼šè®¢å•åˆ›å»ºæ€»æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼šsuccess, device_offline, port_occupiedï¼‰
- `order_timeout_total`ï¼šè¶…æ—¶è®¢å•æ€»æ•°
- `device_ack_latency_seconds`ï¼šè®¾å¤‡ ACK å“åº”å»¶è¿Ÿ

**ç³»ç»ŸæŒ‡æ ‡**ï¼š

- `outbound_queue_length`ï¼šä¸‹è¡Œé˜Ÿåˆ—å½“å‰é•¿åº¦

### 7.2 å‘Šè­¦è§„åˆ™

**Prometheus AlertManager é…ç½®**ï¼ˆ`configs/prometheus_alerts.yml`ï¼‰ï¼š

**ğŸ”´ P0 å‘Šè­¦ - Critical**ï¼š

- `DeviceMassOffline`ï¼šè®¾å¤‡å¤§é¢ç§¯ç¦»çº¿
  - æ¡ä»¶ï¼šåœ¨çº¿è®¾å¤‡æ•° / æ€»è®¾å¤‡æ•° < 80%
  - æŒç»­ï¼š1 åˆ†é’Ÿ
  - æè¿°ï¼šåœ¨çº¿è®¾å¤‡æ•°ä½äº 80%

**ğŸŸ¡ P1 å‘Šè­¦ - Warning**ï¼š

- `HighOrderTimeoutRate`ï¼šè®¢å•è¶…æ—¶ç‡è¿‡é«˜
  - æ¡ä»¶ï¼šè®¢å•è¶…æ—¶ç‡ > 10%
  - æŒç»­ï¼š2 åˆ†é’Ÿ
- `HighDeviceACKLatency`ï¼šè®¾å¤‡ ACK å»¶è¿Ÿè¿‡é«˜
  - æ¡ä»¶ï¼šP95 å»¶è¿Ÿ > 5 ç§’
  - æŒç»­ï¼š3 åˆ†é’Ÿ

**ğŸŸ¢ P2 å‘Šè­¦ - Info**ï¼š

- `OutboundQueueBacklog`ï¼šä¸‹è¡Œé˜Ÿåˆ—å †ç§¯
  - æ¡ä»¶ï¼šé˜Ÿåˆ—é•¿åº¦ > 100
  - æŒç»­ï¼š5 åˆ†é’Ÿ

### 7.3 åå°ç›‘æ§ä»»åŠ¡

**Order Monitor**ï¼ˆ`internal/app/order_monitor.go`ï¼‰ï¼š

**è¿è¡Œå‘¨æœŸ**ï¼šæ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡

**ä»»åŠ¡åˆ—è¡¨**ï¼š

1. **æ¸…ç†è¶…æ—¶ pending è®¢å•**

   - æŸ¥æ‰¾åˆ›å»ºæ—¶é—´è¶…è¿‡ 10 ç§’ä½†ä»ä¸º pending çŠ¶æ€çš„è®¢å•
   - ä½¿ç”¨åŸå­æ›´æ–°å°†çŠ¶æ€å˜ä¸º timeout
   - è®°å½•è¶…æ—¶è®¢å•æ•°é‡

2. **æ£€æµ‹å……ç”µä¸­æ–­è®¢å•**

   - æŸ¥æ‰¾çŠ¶æ€ä¸º charging ä½†è®¾å¤‡å·²ç¦»çº¿ï¼ˆlast_seen > 60 ç§’ï¼‰çš„è®¢å•
   - æ ‡è®°è®¢å•ä¸º interrupted çŠ¶æ€
   - æ¨é€è®¾å¤‡ç¦»çº¿äº‹ä»¶åˆ°ç¬¬ä¸‰æ–¹
   - ç­‰å¾… 60 ç§’è§‚å¯Ÿæ˜¯å¦æ¢å¤
   - æœªæ¢å¤åˆ™æ ‡è®°ä¸º failed

3. **æ¸…ç†é•¿æœŸ pending è®¢å•**
   - æŸ¥æ‰¾åˆ›å»ºæ—¶é—´è¶…è¿‡ 5 åˆ†é’Ÿçš„ pending è®¢å•
   - æ‰¹é‡æ¸…ç†å¹¶è®°å½•æ—¥å¿—

**å…³é”® SQL(v2.2 ç‰ˆæœ¬ä¿®æ­£)**ï¼š

- è¶…æ—¶è®¢å•(é˜²æ­¢å¹¶å‘å†²çª):

  ```sql
  UPDATE orders SET status=4
  WHERE status=0
    AND created_at < NOW() - INTERVAL '10 seconds'
    AND updated_at < NOW() - INTERVAL '10 seconds'  -- æ–°å¢:é¿å…ä¸ä¸šåŠ¡æ›´æ–°å†²çª
  ```

- ä¸­æ–­è®¢å•ï¼š

  ```sql
  SELECT * FROM orders o
  JOIN devices d ON o.device_id = d.id
  WHERE o.status=2
    AND d.last_seen_at < NOW() - INTERVAL '60 seconds'
  ```

- è¶…æ—¶ cancelling/stopping è®¢å•(æ–°å¢):

  ```sql
  -- cancellingè¶…æ—¶å˜ä¸ºcancelled
  UPDATE orders SET status=5
  WHERE status=8 AND updated_at < NOW() - INTERVAL '30 seconds';

  -- stoppingè¶…æ—¶å˜ä¸ºstopped
  UPDATE orders SET status=7
  WHERE status=9 AND updated_at < NOW() - INTERVAL '30 seconds';
  ```

- interrupted è¶…æ—¶è®¢å•(æ–°å¢):
  ```sql
  UPDATE orders SET status=6  -- failed
  WHERE status=10 AND updated_at < NOW() - INTERVAL '60 seconds'
  ```

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­               | è¯´æ˜                         | æ•°æ®åº“å­—æ®µ             |
| ------------------ | ---------------------------- | ---------------------- |
| **pending**        | è®¢å•å·²åˆ›å»ºï¼Œç­‰å¾…è®¾å¤‡ ACK     | `status=0`             |
| **confirmed**      | è®¾å¤‡å·²ç¡®è®¤ï¼Œå‡†å¤‡å……ç”µ         | `status=1`             |
| **charging**       | æ­£åœ¨å……ç”µ                     | `status=2`             |
| **completed**      | å……ç”µå®Œæˆ                     | `status=3`             |
| **timeout**        | è®¾å¤‡ 10 ç§’å†…æ—  ACK           | `status=4`             |
| **cancelled**      | å·²å–æ¶ˆ                       | `status=5`             |
| **failed**         | å……ç”µå¤±è´¥                     | `status=6`             |
| **stopped**        | å·²åœæ­¢                       | `status=7`             |
| **cancelling**     | å–æ¶ˆä¸­ï¼ˆä¸­é—´æ€ï¼‰             | `status=8`             |
| **stopping**       | åœæ­¢ä¸­ï¼ˆä¸­é—´æ€ï¼‰             | `status=9`             |
| **interrupted**    | å……ç”µä¸­æ–­ï¼ˆä¸´æ—¶æ€ï¼‰           | `status=10`            |
| **ACK**            | è®¾å¤‡ç¡®è®¤å“åº”                 | BKV åè®®å­—æ®µ           |
| **last_seen_at**   | è®¾å¤‡æœ€åå¿ƒè·³æ—¶é—´             | `devices.last_seen_at` |
| **online**         | è®¾å¤‡åœ¨çº¿æ ‡å¿—                 | `devices.online`       |
| **outbound_queue** | ä¸‹è¡ŒæŒ‡ä»¤é˜Ÿåˆ—                 | `outbound_queueè¡¨`     |
| **Outbox æ¨¡å¼**    | äº‹åŠ¡æ€§äº‹ä»¶å‘å¸ƒæ¨¡å¼           | `eventsè¡¨`             |
| **CAS**            | Compare-And-Set åŸå­æ›´æ–°æ“ä½œ | ä¹è§‚é”å®ç°             |

### B. BKV åè®®å…³é”®å‘½ä»¤

| å‘½ä»¤å· | å‘½ä»¤å   | æ–¹å‘        | è¯´æ˜         | æ–‡æ¡£ä½ç½® |
| ------ | -------- | ----------- | ------------ | -------- |
| 0x1007 | å¿ƒè·³     | è®¾å¤‡ â†’ å¹³å° | æ¯ 30 ç§’å‘é€ | 2.1 èŠ‚   |
| 0x1004 | ç½‘ç»œèŠ‚ç‚¹ | è®¾å¤‡ â†’ å¹³å° | è®¾å¤‡ä¸Šçº¿æ³¨å†Œ | 2.2 èŠ‚   |
| 0x100F | ç«¯å£çŠ¶æ€ | è®¾å¤‡ â†’ å¹³å° | ç«¯å£çŠ¶æ€ä¸ŠæŠ¥ | -        |
| 0x1010 | åˆ·å¡å……ç”µ | è®¾å¤‡ â†’ å¹³å° | åˆ·å¡å¯åŠ¨å……ç”µ | 2.2.9 èŠ‚ |
| 0x1011 | æ§åˆ¶æŒ‡ä»¤ | å¹³å° â†’ è®¾å¤‡ | ä¸‹å‘å……ç”µæŒ‡ä»¤ | 2.2.8 èŠ‚ |

å‚è€ƒæ–‡æ¡£ï¼š`docs/åè®®/è®¾å¤‡å¯¹æ¥æŒ‡å¼•-ç»„ç½‘è®¾å¤‡2024(1).txt`

### C. ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½æ¨¡å—        | æ–‡ä»¶è·¯å¾„                                                    |
| --------------- | ----------------------------------------------------------- |
| HTTP API        | `internal/api/thirdparty_handler.go`                        |
| è®¾å¤‡åœ¨çº¿æ£€æŸ¥    | `internal/storage/pg/device_repo.go::IsOnline()`            |
| ç«¯å£å ç”¨æ£€æŸ¥    | `internal/storage/pg/order_repo.go::GetActiveOrderByPort()` |
| è®¢å•åˆ›å»º        | `internal/storage/pg/order_repo.go::CreateOrder()`          |
| ä¸‹è¡Œé˜Ÿåˆ—        | `internal/outbound/queue.go`                                |
| BKV åè®®è§£æ    | `internal/protocol/bkv/adapter.go`                          |
| BKV æŒ‡ä»¤å¤„ç†    | `internal/protocol/bkv/handlers.go`                         |
| è®¢å•ç›‘æ§        | `internal/service/order_monitor.go`                         |
| äº‹ä»¶æ¨é€        | `internal/thirdparty/pusher.go`                             |
| Prometheus æŒ‡æ ‡ | `internal/metrics/metrics.go`                               |

### D. å‚è€ƒæ–‡æ¡£

- **BKV åè®®æ–‡æ¡£**: `docs/åè®®/è®¾å¤‡å¯¹æ¥æŒ‡å¼•-ç»„ç½‘è®¾å¤‡2024(1).txt`
- **é¡¹ç›®æ¶æ„è®¾è®¡**: `docs/æ¶æ„/é¡¹ç›®æ¶æ„è®¾è®¡.md`
- **ç¬¬ä¸‰æ–¹ API æ–‡æ¡£**: `docs/api/ç¬¬ä¸‰æ–¹APIæ–‡æ¡£.md`
- **äº‹ä»¶æ¨é€è§„èŒƒ**: `docs/api/äº‹ä»¶æ¨é€è§„èŒƒ.md`

---

## ğŸ“¢ é‡è¦æé†’

> **æœ¬æ–‡æ¡£å®šä¹‰çš„æµç¨‹æ˜¯æŠ€æœ¯è§„èŒƒï¼Œæ‰€æœ‰ä»£ç å®ç°å¿…é¡»ä¸¥æ ¼éµå®ˆï¼**
>
> **ğŸ”´ æ ¸å¿ƒåŸåˆ™ï¼šè®¾å¤‡ç¦»çº¿æ—¶å¿…é¡»æ‹’ç»åˆ›å»ºè®¢å•**
>
> è¿™æ˜¯ä¿æŠ¤ç¬¬ä¸‰æ–¹ä¸šåŠ¡çš„æœ€åä¸€é“é˜²çº¿â€”â€”é¿å…ç”¨æˆ·å·²æ‰£æ¬¾ä½†æ— æ³•å……ç”µçš„æƒ…å†µã€‚

---

_æ–‡æ¡£ç»“æŸ_
