## IoT 平台（PG 方案）架构设计

### 目录

- 1. 目标与范围
- 2. 架构总览与数据流
- 3. 模块职责与接口
- 4. 数据模型（概要）
- 5. 协议实现要点
- 6. SLO 与告警
- 7. 演进
- 8. 已知问题与改进方向
- 9. 模块详细设计

### 1. 目标与范围

- 单体期 MVP，对接 AP3000/主机协议核心闭环（20/21/22/12、82、03/06、83/84/85/86、E0/F8）。
- 不覆盖：跨可用区强一致、消息总线/时序库（为演进预留）。

### 2. 架构总览与数据流

- 网关（TCP）→ 协议插件 → 会话/限速 → 领域服务（设备/订单/参数/升级）→ PG → 观测/管理。
- 关键约束：0.5s 下行节流、15s 超时+一次重发、幂等键=(phyId,msgId,cmd)、01/21 二选一、22/12 请求-应答。

### 3. 模块职责与接口

- 接入网关：长连接、半/粘包、DNY+小端+校验、消息ID回显、单设备下行队列与节流、死链回收。
- 协议插件：20/21/22/12、82、03/06、83/84/85/86、E0/F8 编解码与路由，版本/长度分支。
- 会话/路由：ICCID/物理ID/IMEI 绑定；一致性哈希；设备级令牌桶限速；心跳维护。
- 领域服务：设备档案/端口；订单闭环；参数读写；升级分片重试。
- 持久化（PG）：分区表与索引；批量写；下行WAL；HEX索引。
- 管理/观测：REST+OpenAPI；Prom 指标；RBAC/白名单；pprof。

### 4. 数据模型（概要）

- `devices`、`device_ports`、`sessions`、`orders`、`cmd_log_YYYYMMDD`、`outbound_queue`、`telemetry_summary_YYYYMMDD`、`alarm_events`、`firmware_tasks`、`replay_index`。
- 规范：日志/摘要分区按日；主键与时间统一；批量写优先。

### 5. 协议实现要点

- 帧：DNY 包头；长度=物理ID+消息ID+命令+数据(n)+校验(2)；小端；累加和低16位。
- 策略：01/21 二选一；22/12 请求-应答；82（队列+节流+超时/重发+幂等+FF）；03/06（订单闭环与摘要）；E0/F8（分片≤3重试）。

### 6. SLO 与告警

- 平台：在线、上下行QPS、p95/p99、82成功率、重发率、DB写延迟、下行队列长度。
- 阈值：82成功率<99%、重发率>3%、p99>200ms、DB失败率>0.1%、队列积压、在线骤降。

### 7. 演进

- 多实例水平扩展；PG 分区与批量写延续；如心跳时序查询重，引入 Timescale；如解耦需求强，引入消息总线。

### 8. 已知问题与改进方向（按模块）

- 接入网关
  - 问题：半/粘包边界判定未统一；异常码不规范；下行队列缺少优先级（控制 vs 心跳）。
  - 改进：统一帧状态机；错误码字典；加入优先级与最大排队时长；冷启自检（端到端连通性）。
- 协议插件
  - 问题：长度/版本兼容分支分散；01/21 互斥策略未配置化；82 幂等键与业务幂等未解耦；E0/F8 超时/重试策略缺失。
  - 改进：集中式路由表+版本分支；策略项配置化；幂等键中台化；升级分片窗口/退避重试。
- 会话/路由
  - 问题：ICCID/物理ID/IMEI 绑定优先级场景未覆盖；死链回收仅依赖心跳；限速粒度粗（实例级）。
  - 改进：三标识合并与漂移处理；多信号源离线判定（TCP/心跳/命令ACK）；设备级令牌桶+全局限速。
- 领域服务
  - 问题：订单闭环对乱序/重发敏感；参数写入缺乏范围校验与回读校验；升级缺少灰度/回滚开关。
  - 改进：03/06/82 序约束与重复抑制；参数白名单与上下界校验+回读；升级批次与门限控制。
- 持久化（PG）
  - 问题：分区策略未落地；热点索引风险；批量写通道未定义；`outbound_queue` 清理与重放策略不明确。
  - 改进：日志/摘要按日分区+BRIN；复合索引 `(phy_id, cmd, ts)`；COPY/多值 INSERT 通道；WAL 完成即清理、dead 队列审计。
- 管理/观测
  - 问题：指标基数可能过大（设备标签）；RBAC 范围不足；HEX 审计未脱敏。
  - 改进：降基数聚合（按区域/型号）；最小角色集；HEX UID/ICCID/IMEI 脱敏与访问审计。
- 安全与合规
  - 问题：白名单覆盖不全；日志与数据库敏感字段明文；缺少审计留痕流程。
  - 改进：多层白名单（IP/设备）；敏感字段哈希/掩码；操作审计与留存策略（≥180天）。

### 9. 模块详细设计

- 接入网关
  - 输入/输出：TCP 字节流 <-> `Message(phyId,msgId,cmd,payload,ts,meta)`
  - 状态机：SYNC(DNY)→LEN→BODY→CHK；粘包循环读取，半包缓冲。
  - 队列：每设备下行队列（优先级：控制>心跳）；节流0.5s；超时15s+一次重发。
  - 异常：校验失败/未知指令/长度越界→错误码；冷启连通性自检。
- 协议插件
  - 路由：`cmd -> handler` 集中表；按长度/版本分支；01/21 互斥开关；22/12 请求-应答。
  - 82：幂等键=(phyId,msgId,cmd)；FF 智能端口；合法性校验（端口范围、时长/电量上限）。
  - 03/06：闭环与摘要（最大/最小/平均功率）；乱序/重复抑制策略。
  - E0/F8：分片大小、窗口、≤3重试；失败记录与回滚开关。
- 会话/路由
  - 绑定：ICCID>物理ID>IMEI；漂移处理（变更即重绑）；一致性哈希（实例亲和）。
  - 离线：多信号（TCP断开/心跳超时/ACK缺失）综合判定；阈值可配。
  - 限速：设备令牌桶+全局限流；超限丢弃非关键包（心跳可采样）。
- 领域服务
  - 设备：档案创建/更新；端口状态机（空闲/在充/浮充/故障）。
  - 订单：82→(06*)→03；订单状态（Pending/Active/Settled/Aborted）；原因码映射。
  - 参数：白名单与上下界；回读校验与回滚。
  - 升级：灰度批次、并发阈值、失败回滚；任务状态追踪。
- 持久化（PG）
  - 分区：`cmd_log_YYYYMMDD`、`telemetry_summary_YYYYMMDD`；旧分区 DROP。
  - 索引：`(phy_id, cmd, ts)`、BRIN(ts)；避免高基数标签索引。
  - 批量：COPY/多值 INSERT；`outbound_queue` 完成即清理，dead 审计。
- 管理/观测
  - REST：设备/会话/控制/参数/升级/订单/日志；只保留必要动作；OpenAPI 单源维护。
  - 指标：连接/在线/QPS/p95-p99/82成功率/重发率/DB写延迟/队列长度；降基数聚合。
  - 安全：API Key + HMAC 签名、IP 白名单、日志脱敏、审计留痕（不引入 RBAC）。

### 附：模块文档目录

- 接入网关：`docs/架构/接入网关.md`
- 协议插件：`docs/架构/协议插件.md`
- 会话与路由：`docs/架构/会话与路由.md`
- 领域服务：`docs/架构/领域服务.md`
- 持久化（PG）：`docs/架构/持久化-PG.md`
- 管理与观测：`docs/架构/管理与观测.md`
- 第三方对接：`docs/架构/第三方对接.md`

### 技术栈治理

- 统一参见：`docs/技术栈治理.md`（组件与版本、配置清单、环境矩阵、白名单、ADR）。
