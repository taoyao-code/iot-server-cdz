# IOTæœåŠ¡å™¨æ•°æ®æµå¯è§†åŒ–å›¾è¡¨ ğŸ“Š

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0  
**åˆ›å»ºæ—¶é—´:** 2025-10-20  
**é€‚ç”¨å·¥å…·:** GitHub, GitLab, Typora, VS Code (Mermaidæ’ä»¶)

---

## 1ï¸âƒ£ ç¨‹åºå¯åŠ¨å®Œæ•´æµç¨‹

```mermaid
flowchart TD
    Start([ç¨‹åºå¯åŠ¨ main.go]) --> LoadConfig[åŠ è½½é…ç½®<br/>config.Load]
    LoadConfig --> InitLogger[åˆå§‹åŒ–æ—¥å¿—<br/>logging.InitLogger]
    InitLogger --> BootstrapRun[å¯åŠ¨åº”ç”¨<br/>bootstrap.Run]
    
    BootstrapRun --> Phase1[é˜¶æ®µ1: åŸºç¡€ç»„ä»¶]
    Phase1 --> Metrics[Metrics<br/>PrometheusæŒ‡æ ‡]
    Phase1 --> Ready[Ready<br/>å°±ç»ªæ£€æŸ¥]
    Phase1 --> ServerID[ServerID<br/>å®ä¾‹UUID]
    
    Metrics --> Phase2[é˜¶æ®µ2: Redisåˆå§‹åŒ–]
    Phase2 --> RedisClient[RedisClient<br/>redis:6379]
    
    RedisClient --> Phase3[é˜¶æ®µ3: ä¼šè¯ç®¡ç†]
    Phase3 --> SessionMgr[SessionManager<br/>åˆ†å¸ƒå¼ä¼šè¯]
    Phase3 --> Policy[WeightedPolicy<br/>è´Ÿè½½ç­–ç•¥]
    
    SessionMgr --> Phase4[é˜¶æ®µ4: æ•°æ®åº“]
    Phase4 --> DBConnect[è¿æ¥PostgreSQL<br/>postgres:5432]
    DBConnect --> Migration[æ‰§è¡Œè¿ç§»<br/>db/migrations]
    Migration --> DBPool[è¿æ¥æ± <br/>maxConn=20]
    
    DBPool --> Phase5[é˜¶æ®µ5: ä¸šåŠ¡å¤„ç†å™¨ ğŸ”¥]
    Phase5 --> CreateRepo[åˆ›å»ºRepository]
    Phase5 --> LoadReasonMap[åŠ è½½åŸå› ç æ˜ å°„]
    Phase5 --> CreatePusher[åˆ›å»ºPusher]
    Phase5 --> CreateEventQueue[åˆ›å»ºEventQueue]
    Phase5 --> CreateDeduper[åˆ›å»ºDeduper]
    Phase5 --> CreateOutbound[åˆ›å»ºOutboundAdapter]
    
    CreateRepo --> CreateBKVHandlers[åˆ›å»ºBKV Handlers<br/>6ä¸ªä¾èµ–æ³¨å…¥ ğŸ”¥]
    LoadReasonMap --> CreateBKVHandlers
    CreateOutbound --> CreateBKVHandlers
    CreateEventQueue --> CreateBKVHandlers
    CreateDeduper --> CreateBKVHandlers
    
    CreateBKVHandlers --> Phase6[é˜¶æ®µ6-7: å¯åŠ¨æœåŠ¡]
    Phase6 --> StartHTTP[å¯åŠ¨HTTPæœåŠ¡<br/>ç«¯å£7055]
    Phase6 --> StartWorker[å¯åŠ¨RedisWorker<br/>ä¸‹è¡Œæ¶ˆæ¯]
    Phase6 --> StartEventWorker[å¯åŠ¨EventWorker<br/>äº‹ä»¶æ¨é€]
    
    StartHTTP --> Phase8[é˜¶æ®µ8: å¯åŠ¨TCPæœåŠ¡ ğŸ”¥]
    Phase8 --> CreateTCP[åˆ›å»ºTCPæœåŠ¡å™¨<br/>ç«¯å£7054]
    CreateTCP --> SetHandler[è®¾ç½®ConnHandler<br/>é—­åŒ…ä¼ é€’BKVHandlers]
    SetHandler --> StartTCP[å¯åŠ¨TCPç›‘å¬]
    
    StartTCP --> Running([æœåŠ¡è¿è¡Œä¸­])
    
    style CreateBKVHandlers fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style SetHandler fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style Phase5 fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style Phase8 fill:#ffd43b,stroke:#fab005,stroke-width:2px
```

---

## 2ï¸âƒ£ TCPè¿æ¥å¤„ç†æµç¨‹

```mermaid
flowchart TD
    Device[è®¾å¤‡å‘èµ·TCPè¿æ¥] --> TCPAccept[TCPæœåŠ¡å™¨æ¥å—è¿æ¥<br/>ç«¯å£7054]
    TCPAccept --> CreateConn[åˆ›å»ºConnContext<br/>conn + ctx]
    CreateConn --> CallHandler[è°ƒç”¨ConnHandler]
    
    CallHandler --> CreateAdapters[åˆ›å»ºåè®®é€‚é…å™¨]
    CreateAdapters --> AP3000Adapter[AP3000 Adapter]
    CreateAdapters --> BKVAdapter[BKV Adapter ğŸ”¥]
    
    BKVAdapter --> RegisterCmds[æ³¨å†Œ24ä¸ªå‘½ä»¤<br/>0x0000-0x1017]
    RegisterCmds --> Cmd0000[0x0000 å¿ƒè·³]
    RegisterCmds --> Cmd0005[0x0005 ç½‘ç»œå…¥ç½‘]
    RegisterCmds --> Cmd000B[0x000B åˆ·å¡]
    RegisterCmds --> Cmd0015[0x0015 å¤šåŠŸèƒ½]
    RegisterCmds --> CmdMore[...]
    
    RegisterCmds --> CreateMux[åˆ›å»ºMux<br/>åè®®è·¯ç”±å™¨]
    CreateMux --> BindConn[ç»‘å®šåˆ°è¿æ¥<br/>mux.BindToConn]
    
    BindConn --> WaitData[ç­‰å¾…æ•°æ®åŒ…]
    WaitData --> RecvData[æ¥æ”¶æ•°æ®]
    RecvData --> ParseFrame[è§£æå¸§ç»“æ„<br/>fcfe...fcee]
    
    ParseFrame --> RouteCmd{è·¯ç”±å‘½ä»¤}
    RouteCmd -->|0x0000| HeartbeatHandler[HandleHeartbeat]
    RouteCmd -->|0x000B| CardSwipeHandler[HandleCardSwipe]
    RouteCmd -->|0x0015| MultiFuncHandler[HandleMultiFunctionCmd]
    RouteCmd -->|å…¶ä»–| OtherHandler[å…¶ä»–Handler]
    
    HeartbeatHandler --> ProcessLogic[ä¸šåŠ¡é€»è¾‘å¤„ç†]
    CardSwipeHandler --> ProcessLogic
    MultiFuncHandler --> ProcessLogic
    OtherHandler --> ProcessLogic
    
    ProcessLogic --> WaitData
    
    RecvData -->|è¿æ¥æ–­å¼€| Cleanup[æ¸…ç†ä¼šè¯]
    Cleanup --> End([è¿æ¥ç»“æŸ])
    
    style BKVAdapter fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style RegisterCmds fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style ProcessLogic fill:#51cf66,stroke:#2f9e44,stroke-width:2px
```

---

## 3ï¸âƒ£ BKVåè®®æ•°æ®åŒ…å¤„ç†æµç¨‹

```mermaid
flowchart TD
    RawData[åŸå§‹TCPæ•°æ®<br/>[]byte] --> MuxRead[Mux.Read]
    MuxRead --> ReadHeader[è¯»å–å¸§å¤´<br/>0xFCFE/0xFCFF]
    
    ReadHeader --> IdentifyProto{è¯†åˆ«åè®®}
    IdentifyProto -->|0xFCFE/0xFCFF| BKVProto[BKVåè®® ğŸ”¥]
    IdentifyProto -->|å…¶ä»–| AP3000Proto[AP3000åè®®]
    
    BKVProto --> BKVDecode[BKV Parserè§£æ]
    BKVDecode --> ParseHeader[è§£æå¸§å¤´<br/>2å­—èŠ‚]
    ParseHeader --> ParseLen[è§£æé•¿åº¦<br/>2å­—èŠ‚]
    ParseLen --> ParseCmd[è§£æå‘½ä»¤<br/>2å­—èŠ‚ ğŸ”¥]
    ParseCmd --> ParseMsgID[è§£ææ¶ˆæ¯ID<br/>4å­—èŠ‚]
    ParseMsgID --> ParseDir[è§£ææ–¹å‘<br/>1å­—èŠ‚]
    ParseDir --> ParseGwID[è§£æç½‘å…³ID<br/>7å­—èŠ‚]
    ParseGwID --> ParseData[è§£ææ•°æ®<br/>å¯å˜é•¿åº¦]
    ParseData --> ParseChecksum[è§£ææ ¡éªŒå’Œ<br/>1å­—èŠ‚]
    ParseChecksum --> ParseTail[è§£æå¸§å°¾<br/>1å­—èŠ‚]
    
    ParseTail --> Validate{éªŒè¯}
    Validate -->|å¤±è´¥| ParseError[è§£æé”™è¯¯]
    Validate -->|æˆåŠŸ| CreateFrame[åˆ›å»ºFrameå¯¹è±¡]
    
    CreateFrame --> RouteByCmd[æ ¹æ®å‘½ä»¤ç è·¯ç”±]
    RouteByCmd --> FindHandler{æŸ¥æ‰¾Handler}
    FindHandler -->|æœªæ³¨å†Œ| NoHandler[æœªæ³¨å†Œé”™è¯¯]
    FindHandler -->|å·²æ³¨å†Œ| WrapHandler[wrapBKVHandler]
    
    WrapHandler --> Metrics[æŒ‡æ ‡ä¸ŠæŠ¥<br/>BKVRouteTotal]
    Metrics --> BindSession[ä¼šè¯ç»‘å®š<br/>bindIfNeeded]
    BindSession --> GetHandlers[è·å–Handlers<br/>getBKVHandlers ğŸ”¥]
    
    GetHandlers --> NilCheck{ç©ºæŒ‡é’ˆæ£€æŸ¥}
    NilCheck -->|nil| ReturnNil[è¿”å›nil]
    NilCheck -->|æœ‰æ•ˆ| CallHandler[è°ƒç”¨Handleræ–¹æ³•]
    
    CallHandler --> HandlerLogic[Handlerä¸šåŠ¡é€»è¾‘]
    HandlerLogic --> Success[å¤„ç†æˆåŠŸ]
    
    style ParseCmd fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style GetHandlers fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style HandlerLogic fill:#51cf66,stroke:#2f9e44,stroke-width:2px
```

---

## 4ï¸âƒ£ BKV Handlerä¸šåŠ¡é€»è¾‘æµç¨‹

```mermaid
flowchart TD
    CallHandler[è°ƒç”¨Handleræ–¹æ³•<br/>HandleXxx] --> NilCheck{ç©ºæŒ‡é’ˆæ£€æŸ¥}
    NilCheck -->|h == nil| ReturnNil1[è¿”å›nil]
    NilCheck -->|h.Repo == nil| ReturnNil2[è¿”å›nil]
    NilCheck -->|æœ‰æ•ˆ| ExtractInfo[æå–è®¾å¤‡ä¿¡æ¯<br/>frame.GatewayID]
    
    ExtractInfo --> DBOps[æ•°æ®åº“æ“ä½œ ğŸ”¥]
    DBOps --> EnsureDevice[EnsureDevice<br/>ç¡®ä¿è®¾å¤‡å­˜åœ¨]
    EnsureDevice --> GetDeviceID[è·å–DeviceID]
    
    GetDeviceID --> ParsePayload[è§£æè½½è·æ•°æ®<br/>TLVè§£æ]
    ParsePayload --> UpdateDB[æ›´æ–°æ•°æ®åº“]
    
    UpdateDB --> UpsertPort[UpsertPortState<br/>æ›´æ–°ç«¯å£çŠ¶æ€]
    UpdateDB --> UpsertOrder[UpsertOrderProgress<br/>æ›´æ–°è®¢å•]
    UpdateDB --> InsertLog[InsertCmdLog<br/>è®°å½•å‘½ä»¤æ—¥å¿—]
    
    UpsertPort --> EventCheck{éœ€è¦æ¨é€äº‹ä»¶?}
    UpsertOrder --> EventCheck
    InsertLog --> EventCheck
    
    EventCheck -->|å¦| ReturnSuccess[è¿”å›æˆåŠŸ]
    EventCheck -->|æ˜¯| CheckEventQueue{EventQueueå­˜åœ¨?}
    
    CheckEventQueue -->|nil| ReturnSuccess
    CheckEventQueue -->|å­˜åœ¨| CreateEvent[åˆ›å»ºäº‹ä»¶å¯¹è±¡<br/>StandardEvent]
    
    CreateEvent --> CheckDeduper{Deduperå­˜åœ¨?}
    CheckDeduper -->|nil| EnqueueEvent[å…¥é˜Ÿäº‹ä»¶<br/>EventQueue.Enqueue]
    CheckDeduper -->|å­˜åœ¨| CalcFingerprint[è®¡ç®—äº‹ä»¶æŒ‡çº¹<br/>hashå‡½æ•°]
    
    CalcFingerprint --> DedupCheck[Rediså»é‡æ£€æŸ¥<br/>SETNX]
    DedupCheck -->|é‡å¤| SkipEvent[è·³è¿‡äº‹ä»¶]
    DedupCheck -->|é¦–æ¬¡| EnqueueEvent
    
    EnqueueEvent --> RedisPush[Redis RPUSH<br/>thirdparty:event:queue]
    RedisPush --> ReturnSuccess
    
    SkipEvent --> ReturnSuccess
    ReturnSuccess --> End([å¤„ç†å®Œæˆ])
    
    style DBOps fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style CheckEventQueue fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style CheckDeduper fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style ReturnSuccess fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#fff
```

---

## 5ï¸âƒ£ äº‹ä»¶æ¨é€åå°å¤„ç†æµç¨‹

```mermaid
flowchart TD
    Start([EventQueue Workerå¯åŠ¨<br/>3ä¸ªWorkerå¹¶å‘]) --> BLPop[Redis BLPOP<br/>thirdparty:event:queue<br/>è¶…æ—¶5ç§’]
    
    BLPop -->|æ— æ•°æ®| BLPop
    BLPop -->|æœ‰æ•°æ®| GetEvent[è·å–äº‹ä»¶JSON]
    
    GetEvent --> Unmarshal[è§£æJSON<br/>json.Unmarshal]
    Unmarshal --> PrepareReq[å‡†å¤‡HTTPè¯·æ±‚]
    
    PrepareReq --> SetURL[è®¾ç½®URL<br/>cfg.WebhookURL]
    SetURL --> SetMethod[è®¾ç½®Method<br/>POST]
    SetMethod --> SetHeaders[è®¾ç½®Headers]
    
    SetHeaders --> CalcSig[è®¡ç®—ç­¾å<br/>HMAC-SHA256]
    CalcSig --> SetSigHeader[X-Signature: xxx]
    SetSigHeader --> SetBody[è®¾ç½®Body<br/>äº‹ä»¶JSON]
    
    SetBody --> SendReq[å‘é€HTTPè¯·æ±‚<br/>http.Post]
    SendReq --> CheckResp{æ£€æŸ¥å“åº”}
    
    CheckResp -->|200-299| Success[æ¨é€æˆåŠŸ]
    CheckResp -->|4xx/5xx| Failed[æ¨é€å¤±è´¥]
    CheckResp -->|è¶…æ—¶/ç½‘ç»œé”™è¯¯| Failed
    
    Success --> LogSuccess[è®°å½•æˆåŠŸæ—¥å¿—]
    LogSuccess --> MetricsSuccess[æŒ‡æ ‡ä¸ŠæŠ¥<br/>event_pushed_total]
    MetricsSuccess --> BLPop
    
    Failed --> IncrRetry[é‡è¯•è®¡æ•°+1]
    IncrRetry --> CheckRetry{é‡è¯•æ¬¡æ•° < 5?}
    
    CheckRetry -->|æ˜¯| CalcDelay[è®¡ç®—å»¶è¿Ÿ<br/>2^retries ç§’]
    CalcDelay --> Sleep[ç­‰å¾…]
    Sleep --> RePush[é‡æ–°å…¥é˜Ÿ<br/>RPUSH queue]
    RePush --> BLPop
    
    CheckRetry -->|å¦| MoveToDLQ[ç§»è‡³æ­»ä¿¡é˜Ÿåˆ—<br/>RPUSH dlq]
    MoveToDLQ --> LogFailed[è®°å½•å¤±è´¥æ—¥å¿—]
    LogFailed --> MetricsFailed[æŒ‡æ ‡ä¸ŠæŠ¥<br/>event_push_failed_total]
    MetricsFailed --> BLPop
    
    style Success fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#fff
    style Failed fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style MoveToDLQ fill:#fa5252,stroke:#c92a2a,stroke-width:2px
```

---

## 6ï¸âƒ£ ä¸‹è¡Œæ¶ˆæ¯å‘é€æµç¨‹

```mermaid
flowchart TD
    APIReq[APIè¯·æ±‚<br/>POST /api/control] --> ValidateReq[éªŒè¯è¯·æ±‚å‚æ•°]
    ValidateReq --> BuildCmd[æ„é€ BKVå‘½ä»¤<br/>cmd, data]
    
    BuildCmd --> CallOutbound[è°ƒç”¨OutboundAdapter<br/>SendDownlink]
    CallOutbound --> BuildFrame[æ„é€ ä¸‹è¡Œå¸§<br/>bkv.Build]
    
    BuildFrame --> SetHeader[è®¾ç½®å¸§å¤´<br/>0xFCFF ä¸‹è¡Œ]
    SetHeader --> SetLen[è®¾ç½®é•¿åº¦]
    SetLen --> SetCmd[è®¾ç½®å‘½ä»¤ç ]
    SetCmd --> SetMsgID[è®¾ç½®æ¶ˆæ¯ID]
    SetMsgID --> SetDir[è®¾ç½®æ–¹å‘<br/>0x81]
    SetDir --> SetGwID[è®¾ç½®ç½‘å…³ID]
    SetGwID --> SetData[è®¾ç½®æ•°æ®]
    SetData --> CalcChecksum[è®¡ç®—æ ¡éªŒå’Œ]
    CalcChecksum --> SetTail[è®¾ç½®å¸§å°¾<br/>0xFCEE]
    
    SetTail --> GetDeviceID[è·å–DeviceID<br/>repo.EnsureDevice]
    GetDeviceID --> InsertPG[æ’å…¥PostgreSQLé˜Ÿåˆ—<br/>outbound_queue]
    
    InsertPG --> PushRedis[æ¨é€Redisé˜Ÿåˆ—<br/>RPUSH]
    PushRedis --> ReturnAPI[è¿”å›APIå“åº”]
    
    PushRedis --> WorkerBLPop[RedisWorkeræ¥æ”¶<br/>BLPOP]
    WorkerBLPop --> ParseMsg[è§£ææ¶ˆæ¯]
    ParseMsg --> GetConn{è·å–è®¾å¤‡è¿æ¥<br/>sess.GetConn}
    
    GetConn -->|ä¸å­˜åœ¨| LogOffline[è®°å½•è®¾å¤‡ç¦»çº¿]
    GetConn -->|å­˜åœ¨| SendToDevice[å‘é€åˆ°è®¾å¤‡<br/>conn.Write]
    
    SendToDevice --> WaitACK{ç­‰å¾…ACK?}
    WaitACK -->|å¦| Complete[å®Œæˆ]
    WaitACK -->|æ˜¯| SetTimeout[è®¾ç½®è¶…æ—¶30ç§’]
    
    SetTimeout --> WaitResp[ç­‰å¾…å“åº”]
    WaitResp -->|è¶…æ—¶| LogTimeout[è®°å½•è¶…æ—¶]
    WaitResp -->|æ”¶åˆ°ACK| LogSuccess[è®°å½•æˆåŠŸ]
    
    LogTimeout --> Complete
    LogSuccess --> Complete
    LogOffline --> Complete
    
    Complete --> End([å‘é€å®Œæˆ])
    
    style BuildFrame fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style SendToDevice fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#fff
```

---

## 7ï¸âƒ£ ä¼šè¯ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    TCPAccept[TCPè¿æ¥å»ºç«‹] --> FirstPacket[æ¥æ”¶ç¬¬ä¸€ä¸ªæ•°æ®åŒ…<br/>é€šå¸¸æ˜¯å¿ƒè·³]
    FirstPacket --> ExtractPhyID[æå–ç½‘å…³ID<br/>frame.GatewayID]
    
    ExtractPhyID --> CheckBound{å·²ç»‘å®š?}
    CheckBound -->|æ˜¯ä¸”ç›¸åŒ| SkipBind[è·³è¿‡ç»‘å®š]
    CheckBound -->|å¦æˆ–ä¸åŒ| BindSession[ç»‘å®šä¼šè¯<br/>sess.Bind]
    
    BindSession --> GenConnID[ç”ŸæˆConnID<br/>uuid.New]
    GenConnID --> SaveLocal[ä¿å­˜æœ¬åœ°è¿æ¥<br/>localConn map]
    SaveLocal --> SaveRedis[ä¿å­˜åˆ°Redis]
    
    SaveRedis --> SetDevice[SET session:device:{phyID}<br/>conn_id, server_id, last_seen]
    SetDevice --> SetConn[SET session:conn:{connID}<br/>phyID]
    SetConn --> SetServer[SADD session:server:{serverID}:conns<br/>connID]
    SetServer --> SetTTL[EXPIRE 360ç§’]
    
    SetTTL --> UpdateBound[æ›´æ–°boundPhy]
    UpdateBound --> SkipBind
    
    SkipBind --> ProcessData[å¤„ç†æ•°æ®åŒ…]
    ProcessData --> Heartbeat{æ˜¯å¿ƒè·³?}
    
    Heartbeat -->|æ˜¯| UpdateSession[æ›´æ–°ä¼šè¯<br/>sess.OnHeartbeat]
    UpdateSession --> RefreshRedis[åˆ·æ–°Redis TTL<br/>EXPIRE 360]
    RefreshRedis --> WaitNext[ç­‰å¾…ä¸‹ä¸€ä¸ªåŒ…]
    
    Heartbeat -->|å¦| WaitNext
    WaitNext --> NextPacket{æ”¶åˆ°æ•°æ®?}
    
    NextPacket -->|æ˜¯| ProcessData
    NextPacket -->|è¿æ¥æ–­å¼€| Unbind[è§£ç»‘ä¼šè¯<br/>sess.UnbindByPhy]
    
    Unbind --> DelDevice[DEL session:device:{phyID}]
    DelDevice --> DelConn[DEL session:conn:{connID}]
    DelConn --> DelServer[SREM session:server:{serverID}:conns]
    DelServer --> DelLocal[åˆ é™¤æœ¬åœ°è¿æ¥<br/>delete localConn]
    
    DelLocal --> LogClosed[è®°å½•TCPå…³é—­<br/>sess.OnTCPClosed]
    LogClosed --> UpdateMetrics[æ›´æ–°æŒ‡æ ‡<br/>SessionOfflineTotal]
    UpdateMetrics --> End([è¿æ¥ç»“æŸ])
    
    style BindSession fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style SaveRedis fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style Unbind fill:#fa5252,stroke:#c92a2a,stroke-width:2px
```

---

## 8ï¸âƒ£ å®Œæ•´å¿ƒè·³å¤„ç†æ•°æ®æµ

```mermaid
sequenceDiagram
    participant D as è®¾å¤‡<br/>82200520004869
    participant T as TCPæœåŠ¡å™¨<br/>7065
    participant M as Mux<br/>åè®®è·¯ç”±
    participant A as BKV Adapter<br/>è§£æå™¨
    participant R as Router<br/>å‘½ä»¤è·¯ç”±
    participant H as BKV Handler<br/>HandleHeartbeat
    participant DB as PostgreSQL<br/>æ•°æ®åº“
    participant RD as Redis<br/>ä¼šè¯/é˜Ÿåˆ—
    participant W as EventWorker<br/>åå°ä»»åŠ¡
    participant WH as Webhook<br/>ç¬¬ä¸‰æ–¹
    
    D->>T: TCPè¿æ¥
    T->>M: åˆ›å»ºConnContext
    M->>A: æ³¨å†ŒBKVåè®®
    Note over A: æ³¨å†Œ24ä¸ªå‘½ä»¤
    
    D->>T: å‘é€å¿ƒè·³åŒ…<br/>fcfe 002e 0000...
    T->>M: æ¥æ”¶åŸå§‹æ•°æ®
    M->>A: è¯†åˆ«åè®® 0xFCFE
    A->>A: è§£æå¸§ç»“æ„
    Note over A: å‘½ä»¤: 0x0000<br/>ç½‘å…³ID: 82200520004869
    
    A->>R: è·¯ç”±å‘½ä»¤ 0x0000
    R->>R: wrapBKVHandleræ‰§è¡Œ
    Note over R: 1. æŒ‡æ ‡ä¸ŠæŠ¥<br/>2. ä¼šè¯ç»‘å®š<br/>3. è·å–Handlers
    
    R->>RD: ç»‘å®šä¼šè¯
    RD-->>R: ä¼šè¯å·²ç»‘å®š
    
    R->>H: è°ƒç”¨HandleHeartbeat
    H->>H: ç©ºæŒ‡é’ˆæ£€æŸ¥
    Note over H: h != nil<br/>h.Repo != nil
    
    H->>DB: EnsureDevice(phyID)
    DB-->>H: deviceID = 123
    
    H->>DB: InsertCmdLog(...)
    DB-->>H: æ—¥å¿—å·²è®°å½•
    
    H->>H: æ£€æŸ¥EventQueue
    Note over H: h.EventQueue != nil
    
    H->>H: åˆ›å»ºäº‹ä»¶å¯¹è±¡
    Note over H: event_type: device.heartbeat
    
    H->>H: æ£€æŸ¥Deduper
    Note over H: h.Deduper != nil
    
    H->>RD: å»é‡æ£€æŸ¥<br/>SETNX dedup:{fingerprint}
    RD-->>H: è¿”å›1 (é¦–æ¬¡)
    
    H->>RD: å…¥é˜Ÿäº‹ä»¶<br/>RPUSH event:queue
    RD-->>H: å…¥é˜ŸæˆåŠŸ
    
    H-->>R: è¿”å›nil (æˆåŠŸ)
    R-->>A: å¤„ç†å®Œæˆ
    
    Note over W: åå°Workerç›‘å¬
    W->>RD: BLPOP event:queue
    RD-->>W: è·å–äº‹ä»¶
    
    W->>WH: POST /webhook<br/>X-Signature: xxx
    WH-->>W: 200 OK
    
    W->>W: è®°å½•æˆåŠŸ
    Note over W: æŒ‡æ ‡ä¸ŠæŠ¥
    
    H->>RD: æ›´æ–°ä¼šè¯TTL<br/>EXPIRE 360
    RD-->>H: TTLå·²åˆ·æ–°
```

---

## 9ï¸âƒ£ ä¾èµ–å…³ç³»å›¾

```mermaid
graph TB
    subgraph "ç¨‹åºå…¥å£"
        Main[main.go]
    end
    
    subgraph "å¯åŠ¨å±‚"
        Bootstrap[bootstrap.Run]
        Config[é…ç½®åŠ è½½]
        Logger[æ—¥å¿—åˆå§‹åŒ–]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        Redis[Redis<br/>ä¼šè¯/é˜Ÿåˆ—/å»é‡]
        PostgreSQL[PostgreSQL<br/>æŒä¹…åŒ–å­˜å‚¨]
        Prometheus[Prometheus<br/>æŒ‡æ ‡ç›‘æ§]
    end
    
    subgraph "æ ¸å¿ƒç»„ä»¶å±‚"
        SessionMgr[SessionManager<br/>åˆ†å¸ƒå¼ä¼šè¯]
        Repository[Repository<br/>æ•°æ®è®¿é—®]
        ReasonMap[ReasonMap<br/>åŸå› ç æ˜ å°„]
        EventQueue[EventQueue<br/>äº‹ä»¶é˜Ÿåˆ—]
        Deduper[Deduper<br/>å»é‡å™¨]
        OutboundAdapter[OutboundAdapter<br/>ä¸‹è¡Œé€‚é…å™¨]
        Pusher[Pusher<br/>Webhookæ¨é€]
    end
    
    subgraph "ä¸šåŠ¡å¤„ç†å±‚ ğŸ”¥"
        BKVHandlers[BKV Handlers<br/>6ä¸ªä¾èµ–]
        AP3000Handlers[AP3000 Handlers]
    end
    
    subgraph "ç½‘ç»œå±‚"
        HTTPServer[HTTP Server<br/>7055]
        TCPServer[TCP Server<br/>7065]
        ConnHandler[ConnHandler<br/>è¿æ¥å¤„ç†]
    end
    
    subgraph "åè®®å±‚"
        BKVAdapter[BKV Adapter<br/>24ä¸ªå‘½ä»¤]
        AP3000Adapter[AP3000 Adapter]
        Mux[Mux<br/>åè®®è·¯ç”±]
    end
    
    subgraph "åå°ä»»åŠ¡å±‚"
        RedisWorker[RedisWorker<br/>ä¸‹è¡Œæ¶ˆæ¯]
        EventWorker[EventWorker<br/>äº‹ä»¶æ¨é€]
    end
    
    Main --> Bootstrap
    Bootstrap --> Config
    Bootstrap --> Logger
    
    Bootstrap --> Redis
    Bootstrap --> PostgreSQL
    Bootstrap --> Prometheus
    
    Redis --> SessionMgr
    Redis --> EventQueue
    Redis --> Deduper
    
    PostgreSQL --> Repository
    PostgreSQL --> OutboundAdapter
    
    Repository --> BKVHandlers
    ReasonMap --> BKVHandlers
    EventQueue --> BKVHandlers
    Deduper --> BKVHandlers
    OutboundAdapter --> BKVHandlers
    
    BKVHandlers --> ConnHandler
    AP3000Handlers --> ConnHandler
    SessionMgr --> ConnHandler
    
    ConnHandler --> BKVAdapter
    ConnHandler --> AP3000Adapter
    BKVAdapter --> Mux
    AP3000Adapter --> Mux
    
    Mux --> TCPServer
    TCPServer --> Bootstrap
    
    HTTPServer --> Bootstrap
    
    OutboundAdapter --> RedisWorker
    SessionMgr --> RedisWorker
    
    EventQueue --> EventWorker
    Pusher --> EventWorker
    
    RedisWorker --> Bootstrap
    EventWorker --> Bootstrap
    
    style BKVHandlers fill:#ff6b6b,stroke:#c92a2a,stroke-width:4px,color:#fff
    style ConnHandler fill:#ffd43b,stroke:#fab005,stroke-width:3px
    style TCPServer fill:#51cf66,stroke:#2f9e44,stroke-width:3px
```

---

## ğŸ”Ÿ æ•°æ®å­˜å‚¨å…³ç³»å›¾

```mermaid
erDiagram
    DEVICES ||--o{ PORTS : has
    DEVICES ||--o{ ORDERS : has
    DEVICES ||--o{ CMD_LOG : has
    DEVICES ||--o{ OUTBOUND_QUEUE : has
    DEVICES ||--o{ GATEWAY_SOCKETS : has
    DEVICES ||--o{ OTA_TASKS : has
    DEVICES ||--o{ DEVICE_PARAMS : has
    DEVICES ||--o{ DEVICE_CARDS : has
    DEVICES ||--o{ CARD_TRANSACTIONS : has
    
    DEVICES {
        bigserial id PK
        varchar phy_id UK "ç½‘å…³ç‰©ç†ID"
        timestamp created_at
        timestamp updated_at
    }
    
    PORTS {
        bigserial id PK
        bigint device_id FK
        int port_no
        int status "ç«¯å£çŠ¶æ€"
        int power_w "åŠŸç‡"
        timestamp updated_at
    }
    
    ORDERS {
        bigserial id PK
        bigint device_id FK
        int port_no
        varchar order_no UK "è®¢å•å·"
        bigint kwh_0p01 "ç”µé‡(0.01åº¦)"
        int status "è®¢å•çŠ¶æ€"
        timestamp start_time
        timestamp created_at
        timestamp updated_at
    }
    
    CMD_LOG {
        bigserial id PK
        bigint device_id FK
        bigint msg_id "æ¶ˆæ¯ID"
        int cmd "å‘½ä»¤ç "
        int direction "æ–¹å‘"
        bytea payload "è½½è·"
        boolean success "æ˜¯å¦æˆåŠŸ"
        timestamp created_at
    }
    
    OUTBOUND_QUEUE {
        bigserial id PK
        bigint device_id FK
        varchar phy_id "ç½‘å…³ID"
        int cmd "å‘½ä»¤ç "
        bytea payload "è½½è·"
        int priority "ä¼˜å…ˆçº§"
        bigint msg_id "æ¶ˆæ¯ID"
        timestamp created_at
    }
    
    GATEWAY_SOCKETS {
        bigserial id PK
        bigint device_id FK
        int socket_no "æ’åº§å·"
        boolean online "åœ¨çº¿çŠ¶æ€"
        varchar version "ç‰ˆæœ¬å·"
        timestamp created_at
        timestamp updated_at
    }
    
    OTA_TASKS {
        bigserial id PK
        bigint device_id FK
        varchar file_url "å‡çº§æ–‡ä»¶URL"
        varchar version "ç›®æ ‡ç‰ˆæœ¬"
        int status "ä»»åŠ¡çŠ¶æ€"
        timestamp created_at
        timestamp updated_at
    }
    
    DEVICE_PARAMS {
        bigserial id PK
        bigint device_id FK
        varchar param_name "å‚æ•°å"
        varchar param_value "å‚æ•°å€¼"
        timestamp created_at
        timestamp updated_at
    }
    
    DEVICE_CARDS {
        bigserial id PK
        bigint device_id FK
        varchar card_no "å¡å·"
        varchar card_type "å¡ç±»å‹"
        timestamp created_at
    }
    
    CARD_TRANSACTIONS {
        bigserial id PK
        bigint device_id FK
        int port_no
        varchar card_no "å¡å·"
        varchar order_no "è®¢å•å·"
        int action "æ“ä½œç±»å‹"
        timestamp created_at
    }
```

---

## ğŸ“Š Redisæ•°æ®ç»“æ„

```mermaid
graph TB
    subgraph "ä¼šè¯ç®¡ç†"
        SD[session:device:{phyID}<br/>Hash: conn_id, server_id, last_seen]
        SC[session:conn:{connID}<br/>String: phyID]
        SS[session:server:{serverID}:conns<br/>Set: connIDé›†åˆ]
    end
    
    subgraph "æ¶ˆæ¯é˜Ÿåˆ—"
        OQ[outbound:queue:{serverID}<br/>List: ä¸‹è¡Œæ¶ˆæ¯é˜Ÿåˆ—]
        EQ[thirdparty:event:queue<br/>List: äº‹ä»¶é˜Ÿåˆ—]
        DLQ[thirdparty:event:dlq<br/>List: æ­»ä¿¡é˜Ÿåˆ—]
    end
    
    subgraph "å»é‡"
        DD[thirdparty:dedup:{fingerprint}<br/>String: 1, TTL=3600]
    end
    
    subgraph "ä¸´æ—¶æ•°æ®"
        ACK[ack:{msgID}<br/>String: response, TTL=30]
    end
    
    style SD fill:#4dabf7,stroke:#1971c2,stroke-width:2px
    style EQ fill:#ffd43b,stroke:#fab005,stroke-width:2px
    style DD fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
```

---

## âœ… æ–‡æ¡£ä½¿ç”¨è¯´æ˜

### æŸ¥çœ‹æ–¹å¼

1. **GitHub/GitLab**: ç›´æ¥åœ¨ä»“åº“ä¸­æŸ¥çœ‹ï¼Œè‡ªåŠ¨æ¸²æŸ“Mermaidå›¾è¡¨
2. **Typora**: æ”¯æŒMermaidçš„Markdownç¼–è¾‘å™¨
3. **VS Code**: å®‰è£… "Markdown Preview Mermaid Support" æ’ä»¶
4. **åœ¨çº¿å·¥å…·**: å¤åˆ¶åˆ° [Mermaid Live Editor](https://mermaid.live/)

### å›¾è¡¨è¯´æ˜

- ğŸ”¥ **çº¢è‰²é«˜äº®**: æ ¸å¿ƒå…³é”®èŠ‚ç‚¹ï¼ˆBKV Handlersã€é—­åŒ…ä¼ é€’ç­‰ï¼‰
- ğŸŸ¡ **é»„è‰²é«˜äº®**: é‡è¦é˜¶æ®µï¼ˆå¯åŠ¨é˜¶æ®µã€å‘½ä»¤æ³¨å†Œç­‰ï¼‰
- ğŸŸ¢ **ç»¿è‰²é«˜äº®**: æˆåŠŸå®ŒæˆçŠ¶æ€

### å›¾è¡¨ç´¢å¼•

| å›¾è¡¨ | æè¿° | å…³é”®ç‚¹ |
|------|------|--------|
| **å›¾1** | ç¨‹åºå¯åŠ¨å®Œæ•´æµç¨‹ | 9ä¸ªå¯åŠ¨é˜¶æ®µï¼ŒBKV Handlersåˆå§‹åŒ– |
| **å›¾2** | TCPè¿æ¥å¤„ç†æµç¨‹ | 24ä¸ªå‘½ä»¤æ³¨å†Œï¼Œåè®®è·¯ç”± |
| **å›¾3** | BKVæ•°æ®åŒ…å¤„ç† | å¸§è§£æï¼Œå‘½ä»¤è·¯ç”±ï¼ŒHandlerè°ƒç”¨ |
| **å›¾4** | Handlerä¸šåŠ¡é€»è¾‘ | æ•°æ®åº“æ“ä½œï¼Œäº‹ä»¶æ¨é€ï¼Œå»é‡ |
| **å›¾5** | äº‹ä»¶æ¨é€æµç¨‹ | 3ä¸ªWorkerï¼Œé‡è¯•æœºåˆ¶ï¼Œæ­»ä¿¡é˜Ÿåˆ— |
| **å›¾6** | ä¸‹è¡Œæ¶ˆæ¯å‘é€ | Redisé˜Ÿåˆ—ï¼Œè¿æ¥è·å–ï¼ŒACKç­‰å¾… |
| **å›¾7** | ä¼šè¯ç®¡ç†æµç¨‹ | Redisåˆ†å¸ƒå¼ä¼šè¯ï¼ŒTTLåˆ·æ–° |
| **å›¾8** | å¿ƒè·³æ—¶åºå›¾ | å®Œæ•´æ•°æ®æµï¼Œæ‰€æœ‰ç»„ä»¶äº¤äº’ |
| **å›¾9** | ä¾èµ–å…³ç³»å›¾ | ç»„ä»¶ä¾èµ–ï¼Œæ•°æ®æµå‘ |
| **å›¾10** | æ•°æ®å­˜å‚¨ERå›¾ | 9å¼ è¡¨ï¼Œå…³ç³»æ˜ å°„ |

---

**æ‰€æœ‰å¯è§†åŒ–å›¾è¡¨å·²å®Œæˆï¼å¯ç›´æ¥åœ¨æ”¯æŒMermaidçš„å·¥å…·ä¸­æŸ¥çœ‹ï¼** ğŸ‰
