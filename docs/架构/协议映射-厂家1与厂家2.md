## 协议映射（厂家1：BKV/组网；厂家2：AP3000/主机）

### 1. 目的与范围

- 统一两家协议至平台数据模型（device/port/order/event）与控制契约（82/参数/升级）。
- 明确状态/原因/模式/参数键的映射、校验差异、能力矩阵与降级策略。

### 2. 统一数据模型（摘要）

- device: {vendor, phyId, iccid, imei, type, fw, ports, virtualId?}
- port: {portNo, state(enum), metrics:{v_dv,i_ma,p_dw}, temp, updatedAt}
- order: {orderId, phyId, portNo, mode(enum: time|kwh|power), startTs, endTs, kwh, peakW, reason(enum)}
- event: {kind(enum: alarm|exception|upgrade|status), severity, portNo?, meta(json), ts}

### 3. 状态码映射（端口 state）

| 平台枚举 | 含义 | 厂家1(BKV) 示例 | 厂家2(AP3000) 示例 |
| --- | --- | --- | --- |
| idle | 空闲 | 状态位 0x98 bit 置位解析为空闲 | 21端口状态=0 |
| charging | 充电中 | 状态位显示“充电” | 21端口状态=1 |
| float | 浮充 | 无（N/A） | 21端口状态=5 |
| full | 已充满未断电 | 结束原因/状态组合判定 | 21端口状态=3 |
| fault_contact | 接触不良/保险丝 | 结束/状态字段 | 21端口状态=0x0E/0x08 等 |
| fault_mem | 存储器损坏 | N/A | 21端口状态=6 |
| blocked | 弹片卡住 | N/A | 21端口状态=7 |
| unknown | 未知/保留 | 其他 | 其他 |

说明：BKV 状态需由“插孔属性/温度/功率/RSSI 与事件原因”合成；AP3000 直接使用 21 的端口状态字节。

### 4. 订单结束原因映射（reason）

| 平台枚举 | 含义 | 厂家1(BKV) | 厂家2(AP3000) 03.reason |
| --- | --- | --- | --- |
| user_unplug | 用户拔出 | 事件/状态判定 | 0x05/0x0D |
| time_reached | 达到预设时间 | 控制模式+时长用尽 | 0x03 |
| kwh_reached | 达到预设电量 | 控制模式+电量用尽 | 0x04 |
| full_stop | 充满自停 | 解析功率曲线/结算功率 | 0x01 |
| low_power | 功率过小/空载 | BKV“空载结束” | 0x09/0x0E |
| overload | 过载/过流 | 事件上报/异常字段 | 0x06/0x0C |
| temp_high | 过温 | 事件/温度阈值 | 0x0A/0x0B |
| forced_stop | 服务器强制停止 | 控制回执 | 0x17 |
| voltage_abn | 过压/欠压 | 异常事件 过压/欠压 | 0x1A/0x1B |
| mem_error | 存储器错误 | N/A | 0x19 |
| max_time_reached | 达到最大充电时间 | 参数/最大时长阈值命中 | 0x02 |
| water_alarm | 水浸断电 | N/A | 0x10 |
| fire_cutoff | 灭火结算 | N/A | 0x11/0x12 |
| door_not_closed | 柜门未关好 | N/A | 0x14 |
| external_stop | 外部操作停止 | N/A | 0x15 |
| swipe_stop | 刷卡操作停止 | 刷卡流程判定 | 0x16 |

#### 4.a AP3000 真实端口状态枚举（21）

| 值 | 含义 |
| --- | --- |
| 0x00 | 空闲 |
| 0x01 | 充电中 |
| 0x02 | 有充电器未充（未启动） |
| 0x03 | 有充电器未充（已充满） |
| 0x04 | 无法计量 |
| 0x05 | 浮充 |
| 0x06 | 存储器损坏 |
| 0x07 | 插座弹片卡住故障 |
| 0x08 | 接触不良或保险丝烧断故障 |
| 0x09 | 继电器粘连（算法） |
| 0x0A | 霍尔开关损坏（插入检测传感器） |
| 0x0B | 预检-继电器坏或保险丝断 |
| 0x0D | 预检-负载短路 |
| 0x0E | 过滤性预检-继电器粘连 |
| 0x0F | 刷卡芯片损坏故障 |
| 0x10 | 检测电路故障 |

#### 4.b AP3000 真实结算结束原因（03）

| 值 | 含义 |
| --- | --- |
| 0x01 | 充满自停 |
| 0x02 | 达到最大充电时间 |
| 0x03 | 达到预设时间 |
| 0x04 | 达到预设电量 |
| 0x05 | 用户拔出 |
| 0x06 | 负载过大 |
| 0x07 | 服务器控制停止 |
| 0x08 | 动态过载 |
| 0x09 | 功率过小 |
| 0x0A | 环境温度过高 |
| 0x0B | 端口温度过高 |
| 0x0C | 过流 |
| 0x0D | 用户拔出-1（弹片卡住可能） |
| 0x0E | 无功率停止（接触不良/保险丝断） |
| 0x0F | 预检-继电器坏或保险丝断 |
| 0x10 | 水浸断电 |
| 0x11 | 灭火结算（本端口） |
| 0x12 | 灭火结算（非本端口） |
| 0x13 | 用户密码开柜断电 |
| 0x14 | 未关好柜门 |
| 0x15 | 外部操作停止 |
| 0x16 | 刷卡操作停止 |
| 0x17 | 服务器强制停止（充电柜强制开柜门） |
| 0x18 | 消防系统触发停止 |
| 0x19 | 存储器错误 |
| 0x1A | 过压 |
| 0x1B | 欠压 |
| 0x1C | 低功率断电 |

#### 4.c 厂家1（BKV）真实状态位与事件字段（组网）

说明：BKV 不直接上送“统一结束原因码”，平台需依据“插座状态位”与“异常事件TLV（0x54/0x55/0x56 等）”推导平台枚举的“状态/结束原因”。以下为可采信的“真实取值与键位”。

- 插座状态位（字段 0x09 的“插座状态”1字节，示例值 0x98/0x90）：

| 掩码 | 名称 | 含义 | 例证 |
| --- | --- | --- | --- |
| 0x80 | online | 在线 | 示例 0x98/0x90 含该位 |
| 0x10 | charging | 充电中 | 示例 0x98/0x90 含该位 |
| 0x08 | no_load | 空载（功率过小） | 示例 0x98 含该位，结论“空载结束”由此推导 |

备注：其余位未在公开资料中明确，诸如“计量异常/温度异常/电流异常/功率异常”等需结合异常事件TLV判断。以上掩码据官方样例帧推导，联调阶段应再校对位义。

- 异常/事件字段 TLV 键位（来自“异常事件上报/结束上报”解析）：

| 键 | 含义 | 说明 |
| --- | --- | --- |
| 0x54 | 插座事件原因 | 单字节原因码，具体取值由厂商定义（如过压/欠压/过温/接触不良等） |
| 0x4B | 插座事件状态 | 单字节状态，配合 0x54 使用 |
| 0x55 | 插孔1事件原因 | 单字节 |
| 0x4C | 插孔1事件状态 | 单字节 |
| 0x56 | 插孔2事件原因 | 单字节 |
| 0x4D | 插孔2事件状态 | 单字节 |
| 0x4E | 过压阈值 | 2字节，单位0.1V |
| 0x4F | 欠压阈值 | 2字节，单位0.1V |
| 0x50 | 插孔1漏电流 | 1字节，单位mA |
| 0x51 | 插孔2漏电流 | 1字节，单位mA |
| 0x52 | 插孔1过温阈值 | 1字节，单位℃（无需换算） |
| 0x53 | 插孔2过温阈值 | 1字节，单位℃（无需换算） |

- 推导规则（平台建议）：
  - 若 `charging=1 且 no_load=1` 持续达到配置阈值（最小功率与时间窗），推导平台 reason=low_power。
  - 若 0x54/0x55/0x56 指示“过压/欠压/过流/过温/接触不良/继电器粘连/短路预检”等，则映射为 voltage_abn/overload/temp_high/fault_contact 等平台枚举。
  - BKV 订单闭环由“结束上报 + 状态位/事件TLV”合成，不以单一枚举值判定。

##### 4.c.1 BKV 结束原因（平台推导枚举与数据来源）

| 平台reason | 数据来源 | 判定要点 |
| --- | --- | --- |
| user_unplug | 状态位变化/功率骤降且非过流 | 充电中→非充/功率→0，无过流、无故障TLV |
| time_reached | 控制模式+时长耗尽 | 订单上下文：按时充；累计时长≥下发值 |
| kwh_reached | 控制模式+电量用尽 | 订单上下文：按量充；累计电量≥下发值 |
| full_stop | 浮充后功率低于阈值且达到“充满最长判断时长” | 82/84 配置+功率曲线 |
| low_power | 状态位no_load=1 且超过最小功率时间窗 | 0x09 位+84 最小功率与时间 |
| overload | 超过过载功率/过流阈值 | 85 过载功率或 0x10 过流阈值触发 |
| temp_high | 达到环境/端口温度阈值 | 84 温度阈值或事件TLV触发 |
| voltage_abn | 过压/欠压触发 | 85 过压/欠压设定或事件TLV（0x4E/0x4F） |
| forced_stop | 服务器主动停止 | 82 停止并回执；结束后1分钟内结算 |
| fault_contact | 接触不良/保险丝/继电器粘连/短路预检 | 事件TLV（接触不良、保险丝断、继电器粘连、负载短路预检） |
| mem_error | 存储器错误 | 设备状态/事件TLV（如存储器异常） |

说明：BKV 文档未公开 0x54/0x55/0x56 的“原因码枚举表”，平台以“规则推导+阈值配置+事件键”归一 reason；联调阶段应补录原因码→平台reason 的映射字典。

##### 4.c.2 BKV 事件原因键的已知取值（采样，需联调补齐）

| 键 | 取值 | 含义（待厂商确值） | 备注 |
| --- | --- | --- | --- |
| 0x54 | 0x08 | 未公开，疑似与电压/功率相关 | 来自“异常事件上报”样例 |
| 0x2F | 0x08 | 分功率充电结束原因=0x08 | 来自“分功率充电结束上报”，需定义语义 |

注：请在联调阶段将采集到的各原因码标注语义后补回本表，作为运行期映射字典的来源。

##### 4.c.3 示例帧与推导过程

1) 按时/按量结束（空载推导）

```292:318:docs/协议/设备对接指引-组网设备2024(1).txt
fcfe00250015000000000186004459453005001102025036302000980068000000010050002d41fcee
...
98 插座状态（10011000）... ---- 由此订单结束原因【空载结束】
```

推导：0x09 状态字节=0x98，包含 charging(0x10)=1 与 no_load(0x08)=1，且功率→0，满足最小功率时间窗，归一为 reason=low_power。

2) 分功率结束（带结束原因字段）

```405:436:docs/协议/设备对接指引-组网设备2024(1).txt
... 0x2E 20240823101729 充电结束时间
0x2F 08 分功率充电结束原因
0x12 04 充电模式
...
```

推导：分功率模式带 0x2F 原因=0x08；当前语义未公开，暂以“分功率结束-08”记录，联调后映射到平台 reason（如 full_stop/low_power/overload 等）。

### 5. 控制命令映射（平台 → 厂商）

平台统一：`82 {mode, balanceOrExpire, port, action, durationOrKwh, orderId, ff, longCharge, extra}`

| 字段 | 平台 | 厂家1(BKV) | 厂家2(AP3000) |
| --- | --- | --- | --- |
| action | start/stop | 命令07 开/关位 | 82充电命令=1/0 |
| mode | time/kwh/power | 开关+时长/电量/分功率表 | 费率模式0/2/充满功率参数 |
| port | 0..N / FF | 插座号/孔位 | 端口号0..N/FF智能 |
| durationOrKwh | 值/单位 | bb80(时长min)/电量wh | 充电时长/电量 2字节 |
| orderId | 16B | 业务号 | 82订单编号(16B) |
| ff | 智能端口 | N/A | 0xFF |
| extra | 长充/充满功率/最长判断 | 见分功率/服务费模式 | 对应 82 附加字段 |

约束：端口范围、最大时长/电量、FF冲突校验，一致回执校验（消息ID/业务号）。

### 6. 参数映射（平台 → 厂商）

平台参数键（示例）：`full_charge_delay, null_charge_delay, full_charge_power, null_charge_power, temp_th, max_charge_time, dynamic_overload_power` …

| 平台键 | 厂家1(BKV) 1011/1012 | 厂家2(AP3000) 83/84/85/86 |
| --- | --- | --- |
| full_charge_delay | 0x21(1C20) | 83/84 组合（浮充判定时间）|
| null_charge_delay | 0x22(0078) | 84 最小功率判定时间 |
| full_charge_power | 0x23(0064) 0.1W | 82/84 充满功率与阈值 |
| null_charge_power | 0x24(0008) 0.1W | 84 最小功率 |
| temp_th | 0x25(55) | 84 环境/端口报警温度 |
| max_charge_time | 0x59(0258) min | 85 最大充电时间 |

校验：白名单与上下界校验；必要回读确认（BKV查询、AP3000 90/91/92/93）。

### 7. 升级流程映射

| 平台 | 厂家1(BKV) | 厂家2(AP3000) |
| --- | --- | --- |
| 触发 | 设置FTP信息/命令 | 0xE0（200B）/0xF8（256B） 分片 |
| 分片 | 由设备拉取或协议指定 | 服务端从包1开始；<=3次重试 |
| 回执 | 帧流水号/ACK | 应答=0成功/1重发；当前包号 |
| 失败 | 重试后回滚 | 重试后回滚；05/FA 触发重发 |

### 8. 时间/ID/校验与端序差异

- BKV：包头 `fcfe/fcff`，帧流水号，校验和，`fcee` 尾；大多为十六进制字段直读。
- AP3000：包头 `DNY`，小端，长度=字段和，16位累加和；消息ID 回显匹配。
- 时间：均使用时间戳或BCD/年月日，平台统一为 UTC 秒。
- 连接建立：AP 系列设备首次连接会主动上送 ICCID（ASCII，长度20）；空闲时模块会发 `link`（ASCII）保活。

### 9. 能力矩阵与降级策略

| 能力 | 厂家1(BKV) | 厂家2(AP3000) | 降级策略 |
| --- | --- | --- | --- |
| FF智能端口 | 否 | 是 | 平台在BKV侧需明确端口 |
| 分功率/服务费 | 是 | 否（标准82外） | 透传为扩展字段或转化为定时/定量 |
| 06功率心跳 | 无 | 有 | BKV用状态上报摘要替代 |
| 升级分片 | FTP/命令 | E0/F8 | 统一重试/回滚语义 |

### 10. 测试与对账规范

- 构建回放集：正常/粘包/半包/错校验/乱序/重发/异常事件。
- 统计对账：订单金额/时长/电量/峰值功率；控制回执匹配。
- 验收阈值：回放通过率≥99%、对账偏差=0、p99≤200ms、82成功率≥99%。

### 11. 版本与兼容

- 记录固件/协议版本差异（新增原因码/字段），新增时通过 ADR 说明兼容策略与回退方案。
