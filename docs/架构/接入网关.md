## 接入网关设计

### 1. 目标

- 稳定承载 TCP 长连接；正确处理半/粘包；执行 DNY+小端+16位校验；实现下行节流与可靠发送；提供统一错误码。

### 2. 数据与状态机

- 帧：DNY(0x44,0x4E,0x59) | 长度 | 物理ID | 消息ID | 命令 | 数据 | 校验(16位)
- 状态机：SYNC→LEN→BODY→CHK；粘包循环读取；半包缓存直至完成。

### 3. 队列与可靠性

- 每设备下行队列：优先级（控制>心跳）；节流0.5s；超时15s+一次重发；失败入 dead 队列审计。
- 冷启续发：扫描 outbound_queue（PG）。

### 4. 错误码与观测

- 错误码字典：帧错/校验错/未知指令/长度越界/速率超限。
- 指标：连接数、解析失败率、端到端延迟p95/p99、队列长度、重发率。

### 5. 安全

- 白名单（IP/设备）、限速；ICCID/IMEI 不落日志；pprof 仅内网。

### 6. 依赖

- 协议插件提供 `Handle(Message)`；仓储提供 `EnqueueOutbound/Dequeue/MarkDone`；配置与限速器。

### 7. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-HTTP]、[TS-Config]、[TS-Log]、[TS-Metrics]、[TS-RateLimit]、[TS-Scheduler]

### 8. 配置键引用（详见 `configs/example.yaml`）

- `gateway.listen`: 监听地址（如 `0.0.0.0:9000`）
- `gateway.read_buffer_bytes`: 读缓冲大小（如 32KB）
- `gateway.write_buffer_bytes`: 写缓冲大小（如 32KB）
- `gateway.throttle_ms`: 单设备下行节流毫秒（默认 500）
- `gateway.ack_timeout_ms`: 应答超时毫秒（默认 15000）
- `gateway.retry_max`: 重发次数（默认 1）
- `gateway.dead_retention_days`: dead 队列保留天数（默认 7）
- `gateway.ip_whitelist`: 允许的源 IP 列表/网段
- `gateway.device_whitelist`: 允许的设备识别（phyId/ICCID 前缀）
- `ratelimit.per_device_qps`: 设备级限速（默认关闭）
- `ratelimit.global_qps`: 全局限速（默认关闭）

### 9. 运维要点

- 系统：`ulimit -n` 提升；`somaxconn`、`rmem/wmem` 调优；多队列网卡与中断亲和。
- 安全：仅内网暴露；必要时通过四层 LB；pprof 限内网；日志脱敏 ICCID/IMEI。
- 容量：心跳对齐抖动可通过随机抖动（设备侧）与网关端队列平滑吸收。

### 10. 验证方法

- 协议回放：正常/粘包/半包/错误校验/越界长度；消息ID 回显一致性。
- 压测：5k 连接、3min 心跳；批量 82 控制延迟 p99≤200ms；重发率<1%。
- 可靠性：宕机重启后，`outbound_queue` 冷启续发成功率≥99%。
