## 协议插件设计

### 1. 目标

- 支持 AP3000 与 主机协议核心指令：20/21/22/12、82、03/06、83/84/85/86、E0/F8。
- 通过路由表集中管理命令→处理器，支持版本/长度差异与向后兼容。

### 2. 接口

- 输入：`Message(phyId,msgId,cmd,payload,ts,meta)`（由接入网关提供）。
- 输出：处理结果与可选下行任务（入 outbound 队列）。

### 3. 路由与兼容

- 路由表：`cmd -> handler`；按长度/固件版本分支处理。
- 策略开关：01/21 互斥、22/12 请求-应答、FF 智能端口、跳过短路检测等配置化。

### 4. 关键指令行为

- 20/21：注册/心跳，更新设备/端口状态，生成心跳摘要。
- 22/12：时间请求，单次成功后周期刷新；无需最终确认。
- 82：启停充；校验端口范围/时长或电量上限/订单号匹配；单设备节流与超时重试由下行队列保证。
- 03/06：结算与功率心跳；闭环订单、计算峰/均值与原因码映射；容忍乱序与重复。
- 83/84/85/86：参数读写；白名单+上下界校验；必要时回读校验。
- E0/F8：升级分片、≤3 次重试、失败记录与回滚。

### 5. 幂等与校验

- 幂等键=(phyId,msgId,cmd)；重复上报合并；下行应答消息ID回显校验。
- 载荷校验：端口号、功率/时长、版本号与长度一致性。

### 6. 指标与验收

- 指标：解析错误率、兼容分支命中率、每指令处理延迟、82 成功率、重复抑制比例。
- 验收：覆盖正常/异常/边界与不同版本长度的回放集；与领域与持久化对账一致。

### 7. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-Config]、[TS-OpenAPI]（仅契约校验需要时）

### 8. 配置项（示例键）

- `protocol.legacy_01_enabled`: 是否兼容01（默认 false）
- `protocol.heartbeat_interval_sec`: 心跳摘要窗口（默认 180）
- `protocol.ff_port_enabled`: 是否启用 FF 智能端口（默认 true）
- `protocol.skip_short_check_mode`: 短路检测策略（0=关闭,1=跳过,2=正常）
- `protocol.max_duration_sec` / `protocol.max_kwh`: 时长/电量上限

### 9. 运维要点

- 回放集维护为“真数据+脱敏”；每次固件变更需要增量回放用例。
- 兼容策略开关灰度发布；和设备固件团队建立版本对照表。

### 10. 验证方法

- 静态用例：长度/版本/边界；动态用例：乱序/重发/重复幂等。
- 对账：与 `orders/cmd_log/telemetry_summary` 聚合一致。

### 11. 服务端协议测试规划（2025-09 补充）

为响应 `protocol-validation-test` 的 31 个场景验收，服务端需补齐以下测试体系：

1. **测试分层**
   - 单元：`internal/protocol/ap3000|bkv|gn` 关键解析/业务方法；UT 校验帧头、校验和、TLV 解析
   - 功能：`internal/tcpserver`、`internal/session`、`internal/protocol/bkv` 与 repo mock 组合，验证会话、订单、端口状态、ACK/重试
   - 集成：`cmd/server` 启动完整服务端，模拟网关 TCP 连接（`net.Pipe`/`bufconn`），断言数据库/日志

2. **场景优先级**
   - P0：心跳上下行、控制命令（按时/按量/按功率）、充电结束上报
   - P1：插座状态上报、异常事件、参数查询/回写、ACK/超时管理
   - P2：OTA 升级、刷卡充电、第三方出站 ACK

3. **测试数据管理**
   - 来源：`protocol-validation-test/testdata/scenarios`；校验帧长与校验和，不足部分依据设备日志或协议文档补完
   - 归档：统一放入 `internal/protocol/<proto>/testdata/`，使用 `.hex`/`.bin`，并记录来源与预期断言

4. **验收流程**
   - 完成上述测试后运行 `protocol-validation-test/scripts/run-all-tests.sh`
   - 对比 `reports/*.json`，确保所有 31 个场景通过；失败时回溯服务端实现或测试数据

> 与 `docs/项目进度与缺失清单.md` 中的“服务端协议完整性测试计划”保持同步。

### 12. 实现映射（代码路径与配置）

- 代码路径：
  - 协议路由占位：`internal/protocol/ap3000/router.go`
  - TCP 接入（提供原始帧）：`internal/tcpserver/server.go`
  - 配置读取：`internal/config/config.go`
  - 解析与路由表：`internal/protocol/ap3000/{frame.go,parser.go,router_table.go}`
  - 主程序接线：`cmd/server/main.go`（TCP → Parse → Route）

- 配置键（对应 `configs/example.yaml`）：
  - `protocol.legacy_01_enabled`, `protocol.heartbeat_interval_sec`, `protocol.ff_port_enabled`
  - `protocol.skip_short_check_mode`, `protocol.max_duration_sec`, `protocol.max_kwh`

- 路线图：
  - 在 `internal/protocol/ap3000` 下新增 `frame.go/parser.go/handlers/*.go`，并为 20/21/22/12/82/03/06 等指令注册路由。
