## 第三方对接（中间件输出）设计

### 1. 目标

- 将设备侧数据（注册/心跳/功率/结算/告警等）规范化后推送给第三方平台；
- 提供第三方控制设备的 API（启停充、参数设置、升级触发），并返回执行结果。

### 2. 数据输出模式

- 推送：HTTP Webhook（重试与签名）或 MQ（可选：Kafka/NATS，MVP 先 HTTP）。
- 拉取：REST 查询（订单/日志/状态）。

### 3. 安全与鉴权

- API Key + HMAC 签名（时间戳+nonce）；IP 白名单；传输 HTTPS（由外层网关承担）。

### 4. 事件与格式（示例字段）

- 设备注册：`{phyId, iccid, imei, type, fw, ports, ts}`
- 心跳摘要：`{phyId, ports, voltage, states[], rssi, temp, ts}`
- 订单结算：`{orderId, phyId, port, mode, duration, kwh, peakW, reason, ts}`
- 告警：`{phyId, category, port, level, meta, ts}`
- 控制回执：`{requestId, phyId, port, cmd, result, ts}`

### 5. 推送可靠性

- 重试：指数退避，最大 N 次；去重：`eventId` 幂等键；签名校验失败不重试。
- 可观测：推送结果统计、失败原因分布、目的端延迟。

### 6. 控制接口（第三方→本平台）

- 启停充：`POST /api/third/commands/82`（含订单号/端口/模式/时长或电量）
- 参数：`POST /api/third/params/{83|84|85|86}`
- 升级：`POST /api/third/upgrade`（E0/F8 元信息）
- 鉴权：API Key + HMAC；限频：每设备/全局。

### 7. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-HTTP]、[TS-Config]、[TS-Log]

### 8. 配置项

- `thirdparty.push.webhook_url`、`thirdparty.push.secret`、`thirdparty.push.max_retries`、`thirdparty.push.backoff`
- `thirdparty.auth.api_keys[]`、`thirdparty.ip_whitelist[]`

### 9. 验证方法

- 伪造回调服务收集事件；验证签名/重试/去重；延迟与成功率达标。
- 压测第三方控制路径：批量 82，p99≤200ms（平台内处理）。
