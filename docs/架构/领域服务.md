## 领域服务设计

### 1. 设备与端口

- 档案：型号/固件/端口数；变更触发注册校验。
- 端口状态机：空闲/在充/浮充/故障；来源：21/06/03；一致性规则。

### 2. 订单

- 流程：82 Start→(06*)→03/43 End；状态：Pending/Active/Settled/Aborted。
- 规则：订单号匹配；重复抑制；最大/第二峰值、耗电量与原因码。

### 3. 参数

- 白名单/上下界；回读校验；失败回滚；审计记录。

### 4. 升级

- E0/F8 分片、窗口与≤3重试；灰度批次与并发阈值；失败回滚；成功率指标。

### 5. 指标与验收

- 指标：82 成功率、订单闭环率、参数回读成功率、升级成功率/平均时长。
- 验收：端到端用例（含异常与乱序/重发）；对账一致；回滚可用。

### 6. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-Config]、[TS-DB]、[TS-Migrate]

### 7. 配置项

- `order.timeout_sec`、`order.max_duration_sec`、`order.max_kwh`
- `upgrade.batch_size`、`upgrade.window_size`、`upgrade.max_retries`
- `params.whitelist`（按机型/固件）

### 8. 运维要点

- 定期对账（orders vs cmd_log/telemetry_summary）；异常原因码分布监控。
- 升级任务限流与时间窗；失败回滚演练。

### 9. 验证方法

- 端到端 82→06→03 回放；边界：乱序/重复/短路检测策略变化；参数白名单非法输入。
