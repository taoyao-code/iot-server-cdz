## 领域服务设计

### 当前实现范围（M0 最小闭环）

- AP3000 20/21：设备注册/心跳 → `devices.last_seen_at` 更新；端口快照 `ports(status,power_w)` Upsert；`cmd_log` 记录。
- 出站队列：提供 `outbound_queue` 表与最小 worker（调度占位，sent→done）。
- 会话：`OnHeartbeat` 与在线判定；指标：`session_online_count`、`session_heartbeat_total`。

### 0x82 启停（高优先）

- 解析与校验（最小规则）：
  - 参数：端口号范围（1..N，可配置）、动作（start/stop）、可选时长/电量上限（边界检查）。
  - 错误码：参数非法/端口越界/重复中间态。
- 动作落库：
  - `cmd_log` 记录发起；`outbound_queue` 入队（priority 高于心跳）。
  - worker：节流（≥500ms/设备）、超时（15s）与一次重试，状态 sent→done/dead。
- 指标与验收：
  - 指标：82 成功率、重试率、p99 延迟、队列深度。
  - 单测：有效/无效负载、入队与状态流转；端到端冒烟（Compose）。

### 只读 API（高优先）

- `GET /api/devices`：过滤（在线/型号/关键字），分页；
- `GET /api/orders/{id}`：订单详情（含端口/时段/状态）。

### 下一步（短期实施）

- 完成 0x82 流程与单测；
- Outbound 抽象存储接口（便于可测）与策略单测；
- 只读 API 与 OpenAPI 同步；
- Compose 冒烟脚本：AutoMigrate 启动→`/readyz` ready→核心表存在→`/metrics` 可用。

### 1. 设备与端口

- 档案：型号/固件/端口数；变更触发注册校验。
- 端口状态机：空闲/在充/浮充/故障；来源：21/06/03；一致性规则。

### 2. 订单

- 流程：82 Start→(06*)→03/43 End；状态：Pending/Active/Settled/Aborted。
- 规则：订单号匹配；重复抑制；最大/第二峰值、耗电量与原因码。

### 3. 参数

- 白名单/上下界；回读校验；失败回滚；审计记录。

### 4. 升级

- E0/F8 分片、窗口与≤3重试；灰度批次与并发阈值；失败回滚；成功率指标。

### 5. 指标与验收

- 指标：82 成功率、订单闭环率、参数回读成功率、升级成功率/平均时长。
- 验收：端到端用例（含异常与乱序/重发）；对账一致；回滚可用。

### 6. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-Config]、[TS-DB]、[TS-Migrate]

### 7. 配置项

- `order.timeout_sec`、`order.max_duration_sec`、`order.max_kwh`
- `upgrade.batch_size`、`upgrade.window_size`、`upgrade.max_retries`
- `params.whitelist`（按机型/固件）

### 8. 运维要点

- 定期对账（orders vs cmd_log/telemetry_summary）；异常原因码分布监控。
- 升级任务限流与时间窗；失败回滚演练。

### 9. 验证方法

- 端到端 82→06→03 回放；边界：乱序/重复/短路检测策略变化；参数白名单非法输入。
