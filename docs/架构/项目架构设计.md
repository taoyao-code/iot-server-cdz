# IOT Server - é¡¹ç›®æ¶æ„è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°æ—¶é—´**: 2025-10-05  
> **é€‚ç”¨èŒƒå›´**: å……ç”µæ¡©ç‰©è”ç½‘æœåŠ¡å™¨

---

## ä¸€ã€æ¶æ„æ¦‚è§ˆ

### 1.1 ç³»ç»Ÿå®šä½

IOT Server æ˜¯ä¸€ä¸ª**ç‰©è”ç½‘è®¾å¤‡æ¥å…¥ç½‘å…³æœåŠ¡**ï¼Œä¸“é—¨ç”¨äºå……ç”µæ¡©è®¾å¤‡çš„è¿æ¥ç®¡ç†å’Œæ•°æ®å¤„ç†ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š

- ğŸ”Œ è®¾å¤‡æ¥å…¥ï¼šTCPé•¿è¿æ¥ç®¡ç†
- ğŸ“¡ åè®®è§£æï¼šAP3000ã€BKVç­‰å¤šåè®®æ”¯æŒ
- ğŸ’¾ æ•°æ®æŒä¹…åŒ–ï¼šè®¾å¤‡çŠ¶æ€ã€è®¢å•ã€æ—¥å¿—
- ğŸ”„ æ¶ˆæ¯ä¸‹å‘ï¼šå‘½ä»¤é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶
- ğŸ“Š çŠ¶æ€ç®¡ç†ï¼šä¼šè¯ç®¡ç†å’Œè®¾å¤‡åœ¨çº¿çŠ¶æ€
- ğŸ”— ç¬¬ä¸‰æ–¹å¯¹æ¥ï¼šWebhookæ¨é€

### 1.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å……ç”µæ¡©è®¾å¤‡                              â”‚
â”‚                  (AP3000 / BKV åè®®)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ TCP é•¿è¿æ¥
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IOT Server                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              TCP Server (port 8899)                  â”‚   â”‚
â”‚  â”‚           (internal/tcpserver)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Connection Handler                        â”‚   â”‚
â”‚  â”‚         (internal/gateway)                          â”‚   â”‚
â”‚  â”‚  â€¢ åè®®å—…æ¢ (Sniff)                                  â”‚   â”‚
â”‚  â”‚  â€¢ ä¼šè¯ç»‘å®š (Session)                                â”‚   â”‚
â”‚  â”‚  â€¢ åè®®è·¯ç”± (Protocol Router)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                      â”‚                              â”‚
â”‚       â†“                      â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ AP3000  â”‚          â”‚   BKV    â”‚  Protocol Adapters      â”‚
â”‚  â”‚ Adapter â”‚          â”‚ Adapter  â”‚  (internal/protocol)    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
â”‚       â”‚                     â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                  â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Business Handlers                      â”‚   â”‚
â”‚  â”‚  â€¢ å¿ƒè·³å¤„ç† â€¢ çŠ¶æ€ä¸ŠæŠ¥ â€¢ å……ç”µæ§åˆ¶                    â”‚   â”‚
â”‚  â”‚  â€¢ è®¢å•ç»“ç®— â€¢ å¼‚å¸¸å¤„ç† â€¢ å‚æ•°é…ç½®                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                            â”‚                        â”‚
â”‚       â†“                            â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Session  â”‚              â”‚  PostgreSQL   â”‚               â”‚
â”‚  â”‚ Manager  â”‚              â”‚   Repository  â”‚               â”‚
â”‚  â”‚(Redis)   â”‚              â”‚ (æŒä¹…åŒ–å±‚)     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                            â”‚                        â”‚
â”‚       â†“                            â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Outbound Queue                         â”‚   â”‚
â”‚  â”‚         (internal/outbound)                         â”‚   â”‚
â”‚  â”‚  â€¢ ä¸‹è¡Œæ¶ˆæ¯é˜Ÿåˆ— â€¢ é‡è¯•æœºåˆ¶ â€¢ ACKç¡®è®¤                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€> å›å†™è®¾å¤‡ TCP è¿æ¥                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               HTTP Server (Gin)                     â”‚   â”‚
â”‚  â”‚              (port 8080)                            â”‚   â”‚
â”‚  â”‚  â€¢ åªè¯»æŸ¥è¯¢ API                                      â”‚   â”‚
â”‚  â”‚  â€¢ å¥åº·æ£€æŸ¥ /health                                  â”‚   â”‚
â”‚  â”‚  â€¢ æŒ‡æ ‡ç›‘æ§ /metrics                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ä¸‰æ–¹å¹³å°                                â”‚
â”‚              (Webhook æ¨é€)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€åˆ†å±‚æ¶æ„

### 2.1 å±‚æ¬¡åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åº”ç”¨å±‚ (Application)            â”‚  cmd/server
â”‚      â€¢ å¯åŠ¨å…¥å£ â€¢ é…ç½®åŠ è½½            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¸šåŠ¡å±‚ (Business)               â”‚  internal/app
â”‚      â€¢ Bootstrap â€¢ ä¾èµ–æ³¨å…¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æœåŠ¡å±‚ (Service)                â”‚  internal/
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Gateway   â”‚ Session â”‚ Outbound â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åè®®å±‚ (Protocol)               â”‚  internal/protocol
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AP3000 â”‚ BKV â”‚ GN (æœªæ¥)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ•°æ®å±‚ (Data)                   â”‚  internal/storage
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PostgreSQL â”‚ Redis âœ…          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure)     â”‚  internal/
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TCP â”‚ HTTP â”‚ Metrics â”‚ Loggingâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ ¸å¿ƒç»„ä»¶

### 3.1 TCP Server (internal/tcpserver)

**èŒè´£**: TCPè¿æ¥ç®¡ç†

```go
type Server struct {
    listener net.Listener
    handler  ConnHandler
    metrics  MetricsCallbacks
}

// åŠŸèƒ½ï¼š
// â€¢ ç›‘å¬ç«¯å£ (é»˜è®¤ 8899)
// â€¢ æ¥å—è¿æ¥
// â€¢ è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
// â€¢ ä¼˜é›…å…³é—­
```

**ç‰¹æ€§**ï¼š

- âœ… æ”¯æŒå¹¶å‘è¿æ¥
- âœ… è¿æ¥è¶…æ—¶æ§åˆ¶
- âœ… æŒ‡æ ‡å›è°ƒï¼ˆè¿æ¥æ•°ã€å­—èŠ‚æ•°ï¼‰
- âœ… ä¼˜é›…å…³é—­ï¼ˆ10ç§’è¶…æ—¶ï¼‰

### 3.2 Gateway (internal/gateway)

**èŒè´£**: è¿æ¥å¤„ç†å’Œåè®®è·¯ç”±

```go
type ConnHandler struct {
    sessionMgr   *session.Manager
    policy       session.WeightedPolicy
    protocolCfg  ProtocolConfig
    ap3000       func() *ap3000.Handlers
    bkv          func() *bkv.Handlers
}

// å¤„ç†æµç¨‹ï¼š
// 1. è¯»å–å‰ç¼€å­—èŠ‚
// 2. åè®®å—…æ¢ (Sniff)
// 3. åˆ›å»ºåè®®é€‚é…å™¨
// 4. ä¼šè¯ç»‘å®š (BindSession)
// 5. æŒç»­è¯»å–å¹¶å¤„ç†
```

**åè®®å—…æ¢**:

```
å‰2å­—èŠ‚ â†’ åˆ¤æ–­åè®®ç±»å‹
â€¢ 0xFCFE / 0xFCFF â†’ BKV
â€¢ å…¶ä»– â†’ AP3000
```

### 3.3 Protocol Adapters (internal/protocol)

#### 3.3.1 AP3000 åè®®

```
internal/protocol/ap3000/
â”œâ”€â”€ adapter.go      # é€‚é…å™¨å…¥å£
â”œâ”€â”€ parser.go       # å¸§è§£æ
â”œâ”€â”€ decoder.go      # æ•°æ®è§£ç 
â”œâ”€â”€ encoder.go      # æ•°æ®ç¼–ç 
â”œâ”€â”€ frame.go        # å¸§ç»“æ„å®šä¹‰
â”œâ”€â”€ handlers.go     # ä¸šåŠ¡å¤„ç†å™¨
â”œâ”€â”€ router.go       # å‘½ä»¤è·¯ç”±
â””â”€â”€ wire.go         # DIæ³¨å…¥
```

**ç‰¹ç‚¹**:

- äºŒè¿›åˆ¶å¸§æ ¼å¼
- å¤§ç«¯åº
- CRC16æ ¡éªŒ
- æ”¯æŒå¤šç§å……ç”µæ¨¡å¼

#### 3.3.2 BKV åè®®

```
internal/protocol/bkv/
â”œâ”€â”€ adapter.go      # é€‚é…å™¨å…¥å£
â”œâ”€â”€ parser.go       # å¸§è§£æ (æµå¼)
â”œâ”€â”€ tlv.go          # TLVç¼–è§£ç 
â”œâ”€â”€ frame.go        # å¸§ç»“æ„å®šä¹‰
â”œâ”€â”€ handlers.go     # ä¸šåŠ¡å¤„ç†å™¨
â”œâ”€â”€ router_handlers.go  # è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ encoder.go      # å¸§ç¼–ç 
â”œâ”€â”€ param.go        # å‚æ•°å¤„ç†
â”œâ”€â”€ reason_map.go   # åŸå› ç æ˜ å°„
â””â”€â”€ wire.go         # DIæ³¨å…¥
```

**ç‰¹ç‚¹**:

- åŒ…å¤´åŒ…å°¾é­”æœ¯å­— (0xFCFE/0xFCFF/0xFCEE)
- TLVæ ¼å¼è½½è·
- æ”¯æŒç»„ç½‘è®¾å¤‡
- BKVå­åè®® (0x1000å‘½ä»¤)

### 3.4 Session Manager (internal/session)

**èŒè´£**: ä¼šè¯ç®¡ç†

```go
type Manager struct {
    mu       sync.RWMutex
    byPhyID  map[string]*Session  // ç‰©ç†ID â†’ ä¼šè¯
    byConn   map[net.Conn]*Session // è¿æ¥ â†’ ä¼šè¯
}

type Session struct {
    PhyID     string      // è®¾å¤‡ç‰©ç†ID
    DeviceID  int64       // æ•°æ®åº“è®¾å¤‡ID
    Conn      net.Conn    // TCPè¿æ¥
    Protocol  string      // åè®®ç±»å‹
    CreatedAt time.Time   // åˆ›å»ºæ—¶é—´
}
```

**åŠŸèƒ½**:

- âœ… ä¼šè¯ç»‘å®šï¼ˆç‰©ç†ID â†” è¿æ¥ï¼‰
- âœ… ä¼šè¯æŸ¥è¯¢ï¼ˆé€šè¿‡ç‰©ç†IDæˆ–è¿æ¥ï¼‰
- âœ… è¿æ¥å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†
- âœ… çº¿ç¨‹å®‰å…¨

### 3.5 Storage (internal/storage)

#### PostgreSQL Repository

```go
type Repository struct {
    Pool *pgxpool.Pool
}

// æ ¸å¿ƒæ–¹æ³•ï¼š
// â€¢ EnsureDevice() - ç¡®ä¿è®¾å¤‡å­˜åœ¨
// â€¢ InsertCmdLog() - æ’å…¥å‘½ä»¤æ—¥å¿—
// â€¢ UpsertPortState() - æ›´æ–°ç«¯å£çŠ¶æ€
// â€¢ UpsertOrderProgress() - æ›´æ–°è®¢å•è¿›åº¦
// â€¢ SettleOrder() - ç»“ç®—è®¢å•
// â€¢ InsertOutbound() - æ’å…¥ä¸‹è¡Œæ¶ˆæ¯
// â€¢ AckOutboundByMsgID() - ç¡®è®¤ä¸‹è¡Œæ¶ˆæ¯
```

**æ•°æ®è¡¨**:

```sql
devices             -- è®¾å¤‡ä¿¡æ¯
cmd_logs            -- å‘½ä»¤æ—¥å¿—
port_states         -- ç«¯å£çŠ¶æ€
orders              -- å……ç”µè®¢å•
outbound_queue      -- ä¸‹è¡Œæ¶ˆæ¯é˜Ÿåˆ—
```

### 3.6 Outbound Worker (internal/outbound)

**èŒè´£**: ä¸‹è¡Œæ¶ˆæ¯å¤„ç†

```go
type Worker struct {
    db          *pgxpool.Pool
    throttleMs  int    // èŠ‚æµé—´éš”
    retryMax    int    // æœ€å¤§é‡è¯•æ¬¡æ•°
    getConn     func(phyID string) (interface{}, bool)
}

// å¤„ç†æµç¨‹ï¼š
// 1. å®šæ—¶æ‰«æ outbound_queue è¡¨
// 2. è·å–å¾…å‘é€æ¶ˆæ¯
// 3. é€šè¿‡ Session è·å–è¿æ¥
// 4. å‘é€åˆ°è®¾å¤‡
// 5. ç­‰å¾… ACK æˆ–è¶…æ—¶é‡è¯•
// 6. è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æ ‡è®°å¤±è´¥
```

**ç‰¹æ€§**:

- âœ… æŒä¹…åŒ–é˜Ÿåˆ—ï¼ˆPGè¡¨ï¼‰
- âœ… é‡è¯•æœºåˆ¶ï¼ˆå¯é…ç½®æ¬¡æ•°ï¼‰
- âœ… èŠ‚æµæ§åˆ¶ï¼ˆé¿å…å‘é€è¿‡å¿«ï¼‰
- âœ… ACKç¡®è®¤
- âœ… æ­»ä¿¡å¤„ç†ï¼ˆä¿ç•™Nå¤©ï¼‰

### 3.7 HTTP Server (internal/httpserver)

**èŒè´£**: HTTP APIæœåŠ¡

```go
// è·¯ç”± (internal/api/routes.go)
GET  /health                    # å¥åº·æ£€æŸ¥
GET  /metrics                   # PrometheusæŒ‡æ ‡
GET  /api/devices               # æŸ¥è¯¢è®¾å¤‡åˆ—è¡¨
GET  /api/devices/:id           # æŸ¥è¯¢è®¾å¤‡è¯¦æƒ…
GET  /api/devices/:id/ports     # æŸ¥è¯¢ç«¯å£çŠ¶æ€
GET  /api/orders                # æŸ¥è¯¢è®¢å•åˆ—è¡¨
GET  /api/sessions              # æŸ¥è¯¢åœ¨çº¿ä¼šè¯
```

**ç‰¹ç‚¹**:

- âœ… åªè¯»æŸ¥è¯¢ï¼ˆä¸æ”¯æŒå†™æ“ä½œï¼‰
- âœ… åŸºäºGinæ¡†æ¶
- âœ… å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡
- âœ… ä¼˜é›…å…³é—­

### 3.8 Third-party Pusher (internal/thirdparty)

**èŒè´£**: ç¬¬ä¸‰æ–¹æ¨é€

```go
type Pusher struct {
    webhookURL string
    signer     *Signer  // HMACç­¾å
}

// æ¨é€äº‹ä»¶ï¼š
// â€¢ è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿
// â€¢ å……ç”µå¼€å§‹/ç»“æŸ
// â€¢ å¼‚å¸¸å‘Šè­¦
// â€¢ è®¢å•ç»“ç®—
```

**ç­¾åæœºåˆ¶**:

```
X-Signature = HMAC-SHA256(secret, body)
```

---

## å››ã€æ•°æ®æµ

### 4.1 ä¸Šè¡Œæ•°æ®æµï¼ˆè®¾å¤‡ â†’ å¹³å°ï¼‰

```
è®¾å¤‡å‘é€æ•°æ®
    â†“
TCP Server æ¥æ”¶
    â†“
Gateway è¯»å–å­—èŠ‚æµ
    â†“
åè®®å—…æ¢ (Sniff)
    â†“
åè®®é€‚é…å™¨è§£æ
    â†“
å‘½ä»¤è·¯ç”± (Router)
    â†“
ä¸šåŠ¡å¤„ç†å™¨ (Handler)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                â†“                 â†“
ä¼šè¯ç®¡ç†      æ•°æ®æŒä¹…åŒ–       ç¬¬ä¸‰æ–¹æ¨é€
(Session)     (PostgreSQL)    (Webhook)
```

### 4.2 ä¸‹è¡Œæ•°æ®æµï¼ˆå¹³å° â†’ è®¾å¤‡ï¼‰

```
ä¸šåŠ¡è§¦å‘ä¸‹å‘å‘½ä»¤
    â†“
æ’å…¥ outbound_queue
    â†“
Outbound Worker æ‰«æ
    â†“
è·å–æ¶ˆæ¯å¹¶ç¼–ç 
    â†“
é€šè¿‡ Session è·å–è¿æ¥
    â†“
å†™å…¥ TCP è¿æ¥
    â†“
ç­‰å¾…è®¾å¤‡ ACK
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“          â†“          â†“
æˆåŠŸ       è¶…æ—¶       å¤±è´¥
æ›´æ–°çŠ¶æ€   é‡è¯•      æ ‡è®°æ­»ä¿¡
```

### 4.3 ä¼šè¯ç»‘å®šæµç¨‹

```
TCP è¿æ¥å»ºç«‹
    â†“
è¯»å–é¦–ä¸ªæ¶ˆæ¯
    â†“
è§£æè·å–è®¾å¤‡ç‰©ç†ID
    â†“
EnsureDevice() è·å– DeviceID
    â†“
Session.Bind(PhyID, DeviceID, Conn)
    â†“
åç»­æ¶ˆæ¯å¯å¿«é€Ÿè·¯ç”±
```

---

## äº”ã€æŠ€æœ¯æ ˆ

### 5.1 æ ¸å¿ƒæŠ€æœ¯

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|-----|---------|------|------|
| è¯­è¨€ | Go | 1.21+ | é«˜æ€§èƒ½ã€å¹¶å‘å‹å¥½ |
| Webæ¡†æ¶ | Gin | v1.9+ | HTTP API |
| æ•°æ®åº“ | PostgreSQL | 14+ | ä¸»æ•°æ®åº“ |
| æ•°æ®åº“é©±åŠ¨ | pgx | v5 | é«˜æ€§èƒ½PGé©±åŠ¨ |
| æ—¥å¿— | Zap | v1.24+ | ç»“æ„åŒ–æ—¥å¿— |
| æŒ‡æ ‡ | Prometheus | - | ç›‘æ§æŒ‡æ ‡ |
| è¿ç§» | golang-migrate | v4 | æ•°æ®åº“è¿ç§» |

### 5.2 é¡¹ç›®ç»“æ„

```
iot-server/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go              # å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ app/                     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ bootstrap/           # å¯åŠ¨å¼•å¯¼
â”‚   â”‚   â”œâ”€â”€ http.go              # HTTPæœåŠ¡æ„å»º
â”‚   â”‚   â”œâ”€â”€ tcp.go               # TCPæœåŠ¡æ„å»º
â”‚   â”‚   â”œâ”€â”€ session.go           # ä¼šè¯æ„å»º
â”‚   â”‚   â”œâ”€â”€ db.go                # æ•°æ®åº“æ„å»º
â”‚   â”‚   â”œâ”€â”€ outbound.go          # ä¸‹è¡Œé˜Ÿåˆ—æ„å»º
â”‚   â”‚   â””â”€â”€ thirdparty.go        # ç¬¬ä¸‰æ–¹æ¨é€æ„å»º
â”‚   â”œâ”€â”€ api/                     # HTTPè·¯ç”±
â”‚   â”œâ”€â”€ config/                  # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ gateway/                 # ç½‘å…³/è¿æ¥å¤„ç†
â”‚   â”œâ”€â”€ protocol/                # åè®®é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ ap3000/
â”‚   â”‚   â”œâ”€â”€ bkv/
â”‚   â”‚   â””â”€â”€ gn/
â”‚   â”œâ”€â”€ session/                 # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ storage/                 # æ•°æ®è®¿é—®
â”‚   â”‚   â”œâ”€â”€ pg/
â”‚   â”‚   â””â”€â”€ gn/
â”‚   â”œâ”€â”€ outbound/                # ä¸‹è¡Œé˜Ÿåˆ—
â”‚   â”œâ”€â”€ thirdparty/              # ç¬¬ä¸‰æ–¹é›†æˆ
â”‚   â”œâ”€â”€ tcpserver/               # TCPæœåŠ¡å™¨
â”‚   â”œâ”€â”€ httpserver/              # HTTPæœåŠ¡å™¨
â”‚   â”œâ”€â”€ metrics/                 # æŒ‡æ ‡å®šä¹‰
â”‚   â”œâ”€â”€ logging/                 # æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ migrate/                 # è¿ç§»å·¥å…·
â”‚   â””â”€â”€ health/                  # å¥åº·æ£€æŸ¥
â”œâ”€â”€ db/
â”‚   â””â”€â”€ migrations/              # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ configs/                     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ docs/                        # æ–‡æ¡£
â”œâ”€â”€ api/                         # APIå®šä¹‰
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ Makefile
```

---

## å…­ã€é…ç½®ç®¡ç†

### 6.1 é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# configs/example.yaml

# TCP æœåŠ¡é…ç½®
tcp:
  addr: "0.0.0.0:8899"           # ç›‘å¬åœ°å€
  readTimeout: 300s               # è¯»è¶…æ—¶
  writeTimeout: 30s               # å†™è¶…æ—¶

# HTTP æœåŠ¡é…ç½®
http:
  addr: "0.0.0.0:8080"           # ç›‘å¬åœ°å€
  readTimeout: 30s
  writeTimeout: 30s

# æ•°æ®åº“é…ç½®
database:
  host: localhost
  port: 5432
  user: iot
  password: iot123
  database: iot_server
  sslMode: disable
  maxConns: 20
  minConns: 2

# ä¼šè¯é…ç½®
session:
  idleTimeout: 600s               # ç©ºé—²è¶…æ—¶
  maxConnections: 10000           # æœ€å¤§è¿æ¥æ•°

# ç½‘å…³é…ç½®
gateway:
  throttleMs: 100                 # ä¸‹å‘èŠ‚æµ(ms)
  retryMax: 3                     # æœ€å¤§é‡è¯•æ¬¡æ•°
  deadRetentionDays: 7            # æ­»ä¿¡ä¿ç•™å¤©æ•°

# åè®®é…ç½®
protocols:
  enableAP3000: true
  enableBKV: true
  bkv:
    reasonMapPath: configs/bkv_reason_map.yaml

# ç¬¬ä¸‰æ–¹æ¨é€
thirdparty:
  push:
    webhookURL: "https://api.example.com/webhook"
    secret: "your-secret-key"

# æŒ‡æ ‡é…ç½®
metrics:
  path: "/metrics"

# æ—¥å¿—é…ç½®
logging:
  level: info                     # debug/info/warn/error
  encoding: json                  # json/console
  outputPaths: ["stdout", "logs/iot-server.log"]
```

### 6.2 ç¯å¢ƒå˜é‡

```bash
# é…ç½®æ–‡ä»¶è·¯å¾„
IOT_CONFIG=./configs/example.yaml

# æ•°æ®åº“è¿æ¥ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰
IOT_DB_HOST=localhost
IOT_DB_PORT=5432
IOT_DB_USER=iot
IOT_DB_PASSWORD=iot123
IOT_DB_DATABASE=iot_server
```

---

## ä¸ƒã€å¯åŠ¨æµç¨‹

### 7.1 å¯åŠ¨é¡ºåº

```go
// cmd/server/main.go
func main() {
    // 1. åŠ è½½é…ç½®
    cfg := config.Load()
    
    // 2. åˆå§‹åŒ–æ—¥å¿—
    logger := logging.Init(cfg.Logging)
    
    // 3. å¯åŠ¨åº”ç”¨
    bootstrap.Run(cfg, logger)
}

// internal/app/bootstrap/app.go
func Run(cfg *Config, log *zap.Logger) error {
    // 1. åˆå§‹åŒ–æŒ‡æ ‡
    reg, metrics := app.NewMetrics()
    
    // 2. åˆå§‹åŒ–å°±ç»ªæ£€æŸ¥
    ready := app.NewReady()
    
    // 3. åˆå§‹åŒ–ä¼šè¯ç®¡ç†
    sess, policy := app.NewSessionAndPolicy(cfg.Session)
    
    // 4. åˆ›å»ºHTTPæœåŠ¡å™¨ï¼ˆä¸å¯åŠ¨ï¼‰
    httpSrv := app.NewHTTPServer(cfg.HTTP, ...)
    
    // 5. åˆ›å»ºTCPæœåŠ¡å™¨
    tcpSrv := app.NewTCPServer(cfg.TCP)
    tcpSrv.SetConnHandler(gateway.NewConnHandler(...))
    
    // 6. å¯åŠ¨HTTPæœåŠ¡å™¨ï¼ˆgoroutineï¼‰
    go httpSrv.Start()
    
    // 7. å¯åŠ¨TCPæœåŠ¡å™¨ï¼ˆé˜»å¡ï¼‰
    tcpSrv.Start()
    ready.SetTCPReady(true)
    
    // 8. è¿æ¥æ•°æ®åº“å¹¶è¿ç§»
    db := app.ConnectDBAndMigrate(cfg.Database)
    ready.SetDBReady(true)
    
    // 9. åˆå§‹åŒ–åè®®å¤„ç†å™¨
    ap3000Handlers := &ap3000.Handlers{...}
    bkvHandlers := bkv.NewHandlers(...)
    
    // 10. æ³¨å†ŒHTTPè·¯ç”±
    httpSrv.Register(api.RegisterRoutes)
    
    // 11. å¯åŠ¨ä¸‹è¡Œé˜Ÿåˆ—Worker
    outbound.Start(db, cfg.Gateway, sess)
    
    // 12. å¯åŠ¨ç¬¬ä¸‰æ–¹æ¨é€ï¼ˆå¦‚æœé…ç½®ï¼‰
    pusher := app.NewPusherIfEnabled(cfg.Thirdparty)
    
    // 13. ç­‰å¾…ä¿¡å·
    <-sigCh
    
    // 14. ä¼˜é›…å…³é—­
    httpSrv.Shutdown(ctx)
    tcpSrv.Shutdown(ctx)
}
```

### 7.2 ä¾èµ–æ³¨å…¥

```
é…ç½® â†’ åŸºç¡€ç»„ä»¶ â†’ ä¸šåŠ¡ç»„ä»¶ â†’ æœåŠ¡å¯åŠ¨
  â”‚         â”‚           â”‚          â”‚
  â”‚         â”‚           â”‚          â””â”€> HTTP/TCP Server
  â”‚         â”‚           â””â”€> Handlers (éœ€è¦Repo)
  â”‚         â””â”€> Session, Metrics, Ready
  â””â”€> Logger, Database
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 å•æœºéƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æœåŠ¡å™¨                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     IOT Server (Goè¿›ç¨‹)        â”‚ â”‚
â”‚  â”‚  â€¢ TCP :8899                  â”‚ â”‚
â”‚  â”‚  â€¢ HTTP :8080                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     PostgreSQL                â”‚ â”‚
â”‚  â”‚     :5432                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Dockeréƒ¨ç½²

```bash
# docker-compose.yml
version: '3.8'

services:
  iot-server:
    build: .
    ports:
      - "8899:8899"  # TCP
      - "8080:8080"  # HTTP
    environment:
      - IOT_DB_HOST=postgres
    depends_on:
      - postgres

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=iot_server
      - POSTGRES_USER=iot
      - POSTGRES_PASSWORD=iot123
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

### 8.3 ç”Ÿäº§éƒ¨ç½²ï¼ˆæ¨èï¼‰

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load       â”‚
                    â”‚  Balancer   â”‚
                    â”‚  (Nginx)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
     â”‚ IOT      â”‚    â”‚ IOT      â”‚    â”‚ IOT      â”‚
     â”‚ Server 1 â”‚    â”‚ Server 2 â”‚    â”‚ Server 3 â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ PostgreSQL  â”‚
                    â”‚  (Primary)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ PostgreSQL  â”‚
                    â”‚  (Standby)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„äº‹é¡¹**:

1. TCPè¿æ¥éœ€è¦ä½¿ç”¨**å››å±‚è´Ÿè½½å‡è¡¡**ï¼ˆæ”¯æŒé•¿è¿æ¥ï¼‰
2. HTTPå¯ä»¥ä½¿ç”¨ä¸ƒå±‚è´Ÿè½½å‡è¡¡
3. æ•°æ®åº“å»ºè®®ä¸»ä»å¤åˆ¶æˆ–PGé›†ç¾¤
4. Sessionæ˜¯å†…å­˜çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡**ä¸€è‡´æ€§å“ˆå¸Œ**ä¿è¯è®¾å¤‡è¿æ¥åˆ°åŒä¸€å®ä¾‹

---

## ä¹ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 9.1 æŒ‡æ ‡ (Metrics)

```go
// internal/metrics/metrics.go

type AppMetrics struct {
    // TCPæŒ‡æ ‡
    TCPAccepted       prometheus.Counter   // TCPè¿æ¥æ¥å—æ•°
    TCPBytesReceived  prometheus.Counter   // TCPæ¥æ”¶å­—èŠ‚æ•°
    
    // ä¼šè¯æŒ‡æ ‡
    ActiveSessions    prometheus.Gauge     // æ´»è·ƒä¼šè¯æ•°
    
    // åè®®æŒ‡æ ‡
    ProtocolMessages  *prometheus.CounterVec  // åè®®æ¶ˆæ¯æ•° (by protocol)
    ProtocolErrors    *prometheus.CounterVec  // åè®®é”™è¯¯æ•° (by protocol)
    
    // ä¸šåŠ¡æŒ‡æ ‡
    OrdersCreated     prometheus.Counter   // åˆ›å»ºè®¢å•æ•°
    OrdersSettled     prometheus.Counter   // ç»“ç®—è®¢å•æ•°
    
    // ä¸‹è¡Œé˜Ÿåˆ—æŒ‡æ ‡
    OutboundSent      prometheus.Counter   // ä¸‹å‘æ¶ˆæ¯æ•°
    OutboundFailed    prometheus.Counter   // ä¸‹å‘å¤±è´¥æ•°
    OutboundRetries   prometheus.Counter   // é‡è¯•æ¬¡æ•°
}
```

### 9.2 æ—¥å¿—

```go
// ç»“æ„åŒ–æ—¥å¿—ç¤ºä¾‹
logger.Info("device connected",
    zap.String("phy_id", phyID),
    zap.String("protocol", "bkv"),
    zap.String("remote_addr", conn.RemoteAddr().String()),
)

logger.Error("parse frame failed",
    zap.Error(err),
    zap.String("phy_id", phyID),
    zap.Binary("raw_data", data),
)
```

### 9.3 å¥åº·æ£€æŸ¥

```
GET /health

Response:
{
  "status": "healthy",
  "tcp": "ready",
  "database": "ready",
  "uptime": "3h24m15s"
}
```

---

## åã€å®‰å…¨æ€§è€ƒè™‘

### 10.1 ç½‘ç»œå®‰å…¨

- âœ… TCPè¿æ¥é™åˆ¶ï¼ˆæœ€å¤§è¿æ¥æ•°ï¼‰
- âœ… è¯»å†™è¶…æ—¶ä¿æŠ¤
- âš ï¸ TODO: TLSåŠ å¯†ï¼ˆå¦‚éœ€è¦ï¼‰
- âš ï¸ TODO: IPç™½åå•

### 10.2 æ•°æ®å®‰å…¨

- âœ… æ•°æ®åº“è¿æ¥æ± 
- âœ… SQLæ³¨å…¥é˜²æŠ¤ï¼ˆpgxå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- âœ… æ•æ„Ÿä¿¡æ¯ä¸è®°å½•æ—¥å¿—
- âš ï¸ TODO: å¯†ç åŠ å¯†å­˜å‚¨

### 10.3 ç¬¬ä¸‰æ–¹å®‰å…¨

- âœ… Webhook HMACç­¾å
- âœ… è¶…æ—¶æ§åˆ¶
- âš ï¸ TODO: é‡æ”¾æ”»å‡»é˜²æŠ¤

---

## åä¸€ã€æ€§èƒ½ä¼˜åŒ–

### 11.1 å·²å®ç°ä¼˜åŒ–

1. **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± ï¼ˆ20-2ï¼‰
2. **æ‰¹é‡æ“ä½œ**: ä¸‹è¡Œé˜Ÿåˆ—æ‰¹é‡æŸ¥è¯¢
3. **ç´¢å¼•ä¼˜åŒ–**: å…³é”®æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•
4. **èŠ‚æµæ§åˆ¶**: ä¸‹å‘æ¶ˆæ¯èŠ‚æµï¼ˆ100msï¼‰

### 11.2 ä¼˜åŒ–å»ºè®®

1. **å¼•å…¥Redis**:
   - ä¼šè¯çŠ¶æ€ç¼“å­˜
   - è®¾å¤‡åœ¨çº¿çŠ¶æ€
   - çƒ­ç‚¹æ•°æ®ç¼“å­˜

2. **æ•°æ®åº“ä¼˜åŒ–**:
   - åˆ†åŒºè¡¨ï¼ˆcmd_logsæŒ‰æ—¥æœŸï¼‰
   - å½’æ¡£å†·æ•°æ®
   - åªè¯»å‰¯æœ¬

3. **æ¶ˆæ¯é˜Ÿåˆ—**:
   - ä½¿ç”¨Kafka/RabbitMQæ›¿ä»£PGé˜Ÿåˆ—
   - æé«˜ä¸‹å‘ååé‡

---

## åäºŒã€æ‰©å±•æ€§

### 12.1 æ°´å¹³æ‰©å±•

**æ— çŠ¶æ€åŒ–æ”¹é€ **:

```
Sessionå­˜å‚¨ â†’ Redis
  â”œâ”€ è®¾å¤‡ç‰©ç†ID â†’ æœåŠ¡å™¨IP
  â””â”€ ä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±
```

**æ¶ˆæ¯è½¬å‘**:

```
è®¾å¤‡è¿æ¥Server1
ä¸šåŠ¡è§¦å‘åœ¨Server2
  â†“
Server2æŸ¥Redisè·å–Server1åœ°å€
  â†“
RPC/HTTPè°ƒç”¨Server1ä¸‹å‘
```

### 12.2 åè®®æ‰©å±•

```go
// æ–°å¢åè®®åªéœ€ï¼š
// 1. å®ç° Adapter æ¥å£
type NewProtocolAdapter struct {}

func (a *NewProtocolAdapter) Sniff(prefix []byte) bool {
    // åè®®è¯†åˆ«
}

func (a *NewProtocolAdapter) ProcessBytes(data []byte) error {
    // æ•°æ®å¤„ç†
}

// 2. åœ¨ Gateway æ³¨å†Œ
handler.RegisterProtocol("new", adapter)
```

---

## åä¸‰ã€ç‰ˆæœ¬è§„åˆ’

### v1.0 (å½“å‰)

- âœ… AP3000 åè®®æ”¯æŒ
- âœ… BKV åŸºç¡€åŠŸèƒ½ï¼ˆ50%ï¼‰
- âœ… PostgreSQL æŒä¹…åŒ–
- âœ… ä¸‹è¡Œé˜Ÿåˆ—
- âœ… HTTP API

### v1.1 (è§„åˆ’ä¸­)

- â³ BKV åè®®å®Œæ•´å®ç°ï¼ˆ100%ï¼‰
- â³ Redis ä¼šè¯å­˜å‚¨
- â³ æ°´å¹³æ‰©å±•æ”¯æŒ
- â³ TLS åŠ å¯†

### v2.0 (æœªæ¥)

- â³ GN åè®®æ”¯æŒ
- â³ Kafka æ¶ˆæ¯é˜Ÿåˆ—
- â³ å¾®æœåŠ¡æ‹†åˆ†
- â³ gRPC API

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-05  
**ç‰ˆæœ¬**: v1.0
