## 管理与观测设计（中间件定位）

### 1. 管理面（REST+OpenAPI）

- 设备/会话查询；控制（82）、参数（83/84/85/86）、升级（E0/F8）；订单/日志查询；第三方回调状态查看。
- 安全：API Key + HMAC 签名、IP 白名单；敏感字段脱敏（不引入 RBAC）。

### 2. 指标与告警

- 指标：连接/在线/QPS/p95-p99/82 成功率/重发率/DB 写延迟/下行队列长度。
- 告警：82 成功率<99%、重发率>3%、p99>200ms、写失败>0.1%、在线骤降、队列积压。
- 降基数：按区域/型号聚合，避免每设备标签爆炸。

#### 2.1 新增指标映射（代码）

- `ap3000_82_ack_total{result=ok|err}`：见 `internal/protocol/ap3000/handlers.go`
- `outbound_resend_total`、`outbound_timeout_total`、`outbound_dead_cleanup_total`、`outbound_queue_size{status}`：见 `internal/outbound/worker.go`
- `session_offline_total{reason=tcp|ack}`、`session_online_count`（已切换加权计数）：见 `cmd/server/main.go` 与 `internal/session/manager.go`

#### 2.2 PromQL 告警规则示例

- 82 成功率（5m）：
  - expr: `sum(rate(ap3000_82_ack_total{result="ok"}[5m])) / sum(rate(ap3000_82_ack_total[5m])) < 0.99`
  - for: `10m`
  - labels: `severity: critical`
- 出站重发率（5m）：
  - expr: `rate(outbound_resend_total[5m]) / (rate(outbound_resend_total[5m]) + sum(rate(ap3000_82_ack_total{result="ok"}[5m]))) > 0.03`
  - for: `10m`
  - labels: `severity: warning`
- ACK 超时速率：
  - expr: `rate(outbound_timeout_total[5m]) > 5`
  - for: `10m`
  - labels: `severity: warning`
- 队列积压（待发送）：
  - expr: `outbound_queue_size{status="0"} > 10000`
  - for: `10m`
  - labels: `severity: critical`
- 会话离线（TCP/ACK）：
  - expr: `rate(session_offline_total{reason=~"tcp|ack"}[5m]) > 10`
  - for: `10m`
  - labels: `severity: warning`

#### 2.3 面板建议

- KPI：82 成功率（5m/1h）、重发率、ACK 超时速率、待发送队列、在线设备（加权）。
- 趋势：`ap3000_82_ack_total`（分 result 堆叠）、`outbound_resend_total`、`outbound_timeout_total`、`outbound_queue_size`（按 status）、`session_offline_total`（按 reason）。

### 3. 调试与审计

- pprof 仅内网；HEX 审计文件与索引；访问审计日志。

### 4. 验收

- OpenAPI 与实现一致；指标齐全且阈值生效；审计可检索；权限闭环通过。

### 5. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-HTTP=gin]、[TS-OpenAPI]、[TS-Metrics]、[TS-Log]、[TS-Config]

### 6. 配置项

- `rbac.roles`、`rbac.policies`、`ip.whitelist`
- `metrics.sample_ratio`、`alerts.enabled`、`alerts.thresholds`
- `audit.enabled`、`audit.mask_fields`（ICCID/IMEI/UID 等）

### 7. 运维要点

- 指标降基数：避免每设备/每订单作为 label；使用聚合维度。
- 安全：管理面仅内网暴露；强制 HTTPS（如通过网关）；审计留存周期≥180天。

### 8. 验证方法

- OpenAPI 校验通过；阈值触发演练；审计检索与脱敏验证。

### 9. 实现映射（代码路径与配置）

- 代码路径：
  - HTTP 服务与健康检查：`internal/httpserver/server.go`
  - 指标注册与导出：`internal/metrics/metrics.go`
  - OpenAPI 草案：`api/openapi/openapi.yaml`
  - 日志初始化：`internal/logging/logger.go`
- 配置键（对应 `configs/example.yaml`）：
  - `http.addr`, `http.readTimeout`, `http.writeTimeout`
  - `metrics.enable`, `metrics.path`, `metrics.sample_ratio`, `metrics.alerts.*`
  - `logging.level`, `logging.format`, `logging.file.*`
  - `session.heartbeat_timeout_sec`, `session.ack_grace_sec`
