## 管理与观测设计（中间件定位）

### 1. 管理面（REST+OpenAPI）

- 设备/会话查询；控制（82）、参数（83/84/85/86）、升级（E0/F8）；订单/日志查询；第三方回调状态查看。
- 安全：API Key + HMAC 签名、IP 白名单；敏感字段脱敏（不引入 RBAC）。

### 2. 指标与告警

- 指标：连接/在线/QPS/p95-p99/82 成功率/重发率/DB 写延迟/下行队列长度。
- 告警：82 成功率<99%、重发率>3%、p99>200ms、写失败>0.1%、在线骤降、队列积压。
- 降基数：按区域/型号聚合，避免每设备标签爆炸。

### 3. 调试与审计

- pprof 仅内网；HEX 审计文件与索引；访问审计日志。

### 4. 验收

- OpenAPI 与实现一致；指标齐全且阈值生效；审计可检索；权限闭环通过。

### 5. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-HTTP=gin]、[TS-OpenAPI]、[TS-Metrics]、[TS-Log]、[TS-Config]

### 6. 配置项

- `rbac.roles`、`rbac.policies`、`ip.whitelist`
- `metrics.sample_ratio`、`alerts.enabled`、`alerts.thresholds`
- `audit.enabled`、`audit.mask_fields`（ICCID/IMEI/UID 等）

### 7. 运维要点

- 指标降基数：避免每设备/每订单作为 label；使用聚合维度。
- 安全：管理面仅内网暴露；强制 HTTPS（如通过网关）；审计留存周期≥180天。

### 8. 验证方法

- OpenAPI 校验通过；阈值触发演练；审计检索与脱敏验证。
