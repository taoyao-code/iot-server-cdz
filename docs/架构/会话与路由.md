## 会话与路由设计

### 1. 目标

- 准确绑定设备标识（ICCID/物理ID/IMEI），维持稳定路由与限速，降低误离线。

### 2. 绑定与漂移

- 优先级：ICCID > 物理ID > IMEI；任一变更触发重绑与记录；防止冒用与冲突。

### 3. 路由与亲和

- 一致性哈希实现设备→实例粘连；支持多实例扩缩容的平滑重分配。

### 4. 在线/离线判定

- 多信号源：TCP 断开、心跳超时、命令 ACK 缺失；阈值与宽限窗口可配。

### 5. 限速与背压

- 设备级令牌桶；全局速率限制；超限丢弃非关键消息（心跳可采样）。

### 6. 指标与验收

- 指标：误踢率、限速命中率、重路由次数、在线率。
- 验收：模拟网络抖动/重连风暴；在线/离线判定准确；限速生效且不影响关键指令。

### 7. 依赖标签引用（详见 `docs/技术栈治理.md`）

- [TS-Config]、[TS-RateLimit]

### 8. 配置项

- `session.heartbeat_timeout_sec`（默认 360）
- `session.ack_grace_sec`（默认 30）
- `session.rebind_on_iccid_change`（默认 true）
- `session.hash_ring.replicas`（默认 128）
- `session.token_bucket.qps_per_device`（默认 0 关闭）

### 9. 运维要点

- 观察“重路由次数”与“在线骤降”共同波动；避免扩缩容窗口集中。
- 黑名单同步频率与一致性策略（仅追加，不删除）。

### 10. 验证方法

- 断网/抖动/心跳延迟注入；对比在线率、误踢率；扩缩容重分配平滑度。
