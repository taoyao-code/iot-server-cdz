# IOT Server 生产环境配置
# 生产环境部署配置 - 请根据实际环境修改

app:
  name: iot-server
  env: production

http:
  addr: ":8080"
  readTimeout: 30s
  writeTimeout: 30s

tcp:
  addr: ":7000" # BKV协议端口
  readTimeout: 300s
  writeTimeout: 30s
  maxConnections: 10000
  # 生产环境限流和熔断配置
  limiting:
    enabled: true
    max_connections: 50000 # 最大并发连接数
    rate_per_second: 500 # 每秒新连接速率
    rate_burst: 1000 # 突发容量
    breaker_threshold: 10 # 连续10次失败触发熔断
    breaker_timeout: 60s # 熔断60秒后尝试恢复

protocols:
  enable_bkv: true
  enable_ap3000: false
  enable_gn: false
  bkv:
    reason_map_path: "configs/bkv_reason_map.yaml"

gateway:
  throttle_ms: 300 # 生产环境降低节流时间
  retry_max: 5 # 增加重试次数
  dead_retention_days: 30 # 保留30天

logging:
  level: info # 生产环境使用info级别
  format: json # JSON格式便于日志分析
  file:
    filename: "/var/log/iot-server/iot-server.log"
    maxSize: 500 # 单文件最大500MB
    maxBackups: 30 # 保留30个备份
    maxAge: 90 # 保留90天
    compress: true # 启用压缩

metrics:
  enable: true
  path: "/metrics"

database:
  # 生产环境数据库配置 - 请使用环境变量或密钥管理
  dsn: "${DATABASE_URL}" # 从环境变量读取
  maxOpenConns: 100
  maxIdleConns: 20
  connMaxLifetime: 2h
  autoMigrate: false # 生产环境禁用自动迁移，使用手动迁移

# Redis配置（生产环境）
redis:
  enabled: true
  addr: "${REDIS_URL}" # 从环境变量读取
  password: "${REDIS_PASSWORD}"
  db: 0
  pool_size: 100
  min_idle_conns: 20
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s

# 第三方集成（生产环境）
thirdparty:
  push:
    webhook_url: "${WEBHOOK_URL}" # 从环境变量读取
    secret: "${WEBHOOK_SECRET}" # 从环境变量读取
    max_retries: 5
    worker_count: 10 # 生产环境增加Worker数量
    dedup_ttl: 24h # 去重24小时
    enable_queue: true
    enable_dedup: true
  auth:
    api_keys:
      - "${THIRDPARTY_API_KEY}" # 从环境变量读取
    require_hmac: true
  ip_whitelist: [] # 生产环境建议配置IP白名单

session:
  heartbeat_timeout_sec: 60 # P1-1修复: 心跳周期30s × 2 = 60s (避免网络波动误判)
  weighted:
    enabled: true
    tcp_down_window_sec: 120
    ack_window_sec: 30
    tcp_down_penalty: 0.5
    ack_timeout_penalty: 0.5
    threshold: 0.5

# API认证配置（生产环境必须启用）
api:
  auth:
    enabled: true # 生产环境必须启用
    api_keys:
      - "${API_KEY}" # 从环境变量读取，建议使用32位以上强密钥

