# IOT Server 配置文件
# P0修复: 添加API认证配置

app:
  name: iot-server
  env: dev

http:
  addr: ":8080"
  readTimeout: 30s
  writeTimeout: 30s

tcp:
  addr: ":8899"
  readTimeout: 300s
  writeTimeout: 30s
  maxConnections: 5000
  # Week2: 限流和熔断配置
  limiting:
    enabled: true # 启用限流和熔断
    max_connections: 10000 # 最大并发连接数
    rate_per_second: 100 # 每秒新连接速率
    rate_burst: 200 # 突发容量（2倍速率）
    breaker_threshold: 5 # 连续5次失败触发熔断
    breaker_timeout: 30s # 熔断30秒后尝试恢复

protocols:
  enable_ap3000: true
  enable_bkv: true
  enable_gn: false
  bkv:
    reason_map_path: "configs/bkv_reason_map.yaml"

gateway:
  throttle_ms: 500
  retry_max: 3
  dead_retention_days: 7

logging:
  level: info
  format: json
  file:
    filename: "logs/iot-server.log"
    maxSize: 100
    maxBackups: 7
    maxAge: 30
    compress: true

metrics:
  enable: true
  path: "/metrics"

database:
  dsn: "postgres://iot:iot123@localhost:5432/iot_server?sslmode=disable"
  maxOpenConns: 20
  maxIdleConns: 10
  connMaxLifetime: 1h
  autoMigrate: true

# Redis配置（必选依赖）
# Redis用于分布式会话管理和高性能消息队列
redis:
  enabled: true # 必须为true，否则程序无法启动
  addr: "localhost:6379" # Redis地址
  password: "123456" # 密码（无密码留空）
  db: 0 # 数据库编号
  pool_size: 20 # 连接池大小
  min_idle_conns: 5 # 最小空闲连接
  dial_timeout: 5s # 连接超时
  read_timeout: 3s # 读超时
  write_timeout: 3s # 写超时

thirdparty:
  push:
    webhook_url: ""
    secret: ""
    max_retries: 5

session:
  heartbeat_timeout_sec: 360
  weighted:
    enabled: true
    tcp_down_window_sec: 120
    ack_window_sec: 30
    tcp_down_penalty: 0.5
    ack_timeout_penalty: 0.5
    threshold: 0.5

# P0修复: API认证配置
api:
  auth:
    enabled: false # 开发环境：false, 生产环境：true
    api_keys:
      # 生产环境请使用强密钥，建议32位以上随机字符串
      # 示例生成命令: openssl rand -base64 32
      - "sk_dev_test1234567890" # 开发环境测试密钥
      # - "sk_live_abcd1234efgh5678ijkl"  # 生产环境密钥
