# IOT Server 本地开发配置
# 使用方式: IOT_CONFIG=configs/local.yaml go run cmd/server/main.go

app:
  name: iot-server
  env: dev

http:
  addr: ":8080"
  readTimeout: 30s
  writeTimeout: 30s

tcp:
  addr: ":7001" # 本地开发使用 7001（7000 被系统占用）
  readTimeout: 300s
  writeTimeout: 30s
  maxConnections: 10000 # 与生产保持一致
  # 生产环境限流和熔断配置（本地环境使用相同配置确保一致性）
  limiting:
    enabled: true
    max_connections: 50000 # 与生产保持一致
    rate_per_second: 500 # 与生产保持一致
    rate_burst: 1000 # 与生产保持一致
    breaker_threshold: 10 # 与生产保持一致：连续10次失败触发熔断
    breaker_timeout: 60s # 与生产保持一致：熔断60秒后尝试恢复

protocols:
  enable_bkv: true
  enable_ap3000: false # 与生产保持一致：生产环境仅启用BKV协议
  enable_gn: false
  bkv:
    reason_map_path: "configs/bkv_reason_map.yaml"

gateway:
  throttle_ms: 300 # 与生产保持一致
  retry_max: 5 # 与生产保持一致：增加重试次数
  dead_retention_days: 30 # 与生产保持一致：保留30天

logging:
  level: debug # 本地开发使用 debug 级别便于调试
  format: json # JSON格式便于日志分析
  file:
    filename: "logs/iot-server.log"
    maxSize: 500 # 与生产保持一致：单文件最大500MB
    maxBackups: 30 # 与生产保持一致：保留30个备份
    maxAge: 90 # 与生产保持一致：保留90天
    compress: true # 启用压缩

metrics:
  enable: true
  path: "/metrics"

database:
  # 本地开发：连接到 localhost:5432 (docker-compose.local.yml 启动的 PostgreSQL)
  dsn: "postgres://iot:iot123@localhost:5432/iot_server?sslmode=disable"
  maxOpenConns: 100 # 与生产保持一致
  maxIdleConns: 20 # 与生产保持一致
  connMaxLifetime: 2h # 与生产保持一致
  autoMigrate: true # 本地开发启用自动迁移，方便开发

# Redis配置（本地开发）
redis:
  enabled: true
  addr: "localhost:6379" # 连接到本地 Docker 容器的 Redis
  password: "123456"
  db: 0
  pool_size: 100 # 与生产保持一致
  min_idle_conns: 20 # 与生产保持一致
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s

thirdparty:
  push:
    webhook_url: "" # 本地开发可以留空，或使用 webhook.site 等测试工具
    secret: ""
    max_retries: 5 # 与生产保持一致
    worker_count: 10 # 与生产保持一致：增加Worker数量
    dedup_ttl: 24h # 与生产保持一致：去重24小时
    enable_queue: true
    enable_dedup: true
  auth:
    api_keys:
      - "${THIRDPARTY_API_KEY}" # 从环境变量读取
    require_hmac: true # 与生产保持一致：启用HMAC验证确保安全性
  ip_whitelist: [] # 本地开发不限制 IP（生产环境建议配置）

session:
  heartbeat_timeout_sec: 360
  weighted:
    enabled: true
    tcp_down_window_sec: 120
    ack_window_sec: 30
    tcp_down_penalty: 0.5
    ack_timeout_penalty: 0.5
    threshold: 0.5

# API认证配置
api:
  auth:
    enabled: true # 与生产保持一致：必须启用认证确保安全性
    api_keys:
      - "${API_KEY}" # 从环境变量读取，建议使用32位以上强密钥
