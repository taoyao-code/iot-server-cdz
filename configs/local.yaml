# IOT Server 本地开发配置
# 使用方式: IOT_CONFIG=configs/local.yaml go run cmd/server/main.go

app:
  name: iot-server
  env: dev

http:
  addr: ":7055"
  readTimeout: 30s
  writeTimeout: 30s

tcp:
  addr: ":7065" # 本地开发使用 7065（7000 被系统占用）
  readTimeout: 300s
  writeTimeout: 30s
  maxConnections: 10000 # 与生产保持一致
  # 生产环境限流和熔断配置（本地环境使用相同配置确保一致性）
  limiting:
    enabled: true
    max_connections: 50000 # 与生产保持一致
    rate_per_second: 500 # 与生产保持一致
    rate_burst: 1000 # 与生产保持一致
    breaker_threshold: 10 # 与生产保持一致：连续10次失败触发熔断
    breaker_timeout: 60s # 与生产保持一致：熔断60秒后尝试恢复

protocols:
  enable_bkv: true
  enable_ap3000: false # 与生产保持一致：生产环境仅启用BKV协议
  enable_gn: false
  bkv:
    reason_map_path: "configs/bkv_reason_map.yaml"

gateway:
  throttle_ms: 100 # 与生产保持一致
  retry_max: 5 # 与生产保持一致：增加重试次数
  dead_retention_days: 30 # 与生产保持一致：保留30天

logging:
  level: debug # 本地开发使用 debug 级别便于调试
  format: json # JSON格式便于日志分析
  file:
    filename: "logs/iot-server.log"
    maxSize: 500 # 与生产保持一致：单文件最大500MB
    maxBackups: 30 # 与生产保持一致：保留30个备份
    maxAge: 90 # 与生产保持一致：保留90天
    compress: true # 启用压缩

metrics:
  enable: true
  path: "/metrics"

database:
  dsn: "postgres://iot:iot123@localhost:5432/iot_server?sslmode=disable"
  maxOpenConns: 100
  maxIdleConns: 20
  connMaxLifetime: 2h
  autoMigrate: true
  logLevel: "info" # GORM日志级别: silent(关闭), error(仅错误), warn(警告), info(完整SQL)

redis:
  enabled: true
  addr: "localhost:6379"
  password: "yaohuiisadmin"
  db: 0
  pool_size: 100
  min_idle_conns: 20
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s

thirdparty:
  push:
    webhook_url: "" # 本地开发可以留空，或使用 webhook.site 等测试工具
    secret: ""
    max_retries: 5 # 与生产保持一致
    worker_count: 10 # 与生产保持一致：增加Worker数量
    dedup_ttl: 24h # 与生产保持一致：去重24小时
    enable_queue: true
    enable_dedup: true
  auth:
    api_keys:
      - "sk_test_thirdparty_key_for_testing_12345678"
      - "sk_test_admin_key_for_testing_12345678"  # Web 控制台使用
    require_hmac: true
  ip_whitelist: []

session:
  heartbeat_timeout_sec: 120 # P1-1修复: 心跳周期30s × 2 = 60s (避免网络波动误判)
  weighted:
    enabled: true
    tcp_down_window_sec: 120
    ack_window_sec: 30
    tcp_down_penalty: 0.5
    ack_timeout_penalty: 0.5
    threshold: 0.5

# API认证配置
api:
  auth:
    enabled: true
    api_keys:
      - "sk_test_admin_key_for_testing_12345678"
