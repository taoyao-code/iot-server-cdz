# IOT Server - 下一步任务规划

> **规划日期**: 2025-10-05  
> **更新日期**: 2025-10-05  
> **当前状态**: ✅ Week 4 刷卡充电功能已完成  
> **整体完成度**: 架构层 100% + 业务层 100% + 协议层 43% (9/21命令)

---

## ✅ 已完成工作回顾

### 架构层 - 100%完成 🎉

- ✅ **P0架构修复** (4/4完成)
  - ✅ 启动顺序优化（数据库先于TCP启动）
  - ✅ 参数持久化存储（`device_params`表）
  - ✅ API认证中间件（API Key）
  - ✅ 会话Redis化（支持水平扩展，多实例部署）

- ✅ **Week 2 性能优化** (100%完成)
  - ✅ 连接限流器（10000并发）
  - ✅ 速率限流器（100/s）
  - ✅ 熔断器（故障自动恢复）
  - ✅ 数据库索引优化（6个新索引）
  - ✅ 连接池优化
  - ✅ 健康检查增强（Database/TCP/Redis）

- ✅ **Week 2.2 Redis集成** (100%完成)
  - ✅ Redis客户端封装
  - ✅ Redis Outbound队列（10倍吞吐提升）
  - ✅ Redis健康检查器
  - ✅ 双模式支持（Redis/PostgreSQL）
  - ✅ Redis会话管理器（分布式会话）

### 业务层 - 100%完成 🎉

- ✅ **Week 4 刷卡充电功能** (100%完成)
  - ✅ 数据库设计（cards, card_transactions, card_balance_logs）
  - ✅ Repository层实现（11个方法）
  - ✅ BKV协议扩展（4个新命令：0x0B/0x0C/0x0F/0x1A）
  - ✅ CardService业务逻辑
  - ✅ PricingEngine计费引擎（支持4种充电模式）
  - ✅ 完整的7步刷卡充电流程
  - ✅ 原子性余额管理
  - ✅ 集成到主流程

**交付成果**:

- 3个数据库表 + 迁移脚本
- 11个Repository方法
- 4个BKV协议命令
- 2个Service模块（CardService + PricingEngine）
- ~1,420行生产级代码

### 协议层 - 43%完成

- ✅ **已实现命令** (9/21)
  - 0x00 心跳
  - 0x0B 刷卡上报/充电指令 ⭐ NEW
  - 0x0C 充电结束上报/确认 ⭐ NEW
  - 0x0F 订单确认 ⭐ NEW
  - 0x1A 余额查询 ⭐ NEW
  - 0x1017 状态上报
  - 0x07/0x1007 基础控制
  - 0x02/0x1004 充电结束
  - 0x1010 异常上报

---

## 🎯 下一阶段任务

### 选项A: Outbound下行消息集成 📤 ⭐ 推荐

**目标**: 完成刷卡充电下行消息发送，实现完整的双向通信

**工作量**: 2-3天

**业务价值**: ⭐⭐⭐⭐⭐ 高优先级（完成刷卡充电闭环）

#### 当前状态

Week 4已完成的刷卡充电功能目前只处理上行消息，下行消息发送（TODO）尚未实现：

- ✅ 0x0B上行：刷卡上报 → 解析完成
- ❌ 0x0B下行：下发充电指令 → **待实现**
- ✅ 0x0F上行：订单确认 → 解析完成
- ❌ 0x0F下行：确认回复 → **待实现**
- ✅ 0x0C上行：充电结束 → 解析完成
- ❌ 0x0C下行：结束确认 → **待实现**
- ✅ 0x1A上行：余额查询 → 解析完成
- ❌ 0x1A下行：余额响应 → **待实现**

#### 任务详情

##### 1. 实现Outbound下行消息发送 (1天)

需要在Handlers中集成Outbound队列，实现以下下行消息：

1. **0x0B下行：充电指令**

   ```go
   // 在handleCardSwipeUplink中发送
   func (h *Handlers) sendChargeCommand(gatewayID string, cmd *ChargeCommand) error {
       data, _ := EncodeChargeCommand(cmd)
       frame := NewFrame(0x0B, false, gatewayID, data)
       return h.Outbound.Push(gatewayID, frame)
   }
   ```

2. **0x0F下行：订单确认回复**

   ```go
   type OrderConfirmReply struct {
       OrderNo string
       Result  uint8 // 0=成功
   }
   ```

3. **0x0C下行：充电结束确认**

   ```go
   type ChargeEndReply struct {
       OrderNo string
       Result  uint8 // 0=成功
   }
   ```

4. **0x1A下行：余额响应**

   ```go
   // 在handleBalanceQueryUplink中发送
   func (h *Handlers) sendBalanceResponse(gatewayID string, resp *BalanceResponse) error {
       data, _ := EncodeBalanceResponse(resp)
       frame := NewFrame(0x1A, false, gatewayID, data)
       return h.Outbound.Push(gatewayID, frame)
   }
   ```

##### 2. 集成到Handlers (0.5天)

更新Handlers结构，添加Outbound队列：

```go
type Handlers struct {
    Repo        repoAPI
    Reason      *ReasonMap
    CardService CardServiceAPI
    Outbound    OutboundQueue // 新增
}

type OutboundQueue interface {
    Push(deviceID string, frame *Frame) error
}
```

修改TODO部分，实际调用发送函数：

```go
// handleCardSwipeUplink中
cmd, err := h.CardService.HandleCardSwipe(ctx, req)
if err != nil {
    return err
}
// 下发充电指令
return h.sendChargeCommand(f.GatewayID, cmd)

// handleBalanceQueryUplink中
resp, err := h.CardService.HandleBalanceQuery(ctx, query)
if err != nil {
    return err
}
// 下发余额响应
return h.sendBalanceResponse(f.GatewayID, resp)
```

##### 3. 编写集成测试 (0.5天)

测试完整的刷卡充电流程：

```bash
# 测试场景
1. 模拟设备刷卡上报
2. 验证下行充电指令发送到Outbound队列
3. 模拟设备订单确认
4. 模拟充电结束上报
5. 验证下行结束确认发送
6. 验证余额查询和响应
```

#### 优势

- ✅ 完成刷卡充电完整闭环
- ✅ 双向通信完整可用
- ✅ 工作量小（2-3天）
- ✅ 高优先级（解决当前TODO）

#### 交付物

- ✅ 4个下行消息发送函数
- ✅ Handlers集成Outbound
- ✅ 集成测试
- ✅ 完整的端到端流程

---

### 选项B: 补全其他协议功能 📋

**目标**: 补全组网管理、OTA升级等功能

**工作量**: 8-10天

**优先级**: 中等

#### 任务列表

##### 1. 组网管理 (3天)

- **0x08 刷新插座列表**

  ```go
  // 上行：请求刷新
  type RefreshSocketsRequest struct {
      GatewayID string
  }
  
  // 下行：返回插座列表
  type SocketsList struct {
      GatewayID string
      Sockets   []SocketInfo
  }
  ```

- **0x09 添加单个插座**

  ```go
  type AddSocketRequest struct {
      GatewayID string
      SocketID  string
      Type      uint8
  }
  ```

- **0x0A 删除单个插座**

  ```go
  type DeleteSocketRequest struct {
      GatewayID string
      SocketID  string
  }
  ```

- **数据库设计**:

  ```sql
  CREATE TABLE gateway_sockets (
      id BIGSERIAL PRIMARY KEY,
      gateway_id VARCHAR(64) NOT NULL,
      socket_id VARCHAR(64) NOT NULL,
      socket_type INT,
      status VARCHAR(20),
      created_at TIMESTAMP DEFAULT NOW(),
      UNIQUE(gateway_id, socket_id)
  );
  ```

##### 2. OTA升级 (3天)

- **0x07 OTA命令处理**

  ```go
  type OTACommand struct {
      DeviceID   string
      Version    string
      DownloadURL string
      MD5Sum     string
      FileSize   uint32
  }
  ```

- **升级任务管理**
- **固件版本控制**
- **数据库设计**:

  ```sql
  CREATE TABLE ota_tasks (
      id BIGSERIAL PRIMARY KEY,
      device_id VARCHAR(64),
      version VARCHAR(32),
      status VARCHAR(20), -- pending/downloading/installing/completed/failed
      created_at TIMESTAMP DEFAULT NOW()
  );
  ```

##### 3. 按功率充电完善 (2天)

- **0x17 多档位充电**
- **0x18 分档计费**
- **功率档位配置**

##### 4. 其他功能 (2-3天)

- **0x1D 查询插座状态**
- **0x1B 语音播报时间设置**
- **电费+服务费计费**

#### 优势

- ✅ 协议完成度提升至 ~95%
- ✅ 功能全面
- ✅ 支持更多业务场景

#### 劣势

- ❌ 工作量大
- ❌ 优先级不如刷卡充电
- ❌ 需要按业务需求排优先级

---

## 💡 推荐方案

### 🥇 推荐顺序

#### 阶段1: Outbound下行集成 (Week 5, 2-3天) ⭐ **立即开始**

**选择原因**:

1. ✅ **完成刷卡充电闭环**: Week 4只完成上行，需要下行才能完整工作
2. ✅ **工作量小**: 2-3天即可完成
3. ✅ **技术风险低**: 框架已有Outbound，只需集成
4. ✅ **优先级高**: 解决4个TODO
5. ✅ **业务价值高**: 实现端到端完整流程

#### 阶段2: 选择性补全协议 (Week 6-7, 按需)

根据实际业务需求，选择性实现：

**高优先级**:

- 组网管理（如果有组网设备）
- OTA升级（远程升级需求）

**中优先级**:

- 按功率充电完善
- 插座状态查询

**低优先级**:

- 语音播报设置
- 其他辅助功能

---

## 📊 方案对比

| 维度 | 选项A: Outbound集成 | 选项B: 协议补全 |
|------|----------------|----------------|
| **工作量** | 2-3天 ⭐⭐⭐ | 8-10天 |
| **业务价值** | 高 ⭐⭐⭐ (完成闭环) | 中-高 (全面性) |
| **技术难度** | 低 ⭐⭐⭐ | 中-高 |
| **风险** | 低 ⭐⭐⭐ | 中 |
| **紧迫性** | 高 ⭐⭐⭐ (解决TODO) | 中-低 |
| **投资回报率** | 高 ⭐⭐⭐ | 中 |

**综合评分**:

1. 🥇 **选项A (Outbound集成)**: ⭐⭐⭐⭐⭐
2. 🥈 **选项B (协议补全)**: ⭐⭐⭐

---

## ⚡ Week 5任务分解 - Outbound集成

### Day 1: 实现下行消息发送

**上午**:

- 实现4个下行消息编码和发送函数
- 定义OutboundQueue接口

**下午**:

- 集成到Handlers
- 替换TODO代码

**交付物**:

- 下行消息发送函数
- Handlers更新

### Day 2: 集成测试

**上午**:

- 编写端到端集成测试
- 测试完整刷卡充电流程

**下午**:

- 边界条件测试
- 异常场景测试

**测试场景**:

1. 刷卡→下发指令→订单确认→充电→结束
2. 余额查询→响应
3. 失败场景处理

### Day 3: 优化与文档

**上午**:

- 代码优化
- 性能测试

**下午**:

- 更新文档
- 代码review

**交付物**:

- 完整的刷卡充电端到端流程
- 测试报告
- 更新的文档

---

## 📅 时间线总览

```
✅ Week 1-3: P0任务（架构基础）- 已完成

✅ Week 4: 刷卡充电功能 - 已完成
   ├─ Day 1: 数据库设计 ✅
   ├─ Day 2-3: 协议实现 (0x0B/0x0C/0x0F/0x1A) ✅
   ├─ Day 4: 业务逻辑 ✅
   └─ Day 5: 集成到主流程 ✅

🔄 Week 5: Outbound下行集成 (2-3天) ⬅ 当前
   ├─ Day 1: 下行消息发送
   ├─ Day 2: 集成测试
   └─ Day 3: 优化与文档

⏳ Week 6-7: 选择性补全协议 (按需)
   ├─ 组网管理 (3天，如需要)
   ├─ OTA升级 (3天，如需要)
   └─ 其他功能 (2-3天)

⏳ Week 8: 生产部署准备
   ├─ 压力测试
   ├─ 监控Dashboard
   └─ 运维文档
```

---

## 🎯 最终成果预期

### Week 4 已完成 ✅

- ✅ 刷卡充电上行消息处理
- ✅ 业务逻辑完整
- ✅ 数据库设计和Repository
- ✅ CardService + PricingEngine
- ⚠️ 下行消息待集成（4个TODO）

### Week 5 完成后

- ✅ 刷卡充电完整闭环（上行+下行）
- ✅ 端到端完整可用
- ✅ 协议完成度 43% (9/21命令，功能完整)
- ✅ 支持4种充电模式
- ✅ 完整的计费体系
- ✅ 生产就绪

### 全部完成后

- ✅ 协议完成度 95%+
- ✅ 功能全面，覆盖所有业务场景
- ✅ 可直接投入生产使用

---

## 🤔 决策建议

### 如果您的优先级是

#### 1. **完成刷卡充电闭环** 💼 ⭐⭐⭐ 强烈推荐

→ 立即开始 **选项A** (Outbound集成)  
→ 2-3天后即可完整支持刷卡充电

#### 2. **功能全面覆盖** 📋

→ 先实现 **选项A**，再按需实现 **选项B**  
→ 总计 10-13天，功能完整

#### 3. **快速上线，逐步迭代** 🚀 ⭐⭐ 最推荐

→ Week 5: Outbound集成（完成刷卡充电）  
→ Week 6: 生产部署 + 用户反馈  
→ Week 7+: 根据反馈补充功能

---

## ✅ 强烈建议

**立即开始Week 5任务：Outbound下行集成**

**理由**:

1. ✅ Week 4已完成上行，需要下行才能闭环
2. ✅ 工作量小（2-3天）
3. ✅ 技术风险低
4. ✅ 高优先级（4个TODO待解决）
5. ✅ 投资回报率最高

**预期时间**: 2-3天  
**预期成果**: 完整可用的端到端刷卡充电功能

---

**准备好开始了吗？让我们进入Week 5！** 🚀
