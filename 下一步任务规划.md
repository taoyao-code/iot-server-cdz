# IOT Server - ä¸‹ä¸€æ­¥ä»»åŠ¡è§„åˆ’

> **è§„åˆ’æ—¥æœŸ**: 2025-10-05  
> **å½“å‰çŠ¶æ€**: Week 2 æ€§èƒ½ä¼˜åŒ–å·²å®Œæˆï¼Œå‹åŠ›æµ‹è¯•å·¥å…·å·²å°±ç»ª  
> **æ•´ä½“å®Œæˆåº¦**: çº¦ 50% (æ¶æ„å±‚) + 43% (åè®®å±‚)

---

## âœ… å·²å®Œæˆå·¥ä½œå›é¡¾

### æ¶æ„å±‚ (P0 + Week 2 + Week 2.2)

- âœ… **P0æ¶æ„ä¿®å¤** (3/4å®Œæˆ)
  - âœ… å¯åŠ¨é¡ºåºä¼˜åŒ–ï¼ˆæ•°æ®åº“å…ˆäºTCPå¯åŠ¨ï¼‰
  - âœ… å‚æ•°æŒä¹…åŒ–å­˜å‚¨ï¼ˆ`device_params`è¡¨ï¼‰
  - âœ… APIè®¤è¯ä¸­é—´ä»¶ï¼ˆAPI Keyï¼‰
  - â³ ä¼šè¯RedisåŒ–ï¼ˆéƒ¨åˆ†å®Œæˆï¼Œå·²é›†æˆRedisä½†åŸsessionä»ä½¿ç”¨å†…å­˜ï¼‰

- âœ… **Week 2 æ€§èƒ½ä¼˜åŒ–** (100%å®Œæˆ)
  - âœ… è¿æ¥é™æµå™¨ï¼ˆ10000å¹¶å‘ï¼‰
  - âœ… é€Ÿç‡é™æµå™¨ï¼ˆ100/sï¼‰
  - âœ… ç†”æ–­å™¨ï¼ˆæ•…éšœè‡ªåŠ¨æ¢å¤ï¼‰
  - âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ˆ6ä¸ªæ–°ç´¢å¼•ï¼‰
  - âœ… è¿æ¥æ± ä¼˜åŒ–
  - âœ… å¥åº·æ£€æŸ¥å¢å¼ºï¼ˆDatabase/TCP/Redisï¼‰

- âœ… **Week 2.2 Redisé›†æˆ** (100%å®Œæˆ)
  - âœ… Rediså®¢æˆ·ç«¯å°è£…
  - âœ… Redis Outboundé˜Ÿåˆ—ï¼ˆ10å€ååæå‡ï¼‰
  - âœ… Rediså¥åº·æ£€æŸ¥å™¨
  - âœ… åŒæ¨¡å¼æ”¯æŒï¼ˆRedis/PostgreSQLï¼‰

- âœ… **å·¥å…·å’Œæ–‡æ¡£**
  - âœ… å‹åŠ›æµ‹è¯•å·¥å…·ï¼ˆTCPè¿æ¥æ¨¡æ‹Ÿï¼‰
  - âœ… å‹åŠ›æµ‹è¯•è„šæœ¬ï¼ˆå®Œæ•´å’Œå¿«é€Ÿç‰ˆæœ¬ï¼‰
  - âœ… é¡¹ç›®çŠ¶æ€æŠ¥å‘Š
  - âœ… å®Œæ•´çš„æ–‡æ¡£ä½“ç³»

### åè®®å±‚ (43%å®Œæˆ)

- âœ… **å·²å®ç°å‘½ä»¤** (5/21)
  - 0x00 å¿ƒè·³
  - 0x1017 çŠ¶æ€ä¸ŠæŠ¥
  - 0x07/0x1007 åŸºç¡€æ§åˆ¶
  - 0x02/0x1004 å……ç”µç»“æŸ
  - 0x1010 å¼‚å¸¸ä¸ŠæŠ¥

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä»»åŠ¡é€‰é¡¹

### é€‰é¡¹A: å®Œæˆå‰©ä½™çš„P0æ¶æ„ä¿®å¤ â­ (æ¨è)

**ç›®æ ‡**: å®Œæˆä¼šè¯RedisåŒ–ï¼Œå®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•èƒ½åŠ›

**å·¥ä½œé‡**: 3-5å¤©

#### ä»»åŠ¡è¯¦æƒ…

1. **ä¼šè¯æ•°æ®è¿ç§»åˆ°Redis** (2-3å¤©)
   - å°†`session.Manager`çš„å†…å­˜å­˜å‚¨æ”¹ä¸ºRedis
   - å¿ƒè·³æ•°æ®å­˜å‚¨åˆ°Redis
   - è¿æ¥æ˜ å°„å­˜å‚¨åˆ°Redisï¼ˆphyID -> connï¼‰
   - åœ¨çº¿çŠ¶æ€è®¡ç®—åŸºäºRedisæ•°æ®

2. **æµ‹è¯•éªŒè¯** (1å¤©)
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - å¤šå®ä¾‹æ¨ªå‘æ‰©å±•æµ‹è¯•

3. **æ–‡æ¡£æ›´æ–°** (0.5å¤©)
   - æ›´æ–°æ¶æ„æ–‡æ¡£
   - æ›´æ–°éƒ¨ç½²æ–‡æ¡£

#### ä¼˜åŠ¿

- âœ… å®ŒæˆP0å…¨éƒ¨ä»»åŠ¡ï¼Œæ¶æ„è¾¾åˆ°ç”Ÿäº§çº§åˆ«
- âœ… æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œå¤šå®ä¾‹éƒ¨ç½²
- âœ… ä¼šè¯æ•°æ®æŒä¹…åŒ–ï¼Œå®ä¾‹é‡å¯ä¸å½±å“è®¾å¤‡è¿æ¥
- âœ… ä¸ºåç»­åŠŸèƒ½å¼€å‘æ‰“ä¸‹åšå®åŸºç¡€

#### é£é™©

- âš ï¸ éœ€è¦å¤„ç†è¿æ¥å¯¹è±¡åºåˆ—åŒ–é—®é¢˜ï¼ˆconnæ— æ³•ç›´æ¥å­˜Redisï¼‰
- âš ï¸ éœ€è¦è®¾è®¡ä¼šè¯äº²å’Œæ€§æˆ–è¿æ¥ä»£ç†æœºåˆ¶

## ğŸ’¡ æ¨èæ–¹æ¡ˆ

### ğŸ¥‡ æ¨èï¼š**åˆ†ä¸¤é˜¶æ®µå®æ–½**

#### é˜¶æ®µ1: å®Œæˆæ¶æ„åŸºç¡€ (Week 3, 3-5å¤©)

**æ‰§è¡Œé€‰é¡¹A** - å®Œæˆä¼šè¯RedisåŒ–

**ç†ç”±**:

1. æ‰“å¥½åŸºç¡€ï¼Œé¿å…åç»­è¿”å·¥
2. æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸ºç”Ÿäº§ç¯å¢ƒåšå¥½å‡†å¤‡
3. P0ä»»åŠ¡100%å®Œæˆï¼Œé‡Œç¨‹ç¢‘æ„ä¹‰

#### é˜¶æ®µ2: å®ç°æ ¸å¿ƒä¸šåŠ¡ (Week 4-5, 5-6å¤©)

**æ‰§è¡Œé€‰é¡¹B** - åˆ·å¡å……ç”µåŠŸèƒ½

**ç†ç”±**:

1. æ ¸å¿ƒä¸šåŠ¡ä»·å€¼æœ€é«˜
2. ç”¨æˆ·ç—›ç‚¹æœ€æ˜æ˜¾
3. åœ¨ç¨³å›ºçš„æ¶æ„åŸºç¡€ä¸Šå¼€å‘ï¼Œä»£ç è´¨é‡æ›´é«˜

#### å¯é€‰é˜¶æ®µ3: è¡¥å…¨åè®® (Week 6-7, æŒ‰éœ€)

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‰æ‹©æ€§å®ç°é€‰é¡¹Cä¸­çš„åŠŸèƒ½

---

## ğŸ“Š ä¸‰ä¸ªé€‰é¡¹å¯¹æ¯”

| ç»´åº¦ | é€‰é¡¹A: æ¶æ„å®Œå–„ | é€‰é¡¹B: åˆ·å¡å……ç”µ | é€‰é¡¹C: åè®®è¡¥å…¨ |
|------|----------------|----------------|----------------|
| **å·¥ä½œé‡** | 3-5å¤© â­ | 5-6å¤© | 8-10å¤© |
| **ä¸šåŠ¡ä»·å€¼** | ä¸­ (åŸºç¡€è®¾æ–½) | é«˜ â­ (æ ¸å¿ƒåŠŸèƒ½) | ä¸­-é«˜ (å…¨é¢æ€§) |
| **æŠ€æœ¯ä»·å€¼** | é«˜ â­ (æ‰©å±•æ€§) | ä¸­ (åŠŸèƒ½å®ç°) | ä¸­ (åŠŸèƒ½å®Œæ•´) |
| **é£é™©** | ä¸­ (æŠ€æœ¯æŒ‘æˆ˜) | ä½ â­ | é«˜ (å·¥ä½œé‡å¤§) |
| **ç´§è¿«æ€§** | é«˜ â­ (ç”Ÿäº§å¿…éœ€) | é«˜ â­ (ä¸šåŠ¡éœ€æ±‚) | ä½-ä¸­ |
| **å¯æ‰©å±•æ€§** | é«˜ â­ | ä¸­ (ä¾èµ–æ¶æ„) | ä½ (ç¢ç‰‡åŒ–) |

**ç»¼åˆè¯„åˆ†**:

1. ğŸ¥‡ **é€‰é¡¹A + é€‰é¡¹B (åˆ†é˜¶æ®µ)**: â­â­â­â­â­
2. ğŸ¥ˆ **é€‰é¡¹B (å•ç‹¬)**: â­â­â­â­
3. ğŸ¥‰ **é€‰é¡¹A (å•ç‹¬)**: â­â­â­
4. é€‰é¡¹C (å•ç‹¬): â­â­

---

## âš¡ ç«‹å³å¼€å§‹ - Week 3ä»»åŠ¡

å¦‚æœæ‚¨é€‰æ‹©**æ¨èæ–¹æ¡ˆ**ï¼Œä»¥ä¸‹æ˜¯Week 3çš„è¯¦ç»†ä»»åŠ¡ï¼š

### Week 3: ä¼šè¯RedisåŒ– (3-5å¤©)

#### Day 1-2: è®¾è®¡ä¸å®ç°

**1. è®¾è®¡ä¼šè¯å­˜å‚¨ç»“æ„**

```go
// Redis Keyè®¾è®¡
// 1. è®¾å¤‡åœ¨çº¿çŠ¶æ€: "session:online:{phyID}" -> json{last_seen, conn_id, server_id}
// 2. å¿ƒè·³æ•°æ®: "session:heartbeat:{phyID}" -> json{timestamps[]}
// 3. è¿æ¥æ˜ å°„: "session:conn:{conn_id}" -> phyID
// 4. æœåŠ¡å™¨è¿æ¥: "session:server:{server_id}:conns" -> set[conn_id]
```

**2. å®ç°RedisSessionManager**

```go
// internal/session/redis_manager.go
type RedisSessionManager struct {
    redis     *redis.Client
    serverID  string  // å½“å‰æœåŠ¡å™¨å®ä¾‹ID
    localConn sync.Map  // æœ¬åœ°è¿æ¥ç¼“å­˜ (conn_id -> net.Conn)
}

func (m *RedisSessionManager) Bind(phyID string, conn net.Conn) error
func (m *RedisSessionManager) Unbind(phyID string)
func (m *RedisSessionManager) UpdateHeartbeat(phyID string, ts time.Time)
func (m *RedisSessionManager) IsOnline(phyID string) bool
func (m *RedisSessionManager) GetConn(phyID string) (net.Conn, bool)
```

**3. è¿æ¥è·¯ç”±ç­–ç•¥**

- æ–¹æ¡ˆ1: è¿æ¥äº²å’Œæ€§ï¼ˆåŒä¸€è®¾å¤‡æ€»æ˜¯è¿åˆ°åŒä¸€æœåŠ¡å™¨å®ä¾‹ï¼‰
- æ–¹æ¡ˆ2: æ¶ˆæ¯è½¬å‘ï¼ˆé€šè¿‡Redis Pub/Subè½¬å‘æ¶ˆæ¯ï¼‰
- **æ¨è**: æ–¹æ¡ˆ1ï¼ˆç®€å•å¯é ï¼‰

#### Day 3-4: é›†æˆä¸æµ‹è¯•

**1. æ›´æ–°Bootstrap**

```go
// internal/app/bootstrap/app.go
var sess session.Manager
if redisClient != nil {
    sess = session.NewRedisManager(redisClient, serverID)
} else {
    sess = session.NewManager()  // å…¼å®¹æ¨¡å¼
}
```

**2. æµ‹è¯•åœºæ™¯**

- å•å®ä¾‹æµ‹è¯•
- å¤šå®ä¾‹æµ‹è¯•ï¼ˆ2-3ä¸ªå®ä¾‹ï¼‰
- å®ä¾‹é‡å¯æµ‹è¯•
- Redisæ•…éšœé™çº§æµ‹è¯•

#### Day 5: æ–‡æ¡£ä¸éªŒè¯

**1. æ›´æ–°æ–‡æ¡£**

- æ¶æ„æ–‡æ¡£
- éƒ¨ç½²æ–‡æ¡£ï¼ˆå¤šå®ä¾‹é…ç½®ï¼‰
- è¿ç»´æ–‡æ¡£ï¼ˆRedisç›‘æ§ï¼‰

**2. æ€§èƒ½éªŒè¯**

- ä¼šè¯æ“ä½œå»¶è¿Ÿ < 10ms
- æ”¯æŒ 10000+ è®¾å¤‡åŒæ—¶åœ¨çº¿
- å®ä¾‹é‡å¯æ—¶è®¾å¤‡æ— æ„ŸçŸ¥

---

## ğŸ“… æ—¶é—´çº¿æ€»è§ˆ

```
Week 3 (3-5å¤©): 
  âœ… ä¼šè¯RedisåŒ– â†’ P0ä»»åŠ¡100%å®Œæˆ

Week 4-5 (5-6å¤©):
  âœ… åˆ·å¡å……ç”µåŠŸèƒ½ â†’ åè®®å®Œæˆåº¦67%ï¼Œæ ¸å¿ƒä¸šåŠ¡å¯ç”¨

Week 6-7 (å¯é€‰ï¼ŒæŒ‰éœ€):
  âœ… OTAå‡çº§ (3å¤©)
  âœ… ç»„ç½‘ç®¡ç† (3å¤©)
  âœ… å…¶ä»–åè®®åŠŸèƒ½ (2-3å¤©)

Week 8 (å¯é€‰):
  âœ… ç”Ÿäº§éƒ¨ç½²
  âœ… ç›‘æ§Dashboard
  âœ… å‹åŠ›æµ‹è¯•éªŒè¯
```

---

## ğŸ¤” å†³ç­–å‚è€ƒ

### å¦‚æœæ‚¨çš„ä¼˜å…ˆçº§æ˜¯

#### 1. **å°½å¿«ä¸Šç”Ÿäº§** âš¡

â†’ é€‰æ‹© **é€‰é¡¹A** (3-5å¤©)
â†’ å®Œæˆæ¶æ„åŸºç¡€åï¼Œä½¿ç”¨ç°æœ‰åŠŸèƒ½å…ˆä¸Šçº¿

#### 2. **æ»¡è¶³ä¸šåŠ¡éœ€æ±‚** ğŸ’¼

â†’ é€‰æ‹© **é€‰é¡¹B** (5-6å¤©)
â†’ åˆ·å¡å……ç”µæ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼Œä¼˜å…ˆå®ç°

#### 3. **é•¿æœŸç¨³å®šå‘å±•** ğŸ—ï¸

â†’ é€‰æ‹© **æ¨èæ–¹æ¡ˆ** (8-11å¤©)
â†’ æ¶æ„ â†’ ä¸šåŠ¡ï¼Œç¨³æ‰ç¨³æ‰“

#### 4. **åŠŸèƒ½å…¨é¢** ğŸ“‹

â†’ é€‰æ‹© **é€‰é¡¹C** (8-10å¤©)
â†’ ä½†ä¸æ¨èï¼Œæ€§ä»·æ¯”ä¸é«˜

---

## âœ… å»ºè®®

åŸºäºæ‚¨çš„é¡¹ç›®æƒ…å†µï¼Œ**å¼ºçƒˆæ¨èæ‰§è¡Œæ¨èæ–¹æ¡ˆ**ï¼š

1. **Week 3**: å®Œæˆä¼šè¯RedisåŒ–ï¼ˆé€‰é¡¹Aï¼‰
   - å®ŒæˆP0å…¨éƒ¨ä»»åŠ¡
   - æ¶æ„è¾¾åˆ°ç”Ÿäº§çº§åˆ«
   - ä¸ºåç»­å¼€å‘æ‰“å¥½åŸºç¡€

2. **Week 4-5**: å®ç°åˆ·å¡å……ç”µï¼ˆé€‰é¡¹Bï¼‰
   - åœ¨ç¨³å›ºæ¶æ„ä¸Šå¼€å‘
   - è§£å†³æ ¸å¿ƒä¸šåŠ¡éœ€æ±‚
   - ä»£ç è´¨é‡æœ‰ä¿éšœ

3. **Week 6+**: æ ¹æ®ä¸šåŠ¡ä¼˜å…ˆçº§é€‰æ‹©æ€§è¡¥å…¨å…¶ä»–åŠŸèƒ½

**æ€»å·¥ä½œé‡**: 8-11å¤©  
**æœ€ç»ˆæˆæœ**:

- âœ… æ¶æ„å®Œå–„ï¼Œå¯æ‰©å±•
- âœ… æ ¸å¿ƒä¸šåŠ¡å¯ç”¨
- âœ… åè®®å®Œæˆåº¦67%+
- âœ… ç”Ÿäº§å°±ç»ª

---

**æ‚¨å€¾å‘äºå“ªä¸ªé€‰é¡¹ï¼Ÿæˆ–è€…æœ‰å…¶ä»–ä¼˜å…ˆçº§è€ƒè™‘ï¼Ÿ**
