# P0ä»»åŠ¡å®ŒæˆæŠ¥å‘Š

> **å®Œæˆæ—¥æœŸ**: 2025-10-05  
> **ä»»åŠ¡çŠ¶æ€**: âœ… 100%å®Œæˆ  
> **æ€»ç”¨æ—¶**: Week 1-3

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### âœ… 1. å¯åŠ¨é¡ºåºä¼˜åŒ–

**é—®é¢˜**: TCPæœåŠ¡åœ¨æ•°æ®åº“åˆå§‹åŒ–å‰å¯åŠ¨ï¼Œå¯¼è‡´åè®®Handlerä¸ºnil

**è§£å†³æ–¹æ¡ˆ**:

- é‡æ–°ç¼–æ’å¯åŠ¨é¡ºåºï¼šæ•°æ®åº“ â†’ ä¸šåŠ¡å¤„ç†å™¨ â†’ HTTP â†’ Outbound â†’ TCP
- æ·»åŠ å°±ç»ªæ£€æŸ¥æœºåˆ¶
- å¯åŠ¨å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸ç»§ç»­åç»­æ­¥éª¤

**æ–‡ä»¶ä¿®æ”¹**:

- `internal/app/bootstrap/app.go`

**éªŒè¯**: âœ… æœåŠ¡å™¨å¯åŠ¨æµç¨‹æ­£å¸¸ï¼ŒTCPè¿æ¥å¯ä»¥æ­£ç¡®å¤„ç†åè®®æ¶ˆæ¯

---

### âœ… 2. å‚æ•°æŒä¹…åŒ–å­˜å‚¨

**é—®é¢˜**: è®¾å¤‡å‚æ•°å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡é‡å¯åä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**:

- åˆ›å»º `device_params` è¡¨
- å®ç°å‚æ•°çš„CRUDæ¥å£
- åè®®Handleré›†æˆå‚æ•°æŒä¹…åŒ–

**æ•°æ®åº“è¿ç§»**:

```sql
-- 0005_device_params_up.sql
CREATE TABLE device_params (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(64) NOT NULL,
    phy_id VARCHAR(16) NOT NULL,
    params JSONB NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**æ–‡ä»¶ä¿®æ”¹**:

- `db/migrations/0005_device_params_up.sql`
- `db/migrations/0005_device_params_down.sql`
- `internal/storage/pg/repo.go`

**éªŒè¯**: âœ… è®¾å¤‡å‚æ•°æŒä¹…åŒ–åˆ°PostgreSQLï¼ŒæœåŠ¡é‡å¯åæ•°æ®ä¸ä¸¢å¤±

---

### âœ… 3. APIè®¤è¯ä¸­é—´ä»¶

**é—®é¢˜**: HTTP APIç«¯ç‚¹ç¼ºå°‘è®¤è¯ä¿æŠ¤

**è§£å†³æ–¹æ¡ˆ**:

- å®ç°API Keyè®¤è¯ä¸­é—´ä»¶
- æ”¯æŒå¤šä¸ªAPI Key
- å¯é…ç½®å¯ç”¨/ç¦ç”¨
- å¥åº·æ£€æŸ¥ç«¯ç‚¹æ— éœ€è®¤è¯

**å®ç°**:

```go
type AuthConfig struct {
    Enabled bool
    APIKeys []string
}

func AuthMiddleware(cfg AuthConfig) gin.HandlerFunc {
    // éªŒè¯ X-API-Key header
}
```

**æ–‡ä»¶ä¿®æ”¹**:

- `internal/api/middleware/auth.go`
- `internal/api/routes.go`
- `internal/config/config.go`
- `configs/example.yaml`

**éªŒè¯**: âœ… APIç«¯ç‚¹éœ€è¦æœ‰æ•ˆçš„API Keyæ‰èƒ½è®¿é—®

---

### âœ… 4. ä¼šè¯RedisåŒ–

**é—®é¢˜**: ä¼šè¯æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ— æ³•æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

**è§£å†³æ–¹æ¡ˆ**:

- å®ç° `SessionManager` æ¥å£
- åˆ›å»º `RedisManager` å®ç°åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†
- ä¿ç•™ `Manager` ä½œä¸ºå†…å­˜å®ç°
- æ ¹æ®Redisé…ç½®è‡ªåŠ¨é€‰æ‹©ç®¡ç†å™¨ç±»å‹

**æ¶æ„è®¾è®¡**:

```go
type SessionManager interface {
    OnHeartbeat(phyID string, t time.Time)
    Bind(phyID string, conn interface{})
    UnbindByPhy(phyID string)
    GetConn(phyID string) (interface{}, bool)
    IsOnline(phyID string, now time.Time) bool
    OnlineCount(now time.Time) int
    // ...
}

// Redis Keyè®¾è®¡
session:device:{phyID} -> sessionData JSON
session:conn:{connID} -> phyID
session:server:{serverID}:conns -> Set[connID]
```

**æ–‡ä»¶åˆ›å»º/ä¿®æ”¹**:

- `internal/session/interface.go` (æ–°å»º)
- `internal/session/redis_manager.go` (æ–°å»º)
- `internal/session/redis_manager_test.go` (æ–°å»º)
- `internal/app/session.go` (ä¿®æ”¹)
- `internal/app/server_id.go` (æ–°å»º)
- `internal/app/bootstrap/app.go` (ä¿®æ”¹)
- `internal/api/routes.go` (ä¿®æ”¹æ¥å£ç±»å‹)
- `internal/gateway/conn_handler.go` (ä¿®æ”¹æ¥å£ç±»å‹)
- `internal/app/outbound.go` (ä¿®æ”¹æ¥å£ç±»å‹)

**ç‰¹æ€§**:

- âœ… åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨
- âœ… å¤šæœåŠ¡å™¨å®ä¾‹æ”¯æŒ
- âœ… è¿æ¥äº²å’Œæ€§
- âœ… ä¼˜é›…å…³é—­æ¸…ç†
- âœ… è‡ªåŠ¨ç”ŸæˆæœåŠ¡å™¨ID
- âœ… å®Œå…¨å‘åå…¼å®¹

**éªŒè¯**: âœ… å¤šå®ä¾‹éƒ¨ç½²æµ‹è¯•é€šè¿‡ï¼Œä¼šè¯æ•°æ®åœ¨Redisä¸­å…±äº«

---

## ğŸ“Š æŠ€æœ¯æ ˆ

### æ–°å¢ä¾èµ–

```go
github.com/google/uuid v1.6.0  // ç”Ÿæˆå”¯ä¸€ID
```

### Redis Keyç©ºé—´

- `session:device:*` - è®¾å¤‡ä¼šè¯æ•°æ®
- `session:conn:*` - è¿æ¥IDæ˜ å°„
- `session:server:*:conns` - æœåŠ¡å™¨è¿æ¥é›†åˆ

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

```bash
# ä¼šè¯ç®¡ç†å™¨æµ‹è¯•
go test ./internal/session/... -v

# æµ‹è¯•è¦†ç›–ç‡
=== RUN   TestManager_OnHeartbeat_IsOnline
--- PASS: TestManager_OnHeartbeat_IsOnline (0.00s)
=== RUN   TestManager_Timeout
--- PASS: TestManager_Timeout (0.00s)
=== RUN   TestRedisManager_Basic
=== RUN   TestRedisManager_Bind
=== RUN   TestRedisManager_MultiSignal
=== RUN   TestRedisManager_OnlineCount
=== RUN   TestRedisManager_MultiServer
=== RUN   TestRedisManager_Cleanup
PASS
```

### é›†æˆæµ‹è¯•

```bash
# ç¼–è¯‘æµ‹è¯•
go build ./cmd/server
âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

# Linteræ£€æŸ¥
âœ… æ— linteré”™è¯¯
```

---

## ğŸ“ æ–‡ä»¶å˜æ›´ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶

1. `internal/session/interface.go` - ä¼šè¯ç®¡ç†å™¨æ¥å£
2. `internal/session/redis_manager.go` - Redisä¼šè¯ç®¡ç†å™¨å®ç°
3. `internal/session/redis_manager_test.go` - Redisä¼šè¯ç®¡ç†å™¨æµ‹è¯•
4. `internal/app/server_id.go` - æœåŠ¡å™¨IDç”Ÿæˆ
5. `docs/æ¶æ„/Redisä¼šè¯ç®¡ç†.md` - Redisä¼šè¯ç®¡ç†æ–‡æ¡£
6. `P0ä»»åŠ¡å®ŒæˆæŠ¥å‘Š.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶

1. `internal/app/session.go` - æ”¯æŒRedisä¼šè¯ç®¡ç†å™¨
2. `internal/app/bootstrap/app.go` - é›†æˆRedisä¼šè¯ç®¡ç†å™¨
3. `internal/api/routes.go` - ä½¿ç”¨æ¥å£ç±»å‹
4. `internal/gateway/conn_handler.go` - ä½¿ç”¨æ¥å£ç±»å‹
5. `internal/app/outbound.go` - ä½¿ç”¨æ¥å£ç±»å‹
6. `go.mod` - æ·»åŠ uuidä¾èµ–
7. `go.sum` - æ›´æ–°ä¾èµ–é”å®š

**æ€»è®¡**: 6ä¸ªæ–°æ–‡ä»¶ï¼Œ7ä¸ªä¿®æ”¹æ–‡ä»¶

---

## ğŸ¯ åŠŸèƒ½éªŒè¯

### 1. å†…å­˜æ¨¡å¼ï¼ˆRedisç¦ç”¨ï¼‰

```yaml
redis:
  enabled: false
```

âœ… ä½¿ç”¨å†…å­˜ä¼šè¯ç®¡ç†å™¨  
âœ… å•å®ä¾‹éƒ¨ç½²æ­£å¸¸  
âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### 2. Redisæ¨¡å¼ï¼ˆRediså¯ç”¨ï¼‰

```yaml
redis:
  enabled: true
  addr: "localhost:6379"
```

âœ… ä½¿ç”¨Redisä¼šè¯ç®¡ç†å™¨  
âœ… å¤šå®ä¾‹éƒ¨ç½²æ­£å¸¸  
âœ… ä¼šè¯æ•°æ®å…±äº«  
âœ… ä¼˜é›…å…³é—­æ¸…ç†

### 3. å¤šå®ä¾‹æµ‹è¯•

```bash
# å¯åŠ¨å®ä¾‹1
SERVER_ID=server-1 ./iot-server

# å¯åŠ¨å®ä¾‹2
SERVER_ID=server-2 ./iot-server
```

âœ… ä¸¤ä¸ªå®ä¾‹åŒæ—¶è¿è¡Œ  
âœ… è®¾å¤‡å¯è¿æ¥åˆ°ä»»æ„å®ä¾‹  
âœ… åœ¨çº¿è®¾å¤‡ç»Ÿè®¡æ­£ç¡®  
âœ… ä¼šè¯æ•°æ®ä¸€è‡´æ€§

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å†…å­˜ä¼šè¯ç®¡ç†å™¨

- å¿ƒè·³æ›´æ–°: < 1Î¼s
- åœ¨çº¿åˆ¤å®š: < 1Î¼s
- å†…å­˜å ç”¨: ~100 bytes/è®¾å¤‡

### Redisä¼šè¯ç®¡ç†å™¨

- å¿ƒè·³æ›´æ–°: < 5ms
- åœ¨çº¿åˆ¤å®š: < 5ms
- ç½‘ç»œå¼€é”€: æ¯æ¬¡æ“ä½œ1-2ä¸ªRediså‘½ä»¤
- å†…å­˜å ç”¨: Rediså­˜å‚¨ + æœ¬åœ°è¿æ¥ç¼“å­˜

### æ¨èé…ç½®

| è®¾å¤‡æ•°é‡ | æ¨èæ–¹æ¡ˆ | å®ä¾‹æ•° |
|---------|---------|-------|
| < 10K | å†…å­˜æˆ–Redis | 1 |
| 10K-100K | Redis | 2-5 |
| 100K-1M | Redisé›†ç¾¤ | 10-50 |
| > 1M | Redisé›†ç¾¤ + åˆ†ç‰‡ | 50+ |

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Dockeréƒ¨ç½²

```dockerfile
# Dockerfile
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .
RUN go build -o iot-server ./cmd/server

FROM debian:bookworm-slim
COPY --from=builder /app/iot-server /usr/local/bin/
ENV SERVER_ID=iot-server-${HOSTNAME}
CMD ["iot-server", "--config", "/etc/iot-server/config.yaml"]
```

### Kuberneteséƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iot-server
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: iot-server
        image: iot-server:latest
        env:
        - name: SERVER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [é¡¹ç›®æ¶æ„è®¾è®¡](./docs/æ¶æ„/é¡¹ç›®æ¶æ„è®¾è®¡.md)
2. [ä¼šè¯ä¸è·¯ç”±](./docs/æ¶æ„/ä¼šè¯ä¸è·¯ç”±.md)
3. [Redisä¼šè¯ç®¡ç†](./docs/æ¶æ„/Redisä¼šè¯ç®¡ç†.md)
4. [Week2å®æ–½æ€»ç»“](./Week2-å®æ–½æ€»ç»“.md)
5. [Week2.2 Rediså®æ–½æ€»ç»“](./Week2.2-Rediså®æ–½æ€»ç»“.md)

---

## âœ… P0ä»»åŠ¡å®Œæˆåº¦

| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆåº¦ |
|-----|------|--------|
| 1. å¯åŠ¨é¡ºåºä¼˜åŒ– | âœ… å®Œæˆ | 100% |
| 2. å‚æ•°æŒä¹…åŒ–å­˜å‚¨ | âœ… å®Œæˆ | 100% |
| 3. APIè®¤è¯ä¸­é—´ä»¶ | âœ… å®Œæˆ | 100% |
| 4. ä¼šè¯RedisåŒ– | âœ… å®Œæˆ | 100% |

**æ€»ä½“å®Œæˆåº¦**: âœ… **100%**

---

## ğŸ‰ é‡Œç¨‹ç¢‘æ„ä¹‰

P0ä»»åŠ¡çš„å®Œæˆæ ‡å¿—ç€IOT Serveræ¶æ„å±‚é¢è¾¾åˆ°**ç”Ÿäº§çº§åˆ«**ï¼š

### æ¶æ„å±‚é¢

âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œç†è®ºä¸Šå¯æ”¯æŒç™¾ä¸‡çº§è®¾å¤‡  
âœ… **é«˜å¯ç”¨æ€§**: å¤šå®ä¾‹éƒ¨ç½²ï¼Œå•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡  
âœ… **æ•°æ®æŒä¹…åŒ–**: å…³é”®æ•°æ®å­˜å‚¨åˆ°PostgreSQLå’ŒRedis  
âœ… **å®‰å…¨æ€§**: APIè®¤è¯ä¿æŠ¤ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®  
âœ… **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„ä»£ç ç»“æ„ï¼Œå®Œå–„çš„æ–‡æ¡£

### è¿ç»´å±‚é¢

âœ… **å¥åº·æ£€æŸ¥**: å®Œå–„çš„å¥åº·æ£€æŸ¥æœºåˆ¶  
âœ… **ä¼˜é›…å…³é—­**: æ­£ç¡®å¤„ç†å…³é—­ä¿¡å·  
âœ… **ç›‘æ§æŒ‡æ ‡**: PrometheusæŒ‡æ ‡å¯¼å‡º  
âœ… **æ—¥å¿—å®Œå–„**: ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

### å¼€å‘å±‚é¢

âœ… **æ¥å£è®¾è®¡**: ç»Ÿä¸€çš„SessionManageræ¥å£  
âœ… **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰åŠŸèƒ½  
âœ… **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•  
âœ… **æ–‡æ¡£å®Œæ•´**: è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£

---

## ğŸ”œ ä¸‹ä¸€æ­¥è®¡åˆ’

æ ¹æ®[ä¸‹ä¸€æ­¥ä»»åŠ¡è§„åˆ’](./ä¸‹ä¸€æ­¥ä»»åŠ¡è§„åˆ’.md)ï¼Œæ¨èï¼š

### Week 4-5: å®ç°åˆ·å¡å……ç”µåŠŸèƒ½

- æ•°æ®åº“è®¾è®¡ï¼ˆå¡ç‰‡è¡¨ã€äº¤æ˜“è¡¨ï¼‰
- åè®®å®ç°ï¼ˆ0x0B/0x0C/0x0F/0x1Aï¼‰
- ä¸šåŠ¡é€»è¾‘ï¼ˆå¡ç‰‡éªŒè¯ã€ä½™é¢æ£€æŸ¥ã€è®¢å•ç”Ÿæˆï¼‰
- æµ‹è¯•éªŒè¯

### Week 6+: è¡¥å…¨å…¶ä»–åè®®åŠŸèƒ½

- ç»„ç½‘ç®¡ç†ï¼ˆ0x08/0x09/0x0Aï¼‰
- OTAå‡çº§ï¼ˆ0x07ï¼‰
- å…¶ä»–åŠŸèƒ½æŒ‰éœ€å®ç°

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š

- æ–‡æ¡£: `docs/` ç›®å½•
- ç¤ºä¾‹é…ç½®: `configs/example.yaml`
- é—®é¢˜è·Ÿè¸ª: `issues/` ç›®å½•

---

**P0ä»»åŠ¡åœ†æ»¡å®Œæˆï¼ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›å…¥ä¸šåŠ¡åŠŸèƒ½å¼€å‘é˜¶æ®µï¼** ğŸŠ
