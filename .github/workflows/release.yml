name: Release - ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.0"

      - name: ç”Ÿæˆ Swagger æ–‡æ¡£
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          swag init -g cmd/server/main.go -o api/swagger --parseDependency --parseInternal

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: æ„å»ºå¤šå¹³å°ç‰ˆæœ¬
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')

          # Linux amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
          -o bin/iot-server-linux-amd64 ./cmd/server

          # Linux arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
          -o bin/iot-server-linux-arm64 ./cmd/server

          # Darwin amd64
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
          -o bin/iot-server-darwin-amd64 ./cmd/server

          # Darwin arm64
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
          -o bin/iot-server-darwin-arm64 ./cmd/server

          echo "âœ… å¤šå¹³å°æ„å»ºå®Œæˆ"

      - name: ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
        run: |
          cd bin
          sha256sum iot-server-* > SHA256SUMS
          cat SHA256SUMS

      - name: æå– CHANGELOG
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          if [ -f CHANGELOG.md ]; then
            # æå–å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOG
            awk "/## \[${VERSION#v}\]/,/## \[/" CHANGELOG.md | \
            sed '/## \[/d' | \
            head -n -1 > /tmp/release_notes.md
            
            if [ -s /tmp/release_notes.md ]; then
              echo "âœ… æå– CHANGELOG æˆåŠŸ"
              cat /tmp/release_notes.md
            else
              echo "âš ï¸  æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„ CHANGELOG"
              echo "ç‰ˆæœ¬ $VERSION å‘å¸ƒ" > /tmp/release_notes.md
            fi
          else
            echo "âš ï¸  CHANGELOG.md ä¸å­˜åœ¨"
            echo "ç‰ˆæœ¬ $VERSION å‘å¸ƒ" > /tmp/release_notes.md
          fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          files: |
            bin/iot-server-linux-amd64
            bin/iot-server-linux-arm64
            bin/iot-server-darwin-amd64
            bin/iot-server-darwin-arm64
            bin/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} åˆ›å»ºæˆåŠŸï¼"
          echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
