name: Release - ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  # å¹¶è¡Œæ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶
  build:
    name: æ„å»º - ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.4"

      - name: ç¼“å­˜ Go æ¨¡å—
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # å°è¯•ä»æœ€è¿‘çš„ CI workflow ä¸‹è½½ Swagger æ–‡æ¡£ï¼Œå¤±è´¥åˆ™æœ¬åœ°ç”Ÿæˆ
      - name: ä¸‹è½½ Swagger æ–‡æ¡£
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: ci.yml
          name: swagger-docs
          path: api/swagger/
          if_no_artifact_found: ignore

      - name: ç”Ÿæˆ Swagger æ–‡æ¡£ï¼ˆå¦‚æœæœªä¸‹è½½ï¼‰
        run: |
          if [ ! -f "api/swagger/swagger.json" ]; then
            echo "æœªæ‰¾åˆ° Swagger artifactï¼Œæœ¬åœ°ç”Ÿæˆ..."
            go install github.com/swaggo/swag/cmd/swag@latest
            swag init -g cmd/server/main.go -o api/swagger --parseDependency --parseInternal
            echo "âœ… Swagger æ–‡æ¡£å·²ç”Ÿæˆ"
          else
            echo "âœ… ä½¿ç”¨ä¸‹è½½çš„ Swagger æ–‡æ¡£"
          fi

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: éªŒè¯ç‰ˆæœ¬å·
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
            echo "æ­£ç¡®æ ¼å¼: v1.2.3"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

      - name: æ„å»º ${{ matrix.os }}-${{ matrix.arch }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')

          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
          -o bin/iot-server-${{ matrix.os }}-${{ matrix.arch }} ./cmd/server

          echo "âœ… æ„å»ºå®Œæˆ: iot-server-${{ matrix.os }}-${{ matrix.arch }}"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.os }}-${{ matrix.arch }}
          path: bin/iot-server-${{ matrix.os }}-${{ matrix.arch }}
          retention-days: 1

  # åˆ›å»º GitHub Release
  release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: bin/
          merge-multiple: true

      - name: ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
        run: |
          cd bin
          sha256sum iot-server-* > SHA256SUMS
          echo "âœ… SHA256 æ ¡éªŒå’Œ:"
          cat SHA256SUMS

      - name: æå– CHANGELOG
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          if [ -f CHANGELOG.md ]; then
            # æå–å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOG
            awk "/## \[${VERSION#v}\]/,/## \[/" CHANGELOG.md | \
            sed '/## \[/d' | \
            head -n -1 > /tmp/release_notes.md

            if [ -s /tmp/release_notes.md ]; then
              echo "âœ… æå– CHANGELOG æˆåŠŸ"
              cat /tmp/release_notes.md
            else
              echo "âš ï¸  æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„ CHANGELOG"
              echo "ç‰ˆæœ¬ $VERSION å‘å¸ƒ" > /tmp/release_notes.md
            fi
          else
            echo "âš ï¸  CHANGELOG.md ä¸å­˜åœ¨"
            echo "ç‰ˆæœ¬ $VERSION å‘å¸ƒ" > /tmp/release_notes.md
          fi

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©æ¸…å•:"
          ls -lh bin/

          # éªŒè¯æ‰€æœ‰å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for file in iot-server-linux-amd64 iot-server-linux-arm64 iot-server-darwin-amd64 iot-server-darwin-arm64; do
            if [ ! -f "bin/$file" ]; then
              echo "âŒ ç¼ºå°‘æ„å»ºäº§ç‰©: $file"
              exit 1
            fi
          done

          echo "âœ… æ‰€æœ‰æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          files: |
            bin/iot-server-linux-amd64
            bin/iot-server-linux-arm64
            bin/iot-server-darwin-amd64
            bin/iot-server-darwin-arm64
            bin/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} åˆ›å»ºæˆåŠŸï¼"
          echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
