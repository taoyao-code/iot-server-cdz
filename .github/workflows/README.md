# GitHub Actions CI/CD è¯´æ˜

## ğŸ“‹ å·¥ä½œæµæ¦‚è§ˆ

æœ¬é¡¹ç›®é…ç½®äº†å®Œæ•´çš„GitHub Actions CI/CDè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ã€‚

### å·¥ä½œæµæ–‡ä»¶

- **`test.yml`** - ä¸»æµ‹è¯•å·¥ä½œæµ

## ğŸ¯ test.yml å·¥ä½œæµ

### è§¦å‘æ¡ä»¶

```yaml
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
```

- æ¨é€åˆ° `main` æˆ– `develop` åˆ†æ”¯æ—¶è§¦å‘
- åˆ›å»ºæˆ–æ›´æ–°é’ˆå¯¹ `main` æˆ– `develop` çš„PRæ—¶è§¦å‘

### åŒ…å«çš„Job

#### 1. **test** - å®Œæ•´æµ‹è¯•å¥—ä»¶

- **è¿è¡Œç¯å¢ƒ**: Ubuntu Latest
- **æœåŠ¡ä¾èµ–**: 
  - PostgreSQL 15
  - Redis 7
- **æ‰§è¡Œæ­¥éª¤**:
  1. æ£€å‡ºä»£ç 
  2. è®¾ç½®Go 1.23ç¯å¢ƒ
  3. ä¸‹è½½ä¾èµ–
  4. ç­‰å¾…PostgreSQLå°±ç»ª
  5. è¿è¡Œæ•°æ®åº“è¿ç§»
  6. æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…å«ç«æ€æ£€æµ‹ï¼‰
  7. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
  8. æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼ï¼ˆâ‰¥50%ï¼‰
  9. ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov

**è¦†ç›–ç‡è¦æ±‚**: â‰¥50%ï¼Œå¦åˆ™CIå¤±è´¥

#### 2. **storage-pg-tests** - Storage/PGæ¨¡å—ä¸“é¡¹æµ‹è¯•

- **è¿è¡Œç¯å¢ƒ**: Ubuntu Latest
- **æœåŠ¡ä¾èµ–**: PostgreSQL 15
- **æ‰§è¡Œæ­¥éª¤**:
  1. æ£€å‡ºä»£ç 
  2. è®¾ç½®Goç¯å¢ƒ
  3. è¿è¡Œæ•°æ®åº“è¿ç§»
  4. æ‰§è¡Œ `internal/storage/pg/` æ‰€æœ‰æµ‹è¯•
  5. ç”Ÿæˆæ¨¡å—è¦†ç›–ç‡æŠ¥å‘Š

**è¦†ç›–ç‡ç›®æ ‡**: â‰¥60%ï¼ˆä»…è­¦å‘Šï¼Œä¸é˜»æ­¢CIï¼‰

**æµ‹è¯•å†…å®¹**:
- è®¢å•çŠ¶æ€æµè½¬æµ‹è¯•ï¼ˆ12ä¸ªï¼‰
- å¼‚å¸¸åœºæ™¯æµ‹è¯•ï¼ˆ11ä¸ªï¼‰
- è®¾å¤‡æ£€æŸ¥æµ‹è¯•ï¼ˆ10ä¸ªï¼‰

#### 3. **lint** - ä»£ç è´¨é‡æ£€æŸ¥

- **å·¥å…·**: golangci-lint
- **è¶…æ—¶**: 5åˆ†é’Ÿ
- **ç”¨é€”**: æ£€æŸ¥ä»£ç è§„èŒƒå’Œæ½œåœ¨é—®é¢˜

#### 4. **build** - ç¼–è¯‘æ£€æŸ¥

- **ç”¨é€”**: éªŒè¯ä»£ç å¯ä»¥æˆåŠŸç¼–è¯‘
- **è¾“å‡º**: `server` äºŒè¿›åˆ¶æ–‡ä»¶

---

## ğŸ“Š æŸ¥çœ‹æµ‹è¯•ç»“æœ

### 1. GitHub Actions ç•Œé¢

è®¿é—®ï¼š`https://github.com/YOUR_ORG/iot-server/actions`

### 2. PRæ£€æŸ¥çŠ¶æ€

æ¯ä¸ªPRä¼šæ˜¾ç¤ºCIçŠ¶æ€ï¼š
- âœ… **All checks passed** - æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âŒ **Some checks failed** - éƒ¨åˆ†æµ‹è¯•å¤±è´¥
- ğŸŸ¡ **Checks running** - æµ‹è¯•è¿›è¡Œä¸­

### 3. è¦†ç›–ç‡æŠ¥å‘Š

åœ¨æ¯ä¸ªJobçš„**Summary**æ ‡ç­¾é¡µæŸ¥çœ‹ï¼š
- æ€»ä½“è¦†ç›–ç‡ç»Ÿè®¡
- å„æ¨¡å—è¦†ç›–ç‡æ˜ç»†
- Storage/PGæ¨¡å—è¯¦ç»†æŠ¥å‘Š

### 4. Codecové›†æˆ

è®¿é—®ï¼š`https://codecov.io/gh/YOUR_ORG/iot-server`

æŸ¥çœ‹ï¼š
- è¦†ç›–ç‡è¶‹åŠ¿å›¾
- æœªè¦†ç›–ä»£ç é«˜äº®
- PRè¦†ç›–ç‡å˜åŒ–

---

## ğŸ”§ æœ¬åœ°å¤ç°CIç¯å¢ƒ

### ä½¿ç”¨Docker Compose

```bash
# å¯åŠ¨æµ‹è¯•æœåŠ¡
docker-compose -f docker-compose.test.yml up -d

# è¿è¡Œæµ‹è¯•
export TEST_DATABASE_URL="postgres://postgres:postgres@localhost:5432/iot_test?sslmode=disable"
export REDIS_URL="redis://localhost:6379/0"
go test ./internal/... -v -race -coverprofile=coverage.out

# æŸ¥çœ‹è¦†ç›–ç‡
go tool cover -html=coverage.out

# åœæ­¢æœåŠ¡
docker-compose -f docker-compose.test.yml down
```

### ä½¿ç”¨è„šæœ¬

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
bash scripts/test-coverage.sh
```

---

## ğŸ“ˆ è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | å½“å‰ | ç›®æ ‡ | CIé˜ˆå€¼ |
|------|------|------|--------|
| **æ•´ä½“** | ~29% | **â‰¥50%** | **50%** (å¤±è´¥) |
| **storage/pg** | 0% â†’ | **â‰¥60%** | 60% (è­¦å‘Š) |
| è®¢å•çŠ¶æ€æµè½¬ | - | â‰¥80% | - |
| å¼‚å¸¸åœºæ™¯ | - | â‰¥70% | - |
| è®¾å¤‡æ£€æŸ¥ | - | â‰¥75% | - |

---

## ğŸš¨ CIå¤±è´¥å¤„ç†

### æµ‹è¯•å¤±è´¥

1. æŸ¥çœ‹å¤±è´¥çš„æµ‹è¯•æ—¥å¿—
2. æœ¬åœ°å¤ç°é—®é¢˜
3. ä¿®å¤ä»£ç åé‡æ–°æäº¤

### è¦†ç›–ç‡ä¸è¾¾æ ‡

1. æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Šï¼Œæ‰¾åˆ°æœªè¦†ç›–ä»£ç 
2. è¡¥å……æµ‹è¯•ç”¨ä¾‹
3. æäº¤åè‡ªåŠ¨é‡æ–°è¿è¡ŒCI

### Linté”™è¯¯

```bash
# æœ¬åœ°è¿è¡Œlint
golangci-lint run

# è‡ªåŠ¨ä¿®å¤éƒ¨åˆ†é—®é¢˜
golangci-lint run --fix
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼€å‘æµç¨‹

```bash
# 1. åˆ›å»ºåˆ†æ”¯
git checkout -b feature/new-feature

# 2. å¼€å‘ + ç¼–å†™æµ‹è¯•
# ...

# 3. æœ¬åœ°æµ‹è¯•
go test ./... -v

# 4. æäº¤ä»£ç 
git push origin feature/new-feature

# 5. åˆ›å»ºPR -> è‡ªåŠ¨è§¦å‘CI

# 6. CIé€šè¿‡ååˆå¹¶
```

### 2. PRè¦æ±‚

- âœ… æ‰€æœ‰CIæ£€æŸ¥é€šè¿‡
- âœ… è¦†ç›–ç‡â‰¥50%
- âœ… æ— linté”™è¯¯
- âœ… Code Reviewé€šè¿‡

### 3. ç´§æ€¥ä¿®å¤

å¦‚æœéœ€è¦ç´§æ€¥åˆå¹¶ä½†CIå¤±è´¥ï¼š

```bash
# ä»…ç”¨äºç´§æ€¥æƒ…å†µ
git commit -m "fix: urgent fix [skip ci]"
```

âš ï¸ **ä¸æ¨è**ï¼Œä»…åœ¨ç´§æ€¥æƒ…å†µä½¿ç”¨

---

## ğŸ” Secretsé…ç½®

### å¿…éœ€Secrets

æ— éœ€é…ç½®ï¼Œä½¿ç”¨GitHubå†…ç½®æœåŠ¡

### å¯é€‰Secrets

å¦‚éœ€Codecové›†æˆï¼š

1. è®¿é—® https://codecov.io
2. å…³è”GitHubä»“åº“
3. è·å– `CODECOV_TOKEN`
4. æ·»åŠ åˆ° GitHub Secrets: `Settings -> Secrets -> Actions -> New repository secret`

---

## ğŸ“ ç»´æŠ¤æŒ‡å—

### æ›´æ–°Goç‰ˆæœ¬

ç¼–è¾‘ `.github/workflows/test.yml`:

```yaml
- name: Set up Go
  uses: actions/setup-go@v5
  with:
    go-version: '1.24'  # æ›´æ–°ç‰ˆæœ¬å·
```

### æ·»åŠ æ–°æµ‹è¯•Job

```yaml
new-test-job:
  name: New Test Suite
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
    - run: go test ./new-module/... -v
```

### è°ƒæ•´è¦†ç›–ç‡é˜ˆå€¼

ç¼–è¾‘è¦†ç›–ç‡æ£€æŸ¥æ­¥éª¤ï¼š

```bash
if (( $(echo "$COVERAGE < 60" | bc -l) )); then
  echo "âŒ è¦†ç›–ç‡ä½äº 60%"
  exit 1
fi
```

---

## ğŸ“ æ•…éšœæ’æŸ¥

### Q: æ•°æ®åº“è¿æ¥å¤±è´¥

A: æ£€æŸ¥ `services.postgres` å¥åº·æ£€æŸ¥æ˜¯å¦é€šè¿‡

### Q: æµ‹è¯•è¶…æ—¶

A: å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æ…¢æµ‹è¯•

### Q: è¦†ç›–ç‡è®¡ç®—é”™è¯¯

A: ç¡®ä¿æ‰€æœ‰åŒ…éƒ½åŒ…å«åœ¨æµ‹è¯•èŒƒå›´å†…

---

## âœ… æ£€æŸ¥æ¸…å•

æ¨é€ä»£ç å‰ï¼š

- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] æ–°ä»£ç æœ‰æµ‹è¯•è¦†ç›–
- [ ] Lintæ£€æŸ¥é€šè¿‡
- [ ] ä»£ç å¯ä»¥ç¼–è¯‘

---

**æœ€åæ›´æ–°**: 2025-11-10

