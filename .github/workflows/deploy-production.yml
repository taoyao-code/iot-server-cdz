name: Deploy - ç”Ÿäº§ç¯å¢ƒ

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "éƒ¨ç½²ç‰ˆæœ¬ (å¦‚: v1.2.3)"
        required: true

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment: production
    # é˜²æ­¢ dependabot æˆ–å…¶ä»–è‡ªåŠ¨åŒ–è§¦å‘æ—¶æ— æ³•è®¿é—® secrets
    if: github.actor != 'dependabot[bot]'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.4"

      - name: ç¼“å­˜ Go æ¨¡å—
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # å°è¯•ä»æœ€è¿‘çš„ CI workflow ä¸‹è½½ Swagger æ–‡æ¡£ï¼Œå¤±è´¥åˆ™æœ¬åœ°ç”Ÿæˆ
      - name: ä¸‹è½½ Swagger æ–‡æ¡£
        uses: dawidd6/action-download-artifact@v11
        continue-on-error: true
        with:
          workflow: ci.yml
          name: swagger-docs
          path: api/swagger/
          if_no_artifact_found: ignore

      - name: ç”Ÿæˆ Swagger æ–‡æ¡£ï¼ˆå¦‚æœæœªä¸‹è½½ï¼‰
        run: |
          if [ ! -f "api/swagger/swagger.json" ]; then
            echo "æœªæ‰¾åˆ° Swagger artifactï¼Œæœ¬åœ°ç”Ÿæˆ..."
            go install github.com/swaggo/swag/cmd/swag@latest
            swag init -g cmd/server/main.go -o api/swagger --parseDependency --parseInternal
            echo "âœ… Swagger æ–‡æ¡£å·²ç”Ÿæˆ"
          else
            echo "âœ… ä½¿ç”¨ä¸‹è½½çš„ Swagger æ–‡æ¡£"
          fi

      - name: éªŒè¯ç‰ˆæœ¬å·
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          echo "éƒ¨ç½²ç‰ˆæœ¬: $VERSION"

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
            echo "æ­£ç¡®æ ¼å¼: v1.2.3"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: è¿è¡Œå®Œæ•´æµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
          make test-all

      - name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬: $VERSION"

          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=$(date -u '+%Y-%m-%d %H:%M:%S')" \
          -o bin/iot-server-linux ./cmd/server

          echo "âœ… æ„å»ºå®Œæˆ"

      - name: é¢„æ£€ä¸å‡†å¤‡ SSH
        env:
          SSH_HOST: ${{ secrets.PROD_HOST || secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_USER || secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.PROD_SSH_KEY || secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.PROD_PORT || '22' }}
        run: |
          set -Eeuo pipefail

          # 1) æ ¡éªŒå¿…éœ€å˜é‡
          if [[ -z "${SSH_HOST:-}" || -z "${SSH_USER:-}" || -z "${SSH_KEY:-}" ]]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€çš„ SSH é…ç½®ï¼Œè¯·åœ¨ç¯å¢ƒ 'production' è®¾ç½® PROD_HOST / PROD_USER / PROD_SSH_KEYï¼ˆæˆ–ä½¿ç”¨é€šç”¨ SSH_HOST/SSH_USER/SSH_KEY ä½œä¸ºå…œåº•ï¼‰ã€‚"
            echo "å½“å‰å€¼:"
            echo "  SSH_HOST: ${SSH_HOST:-<æœªè®¾ç½®>}"
            echo "  SSH_USER: ${SSH_USER:-<æœªè®¾ç½®>}"
            echo "  SSH_KEY:  $(if [ -z "${SSH_KEY:-}" ]; then echo "<æœªè®¾ç½®>"; else echo "<å·²è®¾ç½®>"; fi)"
            exit 1
          fi

          # 2) å‡†å¤‡å¯†é’¥ï¼ˆå…¼å®¹æ˜æ–‡æˆ– base64ï¼‰
          mkdir -p ~/.ssh
          if [[ "$SSH_KEY" == *"BEGIN"* ]]; then
            printf "%s\n" "$SSH_KEY" > ~/.ssh/deploy_key
          else
            echo "$SSH_KEY" | base64 -d > ~/.ssh/deploy_key 2>/dev/null || {
              echo "âŒ SSH_KEY æ—¢ä¸æ˜¯æ˜æ–‡ç§é’¥ä¹Ÿä¸æ˜¯æœ‰æ•ˆçš„ base64 ç¼–ç ï¼Œè¯·æ£€æŸ¥ secret å†…å®¹ã€‚"
              exit 1
            }
          fi
          chmod 600 ~/.ssh/deploy_key

          # 3) known_hosts ä¸è¿é€šæ€§æ£€æŸ¥
          echo "ğŸ” æ·»åŠ ä¸»æœºåˆ° known_hosts: $SSH_HOST:$SSH_PORT"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "ğŸ” æµ‹è¯•è¿é€šæ€§: $SSH_HOST:$SSH_PORT"
          if ! timeout 10 bash -c "cat < /dev/null > /dev/tcp/$SSH_HOST/$SSH_PORT" 2>/dev/null; then
            echo "âŒ æ— æ³•è¿æ¥åˆ° $SSH_HOST:$SSH_PORTï¼Œè¯·æ£€æŸ¥:"
            echo "  1. ä¸»æœºå/IP æ˜¯å¦æ­£ç¡®"
            echo "  2. ç«¯å£æ˜¯å¦å¼€æ”¾"
            echo "  3. å®‰å…¨ç»„/é˜²ç«å¢™æ˜¯å¦å…è®¸ GitHub Actions IP è®¿é—®"
            exit 1
          fi
          echo "âœ… è¿é€šæ€§æ£€æŸ¥é€šè¿‡"

      - name: ä¼ è¾“ä¸éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        env:
          SSH_HOST: ${{ secrets.PROD_HOST || secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.PROD_USER || secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.PROD_PORT || '22' }}
          VERSION: ${{ env.VERSION }}
        run: |
          set -Eeuo pipefail

          echo "ğŸ“¦ ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶åˆ° $SSH_HOST..."
          scp -P "$SSH_PORT" -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o IdentitiesOnly=yes -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
            bin/iot-server-linux "${SSH_USER}@${SSH_HOST}:/tmp/iot-server-${VERSION}"

          echo "ğŸš€ æ‰§è¡Œè¿œç¨‹éƒ¨ç½²..."
          ssh -p "$SSH_PORT" -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o IdentitiesOnly=yes -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
            "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
            set -e

            echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
            echo "ç‰ˆæœ¬: ${VERSION}"

            # æ‰§è¡Œæ•°æ®åº“è¿ç§»
            echo "ğŸ“Š æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
            cd /opt/iot-server
            if [ -f "./bin/migrate.sh" ]; then
              ./bin/migrate.sh || echo "âš ï¸ è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥"
            else
              echo "âš ï¸ è¿ç§»è„šæœ¬æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ•°æ®åº“è¿ç§»"
            fi

            # åˆ›å»ºå¤‡ä»½
            BACKUP_DIR="/opt/backups/$(date +%Y%m%d_%H%M%S)_${VERSION}"
            mkdir -p "$BACKUP_DIR"

            if [ -f /opt/iot-server/iot-server ]; then
              cp /opt/iot-server/iot-server "$BACKUP_DIR/iot-server.backup"
              echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
            fi

            # æ›¿æ¢äºŒè¿›åˆ¶
            mv /tmp/iot-server-${VERSION} /opt/iot-server/iot-server
            chmod +x /opt/iot-server/iot-server
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å·²æ›´æ–°"

            # é‡å¯æœåŠ¡ï¼ˆç»Ÿä¸€ä½¿ç”¨ docker composeï¼‰
            cd /opt/iot-server
            if command -v docker compose &> /dev/null; then
              docker compose restart iot-server
            else
              docker-compose restart iot-server
            fi

            echo "âœ… æœåŠ¡å·²é‡å¯"

            # å¢å¼ºå¥åº·æ£€æŸ¥ï¼ˆ15 ç§’åˆå§‹ç­‰å¾… + 8 æ¬¡é‡è¯•ï¼‰
            echo "ğŸ” å¥åº·æ£€æŸ¥ä¸­..."
            sleep 15

            HEALTH_CHECK_PASSED=false
            for i in {1..8}; do
              echo "å°è¯• $i/8..."
              if curl -f http://localhost:7055/healthz > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                HEALTH_CHECK_PASSED=true
                break
              fi
              sleep 5
            done

            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
              if [ -f "$BACKUP_DIR/iot-server.backup" ]; then
                mv "$BACKUP_DIR/iot-server.backup" /opt/iot-server/iot-server
                if command -v docker compose &> /dev/null; then
                  docker compose restart iot-server
                else
                  docker-compose restart iot-server
                fi
                echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬"
              fi
              exit 1
            fi
          ENDSSH

          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "ç‰ˆæœ¬: $VERSION"

      - name: æ¸…ç† SSH å¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: éƒ¨ç½²é€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "ç‰ˆæœ¬: $VERSION"
          echo "ç¯å¢ƒ: production"
          echo "æ—¶é—´: $(date)"
