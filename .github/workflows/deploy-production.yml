name: Deploy - ç”Ÿäº§ç¯å¢ƒ

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "éƒ¨ç½²ç‰ˆæœ¬ (å¦‚: v1.2.3)"
        required: true

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.0"

      - name: éªŒè¯ç‰ˆæœ¬å·
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          echo "éƒ¨ç½²ç‰ˆæœ¬: $VERSION"

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
            echo "æ­£ç¡®æ ¼å¼: v1.2.3"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: è¿è¡Œå®Œæ•´æµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
          make test-all

      - name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬: $VERSION"

          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-w -s -X main.Version=${VERSION} -X main.BuildTime=$(date -u '+%Y-%m-%d %H:%M:%S')" \
          -o bin/iot-server-linux ./cmd/server

          echo "âœ… æ„å»ºå®Œæˆ"

      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        env:
          SSH_HOST: ${{ secrets.PROD_HOST }}
          SSH_USER: ${{ secrets.PROD_USER }}
          SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          SSH_PORT: ${{ secrets.PROD_PORT || '22' }}
        run: |
          # è®¾ç½® SSH å¯†é’¥
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # æ·»åŠ ä¸»æœºåˆ° known_hosts
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
          scp -P $SSH_PORT -i ~/.ssh/deploy_key \
            bin/iot-server-linux ${SSH_USER}@${SSH_HOST}:/tmp/iot-server-${VERSION}

          # éƒ¨ç½²
          ssh -p $SSH_PORT -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << ENDSSH
            set -e
            
            echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
            echo "ç‰ˆæœ¬: ${VERSION}"
            
            # åˆ›å»ºå¤‡ä»½
            BACKUP_DIR="/opt/backups/\$(date +%Y%m%d_%H%M%S)_${VERSION}"
            mkdir -p "\$BACKUP_DIR"
            
            if [ -f /opt/iot-server/iot-server ]; then
              cp /opt/iot-server/iot-server "\$BACKUP_DIR/iot-server.backup"
              echo "âœ… å¤‡ä»½å®Œæˆ: \$BACKUP_DIR"
            fi
            
            # æ›¿æ¢äºŒè¿›åˆ¶
            mv /tmp/iot-server-${VERSION} /opt/iot-server/iot-server
            chmod +x /opt/iot-server/iot-server
            
            # é‡å¯æœåŠ¡ï¼ˆä¼˜é›…é‡å¯ï¼‰
            cd /opt/iot-server
            docker-compose restart iot-server || docker compose restart iot-server
            
            echo "âœ… æœåŠ¡å·²é‡å¯"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # å¥åº·æ£€æŸ¥ï¼ˆå¤šæ¬¡å°è¯•ï¼‰
            for i in {1..6}; do
              if curl -f http://localhost:7065/healthz > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆå°è¯• \$i/6ï¼‰"
                exit 0
              else
                echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (\$i/6)"
                sleep 5
              fi
            done
            
            # å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
            if [ -f "\$BACKUP_DIR/iot-server.backup" ]; then
              mv "\$BACKUP_DIR/iot-server.backup" /opt/iot-server/iot-server
              docker-compose restart iot-server || docker compose restart iot-server
              echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬"
            fi
            exit 1
          ENDSSH

          echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
          echo "ç‰ˆæœ¬: $VERSION"

      - name: æ¸…ç† SSH å¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: éƒ¨ç½²é€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "ç‰ˆæœ¬: $VERSION"
          echo "ç¯å¢ƒ: production"
          echo "æ—¶é—´: $(date)"
