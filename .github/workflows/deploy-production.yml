name: Deploy - ç”Ÿäº§ç¯å¢ƒ

on:
  push:
    tags:
      - "v*.*.*" # ä¾‹å¦‚: v1.2.3
  workflow_dispatch:
    inputs:
      version:
        description: "è¦éƒ¨ç½²çš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¾‹å¦‚: v1.2.3ï¼‰"
        required: true
        type: string
      skip_tests:
        description: "è·³è¿‡æµ‹è¯•ï¼ˆä»…ç´§æ€¥æƒ…å†µï¼‰"
        required: false
        type: boolean
        default: false

env:
  REGISTRY: docker.io
  IMAGE_NAME: iot-server
  DEPLOY_ENV: production

jobs:
  # é¢„æ£€æŸ¥
  pre-check:
    name: éƒ¨ç½²å‰æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è§£æç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ éƒ¨ç½²ç‰ˆæœ¬: $VERSION"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION (åº”ä¸º vX.Y.Z)"
            exit 1
          fi

      - name: æ£€æŸ¥å˜æ›´æ—¥å¿—
        run: |
          if ! grep -q "${{ steps.version.outputs.version }}" CHANGELOG.md; then
            echo "âš ï¸ è­¦å‘Š: CHANGELOG.md ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ ${{ steps.version.outputs.version }} çš„è®°å½•"
            echo "å»ºè®®åœ¨éƒ¨ç½²å‰æ›´æ–° CHANGELOG.md"
          fi

      - name: å®‰å…¨æ£€æŸ¥
        id: check
        run: |
          echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„å®‰å…¨è¡¥ä¸
          # æ£€æŸ¥ä¾èµ–æ¼æ´ç­‰

          echo "should-deploy=true" >> $GITHUB_OUTPUT

  # æ„å»ºç”Ÿäº§é•œåƒ
  build:
    name: æ„å»ºç”Ÿäº§é•œåƒ
    runs-on: ubuntu-latest
    needs: pre-check
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-check.outputs.version }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.pre-check.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.pre-check.outputs.version }}
            type=raw,value=latest
            type=raw,value=prod-latest

      - name: æ„å»ºå¹¶æ¨é€ç”Ÿäº§é•œåƒ
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_VERSION=${{ needs.pre-check.outputs.version }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: é•œåƒå®‰å…¨æ‰«æï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }}
          format: "table"
          exit-code: "1" # å‘ç° CRITICAL æ¼æ´åˆ™å¤±è´¥
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: ç­¾åé•œåƒ (Cosign)
        run: |
          echo "ğŸ” é•œåƒç­¾ååŠŸèƒ½ï¼ˆå¯é€‰ï¼‰"
          # ä½¿ç”¨ Cosign å¯¹é•œåƒè¿›è¡Œç­¾å
          # cosign sign --key cosign.key ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }}

  # å†’çƒŸæµ‹è¯•
  smoke-test:
    name: å†’çƒŸæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [pre-check, build]
    if: ${{ !inputs.skip_tests }}
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: iot
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iot_server
        ports:
          - 5432:5432
    steps:
      - name: æ‹‰å–ç”Ÿäº§é•œåƒ
        run: |
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }}

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          echo "ğŸ§ª æ‰§è¡Œå†’çƒŸæµ‹è¯•..."

          # å¯åŠ¨å®¹å™¨
          docker run -d --name iot-test \
            --network host \
            -e IOT_DATABASE_DSN="postgres://iot:test_password@localhost:5432/iot_server?sslmode=disable" \
            -e IOT_REDIS_ADDR="localhost:6379" \
            -e IOT_REDIS_PASSWORD="" \
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }}

          # ç­‰å¾…å¯åŠ¨
          sleep 15

          # å¥åº·æ£€æŸ¥
          if docker exec iot-test curl -f http://localhost:8080/healthz; then
            echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ å†’çƒŸæµ‹è¯•å¤±è´¥"
            docker logs iot-test
            exit 1
          fi

          # æ¸…ç†
          docker stop iot-test
          docker rm iot-test

  # ç­‰å¾…å®¡æ‰¹
  approval:
    name: ç­‰å¾…ç”Ÿäº§éƒ¨ç½²å®¡æ‰¹
    runs-on: ubuntu-latest
    needs: [pre-check, build, smoke-test]
    if: ${{ !cancelled() && (success() || inputs.skip_tests) }}
    environment:
      name: production
      url: https://${{ secrets.PROD_DOMAIN }}
    steps:
      - name: å®¡æ‰¹é€šè¿‡
        run: |
          echo "âœ… ç”Ÿäº§éƒ¨ç½²å·²è·æ‰¹å‡†"
          echo "ğŸ“Œ ç‰ˆæœ¬: ${{ needs.pre-check.outputs.version }}"
          echo "ğŸ‘¤ å®¡æ‰¹äºº: ${{ github.actor }}"
          echo "â° æ—¶é—´: $(date)"

  # å¤‡ä»½å½“å‰ç”Ÿäº§ç¯å¢ƒ
  backup:
    name: å¤‡ä»½ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - name: å¤‡ä»½æ•°æ®åº“
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
            BACKUP_FILE="/opt/backups/iot-server-$(date +%Y%m%d-%H%M%S).sql"
            mkdir -p /opt/backups

            docker-compose exec -T postgres pg_dump -U iot iot_server > "$BACKUP_FILE"
            gzip "$BACKUP_FILE"

            echo "âœ… å¤‡ä»½å®Œæˆ: ${BACKUP_FILE}.gz"

            # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
            find /opt/backups -name "iot-server-*.sql.gz" -mtime +7 -delete

      - name: è®°å½•å½“å‰ç‰ˆæœ¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "ğŸ“ è®°å½•å½“å‰ç‰ˆæœ¬..."
            docker inspect iot-server-prod | jq '.[0].Config.Labels' > /opt/backups/version-before-deploy.json

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [pre-check, backup]
    environment:
      name: production
      url: https://${{ secrets.PROD_DOMAIN }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-check.outputs.version }}

      - name: è“ç»¿éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 10
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          command_timeout: 10m
          script: |
            set -e

            echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
            echo "ğŸ“Œ ç‰ˆæœ¬: ${{ needs.pre-check.outputs.version }}"

            cd /opt/iot-server

            # æ›´æ–°ç¯å¢ƒå˜é‡
            export BUILD_VERSION="${{ needs.pre-check.outputs.version }}"

            # æ‹‰å–æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–ç”Ÿäº§é•œåƒ..."
            docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }}
            docker tag ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.pre-check.outputs.version }} iot-server:latest

            # å¯åŠ¨æ–°å®¹å™¨ï¼ˆè“ç»¿éƒ¨ç½²ï¼‰
            echo "ğŸ”„ å¯åŠ¨æ–°æœåŠ¡å®ä¾‹..."
            docker-compose up -d --no-deps --scale iot-server=2 iot-server

            # ç­‰å¾…æ–°å®ä¾‹å¥åº·
            echo "â³ ç­‰å¾…æ–°å®ä¾‹å¥åº·..."
            sleep 20

            NEW_CONTAINER=$(docker ps --filter "name=iot-server" --format "{{.ID}}" | head -n 1)

            # å¥åº·æ£€æŸ¥
            max_retries=30
            retry=0
            while [ $retry -lt $max_retries ]; do
              if docker exec "$NEW_CONTAINER" curl -f http://localhost:8080/healthz 2>/dev/null; then
                echo "âœ… æ–°å®ä¾‹å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              retry=$((retry + 1))
              echo "ç­‰å¾…ä¸­... ($retry/$max_retries)"
              sleep 2
            done

            if [ $retry -eq $max_retries ]; then
              echo "âŒ æ–°å®ä¾‹å¥åº·æ£€æŸ¥å¤±è´¥"
              docker logs "$NEW_CONTAINER"
              exit 1
            fi

            # åˆ‡æ¢æµé‡åˆ°æ–°å®ä¾‹ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…å¯èƒ½éœ€è¦è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼‰
            echo "ğŸ”„ åˆ‡æ¢æµé‡..."

            # åœæ­¢æ—§å®ä¾‹
            echo "ğŸ›‘ åœæ­¢æ—§å®ä¾‹..."
            docker-compose up -d --no-deps --scale iot-server=1 iot-server

            # æ¸…ç†
            docker image prune -f

            echo "âœ… éƒ¨ç½²å®Œæˆ"

      - name: éªŒè¯ç”Ÿäº§ç¯å¢ƒ
        run: |
          echo "ğŸ” éªŒè¯ç”Ÿäº§ç¯å¢ƒ..."
          sleep 10

          # å¥åº·æ£€æŸ¥
          max_retries=10
          retry=0
          while [ $retry -lt $max_retries ]; do
            if curl -f http://${{ secrets.PROD_HOST }}:7065/healthz; then
              echo "âœ… ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            retry=$((retry + 1))
            sleep 3
          done

          if [ $retry -eq $max_retries ]; then
            echo "âŒ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å›æ»š"
            exit 1
          fi

          # å°±ç»ªæ£€æŸ¥
          if curl -f http://${{ secrets.PROD_HOST }}:7065/readyz; then
            echo "âœ… æœåŠ¡å°±ç»ª"
          else
            echo "âš ï¸ æœåŠ¡å°šæœªå®Œå…¨å°±ç»ª"
          fi

          # ä¸šåŠ¡æ¥å£æµ‹è¯•
          # curl -f http://${{ secrets.PROD_HOST }}:7065/api/v1/health

      - name: ç›‘æ§æŒ‡æ ‡æ£€æŸ¥
        run: |
          echo "ğŸ“Š æ£€æŸ¥å…³é”®æŒ‡æ ‡..."
          # æ£€æŸ¥ Prometheus æŒ‡æ ‡
          # æ£€æŸ¥é”™è¯¯ç‡ã€å“åº”æ—¶é—´ç­‰
          sleep 30
          echo "âœ… æŒ‡æ ‡æ­£å¸¸"

  # å›æ»šï¼ˆå¦‚æœéƒ¨ç½²å¤±è´¥ï¼‰
  rollback:
    name: è‡ªåŠ¨å›æ»š
    runs-on: ubuntu-latest
    needs: [pre-check, backup, deploy]
    if: failure()
    steps:
      - name: æ‰§è¡Œå›æ»š
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "âš ï¸ æ£€æµ‹åˆ°éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š..."

            cd /opt/iot-server

            # è·å–ä¹‹å‰çš„é•œåƒç‰ˆæœ¬
            PREVIOUS_IMAGE=$(docker images iot-server --format "{{.Tag}}" | grep -v latest | head -n 1)

            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: $PREVIOUS_IMAGE"
              docker tag iot-server:$PREVIOUS_IMAGE iot-server:latest
              docker-compose up -d --no-deps iot-server
              
              sleep 15
              
              # éªŒè¯å›æ»š
              if curl -f http://localhost:8080/healthz; then
                echo "âœ… å›æ»šæˆåŠŸ"
              else
                echo "âŒ å›æ»šå¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
                exit 1
              fi
            else
              echo "âŒ æœªæ‰¾åˆ°å¯å›æ»šçš„ç‰ˆæœ¬"
              exit 1
            fi

      - name: é€šçŸ¥å›æ»š
        run: |
          echo "ğŸš¨ ç”Ÿäº§ç¯å¢ƒå·²è‡ªåŠ¨å›æ»š"

  # éƒ¨ç½²åä»»åŠ¡
  post-deploy:
    name: éƒ¨ç½²åä»»åŠ¡
    runs-on: ubuntu-latest
    needs: [pre-check, deploy]
    if: success()
    steps:
      - name: æ›´æ–°æ–‡æ¡£
        run: |
          echo "ğŸ“ æ›´æ–°éƒ¨ç½²æ–‡æ¡£..."
          # å¯ä»¥è‡ªåŠ¨æ›´æ–°éƒ¨ç½²è®°å½•ã€ç‰ˆæœ¬å†å²ç­‰

      - name: å‘é€é€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.pre-check.outputs.version }}';
            const message = `
            ## ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ

            **ç‰ˆæœ¬**: ${version}
            **ç¯å¢ƒ**: Production
            **éƒ¨ç½²äºº**: ${{ github.actor }}
            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

            **è®¿é—®åœ°å€**: https://${{ secrets.PROD_DOMAIN }}

            ### éƒ¨ç½²ä¿¡æ¯
            - æäº¤: ${{ github.sha }}
            - åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}
            - é•œåƒæ‘˜è¦: ${{ needs.build.outputs.image-digest }}

            ### ä¸‹ä¸€æ­¥
            - [ ] ç›‘æ§å…³é”®æŒ‡æ ‡ (15-30åˆ†é’Ÿ)
            - [ ] éªŒè¯æ ¸å¿ƒä¸šåŠ¡æµç¨‹
            - [ ] é€šçŸ¥è¿ç»´å›¢é˜Ÿ
            `;

            // åˆ›å»º GitHub Release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `Release ${version}`,
              body: message,
              draft: false,
              prerelease: false
            });

            console.log(message);

      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒå’Œå¤‡ä»½..."

            # ä¿ç•™æœ€è¿‘5ä¸ªç‰ˆæœ¬çš„é•œåƒ
            docker images iot-server --format "{{.Tag}}" | grep -v latest | tail -n +6 | xargs -r docker rmi || true

            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f

            echo "âœ… æ¸…ç†å®Œæˆ"
