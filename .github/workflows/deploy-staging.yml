name: Deploy - æµ‹è¯•ç¯å¢ƒ

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "éƒ¨ç½²ç‰ˆæœ¬ (ç•™ç©ºä½¿ç”¨ latest)"
        required: false
        default: ""

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.0"

      - name: ç”Ÿæˆ Swagger æ–‡æ¡£
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          swag init -g cmd/server/main.go -o api/swagger --parseDependency --parseInternal

      - name: æ„å»º Linux äºŒè¿›åˆ¶
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.sha }}"
          fi

          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-w -s -X main.Version=${VERSION}" \
          -o bin/iot-server-linux ./cmd/server

          echo "âœ… æ„å»ºå®Œæˆ: bin/iot-server-linux (version: ${VERSION})"

      - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
        env:
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER }}
          SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_PORT: ${{ secrets.STAGING_PORT || '22' }}
        run: |
          # è®¾ç½® SSH å¯†é’¥
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # æ·»åŠ ä¸»æœºåˆ° known_hosts
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
          scp -P $SSH_PORT -i ~/.ssh/deploy_key \
            bin/iot-server-linux ${SSH_USER}@${SSH_HOST}:/tmp/iot-server-new

          # éƒ¨ç½²
          ssh -p $SSH_PORT -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -f /opt/iot-server/iot-server ]; then
              cp /opt/iot-server/iot-server /opt/iot-server/iot-server.backup
              echo "âœ… å¤‡ä»½å®Œæˆ"
            fi
            
            # æ›¿æ¢äºŒè¿›åˆ¶
            mv /tmp/iot-server-new /opt/iot-server/iot-server
            chmod +x /opt/iot-server/iot-server
            
            # é‡å¯æœåŠ¡
            cd /opt/iot-server
            docker-compose restart iot-server || docker compose restart iot-server
            
            echo "âœ… æœåŠ¡å·²é‡å¯"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:7065/healthz > /dev/null 2>&1; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»šä¸­..."
              if [ -f /opt/iot-server/iot-server.backup ]; then
                mv /opt/iot-server/iot-server.backup /opt/iot-server/iot-server
                docker-compose restart iot-server || docker compose restart iot-server
                echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬"
              fi
              exit 1
            fi
          ENDSSH

          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

      - name: æ¸…ç† SSH å¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
