## Why

当前 `iot-server` 在同一个进程内同时承担了三类职责：

- 作为对第三方的中间件平台（设备/端口/会话视图、API、事件）；
- 作为具体协议（当前主要是 BKV）的 TCP 服务器和报文解析器；
- 部分承担物模型/统一抽象的角色（Device/Port/Order），但没有清晰边界。

这导致：

- 平台核心代码中充斥大量协议细节（socket 编号、子命令、Tag 等），难以扩展第二种协议；
- 协议处理代码直接访问数据库和订单状态机，引入回退路径和冗余逻辑；
- “技术真相”模型（设备/端口/充电会话）没有被正式建模，只存在于零散的代码和文档中。

参考 Hummingbird 「驱动 + 物模型 + 平台」的设计，本变更希望在规范层面明确：

- 中间件核心应围绕一个协议无关的“技术物模型（Thing Model）」运作；
- 协议处理逻辑应收敛为“驱动（Driver）」的职责，并通过窄接口与核心交互；
- 驱动不得直接访问数据库和第三方，只能通过 Driver API 上报事件/消费命令。

## What Changes

本变更不定义具体 HTTP 路径或 Go 类型，而是在 `iot-middleware-core` 规范下新增一组约束，描述：

- **技术物模型层**  
  - 明确定义中间件内部使用的协议无关技术模型：Device / Port / Session（充电会话）；  
  - 明确将设备能力拆分为属性（properties）、事件（events）、服务（services）三类；  
  - 要求所有协议都必须通过这一模型表达能力，而不是将协议字段裸暴露给核心。

- **驱动边界层**  
  - 定义驱动 → 核心的“事件”边界：驱动只能上报标准化的设备/端口/会话事件（如 PortSnapshot、SessionStarted、SessionEnded、ExceptionReported）；  
  - 定义核心 → 驱动的“命令”边界：核心只能下发标准化的服务调用（如 StartCharge、StopCharge、CancelSession、QueryPortStatus）；  
  - 明确驱动不可直接访问数据库和第三方服务，不得自行维护订单状态机。

- **核心职责收敛**  
  - 核心只以技术物模型事件为输入，维护 Device/Port/Session 的持久化状态和一致性任务，并对第三方提供统一 API/事件；  
  - 核心不得直接解析协议帧或依赖协议特定包，新增协议只能通过新驱动实现。

## Impact

本变更属于架构/规范级变更，不会直接引入代码，但会对后续重构产生约束：

- 为未来的重构提供清晰边界：哪些逻辑必须下沉到协议驱动，哪些逻辑必须上移到中间件核心；
- 为实现多协议（在现有 BKV 之外）提前铺路：新增协议时，只需编写新的驱动并映射到相同技术物模型，而无需触碰核心状态机；
- 为删除冗余代码提供依据：一旦驱动/API 边界实现，所有直接操作数据库或混合协议逻辑的路径都可以作为“违反规范”的冗余代码标记并删除。

后续实现层面的重构（例如抽象 CoreEvent/CoreCommand、剥离 BKV Handler 成为独立驱动）应在本变更获批后，按 `tasks.md` 中的任务序列逐步推进。

