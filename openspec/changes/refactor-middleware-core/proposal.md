# Change: 将 IoT 服务重构为协议无关的中间件核心并清理冗余/错误代码

## Why

- 项目定位为 IoT 中间件：设备 ↔ IoT 服务 ↔ 第三方服务，而当前代码中：
  - 存在历史遗留的业务逻辑（与特定上游业务强耦合），与中间件职责不匹配；
  - 存在大量为修复单次问题添加的零散补丁代码，难以判断是否仍然需要；
  - 多种协议（BKV/GN 等）逻辑与通用订单/端口/会话管理代码耦合在一起，影响可维护性和可扩展性。
- 为了支持“多个协议规则”的长远目标，需要：
  - 明确中间件的核心职责边界（设备状态、端口状态、订单、指令队列、事件）；
  - 将协议适配层与业务无关的核心逻辑解耦；
  - 系统性删除冗余、错误和非常不合理的代码，而不是继续叠加补丁。

## What Changes

- 定义 IoT 中间件的核心职责与非核心职责：
  - 核心：设备/端口状态同步、订单生命周期、指令下行队列、事件推送；
  - 非核心：特定上游业务规则、一次性脚本、调试/控制台工具等。
- 基于上述职责对整个项目进行结构化分析：
  - 标记协议适配层（例如 BKV、GN）与核心存储/会话/一致性模块的边界；
  - 识别与中间件职责无关或已经被替代的代码路径。
- 按模块分阶段删除/重构：
  - 删除完全未被引用或者已被更合理实现替代的冗余代码；
  - 删除明显错误或与当前设计相违背的逻辑（例如与 SessionManager/端口位图规范冲突的旧实现）；
  - 将保留的协议逻辑整理为清晰的“协议插件”，通过统一接口与核心交互。

## Impact

- 架构层面：
  - 引入“中间件核心 vs 协议适配器”的清晰分层；
  - 后续可以更容易支持新的协议（在适配层 plug-in），而不污染核心模块。
- 代码层面：
  - 代码量将显著减少（删除冗余/死代码），核心路径变得更直观；
  - 历史补丁代码将被审视并归类：保留为正式特性、迁移到一致性/监控模块或完全删除。
- 文档与规范：
  - 新增 “IoT 中间件核心” 规范，描述职责边界和协议扩展方式；
  - 扩展一致性规范，使其明确不再为特定业务做“隐式兜底”。

