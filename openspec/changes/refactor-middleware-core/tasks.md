## 1. 全局结构分析

- [ ] 1.1 基于目录结构和现有文档，列出主要模块：
  - API 层（第三方 API / 内部控制台 / 只读接口）；
  - 协议适配层（BKV/GN 等）；
  - 核心：SessionManager / CoreRepo / 一致性任务（PortStatusSyncer 等）；
  - 辅助：E2E 测试、脚本、一次性修复 SQL 等。
- [ ] 1.2 对每个模块标注其是否属于中间件核心职责：
  - 如果是核心职责，记录其依赖关系和数据流；
  - 如果是非核心或特定业务逻辑，记录其调用方和实际用途。

## 2. 冗余/错误/不合理代码识别

- [ ] 2.1 使用静态分析和 `rg` 检查未被引用或仅在测试中引用的代码路径，评估是否可以删除：
  - 历史迁移脚本、一次性修复工具；
  - 已被更合理实现替代的旧实现。
- [ ] 2.2 识别违反现有规范（SessionManager 真相源、BKV 端口位图 等）的代码：
  - 直接依赖 `devices.online` 或旧端口状态枚举的逻辑（已在局部清理，此处做全局确认）；
  - 与 OpenSpec 一致性规范冲突的补丁代码。

## 3. 中间件分层与协议适配

- [ ] 3.1 为协议适配层定义统一接口（例如 `ProtocolHandler`）：
  - 负责：解析报文、翻译为核心事件（端口状态更新、订单事件、告警等）；
  - 不负责：订单状态机、端口/订单一致性、自愈逻辑。
- [ ] 3.2 将 BKV/GN 等协议处理逻辑归类到适配层，通过统一接口与 CoreRepo 和 SessionManager 交互。

## 4. 删除与重构

- [ ] 4.1 分批删除明确被标记为冗余或错误的代码：
  - 确认无调用方或仅在过时路径中调用；
  - 删除前在变更说明中记录“删除原因”和替代路径（如有）。
- [ ] 4.2 对保留但“不合理”的代码进行重构：
  - 例如将“隐式兜底”逻辑改为显式错误 + 告警，而不是自动修改订单/端口状态；
  - 将协议特定的临时补丁迁移到适配层或监控层。

## 5. 文档与规范落地

- [ ] 5.1 编写 IoT 中间件核心文档，描述：
  - 核心职责与非核心职责；
  - 核心模块（SessionManager/CoreRepo/一致性任务）的职责和协作方式；
  - 协议适配层的扩展模式。
- [ ] 5.2 更新 OpenSpec 规范，确保：
  - 新增的“middleware-core” 规范中明确禁止在核心路径中加入特定业务逻辑；
  - 一致性规范仅关注设备/端口/订单/队列，而不是上游业务。

## 6. 验证与回归

- [ ] 6.1 运行 E2E 测试和主要 API 集成测试，确认：
  - 中间件作为黑盒对设备和第三方的行为保持稳定；
  - 删除/重构不会改变已承诺的行为（除非在规范中标记为 BREAKING）。
- [ ] 6.2 更新变更日志和内部说明，明确：
  - 哪些 API/行为被视为“中间件契约”的一部分；
  - 非中间件职责的代码已被删除或迁移到上游服务。

