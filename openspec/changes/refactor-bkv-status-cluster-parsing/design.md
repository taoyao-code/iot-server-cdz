# Design: BKV 状态集群解析重构

## Context

### 背景

BKV 协议是组网版充电桩设备的通信协议，其中 0x1017 命令用于上报插座状态集群。当前实现无法正确解析协议文档定义的 TLV 格式，导致关键设备状态数据丢失。

### 约束条件

- 必须向后兼容现有的 `SocketStatus` 接口
- 不能影响其他 BKV 命令的解析（心跳、控制命令等）
- 解析失败时应优雅降级，不阻塞设备通信

### 利益相关者

- 充电平台：依赖状态数据进行设备监控
- 运维团队：需要实时电压/电流/功率数据进行故障诊断
- 第三方系统：通过 Webhook 接收状态事件

## Goals / Non-Goals

### Goals

- 100% 正确解析协议文档定义的 0x1017 状态集群格式
- 提取完整的插座和端口属性字段
- 提供清晰的错误信息用于调试
- 保持与现有业务逻辑的兼容性

### Non-Goals

- 不重构其他 BKV 命令的解析逻辑（0x1004、0x1007 等）
- 不修改上层业务逻辑（CoreEvent 生成、Webhook 推送）
- 不改变存储层数据模型

## Decisions

### Decision 1: TLV 前缀处理策略

**选择**：实现显式的 0x03/0x04 前缀解析器

**原因**：
- 协议文档示例显示 TLV 字段使用 `0x03 01 <tag> <value>` 或 `0x04 01 <tag> <value>` 格式
- 0x03 表示 1 字节值长度，0x04 表示 2 字节值长度
- 现有代码假设标签直接出现，无法正确解析

**格式解析**：
```
03 01 4A 01      -> Tag=0x4A, Len=1, Value=0x01 (插座序号=1)
04 01 3E FF FF   -> Tag=0x3E, Len=2, Value=0xFFFF (软件版本)
03 01 07 25      -> Tag=0x07, Len=1, Value=0x25 (温度=37℃)
```

**替代方案**：
- 方案A：正则匹配标签 → 复杂且不可靠
- 方案B：硬编码偏移量 → 不适应协议变化

### Decision 2: 端口属性容器处理

**选择**：使用状态机解析 0x5B 容器

**原因**：
- 0x5B 是端口属性容器的标识
- 容器内部包含多个子 TLV 字段
- 设备可能有 1-2 个端口，需要循环解析

**解析流程**：
```
遇到 0x28 0x01 0x5B -> 进入端口容器解析模式
  -> 解析 0x08 插孔号
  -> 解析 0x09 状态位
  -> 解析 0x0A 业务号
  -> 解析 0x95 电压
  -> ...
遇到下一个 0x28 0x01 0x5B -> 切换到下一个端口
```

### Decision 3: 兼容性处理

**选择**：双分支识别 + Fallback 机制

**原因**：
- 可能存在使用旧格式的固件版本
- 需要平滑过渡，不中断现有设备通信

**实现**：
```go
func GetSocketStatus(payload *BKVPayload) *SocketStatus {
    // 优先尝试新格式解析
    if status, err := ParseBKVStatusCluster(payload.Raw); err == nil {
        return status
    }
    // Fallback 到旧解析逻辑
    return parseSocketStatusLegacy(payload)
}
```

### Decision 4: 顶层 TLV 标签映射

**选择**：支持双版本标签

| 用途 | 新版本标签 | 旧版本标签 |
|------|------------|------------|
| 命令 | 0x01 | 0x04 |
| 帧序列号 | 0x02 | 0x0A |
| 网关ID | 0x03 | 0x09 |

**原因**：
- 协议文档使用 0x01/0x02/0x03
- 现有代码使用 0x04/0x0A/0x09
- 需要同时支持两种格式以兼容不同固件

## Risks / Trade-offs

### Risk 1: 解析性能下降

**风险**：新解析逻辑更复杂，可能影响高并发场景

**缓解**：
- 预分配缓冲区，避免频繁内存分配
- 使用 `sync.Pool` 复用解析上下文
- 基准测试确保 < 100μs/次

### Risk 2: 未知固件格式

**风险**：部分设备固件可能使用非标准格式

**缓解**：
- 记录解析失败的原始数据（DEBUG 级别）
- 提供 `--strict` 模式用于调试
- Fallback 机制保证基本可用

### Risk 3: 字段缺失

**风险**：部分设备可能不上报某些可选字段

**缓解**：
- 所有字段使用指针或零值表示缺失
- 上层逻辑检查字段是否存在
- 日志记录缺失的字段

## Migration Plan

### Phase 1: 实现与测试（无影响）

1. 新增 `ParseBKVStatusCluster` 函数
2. 编写单元测试覆盖协议示例
3. 不修改现有调用点

### Phase 2: 灰度切换

1. 修改 `GetSocketStatus` 添加双分支
2. 通过配置控制新解析器开关
3. 监控解析成功率和错误日志

### Phase 3: 全量切换

1. 移除旧解析逻辑开关
2. 标记旧函数为 deprecated
3. 观察 7 天无异常后删除旧代码

### Rollback Plan

- 配置开关：`bkv.use_legacy_status_parser: true`
- 回滚命令：修改配置后重启服务
- 回滚时间：< 5 分钟

## Open Questions

1. **Q**: 是否需要支持 0x65/0x94 以外的状态集群标识？
   **A**: 暂时只支持文档定义的格式，后续根据实际需求扩展

2. **Q**: 解析失败时是否应该触发告警？
   **A**: 建议在错误率超过阈值时触发告警，具体阈值待定

3. **Q**: 是否需要存储原始报文用于回溯分析？
   **A**: DEBUG 模式下记录，生产环境仅记录摘要

## Appendix: 协议示例解析

### 原始报文

```
65 01 94                          # 状态集群标识
03 01 4A 01                       # 插座序号 = 1
04 01 3E FF FF                    # 软件版本 = 0xFFFF
03 01 07 25                       # 温度 = 37℃
03 01 96 1E                       # RSSI = 30
28 01 5B                          # 端口A容器开始
  03 01 08 00                     # 插孔号 = 0 (A孔)
  03 01 09 80                     # 状态 = 0x80
  04 01 0A 00 00                  # 业务号 = 0
  04 01 95 08 E3                  # 电压 = 2275 (227.5V)
  04 01 0B 00 00                  # 功率 = 0
  04 01 0C 00 01                  # 电流 = 1
  04 01 0D 00 00                  # 用电量 = 0
  04 01 0E 00 00                  # 充电时间 = 0
28 01 5B                          # 端口B容器开始
  03 01 08 01                     # 插孔号 = 1 (B孔)
  ...
```

### 期望解析结果

```go
SocketStatus{
    SocketNo:    1,
    SoftwareVer: 0xFFFF,
    Temperature: 37,
    RSSI:        30,
    Ports: []PortStatus{
        {
            PortNo:       0,
            Status:       0x80,
            BusinessNo:   0,
            Voltage:      2275,  // 227.5V
            Power:        0,
            Current:      1,
            Energy:       0,
            ChargingTime: 0,
        },
        {
            PortNo:       1,
            Status:       0x80,
            // ...
        },
    },
}
```
