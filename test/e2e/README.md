# IoT å……ç”µæ¡© E2E æµ‹è¯•å¥—ä»¶

å®Œæ•´ã€è§„èŒƒçš„ç«¯åˆ°ç«¯(E2E)æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯ IoT å……ç”µæ¡©ç³»ç»Ÿçš„ç¬¬ä¸‰æ–¹ API åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [ç‰¹æ€§](#ç‰¹æ€§)
- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®](#é…ç½®)
- [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
- [æµ‹è¯•å¥—ä»¶](#æµ‹è¯•å¥—ä»¶)
- [CI/CD é›†æˆ](#cicdé›†æˆ)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## âœ¨ ç‰¹æ€§

- âœ… **è§„èŒƒåŒ–æµ‹è¯•ç»“æ„** - ä½¿ç”¨ testify/suite ç»„ç»‡æµ‹è¯•
- âœ… **å¼ºç±»å‹è®¾è®¡** - æ‰€æœ‰ API æ¨¡å‹éƒ½æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰
- âœ… **ç¯å¢ƒå˜é‡é…ç½®** - æ— ç¡¬ç¼–ç ï¼Œæ”¯æŒå¤šç¯å¢ƒ
- âœ… **è‡ªåŠ¨åŒ–æ¸…ç†** - æ¯ä¸ªæµ‹è¯•åè‡ªåŠ¨æ¸…ç†èµ„æº
- âœ… **è¯¦ç»†æ—¥å¿—** - å¯é…ç½®çš„è¯¦ç»†è¾“å‡º
- âœ… **é”™è¯¯å¤„ç†** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## ğŸ“¦ ç¯å¢ƒè¦æ±‚

- **Go**: 1.21 æˆ–æ›´é«˜ç‰ˆæœ¬
- **ç½‘ç»œ**: èƒ½å¤Ÿè®¿é—®æµ‹è¯•æœåŠ¡å™¨
- **è®¾å¤‡**: è‡³å°‘ä¸€å°åœ¨çº¿çš„ BKV æµ‹è¯•è®¾å¤‡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿›å…¥ç›®å½•

```bash
cd test/e2e
```

### 2. å®‰è£…ä¾èµ–

```bash
go mod download
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# æ–¹å¼1: å¤åˆ¶å¹¶ç¼–è¾‘ .env æ–‡ä»¶
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# æ–¹å¼2: ç›´æ¥è®¾ç½®ç¯å¢ƒå˜é‡
export E2E_SERVER_URL="http://182.43.177.92:7055"
export E2E_API_KEY="your_api_key_here"
export E2E_DEVICE_ID="82241218000382"
```

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -v ./...

# è¿è¡Œç‰¹å®šå¥—ä»¶
go test -v -run ChargeSuite

# è¯¦ç»†è¾“å‡º
E2E_VERBOSE=true go test -v ./...
```

## âš™ï¸ é…ç½®

### å¿…å¡«ç¯å¢ƒå˜é‡

| å˜é‡å          | è¯´æ˜        | ç¤ºä¾‹                         |
| --------------- | ----------- | ---------------------------- |
| `E2E_API_KEY`   | API å¯†é’¥    | `sk_test_thirdparty_key_...` |
| `E2E_DEVICE_ID` | æµ‹è¯•è®¾å¤‡ ID | `82241218000382`             |

### å¯é€‰ç¯å¢ƒå˜é‡

| å˜é‡å                | é»˜è®¤å€¼                  | è¯´æ˜       |
| --------------------- | ----------------------- | ---------- |
| `E2E_SERVER_URL`      | `http://localhost:7055` | æœåŠ¡å™¨åœ°å€ |
| `E2E_REQUEST_TIMEOUT` | `30s`                   | è¯·æ±‚è¶…æ—¶   |
| `E2E_WAIT_TIMEOUT`    | `60s`                   | ç­‰å¾…è¶…æ—¶   |
| `E2E_VERBOSE`         | `false`                 | è¯¦ç»†è¾“å‡º   |

## ğŸ§ª æµ‹è¯•å¥—ä»¶

### ChargeSuite - å……ç”µæµç¨‹æµ‹è¯•

```bash
go test -v -run ChargeSuite
```

æµ‹è¯•ç”¨ä¾‹ï¼š

- âœ… ç«¯å£ 1/2 å……ç”µå®Œæ•´æµç¨‹
- âœ… åŒç«¯å£å¹¶å‘å……ç”µ
- âœ… ç«¯å£å†²çªå¤„ç†
- âœ… ä¸åŒå……ç”µæ¨¡å¼
- âœ… åœæ­¢å……ç”µæŒ‡ä»¤
- âœ… æ— æ•ˆå‚æ•°å¤„ç†

### DeviceSuite - è®¾å¤‡ç®¡ç†æµ‹è¯•

```bash
go test -v -run DeviceSuite
```

æµ‹è¯•ç”¨ä¾‹ï¼š

- âœ… è·å–è®¾å¤‡ä¿¡æ¯
- âœ… è®¾å¤‡åœ¨çº¿çŠ¶æ€
- âœ… è®¾å¤‡ä¸å­˜åœ¨å¤„ç†
- âœ… ç«¯å£ä¿¡æ¯æŸ¥è¯¢
- âœ… æ´»è·ƒè®¢å•è¿½è¸ª

### OrderSuite - è®¢å•ç®¡ç†æµ‹è¯•

```bash
go test -v -run OrderSuite
```

æµ‹è¯•ç”¨ä¾‹ï¼š

- âœ… è®¢å•ä¿¡æ¯æŸ¥è¯¢
- âœ… è®¢å•çŠ¶æ€æµè½¬
- âœ… è®¢å•ä¸å­˜åœ¨å¤„ç†
- âœ… æ—¶é—´è¿½è¸ª
- âœ… ç”µé‡è¿½è¸ª

## ğŸ”§ è°ƒè¯•ç”¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯

åœ¨ä¸é€šè¿‡ `go test` çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®çš„è°ƒè¯•å®¢æˆ·ç«¯ç›´æ¥å¯¹æ¥æœåŠ¡ç«¯ï¼Œè·‘ä¸€éå®Œæ•´çš„å……ç”µæµç¨‹ï¼š

```bash
cd test/e2e

# ä¾ç„¶å¤ç”¨ E2E_* ç¯å¢ƒå˜é‡
export E2E_SERVER_URL="http://182.43.177.92:7055"
export E2E_API_KEY="your_api_key_here"
export E2E_DEVICE_ID="82241218000382"

# è·‘ä¸€æ¬¡å®Œæ•´å……ç”µæµç¨‹ï¼šç­‰å¾…è®¾å¤‡ä¸Šçº¿ â†’ å¯åŠ¨å……ç”µ â†’ ç­‰å¾… charging â†’ åœæ­¢å……ç”µ â†’ ç­‰å¾… completed
go run ./cmd/chargeflow \
  -device "$E2E_DEVICE_ID" \
  -port 1 \
  -amount 100 \
  -mode 2
```

è¯¥å‘½ä»¤è¡Œå·¥å…·åªç”¨äºéªŒè¯æœåŠ¡ç«¯è¡Œä¸ºæ˜¯å¦æ­£ç¡®ï¼Œä¸ä½œä¸ºæ­£å¼å®¢æˆ·ç«¯ä½¿ç”¨ã€‚

## ğŸ“Š CI/CD é›†æˆ

### GitHub Actions ç¤ºä¾‹

```yaml
name: E2E Tests
on: [push, pull_request]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: "1.21"
      - name: Run Tests
        working-directory: test/e2e
        env:
          E2E_SERVER_URL: ${{ secrets.E2E_SERVER_URL }}
          E2E_API_KEY: ${{ secrets.E2E_API_KEY }}
          E2E_DEVICE_ID: ${{ secrets.E2E_DEVICE_ID }}
        run: go test -v -timeout 10m ./...
```

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. è®¾å¤‡ä¸åœ¨çº¿**

```
é”™è¯¯: timeout waiting for device online
è§£å†³: ç¡®è®¤è®¾å¤‡IDæ­£ç¡®ï¼Œæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
```

**2. API å¯†é’¥é”™è¯¯**

```
é”™è¯¯: API Error [401]: Unauthorized
è§£å†³: æ£€æŸ¥ E2E_API_KEY ç¯å¢ƒå˜é‡
```

**3. å……ç”µæœªå¯åŠ¨**

```
ç°è±¡: è®¢å•ä¸€ç›´ä¸º pending çŠ¶æ€
è§£å†³: ç¡®ä¿å……ç”µå™¨å·²æ’å…¥å¯¹åº”ç«¯å£
```

### è°ƒè¯•æŠ€å·§

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
E2E_VERBOSE=true go test -v -run ChargeSuite/TestPort1Charge

# æŸ¥çœ‹å®Œæ•´é”™è¯¯
go test -v ./... 2>&1 | tee test.log

# å¢åŠ è¶…æ—¶æ—¶é—´
E2E_WAIT_TIMEOUT=120s go test -v ./...
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
test/e2e/
â”œâ”€â”€ config.go           # é…ç½®ç®¡ç†
â”œâ”€â”€ client.go           # HTTP å®¢æˆ·ç«¯
â”œâ”€â”€ models.go           # æ•°æ®æ¨¡å‹
â”œâ”€â”€ helpers.go          # æµ‹è¯•åŠ©æ‰‹
â”œâ”€â”€ charge_test.go      # å……ç”µæµ‹è¯•
â”œâ”€â”€ device_test.go      # è®¾å¤‡æµ‹è¯•
â”œâ”€â”€ order_test.go       # è®¢å•æµ‹è¯•
â”œâ”€â”€ README.md           # æœ¬æ–‡æ¡£
â”œâ”€â”€ .env.example        # é…ç½®ç¤ºä¾‹
â””â”€â”€ go.mod              # ä¾èµ–ç®¡ç†
```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-10-31)

- âœ¨ å®Œå…¨é‡æ„ä¸ºè§„èŒƒæµ‹è¯•å¥—ä»¶
- âœ¨ ä½¿ç”¨ testify/suite
- âœ¨ å¼ºç±»å‹ API æ¨¡å‹
- âœ¨ ç¯å¢ƒå˜é‡é…ç½®
- âœ¨ è‡ªåŠ¨èµ„æºæ¸…ç†
- ğŸ“ å®Œå–„æ–‡æ¡£

---

**Happy Testing! ğŸ‰**
